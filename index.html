<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Happy Thursday, Bao ğŸ§¡</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Lora:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #FDF6EC;
    --peach: #F4A56A;
    --rose: #E8736A;
    --deep: #3D2B1F;
    --gold: #D4A853;
    --soft: #FAE8D8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    font-family: 'Lora', serif;
    color: var(--deep);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ---- LANDING ---- */
  #landing {
    position: fixed; inset: 0;
    background: var(--deep);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 100;
    transition: opacity 0.8s ease, transform 0.8s ease;
  }
  #landing.gone { opacity: 0; transform: translateY(-30px); pointer-events: none; }

  .envelope { font-size: 80px; animation: pulse 1.5s ease-in-out infinite; cursor: pointer; user-select: none; }
  @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1) rotate(-3deg)} }
  .tap-text {
    color: var(--peach); font-family:'Playfair Display',serif; font-style:italic;
    font-size:1.1rem; margin-top:1.5rem; opacity:0.8; animation:blink 2s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:.8} 50%{opacity:.3} }

  /* ---- MAIN ---- */
  #main { opacity:0; transition:opacity 1s ease 0.3s; pointer-events:none; }
  #main.visible { opacity:1; pointer-events:all; }

  .hearts-bg { position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0; }
  .heart-float {
    position:absolute; bottom:-60px; font-size:1.2rem; opacity:0.15; animation:floatUp linear infinite;
  }
  @keyframes floatUp {
    0%{transform:translateY(0) rotate(0deg);opacity:.15}
    100%{transform:translateY(-110vh) rotate(20deg);opacity:0}
  }

  .header { position:relative; z-index:1; text-align:center; padding:3.5rem 1.5rem 2rem; }
  .day-label {
    font-family:'Playfair Display',serif; font-size:clamp(.75rem,3vw,.9rem);
    letter-spacing:.35em; color:var(--gold); text-transform:uppercase; margin-bottom:.5rem;
  }
  .main-title {
    font-family:'Playfair Display',serif; font-size:clamp(2.4rem,9vw,4.5rem);
    line-height:1.1; color:var(--rose); text-shadow:2px 3px 0 rgba(61,43,31,.08);
  }
  .main-title span { font-style:italic; color:var(--peach); }
  .subtitle { font-style:italic; margin-top:1rem; font-size:1rem; color:var(--deep); opacity:.7; }

  .note-card {
    position:relative; z-index:1; background:white; border-radius:20px;
    margin:0 1.2rem 2rem; padding:1.8rem 1.6rem;
    box-shadow:0 8px 30px rgba(61,43,31,.1), 0 2px 0 var(--gold) inset;
    border-top:4px solid var(--peach);
  }
  .note-card p { font-size:.97rem; line-height:1.8; color:var(--deep); }
  .note-card p+p { margin-top:1rem; }
  .signature { margin-top:1.2rem; font-family:'Playfair Display',serif; font-style:italic; font-size:1.2rem; color:var(--rose); text-align:right; }

  .section-label {
    position:relative; z-index:1; text-align:center;
    font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--deep); padding:0 1.5rem .5rem;
  }
  .section-label small { display:block; font-family:'Lora',serif; font-style:italic; font-size:.85rem; color:var(--gold); margin-top:.2rem; }

  /* ---- GAME WRAP ---- */
  #game-wrap {
    position:relative; z-index:1;
    margin:1rem 1.2rem 2rem;
    background:var(--deep); border-radius:24px; overflow:hidden;
    padding:1.2rem 1.2rem 1.5rem;
    box-shadow:0 10px 40px rgba(61,43,31,.2);
  }

  /* HUD */
  #hud-top {
    display:grid; grid-template-columns:1fr auto 1fr;
    align-items:center; margin-bottom:.6rem; gap:4px;
  }
  .hud-score { color:var(--cream); font-size:.75rem; }
  .hud-score .val { font-family:'Playfair Display',serif; font-size:1.25rem; color:var(--peach); display:block; }
  #hud-level-badge {
    text-align:center; background:var(--gold); color:var(--deep);
    border-radius:20px; padding:.2rem .7rem;
    font-family:'Playfair Display',serif; font-size:.75rem; font-weight:700; white-space:nowrap;
  }
  #hud-lives { text-align:right; color:var(--rose); font-size:.95rem; letter-spacing:1px; }

  #xp-bar-wrap {
    background:rgba(255,255,255,.08); border-radius:10px; height:7px; margin-bottom:3px; overflow:hidden;
  }
  #xp-bar { height:100%; background:linear-gradient(90deg,var(--peach),var(--gold)); border-radius:10px; width:0%; transition:width .4s ease; }
  #xp-label { text-align:right; font-size:.62rem; color:var(--gold); opacity:.7; margin-bottom:.5rem; }

  /* Active buffs */
  #buffs-row { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:.5rem; min-height:20px; }
  .buff-chip {
    background:rgba(244,165,106,.15); border:1px solid var(--peach);
    color:var(--cream); border-radius:20px; padding:2px 7px;
    font-size:.65rem; display:flex; align-items:center; gap:3px;
  }
  .buff-chip .bt { font-size:.58rem; color:var(--gold); }

  #canvas-wrap {
    position:relative; width:100%;
    background:rgba(255,255,255,.04); border-radius:16px; overflow:hidden; touch-action:none;
  }
  #gameCanvas { display:block; width:100%; border-radius:16px; }

  #game-msg {
    text-align:center; color:var(--cream); font-family:'Playfair Display',serif;
    font-style:italic; font-size:.82rem; margin-top:.7rem; opacity:.7; min-height:1.2em;
  }

  /* Stats panel */
  #stats-panel {
    position:relative; z-index:1;
    margin:0 1.2rem 2rem; background:white; border-radius:20px;
    padding:1.4rem; box-shadow:0 6px 24px rgba(61,43,31,.08); border-top:4px solid var(--gold);
  }
  #stats-panel h3 { font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--deep); margin-bottom:.9rem; }
  .stat-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; font-size:.85rem; }
  .stat-label { color:var(--deep); opacity:.65; }
  .stat-val { font-family:'Playfair Display',serif; color:var(--rose); font-size:.95rem; }

  .unlocks-section { margin-top:1rem; border-top:1px solid var(--soft); padding-top:.9rem; }
  .unlocks-section h4 { font-family:'Playfair Display',serif; font-size:.95rem; color:var(--deep); margin-bottom:.6rem; opacity:.7; }
  .unlock-item { display:flex; align-items:flex-start; gap:8px; margin-bottom:.5rem; font-size:.8rem; opacity:.28; transition:opacity .3s; }
  .unlock-item.achieved { opacity:1; }
  .unlock-icon { font-size:1rem; margin-top:1px; }
  .unlock-name { font-family:'Playfair Display',serif; color:var(--deep); }
  .unlock-desc { font-size:.72rem; color:var(--deep); opacity:.6; font-style:italic; }

  /* Buttons */
  .game-btn {
    display:block; margin:.8rem auto 0;
    background:var(--peach); color:var(--deep); border:none; border-radius:30px;
    padding:.6rem 1.8rem; font-family:'Playfair Display',serif; font-size:.95rem;
    cursor:pointer; font-style:italic; box-shadow:0 4px 0 rgba(0,0,0,.2); transition:transform .1s;
  }
  .game-btn:active { transform:scale(.97); }

  /* Overlay */
  #overlay {
    position:absolute; inset:0; background:rgba(61,43,31,.92);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    border-radius:16px; text-align:center; padding:1.4rem 1.1rem; overflow-y:auto;
  }
  #overlay h2 { font-family:'Playfair Display',serif; color:var(--peach); font-size:1.5rem; margin-bottom:.4rem; }
  #overlay p { color:var(--cream); font-style:italic; margin-bottom:.5rem; font-size:.85rem; line-height:1.6; }
  #overlay.hidden { display:none; }

  /* Buff picker */
  #buff-picker { display:flex; flex-direction:column; gap:7px; width:100%; margin:.5rem 0 .3rem; }
  .buff-option {
    background:rgba(244,165,106,.1); border:1.5px solid rgba(244,165,106,.4);
    border-radius:12px; padding:.55rem .85rem; color:var(--cream); cursor:pointer;
    text-align:left; transition:background .15s, border-color .15s;
    font-family:'Lora',serif; font-size:.78rem;
  }
  .buff-option:active { background:rgba(244,165,106,.28); border-color:var(--peach); }
  .buff-option strong { display:block; font-family:'Playfair Display',serif; font-size:.92rem; color:var(--peach); margin-bottom:2px; }

  footer { position:relative; z-index:1; text-align:center; padding:0 1rem 3rem; font-size:1.6rem; color:var(--rose); letter-spacing:4px; }
</style>
</head>
<body>

<div id="landing">
  <div class="envelope" id="envBtn">ğŸ’Œ</div>
  <p class="tap-text">tap to open your message</p>
</div>

<div id="main">
  <div class="hearts-bg" id="heartsBg"></div>

  <div class="header">
    <p class="day-label">Thursday Â· Just For You</p>
    <h1 class="main-title">Happy<br><span>Thursday,</span><br>Bao ğŸ§¡</h1>
    <p class="subtitle">a little something to brighten your day</p>
  </div>

  <div class="note-card">
    <p>Hey Bao, I just wanted to take a moment to remind you how much you mean to me â€” even on a regular Thursday.</p>
    <p>You make every ordinary day feel a little softer and a little warmer just by being in it. I hope today is as sweet as you are.</p>
    <p>I lub you. I wish you all the best nomnoms forever ğŸœâœ¨ Now go play the game below ğŸ®</p>
    <p class="signature">â€” Your Dudu ğŸ’›</p>
  </div>

  <div class="section-label">
    Catch the Hearts ğŸ’•
    <small>level up Â· unlock buffs Â· collect stats!</small>
  </div>

  <div id="game-wrap">
    <div id="hud-top">
      <div class="hud-score">Score<span class="val" id="scoreDisplay">0</span></div>
      <div id="hud-level-badge">Lv.1 Sweetie</div>
      <div id="hud-lives">â¤ï¸â¤ï¸â¤ï¸</div>
    </div>
    <div id="xp-bar-wrap"><div id="xp-bar"></div></div>
    <div id="xp-label">0 / 10 XP to next level</div>
    <div id="buffs-row"></div>
    <div id="canvas-wrap">
      <canvas id="gameCanvas"></canvas>
      <div id="overlay">
        <h2>Catch the Hearts!</h2>
        <p>Slide your finger to move Bao's basket.<br>Catch ğŸ’• hearts â€” avoid âœ–ï¸ bad ones!<br><br><strong style="color:var(--gold);font-style:normal">Level up to unlock powerful buffs ğŸŒŸ</strong></p>
        <button class="game-btn" id="start-btn">Start Playing ğŸ’•</button>
      </div>
    </div>
    <p id="game-msg">Catch hearts, avoid the âœ–ï¸ ones!</p>
  </div>

  <div id="stats-panel">
    <h3>ğŸ“Š Bao's Stats</h3>
    <div class="stat-row"><span class="stat-label">ğŸ† High Score</span><span class="stat-val" id="stat-hs">0</span></div>
    <div class="stat-row"><span class="stat-label">â­ Highest Level Reached</span><span class="stat-val" id="stat-lv">1</span></div>
    <div class="stat-row"><span class="stat-label">ğŸ’• Total Hearts Caught</span><span class="stat-val" id="stat-hc">0</span></div>
    <div class="stat-row"><span class="stat-label">ğŸ® Games Played</span><span class="stat-val" id="stat-gp">0</span></div>
    <div class="stat-row"><span class="stat-label">ğŸ”¥ Best Catch Streak</span><span class="stat-val" id="stat-st">0</span></div>
    <div class="stat-row"><span class="stat-label">ğŸ’› Buffs Ever Picked</span><span class="stat-val" id="stat-bp">0</span></div>

    <div class="unlocks-section">
      <h4>ğŸ”“ Level Unlocks</h4>
      <div id="unlocks-list"></div>
    </div>
  </div>

  <footer>ğŸ§¡ ğŸŒ¸ ğŸ’› ğŸŒ· ğŸ’•</footer>
</div>

<script>
// ========================
// LEVELS
// ========================
const LEVELS = [
  { level:1, title:'Sweetie',       xpNeeded:10,  color:'#D4A853', desc:'Just getting started ğŸŒ±' },
  { level:2, title:'Nomnom Queen',  xpNeeded:25,  color:'#F4A56A', desc:'First buff unlocked! ğŸœ' },
  { level:3, title:'Fissy Bao', xpNeeded:45,  color:'#E8736A', desc:'Getting serious ğŸ’•' },
  { level:4, title:'Cozy Bao',      xpNeeded:70,  color:'#B56FCC', desc:'Smooth operator ğŸ›‹ï¸' },
  { level:5, title:'Bao Warrior',   xpNeeded:100, color:'#6FAACC', desc:'Stars appear on the canvas ğŸŒŸ' },
  { level:6, title:'Snoozing Bao',  xpNeeded:140, color:'#CC6F8A', desc:'Basket glows with power ğŸ‘‘' },
  { level:7, title:'Potato Bao',      xpNeeded:190, color:'#6FCCAA', desc:'Rainbow basket unlocked ğŸŒˆ' },
  { level:8, title:'Nomnom Bao',     xpNeeded:250, color:'#FFD700', desc:'Golden everything âœ¨' },
  { level:9, title:'Nomnom Demon',    xpNeeded:9999,color:'#FF9ECD', desc:'Maximum form â€” you\'re legendary! ğŸŒŒ' },
];

// ========================
// BUFFS
// ========================
const BUFFS = [
  { id:'wide',   name:'ğŸ›’ Wide Basket',   desc:'Basket is 45% wider for 15s',       dur:15 },
  { id:'slow',   name:'ğŸŒ Slow Fall',     desc:'Hearts fall 35% slower for 12s',     dur:12 },
  { id:'shield', name:'ğŸ›¡ï¸ Love Shield',   desc:'Blocks the next bad heart (1 use)',   dur:Infinity },
  { id:'double', name:'ğŸ’ Double Points', desc:'Hearts worth 2Ã— score for 10s',       dur:10 },
  { id:'magnet', name:'ğŸ§² Heart Magnet',  desc:'Hearts drift toward basket for 10s',  dur:10 },
  { id:'xpboost',name:'âš¡ XP Rush',       desc:'+60% XP gained for 12s',             dur:12 },
  { id:'freeze', name:'â„ï¸ Freeze Baddies',desc:'Bad items crawl slowly for 8s',       dur:8  },
  { id:'golden', name:'ğŸŒŸ Golden Hearts', desc:'All hearts worth 3Ã— for 8s',          dur:8  },
];

const LV_POOLS = {
  2: ['wide','slow','shield'],
  3: ['double','magnet','xpboost'],
  4: ['wide','double','freeze'],
  5: ['shield','golden','magnet'],
  6: ['xpboost','freeze','golden'],
  7: ['wide','shield','double'],
  8: ['golden','magnet','xpboost'],
  9: ['freeze','golden','shield'],
};

// ========================
// PERSISTENT STORAGE
// ========================
let P = JSON.parse(localStorage.getItem('bao_game_v2') || 'null') || {
  highScore:0, highLevel:1, totalHearts:0, gamesPlayed:0, bestStreak:0, buffsPickedTotal:0,
  achievedLevels:[1]
};
function saveP() { localStorage.setItem('bao_game_v2', JSON.stringify(P)); }

// ========================
// CANVAS / STATE
// ========================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');

let W, H;
function resize() {
  W = canvas.width = document.getElementById('canvas-wrap').clientWidth;
  H = canvas.height = Math.min(340, window.innerHeight * 0.42);
}
resize();
window.addEventListener('resize', resize);

const BASE_W = 70, BH = 22;
const HEART_EMO = ['ğŸ’•','ğŸ§¡','ğŸ’›','ğŸŒ¸','ğŸ’–','ğŸ’—'];
const BAD_EMO   = ['âœ–ï¸','ğŸ’¢','âš¡'];

let basket = {x:0};
let items=[], popups=[];
let score=0, lives=3, xp=0, level=1, frame=0, running=false;
let streak=0, sessionHearts=0;
let activeBuffs=[];

// State flags (recomputed from buffs each frame)
let st = {};

function computeState() {
  st = { bw:1, sm:1, shield:false, x2:false, magnet:false, xpM:1, freezeBad:false, x3:false };
  activeBuffs = activeBuffs.filter(b => b.endsAt === Infinity || b.endsAt > frame);
  for (const b of activeBuffs) {
    if (b.id==='wide')    st.bw   = 1.45;
    if (b.id==='slow')    st.sm   = 0.65;
    if (b.id==='shield')  st.shield = true;
    if (b.id==='double')  st.x2   = true;
    if (b.id==='magnet')  st.magnet = true;
    if (b.id==='xpboost') st.xpM  = 1.6;
    if (b.id==='freeze')  st.freezeBad = true;
    if (b.id==='golden')  st.x3   = true;
  }
}

function lvData(lv) { return LEVELS[Math.min(lv,LEVELS.length)-1]; }
function xpNeeded(lv) { return lvData(lv)?.xpNeeded ?? 9999; }

// ========================
// HUD
// ========================
function updateHUD() {
  document.getElementById('scoreDisplay').textContent = score;
  document.getElementById('hud-lives').textContent   = 'â¤ï¸'.repeat(Math.max(0,lives));
  const d = lvData(level);
  const badge = document.getElementById('hud-level-badge');
  badge.textContent    = `Lv.${level} ${d.title}`;
  badge.style.background = d.color;
  badge.style.color = level >= 8 ? '#3D2B1F' : '#3D2B1F';

  const pct = Math.min(100, xp / xpNeeded(level) * 100);
  document.getElementById('xp-bar').style.width = pct+'%';
  document.getElementById('xp-label').textContent = `${xp} / ${xpNeeded(level)} XP to next level`;

  const row = document.getElementById('buffs-row');
  row.innerHTML='';
  for (const b of activeBuffs) {
    const chip = document.createElement('div');
    chip.className='buff-chip';
    const left = b.endsAt===Infinity ? 'âˆ' : Math.max(0,Math.ceil((b.endsAt-frame)/60))+'s';
    chip.innerHTML = `${b.emoji} ${b.shortName} <span class="bt">${left}</span>`;
    row.appendChild(chip);
  }

  const msgs=['Catch hearts, avoid âœ–ï¸!','Keep going, Bao! ğŸ’•','Amazing streak! ğŸ”¥','Heart wizard! ğŸŒ¸','LEGENDARY! ğŸŒŸ'];
  document.getElementById('game-msg').textContent = msgs[Math.min(Math.floor(score/12),msgs.length-1)];
}

function updateStatsPanel() {
  document.getElementById('stat-hs').textContent = P.highScore;
  document.getElementById('stat-lv').textContent = P.highLevel;
  document.getElementById('stat-hc').textContent = P.totalHearts;
  document.getElementById('stat-gp').textContent = P.gamesPlayed;
  document.getElementById('stat-st').textContent = P.bestStreak;
  document.getElementById('stat-bp').textContent = P.buffsPickedTotal;
  renderUnlocks();
}

function renderUnlocks() {
  const list = document.getElementById('unlocks-list');
  list.innerHTML='';
  LEVELS.forEach(l => {
    const achieved = P.achievedLevels.includes(l.level);
    const div = document.createElement('div');
    div.className='unlock-item'+(achieved?' achieved':'');
    div.innerHTML=`
      <span class="unlock-icon" style="color:${l.color}">${achieved?'ğŸ”“':'ğŸ”’'}</span>
      <div>
        <div class="unlock-name">Level ${l.level} â€” ${l.title}</div>
        <div class="unlock-desc">${achieved?l.desc:`Reach ${l.level>1?`level ${l.level}`:'level 1'} to unlock`}</div>
      </div>`;
    list.appendChild(div);
  });
}

// ========================
// SPAWN
// ========================
function spawnItem() {
  const isBad = Math.random() < (0.13 + level * 0.018);
  const spd   = (1.7 + Math.random()*1.7 + level*0.18) * st.sm;
  items.push({
    x: 22 + Math.random()*(W-44),
    y: -24,
    vy: isBad && st.freezeBad ? 0.35 : spd,
    emoji: isBad ? BAD_EMO[Math.floor(Math.random()*BAD_EMO.length)] : HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)],
    bad: isBad, size:22, frozen: isBad&&st.freezeBad
  });
}

// ========================
// GAME LOOP
// ========================
function gameLoop() {
  if (!running) return;
  frame++;
  computeState();

  const rate = Math.max(22, 65 - level*4);
  if (frame % rate === 0) {
    spawnItem();
    if (level >= 4 && Math.random()<0.4) spawnItem();
    if (level >= 7 && Math.random()<0.3) spawnItem();
  }

  // Background
  ctx.clearRect(0,0,W,H);
  if (level >= 5) drawStars();

  const bw = BASE_W * st.bw;
  const bx = basket.x - bw/2, by = H - BH - 10;

  // Basket glow
  if (activeBuffs.length > 0 || level >= 7) {
    ctx.save();
    ctx.shadowBlur = 20;
    ctx.shadowColor = lvData(level).color;
    ctx.fillStyle = 'rgba(0,0,0,0)';
    ctx.beginPath();
    ctx.roundRect(bx-1,by-1,bw+2,BH+2,9);
    ctx.fill();
    ctx.restore();
  }

  // Rainbow basket at level 7+
  if (level >= 7) {
    const grad = ctx.createLinearGradient(bx,0,bx+bw,0);
    grad.addColorStop(0,'#FF9ECD');
    grad.addColorStop(0.5,'#FFD700');
    grad.addColorStop(1,'#6FCCAA');
    ctx.fillStyle = grad;
  } else {
    ctx.fillStyle = lvData(level).color;
  }
  ctx.beginPath();
  ctx.roundRect(bx, by, bw, BH, 8);
  ctx.fill();
  ctx.fillStyle = '#3D2B1F';
  ctx.font = 'bold 11px serif';
  ctx.textAlign = 'center';
  ctx.fillText('Bao ğŸ§º', basket.x, by+14);

  // Items
  for (let i=items.length-1;i>=0;i--) {
    const it=items[i];
    if (!it.frozen) it.y += it.vy;
    if (st.magnet && !it.bad) it.x += (basket.x - it.x)*0.032;

    ctx.save();
    ctx.globalAlpha=0.12;
    ctx.font=it.size+'px serif'; ctx.textAlign='center';
    ctx.fillText(it.emoji,it.x+2,it.y+3);
    ctx.globalAlpha=1;
    ctx.fillText(it.emoji,it.x,it.y);
    ctx.restore();

    // Catch
    if (it.y>=by-4 && it.y<=by+BH+14 && it.x>=bx-8 && it.x<=bx+bw+8) {
      if (it.bad) {
        if (st.shield) {
          activeBuffs = activeBuffs.filter(b=>b.id!=='shield');
          showPopup('ğŸ›¡ï¸ Blocked!',it.x,it.y,'#6FAACC');
        } else {
          lives--; streak=0;
          showPopup('ğŸ’¢ Ouch!',it.x,it.y,'#E8736A');
          if (lives<=0) { endGame(); return; }
        }
      } else {
        const pts = st.x3?3:st.x2?2:1;
        score+=pts; streak++; sessionHearts++; P.totalHearts++;
        if (streak>P.bestStreak) P.bestStreak=streak;
        const xpGain = Math.round((pts+(streak>=5?1:0))*(st.xpM));
        xp+=xpGain;
        showPopup(pts>1?`+${pts} ğŸ’•`:'ğŸ’•',it.x,it.y,lvData(level).color);
        checkLevelUp();
      }
      updateHUD();
      items.splice(i,1);
      continue;
    }
    if (it.y>H+30) {
      if (!it.bad) { lives--; streak=0; if(lives<=0){endGame();return;} updateHUD(); }
      items.splice(i,1);
    }
  }

  drawPopups();
  requestAnimationFrame(gameLoop);
}

// Stars bg
let starCache = null;
function drawStars() {
  if (!starCache || starCache.length === 0) {
    starCache = Array.from({length:30},()=>({x:Math.random()*100,y:Math.random()*100,r:Math.random()*1.4+0.3}));
  }
  ctx.save();
  ctx.fillStyle='rgba(255,255,255,0.35)';
  for (const s of starCache) {
    ctx.beginPath();
    ctx.arc(s.x/100*W, s.y/100*H, s.r, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.restore();
}

// ========================
// POPUPS
// ========================
function showPopup(text,x,y,color='#F4A56A') {
  popups.push({text,x,y,color,age:0});
}
function drawPopups() {
  for (let i=popups.length-1;i>=0;i--) {
    const p=popups[i]; p.age++; p.y-=1.3;
    ctx.save();
    ctx.globalAlpha=Math.max(0,1-p.age/38);
    ctx.font='bold 13px serif'; ctx.fillStyle=p.color; ctx.textAlign='center';
    ctx.fillText(p.text,p.x,p.y);
    ctx.restore();
    if(p.age>38) popups.splice(i,1);
  }
}

// ========================
// LEVEL UP
// ========================
function checkLevelUp() {
  if (level>=LEVELS.length) return;
  if (xp >= xpNeeded(level)) {
    xp -= xpNeeded(level);
    level++;
    if (!P.achievedLevels.includes(level)) P.achievedLevels.push(level);
    if (level>P.highLevel) P.highLevel=level;
    saveP();
    running=false;
    showLevelUpScreen();
  }
}

function showLevelUpScreen() {
  const pool = (LV_POOLS[level]||['wide','slow','shield'])
    .map(id=>BUFFS.find(b=>b.id===id)).filter(Boolean).slice(0,3);
  const d = lvData(level);

  overlay.classList.remove('hidden');
  overlay.innerHTML=`
    <h2>âœ¨ Level Up!</h2>
    <p style="color:${d.color};font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700;font-style:normal;margin-bottom:.2rem">
      Lv.${level} â€” ${d.title}
    </p>
    <p style="font-size:.75rem;margin-bottom:.6rem">${d.desc}</p>
    <p>Pick a buff, Bao! ğŸ€</p>
    <div id="buff-picker">
      ${pool.map(b=>`<button class="buff-option" data-id="${b.id}"><strong>${b.name}</strong>${b.desc}</button>`).join('')}
    </div>`;

  document.querySelectorAll('.buff-option').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.dataset.id;
      const cat = BUFFS.find(b=>b.id===id);
      if(!cat) return;
      P.buffsPickedTotal++;
      activeBuffs.push({
        id, emoji: cat.name.split(' ')[0],
        shortName: cat.name.split(' ').slice(1).join(' '),
        endsAt: cat.dur===Infinity ? Infinity : frame + cat.dur*60
      });
      overlay.classList.add('hidden');
      running=true;
      updateHUD();
      gameLoop();
    });
  });
}

// ========================
// END GAME
// ========================
function endGame() {
  running=false;
  P.gamesPlayed++;
  if(score>P.highScore) P.highScore=score;
  saveP(); updateStatsPanel();

  const d = lvData(level);
  const medal = score>=60?'ğŸ… ':score>=35?'ğŸ¥ˆ ':score>=18?'ğŸ¥‰ ':'ğŸ’• ';
  overlay.classList.remove('hidden');
  overlay.innerHTML=`
    <h2>${score>=40?'ğŸŒŸ Incredible!':score>=20?'ğŸ’• Well done!':'ğŸ§¡ Good try!'}</h2>
    <p>Reached <strong style="color:${d.color}">Lv.${level} ${d.title}</strong><br>
    ${medal}Score: <strong>${score}</strong> &nbsp;Â·&nbsp; Best: ${P.highScore}<br>
    Hearts: ${sessionHearts} &nbsp;Â·&nbsp; Streak: ${streak}</p>
    <p style="font-size:.73rem;opacity:.7;margin-bottom:.8rem">${
      score>=40?'You\'re as legendary as your love, Bao ğŸ’›':
      score>=20?'Keep collecting those nomnoms! ğŸœ':
      'Practice makes perfect, sweet Bao ğŸŒ¸'}</p>
    <button class="game-btn" id="restart-btn">Play Again ğŸ’•</button>`;
  document.getElementById('restart-btn').addEventListener('click', startGame);
}

// ========================
// RESET / START
// ========================
function resetGame() {
  items=[]; popups=[]; activeBuffs=[];
  score=0; lives=3; xp=0; level=1; frame=0;
  streak=0; sessionHearts=0;
  starCache=null;
  basket.x = W/2;
  updateHUD();
}

function startGame() {
  resetGame();
  overlay.classList.add('hidden');
  running=true;
  gameLoop();
}

document.getElementById('start-btn').addEventListener('click', startGame);

// ========================
// CONTROLS
// ========================
function moveBasket(clientX) {
  const rect = canvas.getBoundingClientRect();
  const bw = BASE_W * (st.bw||1);
  let x = (clientX-rect.left)*(W/rect.width);
  basket.x = Math.max(bw/2, Math.min(W-bw/2, x));
}
canvas.addEventListener('mousemove', e=>{ if(running) moveBasket(e.clientX); });
canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(running) moveBasket(e.touches[0].clientX); },{passive:false});
canvas.addEventListener('touchstart',e=>{ if(running) moveBasket(e.touches[0].clientX); },{passive:true});

// ========================
// LANDING
// ========================
document.getElementById('envBtn').addEventListener('click', ()=>{
  document.getElementById('landing').classList.add('gone');
  document.getElementById('main').classList.add('visible');
  spawnHeartsBg();
  updateStatsPanel();
});

function spawnHeartsBg() {
  const bg = document.getElementById('heartsBg');
  const emojis=['ğŸ§¡','ğŸ’›','ğŸŒ¸','ğŸ’•','âœ¨'];
  for(let i=0;i<18;i++){
    const h=document.createElement('div');
    h.className='heart-float';
    h.textContent=emojis[Math.floor(Math.random()*emojis.length)];
    h.style.left=Math.random()*100+'%';
    h.style.animationDuration=(6+Math.random()*10)+'s';
    h.style.animationDelay=(Math.random()*8)+'s';
    h.style.fontSize=(0.9+Math.random()*1.2)+'rem';
    bg.appendChild(h);
  }
}
</script>
</body>
</html>
