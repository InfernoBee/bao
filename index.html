<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title id="page-title">Happy Day, Bao üß°</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Lora:ital@0;1&display=swap" rel="stylesheet">
<style>
:root{--cream:#FDF6EC;--peach:#F4A56A;--rose:#E8736A;--deep:#3D2B1F;--gold:#D4A853;--soft:#FAE8D8;--common:#9E9E9E;--uncommon:#4CAF50;--rare:#2196F3;--epic:#9C27B0;--legendary:#FF9800;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--cream);font-family:'Lora',serif;color:var(--deep);min-height:100vh;overflow-x:hidden;}

/* LANDING */
#landing{position:fixed;inset:0;background:var(--deep);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;transition:opacity .8s ease,transform .8s ease;}
#landing.gone{opacity:0;transform:translateY(-30px);pointer-events:none;}
.envelope{font-size:80px;animation:pulse 1.5s ease-in-out infinite;cursor:pointer;user-select:none;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1) rotate(-3deg)}}
.tap-text{color:var(--peach);font-family:'Playfair Display',serif;font-style:italic;font-size:1.1rem;margin-top:1.5rem;opacity:.8;animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:.8}50%{opacity:.3}}

/* MAIN */
#main{opacity:0;transition:opacity 1s ease .3s;pointer-events:none;}
#main.visible{opacity:1;pointer-events:all;}
.hearts-bg{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:0;}
.heart-float{position:absolute;bottom:-60px;font-size:1.2rem;opacity:.15;animation:floatUp linear infinite;}
@keyframes floatUp{0%{transform:translateY(0) rotate(0deg);opacity:.15}100%{transform:translateY(-110vh) rotate(20deg);opacity:0}}

/* HEADER */
.header{position:relative;z-index:1;text-align:center;padding:3.5rem 1.5rem 2rem;}
.day-label{font-family:'Playfair Display',serif;font-size:clamp(.75rem,3vw,.9rem);letter-spacing:.35em;color:var(--gold);text-transform:uppercase;margin-bottom:.5rem;}
.main-title{font-family:'Playfair Display',serif;font-size:clamp(2.4rem,9vw,4.5rem);line-height:1.1;color:var(--rose);text-shadow:2px 3px 0 rgba(61,43,31,.08);}
.main-title span{font-style:italic;color:var(--peach);}
.subtitle{font-style:italic;margin-top:1rem;font-size:1rem;color:var(--deep);opacity:.7;}

/* NOTE */
.note-card{position:relative;z-index:1;background:white;border-radius:20px;margin:0 1.2rem 2rem;padding:1.8rem 1.6rem;box-shadow:0 8px 30px rgba(61,43,31,.1),0 2px 0 var(--gold) inset;border-top:4px solid var(--peach);}
.note-card p{font-size:.97rem;line-height:1.8;color:var(--deep);}
.note-card p+p{margin-top:1rem;}
.signature{margin-top:1.2rem;font-family:'Playfair Display',serif;font-style:italic;font-size:1.2rem;color:var(--rose);text-align:right;}

.section-label{position:relative;z-index:1;text-align:center;font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--deep);padding:0 1.5rem .5rem;}
.section-label small{display:block;font-family:'Lora',serif;font-style:italic;font-size:.85rem;color:var(--gold);margin-top:.2rem;}

/* CHARACTER SELECT */
.char-select{position:relative;z-index:1;margin:0 1.2rem 1rem;}
.char-select h4{font-family:'Playfair Display',serif;font-size:.9rem;color:var(--deep);text-align:center;margin-bottom:.7rem;opacity:.8;}
.char-cards{display:flex;gap:10px;}
.char-card{flex:1;border-radius:16px;padding:.9rem .6rem .7rem;cursor:pointer;border:2.5px solid transparent;text-align:center;transition:border-color .2s,transform .15s,box-shadow .2s;background:white;box-shadow:0 3px 12px rgba(61,43,31,.07);}
.char-card:active{transform:scale(.97);}
.char-card.active{border-color:var(--peach);box-shadow:0 4px 16px rgba(244,165,106,.35);}
.char-avatar{font-size:2.2rem;margin-bottom:.3rem;}
.char-avatar img{width:44px;height:44px;object-fit:contain;border-radius:50%;}
.char-name{font-family:'Playfair Display',serif;font-size:.88rem;color:var(--deep);}
.char-passive{font-size:.65rem;color:var(--deep);opacity:.6;font-style:italic;margin-top:2px;line-height:1.4;}
.passive-badge{display:inline-block;font-size:.6rem;border-radius:6px;padding:1px 5px;margin-bottom:3px;font-weight:700;letter-spacing:.03em;}
.pb-bao{background:#F4A56A;color:white;}
.pb-dudu{background:#9C27B0;color:white;}
.pb-bubu{background:linear-gradient(135deg,#E91E8C,#FF6BA8);color:white;}
.char-card.locked{position:relative;}
.char-lock-badge{position:absolute;top:5px;right:5px;font-size:.6rem;background:rgba(0,0,0,.5);color:#FFD700;border-radius:6px;padding:1px 5px;}

/* TABS */
.tabs{position:relative;z-index:1;display:flex;flex-wrap:wrap;margin:0 1.2rem .8rem;gap:6px;}
.tab-btn{flex:1;padding:.5rem .2rem;border:none;border-radius:12px;font-family:'Playfair Display',serif;font-size:.82rem;cursor:pointer;background:rgba(61,43,31,.08);color:var(--deep);transition:background .2s,color .2s;}
.tab-btn.active{background:var(--deep);color:var(--cream);}

/* GAME WRAP */
#game-wrap{position:relative;z-index:1;margin:0 1.2rem 2rem;background:var(--deep);border-radius:24px;overflow:hidden;padding:1.1rem 1.1rem 1.4rem;box-shadow:0 10px 40px rgba(61,43,31,.2);}

/* HUD */
#hud-top{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-bottom:.5rem;gap:4px;}
.hud-score{color:var(--cream);font-size:.72rem;}
.hud-score .val{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--peach);display:block;}
.hud-coins{color:var(--cream);font-size:.72rem;text-align:right;}
.hud-coins .val{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--gold);display:block;}
#hud-level-badge{text-align:center;background:var(--gold);color:var(--deep);border-radius:20px;padding:.18rem .65rem;font-family:'Playfair Display',serif;font-size:.72rem;font-weight:700;white-space:nowrap;}
#hud-passive-chip{text-align:center;font-size:.6rem;color:var(--cream);opacity:.7;margin-bottom:.3rem;font-style:italic;}

/* bars */
#stat-bars{display:flex;gap:6px;margin-bottom:.4rem;}
.mini-bar-wrap{flex:1;}
.mini-bar-label{font-size:.55rem;color:rgba(253,246,236,.5);margin-bottom:2px;text-transform:uppercase;letter-spacing:.05em;}
.mini-bar-bg{background:rgba(255,255,255,.08);border-radius:4px;height:5px;overflow:hidden;}
.mini-bar{height:100%;border-radius:4px;transition:width .4s ease;}
.bar-xp{background:linear-gradient(90deg,var(--peach),var(--gold));}
.bar-hp{background:linear-gradient(90deg,#E8736A,#FF9ECD);}
.bar-passive{background:linear-gradient(90deg,#9C27B0,#CE93D8);}

#buffs-row{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:.5rem;min-height:18px;}
.buff-chip{border-radius:20px;padding:2px 7px;font-size:.62rem;display:flex;align-items:center;gap:3px;border:1px solid;}
.buff-chip .bt{font-size:.55rem;opacity:.7;}
.rarity-common{background:rgba(158,158,158,.15);border-color:var(--common);color:#ccc;}
.rarity-uncommon{background:rgba(76,175,80,.12);border-color:var(--uncommon);color:#a5d6a7;}
.rarity-rare{background:rgba(33,150,243,.12);border-color:var(--rare);color:#90caf9;}
.rarity-epic{background:rgba(156,39,176,.15);border-color:var(--epic);color:#ce93d8;}
.rarity-legendary{background:rgba(255,152,0,.15);border-color:var(--legendary);color:#ffcc80;}

#canvas-wrap{position:relative;width:100%;background:rgba(255,255,255,.04);border-radius:16px;overflow:hidden;touch-action:none;}
#gameCanvas{display:block;width:100%;border-radius:16px;}
#game-msg{text-align:center;color:var(--cream);font-family:'Playfair Display',serif;font-style:italic;font-size:.8rem;margin-top:.6rem;opacity:.7;min-height:1.2em;}

/* OVERLAY */
#overlay{position:absolute;inset:0;background:rgba(61,43,31,.93);display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:16px;text-align:center;padding:1.2rem 1rem;overflow-y:auto;}
#overlay h2{font-family:'Playfair Display',serif;color:var(--peach);font-size:1.4rem;margin-bottom:.35rem;}
#overlay p{color:var(--cream);font-style:italic;margin-bottom:.45rem;font-size:.83rem;line-height:1.6;}
#overlay.hidden{display:none;}

/* BUFF PICKER */
#buff-picker{display:flex;flex-direction:column;gap:6px;width:100%;margin:.4rem 0 .2rem;}
.buff-option{border-radius:12px;padding:.5rem .8rem;color:var(--cream);cursor:pointer;text-align:left;transition:filter .15s;font-family:'Lora',serif;font-size:.76rem;border:1.5px solid;}
.buff-option:active{filter:brightness(1.2);}
.buff-option strong{display:block;font-family:'Playfair Display',serif;font-size:.88rem;margin-bottom:2px;}
.buff-option .rarity-tag{font-size:.6rem;border-radius:6px;padding:1px 5px;margin-right:4px;font-family:'Lora',serif;font-style:normal;font-weight:700;letter-spacing:.04em;vertical-align:middle;}
.bo-common{background:rgba(158,158,158,.1);border-color:var(--common);}
.bo-uncommon{background:rgba(76,175,80,.1);border-color:var(--uncommon);}
.bo-rare{background:rgba(33,150,243,.1);border-color:var(--rare);}
.bo-epic{background:rgba(156,39,176,.12);border-color:var(--epic);}
.bo-legendary{background:rgba(255,152,0,.12);border-color:var(--legendary);}
.bo-common strong{color:var(--common);}
.bo-uncommon strong{color:var(--uncommon);}
.bo-rare strong{color:var(--rare);}
.bo-epic strong{color:var(--epic);}
.bo-legendary strong{color:var(--legendary);}
.rt-common{background:var(--common);color:#fff;}
.rt-uncommon{background:var(--uncommon);color:#fff;}
.rt-rare{background:var(--rare);color:#fff;}
.rt-epic{background:var(--epic);color:#fff;}
.rt-legendary{background:var(--legendary);color:#fff;}

/* PANELS */
.panel{position:relative;z-index:1;margin:0 1.2rem 2rem;background:white;border-radius:20px;padding:1.3rem;box-shadow:0 6px 24px rgba(61,43,31,.08);}
.hidden{display:none !important;}
.panel.hidden{display:none;}
.panel h3{font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--deep);margin-bottom:.85rem;}
.stat-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.45rem;font-size:.82rem;}
.stat-label{color:var(--deep);opacity:.6;}
.stat-val{font-family:'Playfair Display',serif;color:var(--rose);font-size:.9rem;}
.prog-section{margin-top:.9rem;border-top:1px solid var(--soft);padding-top:.9rem;}
.prog-section h4{font-family:'Playfair Display',serif;font-size:.9rem;color:var(--deep);opacity:.7;margin-bottom:.6rem;}
.prog-row{margin-bottom:.7rem;}
.prog-label{display:flex;justify-content:space-between;font-size:.75rem;color:var(--deep);opacity:.7;margin-bottom:3px;}
.prog-bg{background:var(--soft);border-radius:8px;height:9px;overflow:hidden;}
.prog-fill{height:100%;border-radius:8px;transition:width .5s ease;}
.unlocks-section{margin-top:.9rem;border-top:1px solid var(--soft);padding-top:.9rem;}
.unlocks-section h4{font-family:'Playfair Display',serif;font-size:.9rem;color:var(--deep);opacity:.7;margin-bottom:.6rem;}
.unlock-item{display:flex;align-items:flex-start;gap:8px;margin-bottom:.45rem;font-size:.78rem;opacity:.28;transition:opacity .3s;}
.unlock-item.achieved{opacity:1;}
.unlock-icon{font-size:.95rem;margin-top:1px;}
.unlock-name{font-family:'Playfair Display',serif;color:var(--deep);}
.unlock-desc{font-size:.7rem;color:var(--deep);opacity:.6;font-style:italic;}

/* SHOP */
.shop-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.85rem;}
.shop-header h3{margin-bottom:0;}
.wallet{font-family:'Playfair Display',serif;font-size:1rem;color:var(--gold);}
.shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.shop-item{border-radius:14px;padding:.7rem;cursor:pointer;border:1.5px solid;transition:filter .15s,transform .1s;text-align:left;}
.shop-item:active{filter:brightness(1.15);transform:scale(.98);}
.shop-item.owned{opacity:.5;cursor:default;}
.shop-item.cant-afford{opacity:.45;cursor:default;}
.shop-item-icon{font-size:1.4rem;margin-bottom:4px;}
.shop-item-name{font-family:'Playfair Display',serif;font-size:.82rem;margin-bottom:2px;}
.shop-item-desc{font-size:.68rem;opacity:.7;font-style:italic;margin-bottom:4px;}
.shop-item-price{font-family:'Playfair Display',serif;font-size:.8rem;color:var(--gold);}
.shop-item-owned{font-size:.7rem;color:#4CAF50;font-style:italic;}
.si-common{background:rgba(158,158,158,.06);border-color:var(--common);}
.si-uncommon{background:rgba(76,175,80,.06);border-color:var(--uncommon);}
.si-rare{background:rgba(33,150,243,.06);border-color:var(--rare);}
.si-epic{background:rgba(156,39,176,.08);border-color:var(--epic);}
.si-legendary{background:rgba(255,152,0,.08);border-color:var(--legendary);}
.si-common .shop-item-name{color:var(--common);}
.si-uncommon .shop-item-name{color:var(--uncommon);}
.si-rare .shop-item-name{color:var(--rare);}
.si-epic .shop-item-name{color:var(--epic);}
.si-legendary .shop-item-name{color:var(--legendary);}

.game-btn{display:block;margin:.75rem auto 0;background:var(--peach);color:var(--deep);border:none;border-radius:30px;padding:.55rem 1.7rem;font-family:'Playfair Display',serif;font-size:.92rem;cursor:pointer;font-style:italic;box-shadow:0 4px 0 rgba(0,0,0,.2);transition:transform .1s;}
.game-btn:active{transform:scale(.97);}
footer{position:relative;z-index:1;text-align:center;padding:0 1rem 3rem;font-size:1.6rem;color:var(--rose);letter-spacing:4px;}


/* ===== CONNECT 4 RPG ===== */
.c4-section{position:relative;z-index:1;margin:0 1.2rem 2rem;}
.c4-label{text-align:center;font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--deep);padding:0 1.5rem .5rem;margin-bottom:1rem;}
.c4-label small{display:block;font-family:'Lora',serif;font-style:italic;font-size:.85rem;color:var(--gold);margin-top:.2rem;}
#c4-wrap{background:var(--deep);border-radius:24px;padding:1.2rem;box-shadow:0 10px 40px rgba(61,43,31,.25);}

/* Difficulty row */
/* Level progress bar for Connect Bao */
#c4-level-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;gap:8px;}
#c4-level-label{font-family:'Playfair Display',serif;color:var(--gold);font-size:.75rem;white-space:nowrap;}
#c4-level-bar-wrap{flex:1;background:rgba(255,255,255,.1);border-radius:6px;height:6px;}
#c4-level-bar{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--peach),var(--gold));transition:width .5s ease;}

/* Battle HUD */
#c4-hud{display:grid;grid-template-columns:1fr auto 1fr;gap:6px;align-items:center;margin-bottom:.7rem;}
.c4-fighter{background:rgba(255,255,255,.05);border-radius:14px;padding:.5rem .7rem;text-align:center;}
.c4-fighter-name{font-family:'Playfair Display',serif;font-size:.72rem;color:var(--peach);margin-bottom:3px;}
.c4-hp-wrap{background:rgba(255,255,255,.1);border-radius:4px;height:7px;overflow:hidden;margin-bottom:3px;}
.c4-hp-bar{height:100%;border-radius:4px;transition:width .4s ease;}
.c4-hp-text{font-size:.6rem;color:rgba(253,246,236,.5);}
.c4-fighter.enemy .c4-fighter-name{color:#FF9999;}
.c4-vs{font-family:'Playfair Display',serif;color:var(--gold);font-size:.9rem;text-align:center;}

/* Round / streak counter */
#c4-round-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;font-size:.65rem;color:rgba(253,246,236,.55);font-family:'Playfair Display',serif;}

/* Status */
#c4-status{min-height:2.5rem;text-align:center;margin-bottom:.5rem;}
#c4-status-main{font-family:'Playfair Display',serif;font-size:.88rem;color:var(--cream);line-height:1.4;}
#c4-status-sub{font-size:.65rem;color:rgba(253,246,236,.5);font-style:italic;margin-top:2px;}

/* Board */
#c4-board-area{position:relative;margin-bottom:.6rem;}
#c4-board{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;background:rgba(33,150,243,.18);border-radius:14px;padding:6px;border:2px solid rgba(33,150,243,.3);}
.c4-cell{aspect-ratio:1;border-radius:50%;background:rgba(0,0,0,.35);border:2px solid rgba(255,255,255,.06);transition:background .2s,box-shadow .2s;cursor:pointer;position:relative;overflow:hidden;}
.c4-cell.hover-col{background:rgba(255,255,255,.1);}
.c4-cell.player{background:var(--peach);border-color:var(--gold);box-shadow:0 0 8px rgba(244,165,106,.5);}
.c4-cell.enemy{background:#E8736A;border-color:#C0392B;box-shadow:0 0 8px rgba(232,115,106,.45);}
.c4-cell.win-cell{animation:c4win .5s ease-in-out 4;box-shadow:0 0 18px var(--gold);}
@keyframes c4win{0%,100%{transform:scale(1)}50%{transform:scale(1.15);}}
.c4-cell.drop-anim{animation:c4drop .25s ease-out;}
@keyframes c4drop{0%{transform:scaleY(0.3);opacity:.4}100%{transform:scaleY(1);opacity:1}}

/* Column drop arrows */
#c4-col-btns{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:3px;}
.c4-col-btn{text-align:center;font-size:.8rem;cursor:pointer;color:rgba(253,246,236,.3);transition:color .15s,transform .1s;user-select:none;padding:2px 0;}
.c4-col-btn:hover{color:var(--peach);transform:translateY(-2px);}
.c4-col-btn.disabled{pointer-events:none;opacity:.15;}

/* Skills */
#c4-skills{display:flex;gap:6px;margin-bottom:.7rem;}
.c4-skill-btn{flex:1;border:none;border-radius:12px;padding:.42rem .3rem;cursor:pointer;font-family:'Playfair Display',serif;font-size:.68rem;transition:filter .15s,transform .1s;position:relative;}
.c4-skill-btn:active:not(:disabled){transform:scale(.96);}
.c4-skill-btn:disabled{opacity:.35;cursor:default;}
.c4-skill-btn .sk-name{display:block;font-size:.7rem;}
.c4-skill-btn .sk-cd{position:absolute;top:3px;right:5px;font-size:.5rem;color:rgba(255,255,255,.6);}
.c4-skill-btn .sk-desc{display:block;font-size:.54rem;opacity:.72;font-family:'Lora',serif;font-style:italic;margin-top:1px;}
.sk-c4-attack{background:linear-gradient(135deg,#E8736A,#C0392B);color:white;}
.sk-c4-defend{background:linear-gradient(135deg,#2196F3,#1565C0);color:white;}
.sk-c4-special{background:linear-gradient(135deg,#9C27B0,#6A1B9A);color:white;}

/* Active buffs */
#c4-buffs{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:.5rem;min-height:16px;}
.c4-buff-chip{border-radius:20px;padding:2px 7px;font-size:.58rem;display:flex;align-items:center;gap:2px;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.7);background:rgba(255,255,255,.07);}

/* Enemy intent */
.c4-intent{font-size:.66rem;color:#FF9999;font-style:italic;text-align:center;margin-bottom:.45rem;min-height:1.1em;}

/* Result overlay */
#c4-overlay{display:none;position:absolute;inset:0;background:rgba(61,43,31,.96);border-radius:12px;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:1.2rem 1rem;z-index:10;}
#c4-overlay.show{display:flex;}
#c4-overlay h3{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--peach);margin-bottom:.4rem;}
#c4-overlay p{font-size:.8rem;color:var(--cream);font-style:italic;line-height:1.6;margin-bottom:.4rem;}
.c4-streak-text{font-family:'Playfair Display',serif;color:var(--gold);font-size:.9rem;}

/* Thinking shimmer */
.c4-cell.thinking{animation:c4think .8s ease-in-out infinite;}
@keyframes c4think{0%,100%{background:rgba(0,0,0,.35)}50%{background:rgba(255,107,107,.12)}}
/* SHARE MODAL */
#share-modal{position:fixed;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;background:rgba(61,43,31,.75);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .2s ease;}
#share-modal.show{opacity:1;pointer-events:all;}
#share-card-wrap{background:white;border-radius:24px;padding:1.4rem 1.2rem 1.1rem;max-width:92vw;width:360px;box-shadow:0 24px 80px rgba(61,43,31,.45);transform:scale(.9);transition:transform .25s cubic-bezier(.17,.67,.4,1.3);}
#share-modal.show #share-card-wrap{transform:scale(1);}
#share-preview{width:100%;border-radius:14px;display:block;margin-bottom:.85rem;}
.share-btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.share-btn{flex:1;min-width:100px;border:none;border-radius:14px;padding:.5rem .8rem;font-family:'Playfair Display',serif;font-size:.82rem;cursor:pointer;font-style:italic;transition:transform .1s,filter .1s;}
.share-btn:active{transform:scale(.96);}
.share-btn.copy-btn{background:var(--soft);color:var(--deep);}
.share-btn.dl-btn{background:var(--peach);color:var(--deep);}
.share-btn.close-btn{background:var(--deep);color:var(--cream);}

/* ===== SLOT MACHINE ===== */
.gacha-machine{display:block;text-align:center;margin:.4rem 0;user-select:none;transition:transform .12s;}
.gacha-machine:active{transform:scale(.93);}
@keyframes machinePulse{0%,100%{filter:drop-shadow(0 4px 18px rgba(255,165,0,0.45))}50%{filter:drop-shadow(0 4px 28px rgba(255,165,0,0.9)) drop-shadow(0 0 20px rgba(255,215,0,0.6))}}
.gacha-machine.spinning #slot-machine-svg{animation:machinePulse .5s ease-in-out 2;}
@keyframes leverPull{0%{transform:translateY(0)}35%{transform:translateY(20px)}65%{transform:translateY(20px)}100%{transform:translateY(0)}}
@keyframes lightBlink{0%,100%{opacity:0.9}50%{opacity:0.15}}
.machine-light{animation:lightBlink 0.8s ease-in-out infinite;}
.machine-light:nth-child(1){animation-delay:0s;}
.machine-light:nth-child(2){animation-delay:0.27s;}
.machine-light:nth-child(3){animation-delay:0.54s;}
.gacha-machine.spinning #lever-knob,.gacha-machine.spinning #big-lever-knob{animation:leverPull .55s ease-in-out;}
/* ===== GACHA PULL OVERLAY ===== */
#gacha-anim-overlay{position:fixed;inset:0;z-index:9999;background:rgba(2,0,12,0.97);display:none;flex-direction:column;align-items:center;justify-content:center;gap:.2rem;}
#gacha-anim-overlay.show{display:flex;}
@keyframes bigReelBlur{0%,100%{filter:blur(0);opacity:1}40%{filter:blur(3px);opacity:0.3}60%{filter:blur(3px);opacity:0.3}}
.big-reel-spinning{animation:bigReelBlur 0.15s linear infinite;}
@keyframes reelReveal{0%{transform:scale(0.2) rotate(-15deg);opacity:0}65%{transform:scale(1.2) rotate(3deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}
.big-reel-reveal{animation:reelReveal 0.45s cubic-bezier(.34,1.56,.64,1) forwards;}
@keyframes bigLightBlink{0%,100%{opacity:1}50%{opacity:0.1}}
.big-light{animation:bigLightBlink 0.45s ease-in-out infinite;}
.big-light:nth-child(1){animation-delay:0s;}
.big-light:nth-child(2){animation-delay:0.09s;}
.big-light:nth-child(3){animation-delay:0.18s;}
.big-light:nth-child(4){animation-delay:0.27s;}
.big-light:nth-child(5){animation-delay:0.36s;}
@keyframes sparkFloat{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--sx),var(--sy)) scale(0);opacity:0}}
.spark{position:absolute;width:7px;height:7px;border-radius:50%;pointer-events:none;animation:sparkFloat 0.85s ease-out forwards;}
@keyframes resultCardPop{0%{transform:scale(0.15) rotate(-12deg);opacity:0}60%{transform:scale(1.18) rotate(2deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}
@keyframes reelReveal{0%{transform:scale(0.2) rotate(-15deg);opacity:0}65%{transform:scale(1.2) rotate(3deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}
#gacha-anim-result{animation:resultCardPop .52s cubic-bezier(.34,1.56,.64,1) forwards;padding:.65rem 1.3rem;border-radius:16px;font-family:'Playfair Display',serif;text-align:center;margin-top:.5rem;}
@keyframes legendaryRays{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
#gacha-rays{position:absolute;width:280px;height:280px;pointer-events:none;animation:legendaryRays 5s linear infinite;opacity:0;transition:opacity .5s;z-index:-1;}
#gacha-rays.show{opacity:0.2;}
@keyframes overlayPulse{0%,100%{background:rgba(2,0,12,0.97)}50%{background:rgba(20,5,40,0.98)}}
#gacha-anim-overlay.pulsing{animation:overlayPulse 0.35s ease 4;}
.gacha-anim-label{font-family:'Playfair Display',serif;font-size:.95rem;color:#a78bfa;letter-spacing:.1em;opacity:.8;min-height:1.4em;text-align:center;}
.gacha-pull-btns{display:flex;gap:8px;margin:.7rem 0;}
.gpb{flex:1;border:none;border-radius:14px;padding:.55rem .4rem;font-family:'Playfair Display',serif;font-size:.8rem;cursor:pointer;font-style:italic;transition:transform .1s,filter .1s;}
.gpb:active{transform:scale(.96);}
.gpb.single{background:linear-gradient(135deg,#7B68EE,#CE93D8);color:#fff;}
.gpb.ten{background:linear-gradient(135deg,#4422aa,#7B68EE);color:#fff;}
.gpb:disabled{filter:grayscale(.7);opacity:.55;cursor:not-allowed;}
.gacha-pity{font-size:.65rem;color:rgba(244,195,130,.5);margin-bottom:.6rem;}
.gacha-result{min-height:54px;margin:.5rem 0;}
.gr-item{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .9rem;border-radius:12px;font-size:.85rem;font-family:'Playfair Display',serif;animation:grPop .4s cubic-bezier(.34,1.56,.64,1);}
@keyframes grPop{from{transform:scale(.4);opacity:0}to{transform:scale(1);opacity:1}}
.gr-common{background:rgba(255,255,255,.09);border:1.5px solid rgba(255,255,255,.25);color:#ddd;}
.gr-uncommon{background:rgba(100,220,100,.12);border:1.5px solid #5cb85c;color:#8de38d;}
.gr-rare{background:rgba(80,160,255,.15);border:1.5px solid #5599ff;color:#88bbff;}
.gr-epic{background:rgba(200,100,255,.18);border:1.5px solid #b44fff;color:#ce93ff;}
.gr-legendary{background:rgba(255,215,0,.18);border:1.5px solid var(--gold);color:var(--gold);}
.gacha-multi{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin:.5rem 0;}
.gacha-multi .gr-item{font-size:.7rem;padding:.3rem .6rem;}
.gacha-inv-title{font-size:.68rem;color:rgba(244,195,130,.55);margin-top:.7rem;margin-bottom:.3rem;}
.gacha-inv{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;}
.ginv-chip{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:.22rem .5rem;font-size:.7rem;color:rgba(244,195,130,.8);cursor:pointer;}
.ginv-chip.equipped{border-color:var(--gold);background:rgba(255,215,0,.15);color:var(--gold);}

/* ===== DAILY LOGIN MODAL ===== */
#daily-modal{position:fixed;inset:0;background:rgba(20,8,4,.85);z-index:201;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .35s;}
#daily-modal.show{opacity:1;pointer-events:all;}
#daily-modal .dm-inner{background:linear-gradient(160deg,#2a1200,#1a0800);border:2px solid var(--gold);border-radius:24px;padding:1.5rem 1.3rem;max-width:320px;width:90%;text-align:center;}
.dm-title{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--gold);margin-bottom:.2rem;}
.dm-sub{font-size:.72rem;color:rgba(244,195,130,.6);margin-bottom:1rem;}
.dm-streak-num{font-family:'Playfair Display',serif;font-size:2.6rem;color:var(--gold);line-height:1;}
.dm-streak-label{font-size:.68rem;color:rgba(244,195,130,.55);margin-bottom:.9rem;}
.daily-dots{display:flex;justify-content:center;gap:6px;margin:.8rem 0;}
.daily-dot{width:28px;height:28px;border-radius:50%;border:2px solid rgba(244,195,130,.25);display:flex;align-items:center;justify-content:center;font-size:.8rem;background:rgba(0,0,0,.2);}
.daily-dot.done{border-color:var(--gold);background:rgba(255,215,0,.18);}
.daily-dot.today{border-color:#E8736A;background:rgba(232,115,106,.2);animation:dotPulse 1.2s ease-in-out infinite;}
@keyframes dotPulse{0%,100%{box-shadow:0 0 0 0 rgba(232,115,106,.5)}50%{box-shadow:0 0 0 5px rgba(232,115,106,0)}}
.dm-reward{background:rgba(255,215,0,.1);border:1.5px solid rgba(255,215,0,.35);border-radius:12px;padding:.6rem;margin:.7rem 0;font-size:.85rem;color:var(--gold);}
.dm-claim-btn{background:linear-gradient(135deg,#E8736A,#F4A56A);border:none;border-radius:14px;padding:.7rem 1.6rem;font-family:'Playfair Display',serif;font-size:.95rem;color:#fff;cursor:pointer;font-style:italic;}
.dm-claim-btn:active{transform:scale(.96);}

/* ===== COMBO FLASH ===== */
#combo-flash{position:fixed;top:38%;left:50%;transform:translateX(-50%) scale(0);font-family:'Playfair Display',serif;font-size:2rem;font-weight:bold;pointer-events:none;z-index:300;white-space:nowrap;text-shadow:0 2px 16px rgba(0,0,0,.7);opacity:0;transition:none;}
@keyframes comboPop{0%{transform:translateX(-50%) scale(0);opacity:0}40%{transform:translateX(-50%) scale(1.18);opacity:1}70%{transform:translateX(-50%) scale(.95);opacity:1}100%{transform:translateX(-50%) scale(1);opacity:1}}
@keyframes comboFade{from{opacity:1}to{opacity:0;transform:translateX(-50%) scale(.8) translateY(-20px)}}
#combo-flash.pop{animation:comboPop .45s cubic-bezier(.34,1.56,.64,1) forwards;}
#combo-flash.fade{animation:comboFade .35s ease forwards;}

/* ===== ACHIEVEMENT TOAST ===== */
#achieve-toast{position:fixed;top:4.5rem;left:50%;transform:translateX(-50%) translateY(-100px);background:linear-gradient(135deg,#2a1200,#1a0800);border:1.5px solid var(--gold);border-radius:14px;padding:.5rem 1rem;font-size:.78rem;color:var(--gold);z-index:250;pointer-events:none;transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .4s;opacity:0;white-space:nowrap;font-family:'Playfair Display',serif;}
#achieve-toast.show{transform:translateX(-50%) translateY(0);opacity:1;}

/* ===== GACHA SHOP BUTTON ===== */

/* ================================================================
   DESKTOP RESPONSIVE  (‚â• 700 px)
   ================================================================ */
@media(min-width:700px){
  body{display:flex;flex-direction:column;align-items:center;
    background:radial-gradient(ellipse at 55% 0%,#f8e4cc 0%,var(--cream) 60%);}
  #landing{border-radius:0;}
  #main{width:100%;max-width:660px;}
  .header{padding:4rem 2rem 2.5rem;}
  .note-card{margin:0 0 2rem;padding:2rem 2.2rem;}
  .char-select{margin:0 0 1rem;}
  .tabs{margin:0 0 .8rem;}
  #game-wrap{margin:0 0 2rem;padding:1.4rem 1.6rem 1.8rem;}
  .panel{margin:0 0 2rem;padding:1.5rem 1.7rem;}
  .c4-section{margin:0 0 2rem;}
  footer{padding:0 0 3.5rem;}
  .hud-score .val,.hud-coins .val{font-size:1.3rem;}
  #hud-level-badge{font-size:.78rem;padding:.2rem .75rem;}
  .shop-grid{grid-template-columns:repeat(3,1fr);}
  #c4-wrap{padding:1.4rem 1.6rem;}
  .c4-fighter{padding:.6rem .9rem;}
  .c4-fighter-name{font-size:.8rem;}
  .c4-hp-wrap{height:8px;}
  .c4-vs{font-size:1rem;}
  #c4-round-bar{font-size:.7rem;}
  #c4-board{gap:6px;padding:8px;border-radius:16px;}
  #c4-col-btns{gap:6px;}
  .c4-col-btn{font-size:.88rem;padding:3px 0;}
  #c4-skills{gap:8px;}
  .c4-skill-btn{padding:.5rem .35rem;font-size:.72rem;}
  .c4-skill-btn .sk-name{font-size:.76rem;}
  .c4-skill-btn .sk-desc{font-size:.58rem;}
  #c4-status-main{font-size:.92rem;}
  #c4-status-sub{font-size:.7rem;}
  .c4-intent{font-size:.72rem;}
  #c4-level-label,#c4-level-label-r{font-size:.8rem;}
  #c4-overlay h3{font-size:1.4rem;}
  #c4-overlay p{font-size:.85rem;}
}
@media(min-width:960px){
  #main{max-width:760px;}
  #c4-board{gap:8px;}
  #c4-col-btns{gap:8px;}
}

/* ‚îÄ‚îÄ SHOP CATEGORY / RARITY TABS ‚îÄ‚îÄ‚îÄ */
.shop-cat-btn,.shop-rar-btn{
  border:none;border-radius:20px;padding:.28rem .7rem;font-family:'Playfair Display',serif;
  font-size:.72rem;cursor:pointer;background:rgba(61,43,31,.09);color:var(--deep);
  transition:background .18s,color .18s;
}
.shop-cat-btn.active{background:var(--deep);color:var(--cream);}
.shop-rar-btn.active{background:var(--deep);color:var(--cream);}

/* ‚îÄ‚îÄ SHOP PAGINATION ‚îÄ‚îÄ‚îÄ */
.shop-page-btn{
  border:1.5px solid rgba(61,43,31,.18);border-radius:50%;width:28px;height:28px;
  font-family:'Playfair Display',serif;font-size:.78rem;cursor:pointer;
  background:white;color:var(--deep);transition:background .15s;
  display:inline-flex;align-items:center;justify-content:center;
}
.shop-page-btn:disabled{opacity:.3;cursor:default;}
.shop-page-btn.active{background:var(--deep);color:var(--cream);border-color:var(--deep);}
.shop-page-btn:not(.active):not(:disabled):hover{background:var(--soft);}

/* ‚îÄ‚îÄ EASTER EGG MODAL ‚îÄ‚îÄ‚îÄ */
#egg-modal{
  position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
  background:rgba(20,8,4,.88);backdrop-filter:blur(6px);
  opacity:0;pointer-events:none;transition:opacity .4s;
}
#egg-modal.show{opacity:1;pointer-events:all;}
#egg-inner{
  background:linear-gradient(160deg,#3a0a1a,#1a0508);
  border:2px solid #800020;border-radius:24px;
  padding:1.8rem 1.5rem;max-width:320px;width:90%;
  text-align:center;box-shadow:0 24px 80px rgba(128,0,32,.6);
  transform:scale(.85);transition:transform .35s cubic-bezier(.34,1.56,.64,1);
}
#egg-modal.show #egg-inner{transform:scale(1);}
#egg-emoji{font-size:3rem;margin-bottom:.5rem;}
#egg-title{font-family:'Playfair Display',serif;font-size:1.25rem;color:#CE93D8;margin-bottom:.4rem;}
#egg-msg{font-size:.83rem;color:rgba(253,246,236,.85);line-height:1.7;font-style:italic;margin-bottom:.9rem;}
#egg-close{
  background:linear-gradient(135deg,#800020,#CE93D8);border:none;border-radius:14px;
  padding:.55rem 1.4rem;font-family:'Playfair Display',serif;font-size:.9rem;
  color:#fff;cursor:pointer;font-style:italic;
}
#egg-close:active{transform:scale(.96);}
.egg-found-badge{
  position:fixed;top:1rem;right:1rem;z-index:301;
  background:linear-gradient(135deg,#800020,#CE93D8);
  border-radius:20px;padding:.3rem .8rem;font-size:.68rem;
  color:white;font-family:'Playfair Display',serif;
  opacity:0;transition:opacity .4s;pointer-events:none;
}
.egg-found-badge.show{opacity:1;}

</style>
</head>
<body>
<div id="landing">
  <div class="envelope" id="envBtn">üíå</div>
  <p class="tap-text">tap to open your message</p>
</div>

<div id="main">
  <div class="hearts-bg" id="heartsBg"></div>
  <div class="header">
    <p class="day-label" id="day-label-el">Just For You</p>
    <h1 class="main-title">Happy<br><span id="day-name-el">Day,</span><br>Bao üß°</h1>
    <p class="subtitle">a little something to brighten your day</p>
  </div>
  <div class="note-card" id="note-card">
    <p id="note-line1"></p>
    <p id="note-line2"></p>
    <p id="note-line3"></p>
    <p class="signature">‚Äî Your Dudu üíõ</p>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('game')">üíï Heart Catcher</button>
    <button class="tab-btn" onclick="showTab('blackjack')">ü•î Potato Dealer</button>
    <button class="tab-btn" onclick="showTab('c4')">üî¥ Bao Connector</button>
    <button class="tab-btn" onclick="showTab('stats')">üìä Stats</button>
  </div>

  <!-- GAME TAB -->
  <div id="tab-game" class="hidden">
  <div class="section-label">
    Catch the Hearts üíï
    <small>pick your character ¬∑ level up ¬∑ unlock tiered buffs ¬∑ shop!</small>
  </div>

  <!-- Heart Catcher Sub-tabs -->
  <div style="display:flex;gap:5px;margin:0 1.2rem .7rem;">
    <button class="tab-btn active" onclick="hcSubTab('play')" id="hc-subtab-play" style="flex:1;font-size:.78rem;">üíï Play</button>
    <button class="tab-btn" onclick="hcSubTab('shop')" id="hc-subtab-shop" style="flex:1;font-size:.78rem;">üõí Shop</button>
  </div>

  <!-- PLAY SUB-TAB -->
  <div id="hc-subtab-play-content">

  <!-- CHARACTER SELECT -->
  <div class="char-select">
    <h4>Choose your character</h4>
    <div style="position:relative;z-index:1;">
      <select id="char-dropdown" onchange="selectChar(this.value)" style="width:100%;padding:.65rem 1rem;border-radius:14px;border:2px solid var(--peach);background:white;font-family:'Playfair Display',serif;font-size:.95rem;color:var(--deep);cursor:pointer;appearance:none;-webkit-appearance:none;box-shadow:0 3px 12px rgba(61,43,31,.07);">
        <option value="bao">Bao ‚Äî Nomnom (catch 5 ü•î potatoes ‚Üí +1 life!)</option>
        <option value="dudu">Dudu ‚Äî Angry Aura (streak 5+ ‚Üí 2√ó next catch)</option>
        <option value="bubu" id="bubu-option" disabled>üîí ??? ‚Äî Mystery Character (unlock via Capsule Machine)</option>
      </select>
      <div style="pointer-events:none;position:absolute;right:1rem;top:50%;transform:translateY(-50%);font-size:.8rem;opacity:.5;">‚ñº</div>
    </div>
    <div id="char-preview-card" style="margin-top:.75rem;background:white;border-radius:16px;padding:.9rem 1.1rem;box-shadow:0 3px 12px rgba(61,43,31,.07);border:2px solid var(--peach);display:flex;align-items:center;gap:.85rem;">
      <div id="char-preview-avatar" style="flex-shrink:0;"></div>
      <div>
        <div id="char-preview-name" style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--deep);margin-bottom:.2rem;"></div>
        <div id="char-preview-passive" style="font-size:.75rem;color:var(--deep);opacity:.7;font-style:italic;line-height:1.4;"></div>
      </div>
    </div>
  </div>
    <div id="game-wrap">
      <div id="hud-top">
        <div class="hud-score">Score<span class="val" id="scoreDisplay">0</span></div>
        <div id="hud-level-badge">Lv.1 Sweetie</div>
        <div class="hud-coins">Coins<span class="val" id="coinsDisplay">0</span></div>
      </div>
      <div id="hud-passive-chip">Bao passive: Nomnom</div>
      <div id="stat-bars">
        <div class="mini-bar-wrap">
          <div class="mini-bar-label">XP</div>
          <div class="mini-bar-bg"><div class="mini-bar bar-xp" id="xp-bar" style="width:0%"></div></div>
        </div>
        <div class="mini-bar-wrap">
          <div class="mini-bar-label">HP</div>
          <div class="mini-bar-bg"><div class="mini-bar bar-hp" id="hp-bar" style="width:100%"></div></div>
        </div>
        <div class="mini-bar-wrap">
          <div class="mini-bar-label" id="passive-bar-label">PASSIVE</div>
          <div class="mini-bar-bg"><div class="mini-bar bar-passive" id="passive-bar" style="width:0%"></div></div>
        </div>
      </div>
      <div id="xp-label" style="text-align:right;font-size:.6rem;color:var(--gold);opacity:.7;margin-bottom:.4rem;">0 / 10 XP</div>
      <div id="buffs-row"></div>
      <div id="canvas-wrap">
        <canvas id="gameCanvas"></canvas>
        <div id="overlay">
          <h2>Catch the Hearts!</h2>
          <p>Slide your finger to move the basket.<br>Catch üíï hearts ¬∑ avoid ‚úñÔ∏è bad ones!<br><br><strong style="color:var(--gold);font-style:normal">Each character has a unique passive üåü<br>Level up ‚Üí choose tiered buffs ¬∑ Earn coins ‚Üí Shop üõí</strong></p>
          <button class="game-btn" id="start-btn">Start Playing üíï</button>
        </div>
      </div>
      <p id="game-msg">Catch hearts, avoid the ‚úñÔ∏è ones!</p>
    </div>

  <!-- SHOP SUB-TAB (embedded in Heart Catcher tab) -->
  </div><!-- end hc-subtab-play-content -->
  <div id="hc-subtab-shop-content" style="display:none;">
  <div id="tab-game-shop" style="margin:0 1.2rem 2rem;background:white;border-radius:20px;padding:1.3rem;box-shadow:0 6px 24px rgba(61,43,31,.08);border-top:4px solid var(--gold);">
    <div class="shop-header">
      <h3>üõí Bao's Shop</h3>
      <div class="wallet">üí∞ <span id="shop-wallet">0</span> &nbsp;üíé <span id="shop-diamond-wallet" style="color:#a78bfa;">0</span></div>
    </div>

    <!-- ‚îÄ‚îÄ INLINE CAPSULE MACHINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="inline-gacha" style="background:linear-gradient(160deg,#0a0a2a,#080818);border:2px solid #7B68EE;border-radius:20px;padding:1.1rem 1rem 1rem;margin-bottom:1rem;text-align:center;">
      <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:#a78bfa;margin-bottom:.15rem;">üíé Capsule Machine</div>
      <div style="font-size:.7rem;color:rgba(167,139,250,.55);margin-bottom:.4rem;">Premium pulls ¬∑ Collect pets &amp; bonuses!</div>
      <div style="font-size:.75rem;color:rgba(167,139,250,.75);margin-bottom:.7rem;">üíé Diamonds: <span id="gacha-diamond-display" style="font-family:'Playfair Display',serif;color:#a78bfa;font-size:.9rem;">0</span>
        <span style="opacity:.5;margin-left:.4rem;font-size:.65rem;font-style:italic;">earn from bosses &amp; high scores</span>
      </div>
      <div class="gacha-machine" id="gacha-ball" onclick="gachaPull(1)" title="Pull! (costs 3 üíé)" style="cursor:pointer;display:block;text-align:center;">
        <svg id="slot-machine-svg" viewBox="0 0 120 110" xmlns="http://www.w3.org/2000/svg" style="width:110px;height:100px;display:block;margin:0 auto;filter:drop-shadow(0 4px 18px rgba(120,80,220,0.55))">
          <rect x="8" y="18" width="104" height="72" rx="14" fill="url(#machineGrad)"/>
          <rect x="8" y="18" width="104" height="72" rx="14" fill="none" stroke="#7B68EE" stroke-width="2.5"/>
          <rect x="14" y="22" width="40" height="14" rx="6" fill="rgba(255,255,255,0.08)"/>
          <rect x="18" y="30" width="84" height="46" rx="8" fill="#060210" stroke="#6644cc" stroke-width="1.5"/>
          <line x1="46" y1="30" x2="46" y2="76" stroke="#6644cc" stroke-width="1" opacity="0.6"/>
          <line x1="74" y1="30" x2="74" y2="76" stroke="#6644cc" stroke-width="1" opacity="0.6"/>
          <text id="reel1" x="32" y="59" text-anchor="middle" font-size="20">üíé</text>
          <text id="reel2" x="60" y="59" text-anchor="middle" font-size="20">‚≠ê</text>
          <text id="reel3" x="88" y="59" text-anchor="middle" font-size="20">üíú</text>
          <line x1="18" y1="53" x2="102" y2="53" stroke="rgba(167,139,250,0.35)" stroke-width="1.5" stroke-dasharray="4 3"/>
          <rect x="101" y="36" width="11" height="38" rx="5.5" fill="url(#leverGrad)" stroke="#7B68EE" stroke-width="1.2"/>
          <circle id="lever-knob" cx="106.5" cy="38" r="6.5" fill="url(#knobGrad)" stroke="#7B68EE" stroke-width="1.5"/>
          <rect x="22" y="6" width="76" height="15" rx="7.5" fill="url(#signGrad)" stroke="#7B68EE" stroke-width="1.5"/>
          <text x="60" y="17" text-anchor="middle" font-family="serif" font-size="7.5" fill="#e9e0ff" font-weight="bold" letter-spacing="0.8">CAPSULE MACHINE</text>
          <rect x="46" y="92" width="28" height="5" rx="2.5" fill="#060210" stroke="#6644cc" stroke-width="1"/>
          <text x="60" y="106" text-anchor="middle" font-size="6.5" fill="rgba(167,139,250,0.5)" font-family="serif">3 üíé PER PULL</text>
          <circle class="machine-light" cx="20" cy="24" r="3" fill="#CE93D8" opacity="0.9"/>
          <circle class="machine-light" cx="100" cy="24" r="3" fill="#a78bfa" opacity="0.9"/>
          <circle class="machine-light" cx="60" cy="24" r="3" fill="#90caf9" opacity="0.9"/>
          <defs>
            <linearGradient id="machineGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#2a1060"/>
              <stop offset="50%" stop-color="#180838"/>
              <stop offset="100%" stop-color="#0a0418"/>
            </linearGradient>
            <linearGradient id="leverGrad" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#888"/><stop offset="50%" stop-color="#ddd"/><stop offset="100%" stop-color="#888"/>
            </linearGradient>
            <radialGradient id="knobGrad" cx="0.35" cy="0.3">
              <stop offset="0%" stop-color="#CE93D8"/><stop offset="100%" stop-color="#5B1A8B"/>
            </radialGradient>
            <linearGradient id="signGrad" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#4422aa"/><stop offset="50%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#4422aa"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
      <div class="gacha-pull-btns" style="margin:.6rem 0 .4rem;">
        <button class="gpb single" onclick="gachaPull(1)" id="gpb1">‚ú® √ó1 Pull ‚Äî 3 üíé</button>
        <button class="gpb ten" onclick="gachaPull(10)" id="gpb10">üí´ √ó10 Pull ‚Äî 25 üíé</button>
      </div>
      <div class="gacha-pity" id="gacha-pity-txt">Pity: 0 / 10 pulls until rare+</div>
      <div class="gacha-result" id="gacha-result"></div>
      <div class="gacha-inv-title" style="margin-top:.6rem;">Your collection (tap to equip as companion)</div>
      <div class="gacha-inv" id="gacha-inv"></div>
    </div>
    <!-- ‚îÄ‚îÄ END CAPSULE MACHINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

    <!-- shop category tabs -->
    <div id="shop-cat-tabs" style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:.7rem;">
      <button class="shop-cat-btn active" data-cat="all" onclick="setShopCat('all')">All</button>
      <button class="shop-cat-btn" data-cat="Starter" onclick="setShopCat('Starter')">üöÄ Starter</button>
      <button class="shop-cat-btn" data-cat="Passive" onclick="setShopCat('Passive')">üí° Passive</button>
      <button class="shop-cat-btn" data-cat="Combat" onclick="setShopCat('Combat')">‚öîÔ∏è Combat</button>
    </div>
    <div id="shop-rarity-tabs" style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:.85rem;">
      <button class="shop-rar-btn active" data-rar="all" onclick="setShopRar('all')">All Rarities</button>
      <button class="shop-rar-btn" data-rar="common" onclick="setShopRar('common')" style="color:#9E9E9E">Common</button>
      <button class="shop-rar-btn" data-rar="uncommon" onclick="setShopRar('uncommon')" style="color:#4CAF50">Uncommon</button>
      <button class="shop-rar-btn" data-rar="rare" onclick="setShopRar('rare')" style="color:#2196F3">Rare</button>
      <button class="shop-rar-btn" data-rar="epic" onclick="setShopRar('epic')" style="color:#9C27B0">Epic</button>
      <button class="shop-rar-btn" data-rar="legendary" onclick="setShopRar('legendary')" style="color:#FF9800">Legendary</button>
    </div>
    <div class="shop-grid" id="shop-grid"></div>
    <!-- pagination -->
    <div id="shop-pages" style="display:flex;align-items:center;justify-content:center;gap:8px;margin-top:.8rem;flex-wrap:wrap;"></div>
  </div>
  </div><!-- end hc-subtab-shop-content -->
    </div><!-- end tab-game -->

  <!-- STATS TAB -->
  <div id="tab-stats" class="panel hidden" style="border-top:4px solid var(--gold);">
    <h3>üìä Bao's Stats</h3>
    <!-- High score hero card -->
    <div style="background:linear-gradient(135deg,var(--deep) 0%,#5C3D2A 100%);border-radius:16px;padding:1.1rem 1.2rem;margin-bottom:1rem;text-align:center;box-shadow:0 4px 18px rgba(61,43,31,.18);">
      <div style="font-size:.65rem;letter-spacing:.18em;text-transform:uppercase;color:var(--gold);opacity:.8;margin-bottom:.25rem;">‚ú® Personal Best ‚ú®</div>
      <div style="font-family:'Playfair Display',serif;font-size:2.8rem;color:var(--cream);line-height:1;" id="st-hs-hero">0</div>
      <div style="font-size:.68rem;color:var(--peach);font-style:italic;margin-top:.3rem;">saved on this device üíæ</div>
    </div>
    <div class="stat-row"><span class="stat-label">üèÜ High Score</span><span class="stat-val" id="st-hs">0</span></div>
    <div class="stat-row"><span class="stat-label">‚≠ê Highest Level</span><span class="stat-val" id="st-lv">1</span></div>
    <div class="stat-row"><span class="stat-label">üíï Total Hearts Caught</span><span class="stat-val" id="st-hc">0</span></div>
    <div class="stat-row"><span class="stat-label">üéÆ Games Played</span><span class="stat-val" id="st-gp">0</span></div>
    <div class="stat-row"><span class="stat-label">üî• Best Streak</span><span class="stat-val" id="st-st">0</span></div>
    <div class="stat-row"><span class="stat-label">üí∞ Total Coins Earned</span><span class="stat-val" id="st-ce">0</span></div>
    <div class="stat-row"><span class="stat-label">üíé Diamonds</span><span class="stat-val" id="st-dm" style="color:#a78bfa;">0</span></div>
    <div class="stat-row"><span class="stat-label">üõí Items Purchased</span><span class="stat-val" id="st-ip">0</span></div>
    <div class="stat-row"><span class="stat-label">‚ú® Buffs Picked</span><span class="stat-val" id="st-bp">0</span></div>
    <div class="stat-row"><span class="stat-label">‚ö° Best XP / Game</span><span class="stat-val" id="st-xp">0</span></div>
    <div class="stat-row"><span class="stat-label">üëë Legendary Buffs Rolled</span><span class="stat-val" id="st-leg">0</span></div>
    <div class="stat-row"><span class="stat-label">ü•ü Bao Games</span><span class="stat-val" id="st-bg">0</span></div>
    <div class="stat-row"><span class="stat-label">üêª Dudu Games</span><span class="stat-val" id="st-dg">0</span></div>
    <div class="stat-row"><span class="stat-label">ü•î Nomnom Life Procs (Bao)</span><span class="stat-val" id="st-ss">0</span></div>
    <div class="stat-row"><span class="stat-label">‚öîÔ∏è Bosses Defeated</span><span class="stat-val" id="st-bd">0</span></div>
    <div class="stat-row"><span class="stat-label">üí• Angry Aura Procs</span><span class="stat-val" id="st-aa">0</span></div>
    <div class="prog-section">
      <h4>üìà Progression Milestones</h4>
      <div class="prog-row">
        <div class="prog-label"><span>Hearts Caught</span><span id="prog-hc-val">0 / 100</span></div>
        <div class="prog-bg"><div class="prog-fill" id="prog-hc" style="width:0%;background:var(--rose)"></div></div>
      </div>
      <div class="prog-row">
        <div class="prog-label"><span>Games Played</span><span id="prog-gp-val">0 / 20</span></div>
        <div class="prog-bg"><div class="prog-fill" id="prog-gp" style="width:0%;background:var(--peach)"></div></div>
      </div>
      <div class="prog-row">
        <div class="prog-label"><span>Coins Earned (lifetime)</span><span id="prog-ce-val">0 / 500</span></div>
        <div class="prog-bg"><div class="prog-fill" id="prog-ce" style="width:0%;background:var(--gold)"></div></div>
      </div>
      <div class="prog-row">
        <div class="prog-label"><span>Best Streak</span><span id="prog-st-val">0 / 20</span></div>
        <div class="prog-bg"><div class="prog-fill" id="prog-st" style="width:0%;background:#B56FCC"></div></div>
      </div>
    </div>
    <div class="unlocks-section">
      <h4>üîì Level Titles</h4>
      <div id="unlocks-list"></div>
    </div>
  </div>

<!-- COMBO FLASH -->
<div id="combo-flash"></div>
<!-- ACHIEVEMENT TOAST -->
<div id="achieve-toast"></div>

<!-- DAILY LOGIN MODAL -->
<div id="daily-modal">
  <div class="dm-inner">
    <div class="dm-title">üå∏ Daily Bonus!</div>
    <div class="dm-sub">You came back, Bao üß°</div>
    <div class="dm-streak-num" id="dm-streak-num">1</div>
    <div class="dm-streak-label">day streak üî•</div>
    <div class="daily-dots" id="daily-dots"></div>
    <div class="dm-reward" id="dm-reward">+10 coins üí∞</div>
    <button class="dm-claim-btn" onclick="claimDaily()">Claim Reward üéÅ</button>
  </div>
</div>

<!-- GACHA PULL ANIMATION OVERLAY (full-screen, shown during pulls) -->
<div id="gacha-anim-overlay">
  <div style="position:relative;display:flex;align-items:center;justify-content:center;">
    <svg id="gacha-rays" viewBox="0 0 280 280" xmlns="http://www.w3.org/2000/svg">
      <!-- Rotating rays for legendary -->
      <g fill="#D4A853">
        <polygon points="140,10 145,135 135,135" opacity="0.6"/>
        <polygon points="270,140 145,145 145,135" opacity="0.6"/>
        <polygon points="140,270 135,145 145,145" opacity="0.6"/>
        <polygon points="10,140 135,135 135,145" opacity="0.6"/>
        <polygon points="210,30 148,138 138,130" opacity="0.4"/>
        <polygon points="250,210 142,142 150,132" opacity="0.4"/>
        <polygon points="70,250 132,142 142,150" opacity="0.4"/>
        <polygon points="30,70 138,130 130,140" opacity="0.4"/>
      </g>
    </svg>
    <svg id="gacha-big-machine" viewBox="0 0 220 185" xmlns="http://www.w3.org/2000/svg" style="width:220px;height:185px;filter:drop-shadow(0 6px 36px rgba(120,80,220,0.65))">
      <!-- Body -->
      <rect x="10" y="30" width="185" height="118" rx="18" fill="url(#bMG)"/>
      <rect x="10" y="30" width="185" height="118" rx="18" fill="none" stroke="#7B68EE" stroke-width="3"/>
      <!-- Shine -->
      <rect x="18" y="36" width="65" height="18" rx="9" fill="rgba(255,255,255,0.09)"/>
      <!-- Screen -->
      <rect x="22" y="46" width="158" height="76" rx="10" fill="#050115" stroke="#6644cc" stroke-width="2"/>
      <!-- Dividers -->
      <line x1="74.5" y1="46" x2="74.5" y2="122" stroke="#6644cc" stroke-width="1.5" opacity="0.5"/>
      <line x1="130.5" y1="46" x2="130.5" y2="122" stroke="#6644cc" stroke-width="1.5" opacity="0.5"/>
      <!-- Reels -->
      <text id="ov-reel1" x="48.5" y="96" text-anchor="middle" font-size="38">üíé</text>
      <text id="ov-reel2" x="102.5" y="96" text-anchor="middle" font-size="38">‚≠ê</text>
      <text id="ov-reel3" x="156.5" y="96" text-anchor="middle" font-size="38">üíú</text>
      <!-- Scanline -->
      <line x1="22" y1="84" x2="180" y2="84" stroke="rgba(167,139,250,0.4)" stroke-width="2" stroke-dasharray="6 4"/>
      <!-- Lever -->
      <rect x="182" y="54" width="18" height="62" rx="9" fill="url(#bLG)" stroke="#7B68EE" stroke-width="1.5"/>
      <circle id="ov-lever-knob" cx="191" cy="56" r="11" fill="url(#bKG)" stroke="#7B68EE" stroke-width="2"/>
      <!-- Coin slot -->
      <rect x="82" y="150" width="40" height="8" rx="4" fill="#050115" stroke="#6644cc" stroke-width="1.5"/>
      <text x="102" y="168" text-anchor="middle" font-size="9" fill="rgba(167,139,250,0.5)" font-family="serif">INSERT DIAMOND</text>
      <!-- Sign -->
      <rect x="30" y="12" width="145" height="22" rx="11" fill="url(#bSG)" stroke="#7B68EE" stroke-width="2"/>
      <text x="102.5" y="26.5" text-anchor="middle" font-family="serif" font-size="10.5" fill="#e9e0ff" font-weight="bold" letter-spacing="1.5">‚ú® CAPSULE MACHINE ‚ú®</text>
      <!-- Lights row -->
      <circle class="big-light" cx="30" cy="40" r="5" fill="#CE93D8"/>
      <circle class="big-light" cx="175" cy="40" r="5" fill="#a78bfa"/>
      <circle class="big-light" cx="102" cy="40" r="5" fill="#90caf9"/>
      <circle class="big-light" cx="66" cy="40" r="4.5" fill="#b39ddb"/>
      <circle class="big-light" cx="139" cy="40" r="4.5" fill="#7986CB"/>
      <defs>
        <linearGradient id="bMG" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#2a1060"/>
          <stop offset="50%" stop-color="#180838"/>
          <stop offset="100%" stop-color="#0a0418"/>
        </linearGradient>
        <linearGradient id="bLG" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#777"/><stop offset="50%" stop-color="#eee"/><stop offset="100%" stop-color="#777"/>
        </linearGradient>
        <radialGradient id="bKG" cx="0.35" cy="0.3">
          <stop offset="0%" stop-color="#CE93D8"/><stop offset="100%" stop-color="#5B1A8B"/>
        </radialGradient>
        <linearGradient id="bSG" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#4422aa"/><stop offset="50%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#4422aa"/>
        </linearGradient>
      </defs>
    </svg>
  </div>
  <div class="gacha-anim-label" id="gacha-anim-label">Pulling...</div>
  <div id="gacha-anim-result" style="display:none;"></div>
  <div id="gacha-anim-sparks" style="position:fixed;inset:0;pointer-events:none;overflow:hidden;"></div>
</div>

  <!-- POTATO DEALER TAB -->
  <div id="tab-blackjack" class="hidden">
    <style>
      /* POTATO DEALER STYLES */
      .pd-card{width:42px;height:60px;border-radius:8px;display:inline-flex;flex-direction:column;align-items:center;justify-content:center;font-size:.7rem;font-weight:bold;box-shadow:0 3px 10px rgba(0,0,0,.25);cursor:default;transition:transform .25s ease,box-shadow .25s ease;position:relative;overflow:hidden;}
      .pd-card.red{background:linear-gradient(145deg,#fff8f0,#ffe8d0);border:2px solid #e05c2a;color:#c0391a;}
      .pd-card.black{background:linear-gradient(145deg,#f8f2e8,#ede3d0);border:2px solid #3d2b1f;color:#3d2b1f;}
      .pd-card.hidden-card{background:repeating-linear-gradient(45deg,#6b4226,#6b4226 5px,#8a5c3e 5px,#8a5c3e 10px);border:2px solid #4a2c16;}
      .pd-card .suit{font-size:1.1rem;line-height:1;}
      .pd-card .rank{font-size:.7rem;line-height:1;font-family:'Playfair Display',serif;}
      @keyframes pdDeal{from{transform:translateY(-80px) rotate(-15deg) scale(.5);opacity:0}to{transform:translateY(0) rotate(0deg) scale(1);opacity:1}}
      @keyframes pdFlip{0%{transform:rotateY(90deg) scale(.8)}100%{transform:rotateY(0deg) scale(1)}}
      @keyframes pdBossShake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
      @keyframes pdBossHurt{0%{filter:brightness(1)}50%{filter:brightness(2) hue-rotate(20deg)}100%{filter:brightness(1)}}
      @keyframes pdPlayerWin{0%{transform:scale(1)}50%{transform:scale(1.15) rotate(3deg)}100%{transform:scale(1)}}
      @keyframes pdRewardReveal{from{transform:scale(.5) rotate(-10deg);opacity:0}to{transform:scale(1) rotate(0deg);opacity:1}}
      .pd-card.dealing{animation:pdDeal .35s cubic-bezier(.25,.46,.45,.94) forwards;}
      .pd-card.flipping{animation:pdFlip .3s ease forwards;}
      .boss-shake{animation:pdBossShake .4s ease;}
      .boss-hurt{animation:pdBossHurt .4s ease;}
      .player-win-anim{animation:pdPlayerWin .5s ease;}
      .pd-reward-card{animation:pdRewardReveal .4s ease forwards;border-radius:16px;padding:1rem .8rem;background:white;box-shadow:0 6px 24px rgba(61,43,31,.12);border:2px solid var(--peach);cursor:pointer;text-align:center;transition:transform .15s ease,box-shadow .15s ease;}
      .pd-reward-card:hover{transform:translateY(-4px);box-shadow:0 10px 32px rgba(61,43,31,.2);}
      .pd-reward-card.selected{border-color:var(--gold);background:linear-gradient(135deg,#fff9ec,#fffdf5);}
      .pd-ability-btn{border-radius:12px;padding:.4rem .3rem;font-family:'Playfair Display',serif;font-size:.62rem;color:var(--deep);cursor:pointer;transition:opacity .2s,transform .1s;text-align:center;}
      .pd-ability-btn:active{transform:scale(.95);}
      .pd-slot-reel{width:52px;height:52px;border-radius:12px;border:2px solid var(--gold);background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:bold;color:white;transition:transform .1s;box-shadow:0 2px 10px rgba(0,0,0,.4);}
      @keyframes pdSlotSpin{0%{transform:translateY(-40px) scale(.5);opacity:0}60%{transform:translateY(4px) scale(1.1)}100%{transform:translateY(0) scale(1);opacity:1}}
      .pd-slot-reel.spinning{animation:pdSlotSpin .15s ease-out forwards;}
      /* Pet animations for blackjack */
      @keyframes pdPetBounce{0%{transform:translateY(0) scale(1)}30%{transform:translateY(-12px) scale(1.15)}60%{transform:translateY(2px) scale(.95)}100%{transform:translateY(0) scale(1)}}
      @keyframes pdPetGlow{0%{filter:brightness(1) drop-shadow(0 0 0 transparent)}50%{filter:brightness(1.3) drop-shadow(0 0 12px var(--pet-glow,#ffd700))}100%{filter:brightness(1) drop-shadow(0 0 0 transparent)}}
      @keyframes pdPetShield{0%{transform:scale(0) rotate(-10deg);opacity:0}50%{transform:scale(1.2) rotate(5deg);opacity:1}100%{transform:scale(1) rotate(0deg);opacity:1}}
      @keyframes pdPetAttack{0%{transform:translateX(0)}30%{transform:translateX(15px) scale(1.1)}60%{transform:translateX(-5px)}100%{transform:translateX(0)}}
      @keyframes pdPetHeal{0%{opacity:0;transform:translateY(8px)}50%{opacity:1;transform:translateY(-6px)}100%{opacity:0;transform:translateY(-18px)}}
      .pd-pet-bounce{animation:pdPetBounce .4s ease;}
      .pd-pet-glow{animation:pdPetGlow .6s ease;}
      .pd-pet-shield{animation:pdPetShield .4s ease forwards;}
      .pd-pet-attack{animation:pdPetAttack .35s ease;}
      .pd-pet-heal{animation:pdPetHeal .7s ease forwards;position:absolute;pointer-events:none;font-size:.9rem;}
      .pd-pet-card{border-radius:12px;padding:.6rem;cursor:pointer;border:1.5px solid;text-align:center;transition:transform .15s,box-shadow .15s;}
      .pd-pet-card:hover{transform:translateY(-2px);}
      .pd-pet-card.equipped{box-shadow:0 0 12px rgba(212,168,83,.4);}
      .pd-pet-card .pet-emoji{font-size:1.5rem;}
      .pd-pet-card .pet-name{font-family:'Playfair Display',serif;font-size:.75rem;margin-top:.2rem;}
      .pd-pet-card .pet-skill{font-size:.6rem;opacity:.65;font-style:italic;margin-top:.1rem;line-height:1.3;}
    </style>
    <div style="margin:0 1.2rem 1.5rem;">
      <!-- Header -->
      <div style="text-align:center;padding:.6rem 0 .3rem;">
        <div style="font-family:'Playfair Display',serif;font-size:1.35rem;color:var(--deep);">ü•î Potato Dealer</div>
        <small style="font-family:'Lora',serif;font-style:italic;font-size:.72rem;color:var(--gold);">Blackjack with potatoes ¬∑ beat the bosses ¬∑ claim your rewards!</small>
      </div>

      <!-- Coin Display -->
      <div id="pd-coin-bar" style="display:flex;align-items:center;justify-content:center;gap:12px;padding:.4rem .8rem;margin:.3rem 0 .5rem;background:linear-gradient(135deg,rgba(212,168,83,.12),rgba(212,168,83,.04));border-radius:14px;border:1.5px solid rgba(212,168,83,.3);">
        <div style="font-family:'Playfair Display',serif;font-size:.9rem;color:var(--gold);">üí∞ <span id="pd-coins-display">0</span> coins</div>
        <div style="width:1px;height:16px;background:rgba(212,168,83,.3);"></div>
        <div style="font-family:'Playfair Display',serif;font-size:.9rem;color:#a78bfa;">üíé <span id="pd-diamonds-display">0</span></div>
        <div style="width:1px;height:16px;background:rgba(212,168,83,.3);"></div>
        <div style="font-size:.7rem;color:var(--deep);opacity:.6;" id="pd-pet-badge">No pet</div>
      </div>

      <!-- Sub-tabs -->
      <div style="display:flex;gap:5px;margin-bottom:.7rem;">
        <button class="tab-btn active" onclick="pdSubTab('play')" id="pd-subtab-play" style="flex:1;font-size:.78rem;">üÉè Play</button>
        <button class="tab-btn" onclick="pdSubTab('shop')" id="pd-subtab-shop" style="flex:1;font-size:.78rem;">üé∞ Shop</button>
        <button class="tab-btn" onclick="pdSubTab('pets')" id="pd-subtab-pets" style="flex:1;font-size:.78rem;">üêæ Pets</button>
      </div>

      <!-- PLAY SUB-TAB -->
      <div id="pd-subtab-play-content">

      <!-- Betting Panel (shown before game starts) -->
      <div id="pd-bet-panel" style="background:linear-gradient(160deg,#1a0800,#2a1200);border-radius:18px;padding:1.2rem 1rem;margin-bottom:.7rem;text-align:center;border:2px solid var(--gold);">
        <div style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--gold);margin-bottom:.3rem;">üé≤ Place Your Bet</div>
        <div style="font-size:.7rem;color:rgba(255,255,255,.6);font-style:italic;margin-bottom:.7rem;">Win = earn your bet ¬∑ Lose = lose your bet</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:.6rem;">
          <button onclick="pdAdjustBet(-5)" style="width:32px;height:32px;border-radius:50%;border:1.5px solid var(--gold);background:rgba(255,255,255,.06);color:var(--gold);font-size:1rem;cursor:pointer;">‚àí</button>
          <div style="font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--gold);min-width:60px;" id="pd-bet-amount">5</div>
          <button onclick="pdAdjustBet(5)" style="width:32px;height:32px;border-radius:50%;border:1.5px solid var(--gold);background:rgba(255,255,255,.06);color:var(--gold);font-size:1rem;cursor:pointer;">+</button>
        </div>
        <div style="display:flex;gap:5px;justify-content:center;margin-bottom:.6rem;">
          <button onclick="pdSetBet(5)" style="padding:.25rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:rgba(255,255,255,.7);font-size:.65rem;cursor:pointer;">5</button>
          <button onclick="pdSetBet(10)" style="padding:.25rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:rgba(255,255,255,.7);font-size:.65rem;cursor:pointer;">10</button>
          <button onclick="pdSetBet(25)" style="padding:.25rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:rgba(255,255,255,.7);font-size:.65rem;cursor:pointer;">25</button>
          <button onclick="pdSetBet(50)" style="padding:.25rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:rgba(255,255,255,.7);font-size:.65rem;cursor:pointer;">50</button>
        </div>
        <div style="font-size:.6rem;color:rgba(255,255,255,.4);margin-bottom:.1rem;" id="pd-bet-limit-info">Max bet: 50 coins (scales with level)</div>
        <div style="font-size:.6rem;color:rgba(255,200,100,.5);margin-bottom:.6rem;">Minimum bet: 5 coins to play</div>
        <div id="pd-bet-error" style="font-size:.7rem;color:#f87171;min-height:1em;margin-bottom:.3rem;"></div>
      </div>

      <!-- Character Select -->
      <div id="pd-char-select" style="margin:.6rem 0 .7rem;">
        <div style="font-family:'Playfair Display',serif;font-size:.82rem;color:var(--deep);text-align:center;margin-bottom:.45rem;opacity:.75;">Choose your hero</div>
        <div style="display:flex;gap:7px;">
          <button class="pd-char-btn" onclick="pdSelectChar('bao')" id="pd-btn-bao"
            style="flex:1;border:2px solid var(--peach);border-radius:14px;padding:.55rem .2rem;background:rgba(255,183,147,.1);cursor:pointer;font-family:'Playfair Display',serif;font-size:.72rem;color:var(--deep);transition:all .2s;">
            <div id="pd-portrait-bao" style="display:flex;justify-content:center;margin-bottom:.2rem;"></div>
            <div style="font-weight:bold;">Bao</div>
            <div style="font-size:.58rem;opacity:.68;line-height:1.3;margin-top:.15rem;">Potato Shield<br>Double Luck</div>
          </button>
          <button class="pd-char-btn" onclick="pdSelectChar('dudu')" id="pd-btn-dudu"
            style="flex:1;border:2px solid #f4a261;border-radius:14px;padding:.55rem .2rem;background:rgba(244,162,97,.1);cursor:pointer;font-family:'Playfair Display',serif;font-size:.72rem;color:var(--deep);transition:all .2s;">
            <div id="pd-portrait-dudu" style="display:flex;justify-content:center;margin-bottom:.2rem;"></div>
            <div style="font-weight:bold;">Dudu</div>
            <div style="font-size:.58rem;opacity:.68;line-height:1.3;margin-top:.15rem;">Rage Draw<br>Angry Aura</div>
          </button>
          <button class="pd-char-btn" onclick="pdSelectChar('bubu')" id="pd-btn-bubu"
            style="flex:1;border:2px solid #a78bfa;border-radius:14px;padding:.55rem .2rem;background:rgba(167,139,250,.1);cursor:pointer;font-family:'Playfair Display',serif;font-size:.72rem;color:var(--deep);transition:all .2s;">
            <div id="pd-portrait-bubu" style="display:flex;justify-content:center;margin-bottom:.2rem;"></div>
            <div style="font-weight:bold;">Bubu</div>
            <div style="font-size:.58rem;opacity:.68;line-height:1.3;margin-top:.15rem;">Peek Card<br>Fortune Paw</div>
          </button>
        </div>
      </div>

      <!-- Game Area -->
      <div id="pd-game-area" style="display:none;">
        <!-- HP Bars -->
        <div style="background:white;border-radius:16px;padding:.75rem 1rem;margin-bottom:.6rem;box-shadow:0 3px 12px rgba(61,43,31,.07);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
            <div style="display:flex;align-items:center;gap:.4rem;">
              <div id="pd-hero-portrait" style="flex-shrink:0;"></div>
              <div style="font-family:'Playfair Display',serif;font-size:.78rem;color:var(--deep);" id="pd-hero-name">Bao</div>
            </div>
            <div style="font-size:.7rem;color:var(--gold);font-family:'Playfair Display',serif;" id="pd-wave-info">Boss 1/5 ¬∑ Round 1</div>
            <div style="display:flex;align-items:center;gap:.4rem;">
              <div style="font-family:'Playfair Display',serif;font-size:.78rem;color:var(--deep);" id="pd-boss-name">üëπ</div>
              <div id="pd-boss-sprite" style="font-size:1.6rem;cursor:default;transition:transform .1s;">üßÖ</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:.3rem;">
            <div style="font-size:.58rem;color:var(--deep);opacity:.55;width:20px;">HP</div>
            <div style="flex:1;background:#f0e8e0;border-radius:6px;height:9px;overflow:hidden;">
              <div id="pd-hero-hp-bar" style="height:100%;background:linear-gradient(90deg,#f4a261,var(--peach));border-radius:6px;transition:width .4s ease;width:100%;"></div>
            </div>
            <div style="font-size:.62rem;color:var(--deep);min-width:38px;text-align:right;" id="pd-hero-hp-text">100/100</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="font-size:.58rem;color:var(--deep);opacity:.55;width:20px;">üëπ</div>
            <div style="flex:1;background:#f0e8e0;border-radius:6px;height:9px;overflow:hidden;">
              <div id="pd-boss-hp-bar" style="height:100%;background:linear-gradient(90deg,#800000,#c0391a);border-radius:6px;transition:width .4s ease;width:100%;"></div>
            </div>
            <div style="font-size:.62rem;color:var(--deep);min-width:38px;text-align:right;" id="pd-boss-hp-text">80/80</div>
          </div>
        </div>

        <!-- Ability Bar -->
        <div style="display:flex;gap:5px;margin-bottom:.6rem;">
          <button id="pd-ab1-btn" onclick="pdUseAbility(1)" class="pd-ability-btn" style="flex:1;border:2px solid var(--peach);background:white;">
            <div id="pd-ab1-icon" style="font-size:1rem;">ü•î</div>
            <div id="pd-ab1-name" style="font-weight:bold;font-size:.6rem;">Shield</div>
            <div id="pd-ab1-cd" style="font-size:.55rem;opacity:.6;">Ready</div>
            <div id="pd-ab1-desc" style="font-size:.48rem;opacity:.5;font-family:'Lora',serif;font-style:italic;margin-top:.1rem;line-height:1.2;display:none;"></div>
          </button>
          <button id="pd-ab2-btn" onclick="pdUseAbility(2)" class="pd-ability-btn" style="flex:1;border:2px solid #f4a261;background:white;">
            <div id="pd-ab2-icon" style="font-size:1rem;">üí•</div>
            <div id="pd-ab2-name" style="font-weight:bold;font-size:.6rem;">Double</div>
            <div id="pd-ab2-cd" style="font-size:.55rem;opacity:.6;">Ready</div>
            <div id="pd-ab2-desc" style="font-size:.48rem;opacity:.5;font-family:'Lora',serif;font-style:italic;margin-top:.1rem;line-height:1.2;display:none;"></div>
          </button>
          <button id="pd-ult-btn" onclick="pdUseAbility('ult')" class="pd-ability-btn" style="flex:1.3;border:2px solid var(--gold);background:linear-gradient(135deg,rgba(212,168,83,.12),rgba(212,168,83,.04));">
            <div id="pd-ult-icon" style="font-size:1rem;">‚ú®</div>
            <div id="pd-ult-name" style="font-weight:bold;font-size:.6rem;">Ultimate</div>
            <div id="pd-ult-cd" style="font-size:.55rem;opacity:.6;">0/3</div>
            <div id="pd-ult-desc" style="font-size:.48rem;opacity:.5;font-family:'Lora',serif;font-style:italic;margin-top:.1rem;line-height:1.2;display:none;"></div>
          </button>
          <div style="flex:1;border:2px solid rgba(61,43,31,.15);border-radius:12px;padding:.4rem .2rem;background:rgba(212,168,83,.05);text-align:center;">
            <div style="font-size:.7rem;">üõ°Ô∏è</div>
            <div style="font-size:.58rem;font-family:'Playfair Display',serif;color:var(--deep);">Buffs</div>
            <div id="pd-active-buffs" style="font-size:.55rem;color:var(--gold);opacity:.8;">‚Äî</div>
          </div>
        </div>

        <!-- Card Table -->
        <div style="background:linear-gradient(160deg,#1a4a2a,#0d3320);border-radius:20px;padding:.9rem .9rem 1rem;margin-bottom:.6rem;min-height:215px;position:relative;">
          <!-- Dealer -->
          <div style="margin-bottom:.7rem;">
            <div style="font-size:.62rem;color:rgba(255,255,255,.55);margin-bottom:.3rem;font-family:'Lora',serif;font-style:italic;">
              Dealer's hand ‚Äî <span id="pd-dealer-total" style="color:rgba(255,220,150,.9);">?</span>
            </div>
            <div id="pd-dealer-cards" style="display:flex;gap:5px;flex-wrap:wrap;min-height:60px;align-items:center;"></div>
          </div>
          <div style="border-top:1px solid rgba(255,255,255,.1);margin:.4rem 0 .5rem;"></div>
          <!-- Player -->
          <div>
            <div style="font-size:.62rem;color:rgba(255,255,255,.55);margin-bottom:.3rem;font-family:'Lora',serif;font-style:italic;">
              Your hand ‚Äî <span id="pd-player-total" style="color:rgba(255,220,150,.9);">0</span>
            </div>
            <div id="pd-player-cards" style="display:flex;gap:5px;flex-wrap:wrap;min-height:60px;align-items:center;"></div>
          </div>
          <!-- Floating message -->
          <div id="pd-float-msg" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Playfair Display',serif;font-size:1.1rem;color:#ffd700;text-shadow:0 2px 8px rgba(0,0,0,.5);pointer-events:none;"></div>
        </div>

        <!-- Action Buttons -->
        <div style="display:flex;gap:7px;margin-bottom:.55rem;">
          <button id="pd-hit-btn" onclick="pdHit()"
            style="flex:1;padding:.6rem;border:none;border-radius:14px;background:var(--deep);color:var(--cream);font-family:'Playfair Display',serif;font-size:.88rem;cursor:pointer;transition:transform .1s,opacity .2s;">
            Hit ü•î
          </button>
          <button id="pd-stand-btn" onclick="pdStand()"
            style="flex:1;padding:.6rem;border:none;border-radius:14px;background:#3a6b47;color:white;font-family:'Playfair Display',serif;font-size:.88rem;cursor:pointer;transition:transform .1s,opacity .2s;">
            Stand ‚úã
          </button>
          <button id="pd-deal-btn" onclick="pdDeal()" style="display:none;flex:1;padding:.6rem;border:none;border-radius:14px;background:linear-gradient(135deg,var(--gold),#e8c068);color:var(--deep);font-family:'Playfair Display',serif;font-size:.88rem;cursor:pointer;">
            Next ü•î
          </button>
        </div>

        <!-- Message Bar -->
        <div id="pd-msg" style="text-align:center;font-family:'Lora',serif;font-style:italic;font-size:.82rem;color:var(--deep);min-height:1.3rem;padding:.3rem .6rem;background:white;border-radius:11px;box-shadow:0 2px 8px rgba(61,43,31,.06);"></div>
      </div>

      <!-- Reward Screen -->
      <div id="pd-reward-screen" style="display:none;padding:.5rem 0 1rem;">
        <div style="text-align:center;margin-bottom:.8rem;">
          <div style="font-size:1.8rem;" id="pd-reward-emoji">üèÜ</div>
          <div style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--deep);margin:.3rem 0 .1rem;" id="pd-reward-title">Boss Defeated!</div>
          <div style="font-family:'Lora',serif;font-style:italic;font-size:.75rem;color:var(--gold);" id="pd-reward-subtitle">Choose your reward</div>
        </div>
        <div id="pd-reward-choices" style="display:flex;flex-direction:column;gap:.55rem;"></div>
        <button id="pd-continue-btn" onclick="pdContinueAfterReward()" style="display:none;width:100%;margin-top:.8rem;padding:.65rem;border:none;border-radius:14px;background:var(--deep);color:var(--cream);font-family:'Playfair Display',serif;font-size:.9rem;cursor:pointer;">
          Continue ‚û°Ô∏è
        </button>
      </div>

      <!-- End Screen -->
      <div id="pd-end-screen" style="display:none;text-align:center;padding:1.5rem 1rem;">
        <div style="font-size:2.8rem;" id="pd-end-emoji">üèÜ</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--deep);margin:.5rem 0 .2rem;" id="pd-end-title">Victory!</div>
        <div style="font-family:'Lora',serif;font-style:italic;font-size:.78rem;color:var(--deep);opacity:.7;margin-bottom:1rem;" id="pd-end-msg">You beat all the bosses!</div>
        <div id="pd-acquired-buffs" style="margin-bottom:.8rem;font-size:.75rem;color:var(--deep);opacity:.7;"></div>
        <div id="pd-coins-earned-msg" style="margin-bottom:.6rem;font-size:.8rem;color:var(--gold);font-family:'Playfair Display',serif;font-weight:bold;"></div>
        <!-- Slot Machine -->
        <div id="pd-slot-wrap" style="display:none;border:2px solid var(--gold);border-radius:18px;padding:1rem .8rem;margin-bottom:1rem;background:linear-gradient(160deg,#1a0800,#0d0400);">
          <div style="font-family:'Playfair Display',serif;color:var(--gold);font-size:.95rem;margin-bottom:.5rem;">üé∞ Lucky Slot Machine</div>
          <div style="font-size:.65rem;color:rgba(255,255,255,.6);font-family:'Lora',serif;font-style:italic;margin-bottom:.7rem;">Win the jackpot to unlock a pet or special reward!</div>
          <div style="display:flex;justify-content:center;gap:8px;margin-bottom:.7rem;">
            <div class="pd-slot-reel" id="pd-slot-r1">ü•î</div>
            <div class="pd-slot-reel" id="pd-slot-r2">ü•î</div>
            <div class="pd-slot-reel" id="pd-slot-r3">ü•î</div>
          </div>
          <div id="pd-slot-result" style="font-size:.72rem;color:rgba(255,255,255,.8);font-family:'Lora',serif;min-height:1.1rem;margin-bottom:.5rem;"></div>
          <div style="font-size:.6rem;color:rgba(255,255,255,.4);margin-bottom:.6rem;">Cost: 5 ü™ô coins per pull</div>
          <button onclick="pdSlotPull()" id="pd-slot-btn" style="padding:.55rem 1.4rem;border:none;border-radius:12px;background:linear-gradient(135deg,var(--gold),#e8c068);color:var(--deep);font-family:'Playfair Display',serif;font-size:.82rem;cursor:pointer;font-weight:bold;">Pull! üé∞</button>
          <div style="font-size:.58rem;color:rgba(255,255,255,.35);margin-top:.45rem;font-style:italic;">Match 3 symbols = jackpot ¬∑ 3√óüåü = legendary!</div>
        </div>
        <button onclick="pdRestartGame()" style="padding:.7rem 1.8rem;border:none;border-radius:14px;background:var(--deep);color:var(--cream);font-family:'Playfair Display',serif;font-size:.9rem;cursor:pointer;">Play Again ü•î</button>
      </div>
    </div>
    </div><!-- end pd-subtab-play-content -->

    <!-- SHOP SUB-TAB (Slot Machine + Casino) -->
    <div id="pd-subtab-shop-content" style="display:none;">
      <div style="background:linear-gradient(160deg,#0a0418,#180838);border-radius:20px;padding:1.2rem 1rem;border:2px solid rgba(123,104,238,.3);margin-bottom:.8rem;">
        <div style="text-align:center;font-family:'Playfair Display',serif;font-size:1.1rem;color:#a78bfa;margin-bottom:.2rem;">üé∞ Casino</div>
        <div style="text-align:center;font-size:.68rem;color:rgba(167,139,250,.5);font-style:italic;margin-bottom:.8rem;">Spin for coins, pets & legendary rewards!</div>
        
        <!-- Slot Machine -->
        <div style="border:2px solid var(--gold);border-radius:18px;padding:1rem .8rem;margin-bottom:.8rem;background:linear-gradient(160deg,#1a0800,#0d0400);">
          <div style="font-family:'Playfair Display',serif;color:var(--gold);font-size:.95rem;margin-bottom:.3rem;text-align:center;">üé∞ Lucky Slot Machine</div>
          <div style="font-size:.62rem;color:rgba(255,255,255,.5);text-align:center;margin-bottom:.6rem;">Match 3 symbols for jackpot! üåüüåüüåü = LEGENDARY PET</div>
          <div style="display:flex;justify-content:center;gap:8px;margin-bottom:.6rem;">
            <div class="pd-slot-reel" id="pd-shop-slot-r1">ü•î</div>
            <div class="pd-slot-reel" id="pd-shop-slot-r2">ü•î</div>
            <div class="pd-slot-reel" id="pd-shop-slot-r3">ü•î</div>
          </div>
          <div id="pd-shop-slot-result" style="font-size:.72rem;color:rgba(255,255,255,.8);font-family:'Lora',serif;min-height:1.1rem;margin-bottom:.5rem;text-align:center;"></div>
          <div style="display:flex;gap:6px;justify-content:center;margin-bottom:.5rem;">
            <button onclick="pdShopSlotPull(5)" id="pd-shop-slot-btn5" style="padding:.5rem 1rem;border:none;border-radius:12px;background:linear-gradient(135deg,var(--gold),#e8c068);color:var(--deep);font-family:'Playfair Display',serif;font-size:.78rem;cursor:pointer;font-weight:bold;">Spin 5ü™ô</button>
            <button onclick="pdShopSlotPull(15)" id="pd-shop-slot-btn15" style="padding:.5rem 1rem;border:none;border-radius:12px;background:linear-gradient(135deg,#7B68EE,#CE93D8);color:#fff;font-family:'Playfair Display',serif;font-size:.78rem;cursor:pointer;font-weight:bold;">Super 15ü™ô</button>
          </div>
          <div style="font-size:.55rem;color:rgba(255,255,255,.3);text-align:center;line-height:1.5;">
            ü•îü•îü•î = refund ¬∑ üå∏üå∏üå∏ = +10 ¬∑ üçüüçüüçü = +20 ¬∑ üí•üí•üí• = +50<br>
            ‚≠ê‚≠ê‚≠ê = Epic Pet ¬∑ üåüüåüüåü = LEGENDARY PET (0.08% chance!)<br>
            Super Spin: 3√ó better legendary odds!
          </div>
        </div>

        <!-- Pet Egg Machine -->
        <div style="border:2px solid rgba(206,147,216,.4);border-radius:18px;padding:1rem .8rem;background:linear-gradient(160deg,#1a0520,#0a0218);">
          <div style="font-family:'Playfair Display',serif;color:#CE93D8;font-size:.95rem;margin-bottom:.3rem;text-align:center;">ü•ö Pet Egg Machine</div>
          <div style="font-size:.62rem;color:rgba(206,147,216,.5);text-align:center;margin-bottom:.6rem;">Hatch a random pet! Casino-grade rarities üé≤</div>
          <div style="text-align:center;margin-bottom:.5rem;">
            <div id="pd-egg-display" style="font-size:3rem;animation:pulse 1.5s ease-in-out infinite;">ü•ö</div>
          </div>
          <div id="pd-egg-result" style="font-size:.75rem;color:rgba(255,255,255,.8);text-align:center;min-height:1.2rem;margin-bottom:.5rem;"></div>
          <div style="display:flex;gap:6px;justify-content:center;margin-bottom:.4rem;">
            <button onclick="pdEggPull()" id="pd-egg-btn" style="padding:.55rem 1.2rem;border:none;border-radius:12px;background:linear-gradient(135deg,#CE93D8,#9C27B0);color:#fff;font-family:'Playfair Display',serif;font-size:.82rem;cursor:pointer;">Hatch! 25ü™ô</button>
          </div>
          <div style="font-size:.54rem;color:rgba(206,147,216,.35);text-align:center;line-height:1.5;">
            Common: 55% ¬∑ Uncommon: 28% ¬∑ Rare: 12%<br>
            Epic: 4% ¬∑ Legendary: 0.8% ¬∑ Pity at 50 hatches
          </div>
        </div>
      </div>
    </div>

    <!-- PETS SUB-TAB -->
    <div id="pd-subtab-pets-content" style="display:none;">
      <div style="background:white;border-radius:20px;padding:1.2rem;box-shadow:0 6px 24px rgba(61,43,31,.08);">
        <div style="text-align:center;margin-bottom:.8rem;">
          <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--deep);">üêæ Your Pets</div>
          <div style="font-size:.7rem;color:var(--deep);opacity:.6;font-style:italic;">Equip a pet for blackjack ability bonuses!</div>
        </div>
        
        <!-- Equipped Pet Display -->
        <div id="pd-equipped-pet-display" style="border:2px solid var(--gold);border-radius:16px;padding:.8rem;margin-bottom:.8rem;text-align:center;background:linear-gradient(135deg,rgba(212,168,83,.06),rgba(212,168,83,.02));">
          <div style="font-size:.65rem;color:var(--gold);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.3rem;">Equipped Pet</div>
          <div id="pd-equipped-pet-info" style="font-size:.85rem;color:var(--deep);">None equipped ‚Äî tap a pet below!</div>
          <div id="pd-equipped-pet-ability" style="font-size:.68rem;color:var(--deep);opacity:.6;font-style:italic;margin-top:.2rem;"></div>
        </div>

        <!-- Pet Grid -->
        <div id="pd-pet-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div style="grid-column:1/-1;text-align:center;font-style:italic;opacity:.5;font-size:.8rem;padding:1rem;">No pets yet! Try the Casino üé∞</div>
        </div>

        <!-- Blackjack Pet Abilities Legend -->
        <div style="margin-top:.8rem;border-top:1px solid rgba(61,43,31,.1);padding-top:.7rem;">
          <div style="font-family:'Playfair Display',serif;font-size:.8rem;color:var(--deep);margin-bottom:.4rem;">üìñ Pet Abilities in Blackjack</div>
          <div style="font-size:.62rem;color:var(--deep);opacity:.6;line-height:1.7;">
            üê± <b>Heal</b> ‚Äî Restore HP when you win a hand<br>
            üõ°Ô∏è <b>Shield</b> ‚Äî Chance to block boss damage<br>
            ‚öîÔ∏è <b>Damage</b> ‚Äî Bonus damage on winning hands<br>
            üçÄ <b>Lucky</b> ‚Äî Improved card draws<br>
            üí∞ <b>Coins</b> ‚Äî Earn bonus coins from wins<br>
            ‚ú® <b>Ultimate</b> ‚Äî Legendary-only mega abilities
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONNECT 4 TAB -->
  <div id="tab-c4" class="hidden">
  <div class="c4-section">
    <div class="c4-label">
      Connect Bao üî¥
      <small>connect 4 RPG ¬∑ minimax AI ¬∑ skill battles ¬∑ 4 difficulties</small>
    </div>

    <!-- Character select -->
    <div class="char-select" style="margin-bottom:.8rem;">
      <h4>Choose your fighter</h4>
      <div style="position:relative;z-index:1;">
        <select id="c4-char-dropdown" onchange="c4SelectChar(this.value)" style="width:100%;padding:.65rem 1rem;border-radius:14px;border:2px solid var(--peach);background:white;font-family:'Playfair Display',serif;font-size:.9rem;color:var(--deep);cursor:pointer;appearance:none;-webkit-appearance:none;box-shadow:0 3px 12px rgba(61,43,31,.07);">
          <option value="bao">Bao ‚Äî Nomnom Healer (heal 6 HP/4 turns)</option>
          <option value="dudu">Dudu ‚Äî Angry Aura (streak deals 2√ó damage)</option>
          <option value="bubu" id="c4-bubu-option" disabled>üîí ??? ‚Äî Mystery Character (win 5 rounds in a row!)</option>
        </select>
        <div style="pointer-events:none;position:absolute;right:1rem;top:50%;transform:translateY(-50%);font-size:.8rem;opacity:.5;">‚ñº</div>
      </div>
      <div id="c4-char-preview" style="margin-top:.6rem;display:flex;align-items:center;gap:.7rem;background:white;border-radius:12px;padding:.55rem .9rem;box-shadow:0 2px 8px rgba(61,43,31,.07);">
        <div id="c4-char-preview-avatar" style="flex-shrink:0;"></div>
        <div>
          <div id="c4-char-preview-name" style="font-family:'Playfair Display',serif;font-size:.85rem;color:var(--deep);"></div>
          <div id="c4-char-preview-passive" style="font-size:.65rem;color:var(--deep);opacity:.65;font-style:italic;margin-top:1px;line-height:1.35;"></div>
        </div>
      </div>
    </div>

    <!-- Level progress display -->
    <div id="c4-level-row">
      <span id="c4-level-label">‚öîÔ∏è Level 1</span>
      <div id="c4-level-bar-wrap"><div id="c4-level-bar" style="width:0%"></div></div>
      <span id="c4-level-label-r" style="font-size:.65rem;color:rgba(61,43,31,.45);font-style:italic">Choose your boss!</span>
    </div>

    <!-- Boss pick panel (shown before each battle) -->
    <div id="c4-boss-pick" style="display:none;background:linear-gradient(160deg,#1a0800,#0d0400);border:2px solid var(--gold);border-radius:18px;padding:.9rem .8rem;margin-bottom:.8rem;"></div>

    <div id="c4-wrap">
      <!-- HUD -->
      <div id="c4-hud">
        <div class="c4-fighter">
          <div id="c4-p-portrait" style="height:36px;display:flex;align-items:center;justify-content:center;margin-bottom:3px;"></div>
          <div class="c4-fighter-name" id="c4-p-name">Bao</div>
          <div class="c4-hp-wrap"><div class="c4-hp-bar" id="c4-p-bar" style="width:100%;background:linear-gradient(90deg,#E8736A,#FF9ECD)"></div></div>
          <div class="c4-hp-text" id="c4-p-hp">30/30 HP</div>
        </div>
        <div class="c4-vs">VS</div>
        <div class="c4-fighter enemy">
          <div class="c4-fighter-name" id="c4-e-name">???</div>
          <div class="c4-hp-wrap"><div class="c4-hp-bar" id="c4-e-bar" style="width:100%;background:linear-gradient(90deg,#FF6B6B,#C0392B)"></div></div>
          <div class="c4-hp-text" id="c4-e-hp">??? HP</div>
        </div>
      </div>
      <div id="c4-round-bar">
        <span id="c4-round-text">Round 1</span>
        <span id="c4-streak-hud">Win streak: 0 üî•</span>
      </div>

      <!-- Buffs + Intent -->
      <div id="c4-buffs"></div>
      <div class="c4-intent" id="c4-intent"></div>

      <!-- Board -->
      <div id="c4-board-area">
        <div id="c4-col-btns"></div>
        <div id="c4-board"></div>
        <div id="c4-overlay">
          <h3 id="c4-ov-title">Round Over!</h3>
          <p id="c4-ov-body"></p>
          <p class="c4-streak-text" id="c4-ov-streak"></p>
          <button class="game-btn" id="c4-next-btn" onclick="c4NextRound()">Next Round ‚öîÔ∏è</button>
        </div>
      </div>

      <!-- Status -->
      <div id="c4-status">
        <div id="c4-status-main">Pick your character and start!</div>
        <div id="c4-status-sub"></div>
      </div>

      <!-- Skills -->
      <div id="c4-skills">
        <button class="c4-skill-btn sk-c4-attack" id="c4-sk0" onclick="c4UseSkill(0)">
          <span class="sk-name" id="c4-sk0-name">‚öîÔ∏è</span>
          <span class="sk-desc" id="c4-sk0-desc">Normal drop</span>
          <span class="sk-cd" id="c4-sk0-cd"></span>
        </button>
        <button class="c4-skill-btn sk-c4-defend" id="c4-sk1" onclick="c4UseSkill(1)">
          <span class="sk-name" id="c4-sk1-name">üõ°Ô∏è</span>
          <span class="sk-desc" id="c4-sk1-desc">Block next hit</span>
          <span class="sk-cd" id="c4-sk1-cd"></span>
        </button>
        <button class="c4-skill-btn sk-c4-special" id="c4-sk2" onclick="c4UseSkill(2)">
          <span class="sk-name" id="c4-sk2-name">‚ú®</span>
          <span class="sk-desc" id="c4-sk2-desc">Special</span>
          <span class="sk-cd" id="c4-sk2-cd"></span>
        </button>
      </div>

      <button class="game-btn" id="c4-start-btn" onclick="showBossPick(0)" style="width:100%;margin-top:0;">Start from Level 1 üíï</button>
    </div>
  </div>


  </div><!-- end tab-c4 -->

  <footer>üß° üå∏ üíõ üå∑ üíï</footer>
</div>
<!-- Hidden character portraits -->
<img id="dudu-portrait" src="data:image/png;base64,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" alt="Dudu" style="display:none;"/>
<img id="bubu-portrait" src="data:image/png;base64,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" alt="Bubu" style="display:none;"/>

<script>
// ===================== DYNAMIC DAY =====================
(function(){
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const day=days[new Date().getDay()];
  document.getElementById('page-title').textContent=`Happy ${day}, Bao üß°`;
  document.getElementById('day-label-el').textContent=`${day} ¬∑ Just For You`;
  document.getElementById('day-name-el').textContent=`${day},`;
})();

// ===================== LOVE NOTES =====================
// One random note shown per page visit ‚Äî stays fixed until they reload.
const LOVE_NOTES=[
  {
    l1:`Hey Bao, I just wanted to take a moment to remind you how much you mean to me ‚Äî even on a regular day.`,
    l2:`You make every ordinary day feel a little softer and a little warmer just by being in it. I hope today is as sweet as you are.`,
    l3:`I lub you. I wish you all the best nomnoms forever üçú‚ú® Now go play the game below üéÆ`
  },
  {
    l1:`Hi Bao ü•ü Just popping in to say: you are genuinely my favourite person, and I think about you a ridiculous amount.`,
    l2:`I wish you an endless supply of the most delicious nomnoms ‚Äî warm bowls of noodles, crispy snacks, and every good bite in between. You deserve them all. üçúüç°`,
    l3:`I lub you so much it's a little silly. Now go catch some hearts, you nommable little dumpling üíïüéÆ`
  },
  {
    l1:`Dear Bao, today's forecast: 100% chance of someone loving you very much and thinking your cheeks are absolutely nommable. üå§Ô∏è`,
    l2:`I hope the universe delivers you something delicious today ‚Äî whether it's a great meal, a good laugh, or just a peaceful cosy moment. You deserve all of it.`,
    l3:`I lub you to the moon and back and also to the nearest noodle shop. Go play! üçú‚ú®üéÆ`
  },
  {
    l1:`Hey you. Yes, you ‚Äî the one with the nommable cheeks and the big heart. I just wanted to say I'm really glad you exist. üß°`,
    l2:`You're the kind of person who makes everything feel warmer. I hope today treats you gently and gives you something really tasty to eat. üç°`,
    l3:`I lub you. Wishing you all the best nomnoms, the softest moments, and a fantastic game below üéÆüíï`
  },
  {
    l1:`Bao! ü•ü A quick note from your Dudu: you are loved, cherished, and also ‚Äî your cheeks are extremely nommable and I will not apologise for that.`,
    l2:`I hope today surprises you with something good. Maybe a snack you didn't expect, a smile out of nowhere, or just a quiet moment that feels really nice. üçú`,
    l3:`I lub you lots and lots. Now stop reading and go play the game I made for you üéÆ‚ú®`
  },
  {
    l1:`Good morning (or afternoon, or evening ‚Äî I don't know when you're reading this, but I know I'm glad you are) üå∏`,
    l2:`I think about you constantly, in the most embarrassing way. Like, fully mid-task, brain just goes: "Bao." And then I smile like an idiot. It happens a lot.`,
    l3:`I lub you more than I can put into words, but I made you a game so that's close enough. Go play üéÆüíï`
  },
  {
    l1:`Bao, did you eat today? Have some water too. I'm watching from this message and I will know. üëÄ`,
    l2:`But genuinely ‚Äî I hope you're taking care of yourself, eating something warm and yummy, and feeling at least a little bit cosy wherever you are right now. üçú`,
    l3:`I lub you a ridiculous amount. Now go catch some hearts for me üíïüéÆ`
  },
  {
    l1:`Hey Bao. I just wanted to say: the way you laugh at things, the way you get particular about food textures, the way you remember tiny details ‚Äî all of it is my favourite. üß°`,
    l2:`You are genuinely one of a kind and I feel very lucky that I get to be the person who knows that. I hope today is as good to you as you are to me.`,
    l3:`I lub you heaps. Go show those hearts who's boss üéÆ‚ú®`
  },
  {
    l1:`Dear Bao ü•ü A reminder that someone out there thinks you are the most nommable, most wonderful, most loveable person in the entire world.`,
    l2:`That someone is me, by the way. Just so we're clear. I lub you a lot and I think about you all the time and your cheeks are extremely nommable and I stand by all of this.`,
    l3:`Okay. Go play the game. I made it for you. I hope it makes you smile üéÆüíï`
  },
  {
    l1:`Bao! üå∏ You know what's a good thing? You. You are a very good thing. The world is genuinely better with you in it.`,
    l2:`I hope today has at least one moment where something makes you really happy ‚Äî a bite of something delicious, a warm feeling, a little laugh. You deserve a lot of those. üç°`,
    l3:`I lub you so much. Now go play and beat your high score üéÆüèÜ`
  },
  {
    l1:`Hi love üíõ I was just sitting here thinking about you and I figured I'd write it down so you'd know.`,
    l2:`You're my favourite person to eat with, to talk with, to just be around. Even on the quiet days, being near you feels like the warmest, nicest place to be. üçú`,
    l3:`I lub you lots. Go catch some hearts, my nommable little dumpling ü•üüéÆ`
  },
  {
    l1:`Bao, today I am sending you: one very warm hug, one bowl of your favourite noodles (imaginary but full of love), and this message. üçúü§ó`,
    l2:`I hope something small and lovely happens to you today. You deserve kindness in every corner of your day ‚Äî and also very soft broccoli, obviously.`,
    l3:`I lub you. Thank you for existing. Now go play üéÆ‚ú®`
  },
  {
    l1:`Quick appreciation message from your Dudu üß° You are: smart, funny, kind, extremely particular about food textures (very valid), and absolutely nommable.`,
    l2:`I could go on. Actually, I will ‚Äî you're also the person I most want to share good food with, and the one I think about when something funny happens, and the best Bao there is.`,
    l3:`I lub you a whole lot. Go play the game I made for you üéÆüíï`
  },
  {
    l1:`Bao ü•ü Remember that time we went to Ding Te Le in Kovan and it was our first date and everything felt a little electric and a little warm?`,
    l2:`I think about that evening a lot. You had your navy blue top on and brown pants and you were just ‚Äî really lovely. You still are. Even more now, actually.`,
    l3:`I lub you. A lot. Now go play this silly game I made because I love you üéÆüíï`
  },
  {
    l1:`Hey Bao üåô It's giving late-night-cozy-music-in-the-background vibes right now and I just wanted to reach through this screen and tell you you're my person.`,
    l2:`Like genuinely. My favourite person. The one I want to call when something good happens, and the one I want next to me when something doesn't. That's you. That's Bao.`,
    l3:`I lub you so much it's honestly a little embarrassing. Now go play üéÆ‚ú®`
  },
  {
    l1:`Dear Bao üíï Soft broccoli, baked potatoes, sheng jian bao, penne pasta, grandma's si ji dou ‚Äî you have very good taste and I respect every single one of those choices.`,
    l2:`Also: the way you know what you like and stay true to it (including firmly avoiding udon, raw onions, and bean sprouts ‚Äî all completely justified) is one of my favourite things about you.`,
    l3:`I lub you very much, my wonderful, particular, nommable Bao. Go play üéÆü•ü`
  },
  {
    l1:`Bao! üå∏ Today's message is short and sweet, just like a certain someone I know: I love you and I'm really glad you're mine.`,
    l2:`I hope your day has good food, cozy moments, and zero unwanted onions in it. You deserve all the good things and none of the garnishes you didn't ask for. üßÖüö´`,
    l3:`I lub you lots and lots. Now go catch those hearts üéÆüíï`
  },
  {
    l1:`Hey Bao üß° I know I say this a lot but ‚Äî you make things better just by being around. That's a real talent and not everyone has it. You do.`,
    l2:`I hope today is gentle with you. I hope something makes you laugh and something makes you full and something reminds you that you are very, very loved. Because you are.`,
    l3:`I lub you. Okay. Game time. Go go go üéÆ‚ú®`
  },
  {
    l1:`Bao ü•ü Fun fact: I think about you constantly. Like an embarrassing amount. Like "oh that's a funny cloud" and then immediately "Bao would have a take on this cloud."`,
    l2:`That's just how it is now. My brain has a Bao folder and it is extremely full. I wouldn't have it any other way, honestly. You're my favourite thought.`,
    l3:`I lub you so much. Now go play and catch all the hearts üíïüéÆ`
  },
  {
    l1:`Good day, Bao üå§Ô∏è I hope wherever you are right now, you're warm and comfortable and at least a little bit happy.`,
    l2:`If you're not ‚Äî I hope this helps a little. You are loved deeply, thought about constantly, and considered nommable by at least one very important person. That person is me. üß°`,
    l3:`I lub you. Go play the game I made for you because you are my favourite person üéÆüíï`
  },
  {
    l1:`Bao! Steamboat night energy right now ü´ï Chicken in the pot, crabsticks going in, maggie noodles because obviously, and you across the table from me ‚Äî perfect evening.`,
    l2:`I just love being with you. In the big moments and the small ones. Especially the small ones, actually. The ones where we're just eating something warm and everything feels right.`,
    l3:`I lub you a whole lot, my nommable little dumpling. Now go play üéÆ‚ú®`
  },
];

(function(){
  const n=LOVE_NOTES[Math.floor(Math.random()*LOVE_NOTES.length)];
  document.getElementById('note-line1').textContent=n.l1;
  document.getElementById('note-line2').textContent=n.l2;
  document.getElementById('note-line3').textContent=n.l3;
})();

// ===================== CHARACTERS =====================
const CHARS={
  bao:{
    id:'bao', name:'Bao', emoji:'',
    color:'#F4A56A', basketLabel:'Bao',
    passive:'Nomnom',
    passiveDesc:'Catch 5 ü•î potatoes ‚Üí +1 life!',
    passiveTrigger:5,
    passiveBarColor:'#F4A56A',
  },
  dudu:{
    id:'dudu', name:'Dudu', emoji:'',
    color:'#9C27B0', basketLabel:'Dudu',
    passive:'Angry Aura',
    passiveDesc:'Streak 5+ ‚Üí next catch is 2√ó bonus',
    // Aura is always watching streak; fires when streak hits 5 and next catch
    passiveBarColor:'#CE93D8',
  },
  bubu:{
    id:'bubu', name:'Bubu', emoji:'üêº',
    color:'#E91E8C', basketLabel:'Bubu üêº',
    passive:'Shopaholic',
    passiveDesc:'Catch 5 üõçÔ∏è bags ‚Üí +5 coins!',
    passiveTrigger:5,
    passiveBarColor:'#FF6BA8',
    locked:true, // requires gacha unlock
  },
};

let currentChar='bao';
let duduAuraReady=false;
let running=false; // early ‚Äî selectChar references this before canvas block

function selectChar(id){
  if(running){
    // Reset dropdown to current char
    const dd=document.getElementById('char-dropdown');
    if(dd) dd.value=currentChar;
    return;
  }
  if(id==='bubu'&&!P.bubuUnlocked){
    showToast('üîí Mystery character locked! Try the Capsule Machine to discover them!');
    const dd=document.getElementById('char-dropdown');
    if(dd) dd.value=currentChar;
    return;
  }
  currentChar=id;
  const dd=document.getElementById('char-dropdown');
  if(dd) dd.value=id;
  updateCharPreview(id);
  updateHUD();
}

const BAO_SVG=`<svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
  <!-- Body: fluffy white bao -->
  <ellipse cx="30" cy="34" rx="22" ry="18" fill="url(#baoBody)" filter="url(#baoShadow)"/>
  <!-- Top dome -->
  <path d="M12 30 Q14 12 30 10 Q46 12 48 30" fill="url(#baoTop)" stroke="#E8D8C8" stroke-width="0.5"/>
  <!-- Pleats on top -->
  <path d="M24 14 Q26 10 30 10 Q34 10 36 14" stroke="#D4C4B0" stroke-width="1.2" fill="none" stroke-linecap="round"/>
  <path d="M20 17 Q22 13 26 12" stroke="#D4C4B0" stroke-width="1" fill="none" stroke-linecap="round"/>
  <path d="M40 17 Q38 13 34 12" stroke="#D4C4B0" stroke-width="1" fill="none" stroke-linecap="round"/>
  <path d="M17 22 Q18 18 22 16" stroke="#D4C4B0" stroke-width="0.9" fill="none" stroke-linecap="round"/>
  <path d="M43 22 Q42 18 38 16" stroke="#D4C4B0" stroke-width="0.9" fill="none" stroke-linecap="round"/>
  <!-- Shine/highlight -->
  <ellipse cx="24" cy="20" rx="4" ry="3" fill="white" opacity="0.5" transform="rotate(-20 24 20)"/>
  <!-- Blush cheeks -->
  <ellipse cx="18" cy="36" rx="5" ry="3.5" fill="#FFB8A8" opacity="0.55"/>
  <ellipse cx="42" cy="36" rx="5" ry="3.5" fill="#FFB8A8" opacity="0.55"/>
  <!-- Eyes -->
  <ellipse cx="24" cy="31" rx="2.2" ry="2.5" fill="#3D2B1F"/>
  <ellipse cx="36" cy="31" rx="2.2" ry="2.5" fill="#3D2B1F"/>
  <circle cx="25" cy="30" r="0.8" fill="white"/>
  <circle cx="37" cy="30" r="0.8" fill="white"/>
  <!-- Smile -->
  <path d="M25 37 Q30 41 35 37" stroke="#C47060" stroke-width="1.5" fill="none" stroke-linecap="round"/>
  <defs>
    <radialGradient id="baoBody" cx="0.4" cy="0.3" r="0.7">
      <stop offset="0%" stop-color="#FFFFFF"/>
      <stop offset="60%" stop-color="#F8F2EC"/>
      <stop offset="100%" stop-color="#EDE3D8"/>
    </radialGradient>
    <radialGradient id="baoTop" cx="0.5" cy="0.2" r="0.8">
      <stop offset="0%" stop-color="#FFFFFF"/>
      <stop offset="100%" stop-color="#F0E8DC"/>
    </radialGradient>
    <filter id="baoShadow" x="-10%" y="-10%" width="120%" height="130%">
      <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#C4A890" flood-opacity="0.3"/>
    </filter>
  </defs>
</svg>`;

function getCharPortraitHTML(id, size=52){
  if(id==='bubu'){
    const img=document.getElementById('bubu-portrait');
    return img?`<img src="${img.src}" style="width:${size}px;height:${size}px;object-fit:contain;background:transparent;">`:'üêº';
  } else if(id==='dudu'){
    const img=document.getElementById('dudu-portrait');
    return img?`<img src="${img.src}" style="width:${size}px;height:${size}px;object-fit:contain;background:transparent;">`:'üêª';
  } else {
    return `<div style="width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center;">${BAO_SVG}</div>`;
  }
}

function updateCharPreview(id){
  const c=CHARS[id];
  if(!c) return;
  const avatarEl=document.getElementById('char-preview-avatar');
  const nameEl=document.getElementById('char-preview-name');
  const passiveEl=document.getElementById('char-preview-passive');
  if(!avatarEl) return;
  avatarEl.innerHTML=getCharPortraitHTML(id, 52);
  if(nameEl) nameEl.textContent=`${c.name}`;
  if(passiveEl){
    passiveEl.innerHTML=`<strong style="color:${c.color||'#E91E8C'}">${c.passive}</strong>: ${c.passiveDesc}`;
  }
}

// ===================== LEVELS =====================
const LEVELS=[
  {level:1,title:'Sweetie',      xpNeeded:10, color:'#D4A853',desc:'Just getting started üå±'},
  {level:2,title:'Nomnom Queen', xpNeeded:25, color:'#F4A56A',desc:'First buff unlocked! üçú'},
  {level:3,title:'Fissy Bao',    xpNeeded:45, color:'#E8736A',desc:'Getting serious üíï'},
  {level:4,title:'Cozy Bao',     xpNeeded:70, color:'#B56FCC',desc:'Smooth operator üõãÔ∏è'},
  {level:5,title:'Bao Warrior',  xpNeeded:100,color:'#6FAACC',desc:'Stars appear! üåü'},
  {level:6,title:'Snoozing Bao', xpNeeded:140,color:'#CC6F8A',desc:'Basket glows üëë'},
  {level:7,title:'Potato Bao',   xpNeeded:190,color:'#6FCCAA',desc:'Rainbow basket üåà'},
  {level:8,title:'Nomnom Bao',   xpNeeded:250,color:'#FFD700',desc:'Golden everything ‚ú®'},
  {level:9,title:'Nomnom Demon', xpNeeded:9999,color:'#FF9ECD',desc:'LEGENDARY! üåå'},
];

// ===================== TIERED BUFFS =====================
const ALL_BUFFS=[
  // COMMON (tier unlocks at lv1)
  {id:'wide_s',    rarity:'common',   name:'üõí Wider Basket',   emoji:'üõí',short:'Wide',    desc:'Basket 30% wider for 10s',             dur:10,w:28},
  {id:'slow_s',    rarity:'common',   name:'üêå Slow Drizzle',   emoji:'üêå',short:'Slow',    desc:'Hearts 20% slower for 10s',            dur:10,w:28},
  {id:'coins_s',   rarity:'common',   name:'üí∞ Coin Shower',    emoji:'üí∞',short:'Coins',   desc:'+5 bonus coins now',                   dur:0, w:22,instant:true,fn:(g)=>{g.coins+=5;g.P.coins+=5;g.P.coinsEarned+=5;}},
  {id:'xp_s',      rarity:'common',   name:'‚ö° XP Trickle',     emoji:'‚ö°',short:'XP+',     desc:'+20% XP for 8s',                       dur:8, w:22},
  {id:'lucky_s',   rarity:'common',   name:'üçÄ Lucky Break',    emoji:'üçÄ',short:'Lucky',   desc:'Blocks next bad heart OR saves 1 missed good heart ‚Äî whichever comes first',  dur:Infinity,w:18},
  {id:'rally',     rarity:'common',   name:'üí™ Rally',          emoji:'üí™',short:'Rally',   desc:'+1 pt bonus per heart for 8s',         dur:8, w:16},
  {id:'heartstorm',rarity:'common',   name:'üåßÔ∏è Heart Rain',     emoji:'üåßÔ∏è',short:'Rain',    desc:'Extra hearts fall for 6s',             dur:6, w:14},
  // UNCOMMON (tier unlocks at lv2)
  {id:'wide_m',    rarity:'uncommon', name:'üõí Big Basket',     emoji:'üõí',short:'Big',     desc:'Basket 50% wider for 14s',             dur:14,w:18},
  {id:'slow_m',    rarity:'uncommon', name:'üêå Slow Fall',      emoji:'üêå',short:'Slower',  desc:'Hearts 35% slower for 12s',            dur:12,w:18},
  {id:'shield',    rarity:'uncommon', name:'üõ°Ô∏è Love Shield',    emoji:'üõ°Ô∏è',short:'Shield',  desc:'Blocks next bad heart',                dur:Infinity,w:16},
  {id:'magnet_s',  rarity:'uncommon', name:'üß≤ Mini Magnet',    emoji:'üß≤',short:'Magnet',  desc:'Hearts drift to basket for 8s',        dur:8, w:15},
  {id:'coins_m',   rarity:'uncommon', name:'üí∞ Coin Burst',     emoji:'üí∞',short:'Coins+',  desc:'+12 bonus coins now',                  dur:0, w:14,instant:true,fn:(g)=>{g.coins+=12;g.P.coins+=12;g.P.coinsEarned+=12;}},
  {id:'streak_up', rarity:'uncommon', name:'üî• Streak Saver',   emoji:'üî•',short:'StrSave', desc:'Streak stays on 1 miss for 15s',       dur:15,w:12},
  {id:'blitz',     rarity:'uncommon', name:'‚ö° Blitz',           emoji:'‚ö°',short:'Blitz',   desc:'Catch speed doubled, pts +1 for 8s',   dur:8, w:11},
  {id:'liferegen', rarity:'uncommon', name:'üíó Life Regen',      emoji:'üíó',short:'+Life',   desc:'Recover 1 lost life right now',        dur:0, w:10,instant:true,fn:(g)=>{g.lives=Math.min(g.lives+1,6);}},
  // RARE (tier unlocks at lv3)
  {id:'double',    rarity:'rare',     name:'üíé Double Points',  emoji:'üíé',short:'2√ó',      desc:'Hearts worth 2√ó score for 12s',        dur:12,w:10},
  {id:'slow_l',    rarity:'rare',     name:'üêå Glacier Mode',   emoji:'üêå',short:'Glacier', desc:'Hearts 55% slower for 10s',            dur:10,w:9},
  {id:'magnet_m',  rarity:'rare',     name:'üß≤ Heart Magnet',   emoji:'üß≤',short:'Magnet+', desc:'Strong magnet for 12s',                dur:12,w:9},
  {id:'xp_m',      rarity:'rare',     name:'‚ö° XP Surge',       emoji:'‚ö°',short:'XP++',    desc:'+60% XP for 12s',                      dur:12,w:8},
  {id:'freeze',    rarity:'rare',     name:'‚ùÑÔ∏è Freeze Baddies', emoji:'‚ùÑÔ∏è',short:'Freeze',  desc:'Bad items crawl for 10s',              dur:10,w:8},
  {id:'vacuum',    rarity:'rare',     name:'üåÄ Vacuum',         emoji:'üåÄ',short:'Vacuum',  desc:'All hearts on screen snap to basket',  dur:0, w:7,instant:true,fn:(g)=>{g._vacuum=true;}},
  {id:'timewarp',  rarity:'rare',     name:'‚è±Ô∏è Time Warp',      emoji:'‚è±Ô∏è',short:'Warp',    desc:'Freeze all items for 4s',              dur:4, w:7},
  {id:'coinrain',  rarity:'rare',     name:'üí∞ Coin Rain',      emoji:'üí∞',short:'CRain',   desc:'+3 coins per heart for 10s',           dur:10,w:6},
  // EPIC (tier unlocks at lv5)
  {id:'triple',    rarity:'epic',     name:'üåü Triple Points',  emoji:'üåü',short:'3√ó',      desc:'Hearts worth 3√ó for 10s',              dur:10,w:4},
  {id:'wide_l',    rarity:'epic',     name:'üõí Mega Basket',    emoji:'üõí',short:'MEGA',    desc:'Basket 80% wider for 14s',             dur:14,w:4},
  {id:'shield2',   rarity:'epic',     name:'üõ°Ô∏è Fortress',       emoji:'üõ°Ô∏è',short:'Fortress',desc:'Blocks next 3 bad hearts',             dur:Infinity,w:3},
  {id:'coins_l',   rarity:'epic',     name:'üí∞ Gold Rush',      emoji:'üí∞',short:'GOLD',    desc:'+30 coins now',                        dur:0, w:3,instant:true,fn:(g)=>{g.coins+=30;g.P.coins+=30;g.P.coinsEarned+=30;}},
  {id:'extralife', rarity:'epic',     name:'‚ù§Ô∏è Extra Life',     emoji:'‚ù§Ô∏è',short:'+HP',     desc:'Gain 1 extra life',                    dur:0, w:3,instant:true,fn:(g)=>{g.lives=Math.min(g.lives+1,6);}},
  {id:'frenzy',    rarity:'epic',     name:'üéÜ Frenzy',         emoji:'üéÜ',short:'Frenzy',  desc:'4√ó pts + speed up hearts for 8s',      dur:8, w:2},
  {id:'ghost',     rarity:'epic',     name:'üëª Ghost Mode',     emoji:'üëª',short:'Ghost',   desc:'Bad items pass through you for 12s',   dur:12,w:2},
  {id:'starburst', rarity:'epic',     name:'üí´ Starburst',      emoji:'üí´',short:'Burst',   desc:'+2 streak & score boost for 10s',      dur:10,w:2},
  // COMMON ADDITIONS
  {id:'heartboost',rarity:'common',   name:'üíû Heart Boost',   emoji:'üíû',short:'Boost',   desc:'Hearts worth +2 pts each for 7s',      dur:7, w:16},
  {id:'miniwall',  rarity:'common',   name:'ü™® Mini Wall',     emoji:'ü™®',short:'Wall',    desc:'Shrinks bad items 30% for 10s',        dur:10,w:14},
  {id:'snack',     rarity:'common',   name:'üç° Snack Time',    emoji:'üç°',short:'Snack',   desc:'Instantly earn +8 coins',              dur:0, w:14,instant:true,fn:(g)=>{g.coins+=8;g.P.coins+=8;g.P.coinsEarned+=8;}},
  {id:'tailwind',  rarity:'common',   name:'üí® Tailwind',      emoji:'üí®',short:'Wind',    desc:'Basket 25% wider & +1pt for 6s',      dur:6, w:13},
  {id:'warmup',    rarity:'common',   name:'üîÜ Warm-Up',       emoji:'üîÜ',short:'Warm',    desc:'+10% XP and +10% coins for 8s',        dur:8, w:13},
  {id:'pocketful', rarity:'common',   name:'ü™ô Pocketful',     emoji:'ü™ô',short:'Pocket',  desc:'+7 coins now',                         dur:0, w:13,instant:true,fn:(g)=>{g.coins+=7;g.P.coins+=7;g.P.coinsEarned+=7;}},
  // UNCOMMON ADDITIONS
  {id:'xp_streak', rarity:'uncommon', name:'üîó XP Chain',      emoji:'üîó',short:'Chain',   desc:'Streak 3+ gives 2√ó XP for 10s',       dur:10,w:13},
  {id:'bounty',    rarity:'uncommon', name:'ü§ë Bounty Hearts',  emoji:'ü§ë',short:'Bounty',  desc:'+2 coins per heart caught for 10s',    dur:10,w:11},
  {id:'doubleshot',rarity:'uncommon', name:'üéØ Double Shot',   emoji:'üéØ',short:'DblShot', desc:'Every other heart caught scores 2√ó for 12s', dur:12,w:10},
  {id:'shieldplus', rarity:'uncommon',name:'üõ°Ô∏è Iron Shield',   emoji:'üõ°Ô∏è',short:'Iron',    desc:'Blocks next 2 bad hearts',             dur:Infinity,w:9},
  {id:'breezy',    rarity:'uncommon', name:'üå¨Ô∏è Breezy',        emoji:'üå¨Ô∏è',short:'Breeze',  desc:'All items 25% slower + basket 20% wider for 8s', dur:8,w:9},
  {id:'caffeinate',rarity:'uncommon', name:'‚òï Caffeinate',    emoji:'‚òï',short:'Caff',    desc:'+1 life regen + 15% XP boost for 10s',  dur:10,w:8},
  // RARE ADDITIONS
  {id:'scatter',   rarity:'rare',     name:'üå∏ Blossom Burst', emoji:'üå∏',short:'Blossom', desc:'Instantly spawns 6 bonus hearts',      dur:0, w:7,instant:true,fn:(g)=>{g._scatter=true;}},
  {id:'nullfield', rarity:'rare',     name:'üö´ Null Field',    emoji:'üö´',short:'Null',    desc:'Removes all bad items from screen',    dur:0, w:6,instant:true,fn:(g)=>{g._nullfield=true;}},
  {id:'overclock', rarity:'rare',     name:'‚öôÔ∏è Overclock',     emoji:'‚öôÔ∏è',short:'Clock',   desc:'Hearts fall 50% faster but score 2√ó for 10s', dur:10,w:6},
  {id:'goldrain',  rarity:'rare',     name:'üåßÔ∏è Gold Rain',     emoji:'üåßÔ∏è',short:'Gold‚ú¶',  desc:'+5 coins per heart for 8s',            dur:8, w:6},
  {id:'foresight', rarity:'rare',     name:'üîÆ Foresight',     emoji:'üîÆ',short:'Sight',   desc:'Bad items glow red 2s before hitting for 12s', dur:12,w:5},
  {id:'avalanche', rarity:'rare',     name:'‚ùÑÔ∏è Avalanche',     emoji:'‚ùÑÔ∏è',short:'Avalan',  desc:'All bad items frozen + 6 bonus hearts spawned now', dur:0,w:5,instant:true,fn:(g)=>{g.freezeBad=true;g._scatter=true;}},
  // EPIC ADDITIONS
  {id:'overcharge',rarity:'epic',     name:'‚ö° Overcharge',    emoji:'‚ö°',short:'5√ó',      desc:'Hearts worth 5√ó pts for 5s',           dur:5, w:2},
  {id:'lifesteal', rarity:'epic',     name:'üßõ Life Steal',    emoji:'üßõ',short:'Steal',   desc:'Each heart heals 0.25 life for 10s',   dur:10,w:2},
  {id:'vortex',    rarity:'epic',     name:'üåÄ Vortex',        emoji:'üåÄ',short:'Vortex',  desc:'Magnet + 3√ó pts + freeze bad for 8s',  dur:8, w:1},
  {id:'timegod',   rarity:'epic',     name:'‚è≥ Time God',      emoji:'‚è≥',short:'TGod',    desc:'Freeze all items for 6s + score 3√ó for 6s', dur:6,w:1},
  {id:'supernova', rarity:'epic',     name:'üå† Supernova',     emoji:'üå†',short:'Nova',    desc:'Clear all bad items + 4√ó pts for 8s',  dur:8, w:1,instant:true,fn:(g)=>{g._nullfield=true;}},
  // LEGENDARY ADDITIONS
  {id:'soulbound', rarity:'legendary',name:'üíú Soulbound',     emoji:'üíú',short:'SOUL',    desc:'Each heart heals 1 life for 8s',       dur:8, w:1},
  {id:'apotheosis',rarity:'legendary',name:'üåå Apotheosis',    emoji:'üåå',short:'APEX',    desc:'5√ó pts + clear all bad items + magnet for 10s', dur:10,w:1,instant:true,fn:(g)=>{g._nullfield=true;}},
  {id:'heartquake',rarity:'legendary',name:'üí• Heartquake',    emoji:'üí•',short:'QUAKE',   desc:'5√ó pts + scatter 6 hearts + freeze bad for 12s', dur:12,w:1,instant:true,fn:(g)=>{g._nullfield=true;g._scatter=true;}},
  {id:'eclipse',   rarity:'legendary',name:'üåë Eclipse',        emoji:'üåë',short:'ECLI',    desc:'All bad items vanish + 5√ó pts + magnet for 15s', dur:15,w:1,instant:true,fn:(g)=>{g._nullfield=true;}},
  // LEGENDARY (tier unlocks at lv7)
  {id:'godmode',   rarity:'legendary',name:'üëë Queen Mode',     emoji:'üëë',short:'QUEEN',   desc:'2√ó pts + magnet + slow for 15s',       dur:15,w:1},
  {id:'xp_l',      rarity:'legendary',name:'üìö XP OVERDRIVE',   emoji:'üìö',short:'OVER',    desc:'+100% XP for 20s',                     dur:20,w:1},
  {id:'coins_xl',  rarity:'legendary',name:'üí∞ JACKPOT',        emoji:'üí∞',short:'JACK',    desc:'+60 coins now + 2√ó coins for 10s',     dur:10,w:1,instant:true,fn:(g)=>{g.coins+=60;g.P.coins+=60;g.P.coinsEarned+=60;}},
  {id:'phoenix',   rarity:'legendary',name:'üî• Phoenix',        emoji:'üî•',short:'PH≈íNIX',  desc:'Revive once with 3 HP',                dur:Infinity,w:1},
  {id:'omni',      rarity:'legendary',name:'‚ú® Omnipower',      emoji:'‚ú®',short:'OMNI',    desc:'3√ó pts + magnet + freeze bad + 20s',   dur:20,w:1},
  {id:'ultralife', rarity:'legendary',name:'üíñ Ultra Life',     emoji:'üíñ',short:'ULTRA',   desc:'+3 lives right now',                   dur:0, w:1,instant:true,fn:(g)=>{g.lives=Math.min(g.lives+3,8);}},
];

const RARITY_ORDER=['common','uncommon','rare','epic','legendary'];
const RARITY_LABELS={common:'COMMON',uncommon:'UNCOMMON',rare:'RARE',epic:'EPIC',legendary:'LEGENDARY'};

function getRarityPool(lv){
  const thresholds=[0,1,2,4,6]; // min lv to see common/uncommon/rare/epic/legendary
  return ALL_BUFFS.filter(b=>lv>=thresholds[RARITY_ORDER.indexOf(b.rarity)]+1);
}
function pickWeighted(pool){
  let r=Math.random()*pool.reduce((s,b)=>s+b.w,0);
  for(const b of pool){r-=b.w;if(r<=0)return b;}
  return pool[pool.length-1];
}
function pick3Buffs(lv,legendLuck){
  const pool=getRarityPool(lv);
  const chosen=[],used=new Set();
  for(let i=0;i<60&&chosen.length<3;i++){
    const b=pickWeighted(pool);
    if(!used.has(b.id)){used.add(b.id);chosen.push(b);}
  }
  if(legendLuck){
    for(let t=0;t<5;t++){
      const trial=[];const u2=new Set();
      for(let i=0;i<60&&trial.length<3;i++){const b=pickWeighted(pool);if(!u2.has(b.id)){u2.add(b.id);trial.push(b);}}
      if(trial.some(x=>x.rarity==='epic'||x.rarity==='legendary')){return trial;}
    }
  }
  return chosen;
}

// ===================== SHOP ITEMS =====================
const SHOP_ITEMS=[
  // ‚îÄ‚îÄ COMMON (20‚Äì38 coins) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'start_wide',       rarity:'common',   price:25,  icon:'üß∫', name:'Wider Start',       desc:'Begin each game with a wider basket',             cat:'Starter'},
  {id:'start_life',       rarity:'common',   price:30,  icon:'‚ù§Ô∏è', name:'Bonus Life',         desc:'Start with 4 lives instead of 3',                 cat:'Starter'},
  {id:'lucky_start',      rarity:'common',   price:28,  icon:'üçÄ', name:'Lucky Start',        desc:'Begin each game with Lucky Break active',         cat:'Starter'},
  {id:'potato_boost',     rarity:'common',   price:30,  icon:'ü•î', name:'Potato Lover',       desc:'Bao needs 1 fewer potato to trigger Nomnom',      cat:'Passive'},
  {id:'soft_landing',     rarity:'common',   price:22,  icon:'üõ¨', name:'Soft Landing',       desc:'First bad item each game does no damage',         cat:'Starter'},
  {id:'head_start',       rarity:'common',   price:35,  icon:'üå±', name:'Head Start',         desc:'Begin with +5 XP already banked',                 cat:'Starter'},
  {id:'pocket_change',    rarity:'common',   price:20,  icon:'ü™ô', name:'Pocket Change',      desc:'Start each game with +3 bonus coins',             cat:'Passive'},
  {id:'cozy_basket',      rarity:'common',   price:32,  icon:'üõãÔ∏è', name:'Cozy Basket',        desc:'Basket moves 15% faster to your finger',          cat:'Passive'},
  {id:'nomnom_buff',      rarity:'common',   price:28,  icon:'üçú', name:'Nomnom Buff',        desc:'Earn 1 bonus XP per 5 hearts caught',             cat:'Passive'},
  {id:'first_aid',        rarity:'common',   price:35,  icon:'üíä', name:'First Aid Kit',      desc:'Auto-recover 1 life when you hit 1 HP (once per game)', cat:'Combat'},
  // ‚îÄ‚îÄ UNCOMMON (50‚Äì80 coins) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'coin_mult',        rarity:'uncommon', price:55,  icon:'üí∞', name:'Coin Saver',         desc:'+25% coins earned per game',                      cat:'Passive'},
  {id:'xp_passive',       rarity:'uncommon', price:60,  icon:'‚ö°', name:'XP Booster',         desc:'+15% XP gain always',                             cat:'Passive'},
  {id:'slow_start',       rarity:'uncommon', price:50,  icon:'üï∞Ô∏è', name:'Easy Start',         desc:'Slower hearts for the first 30s',                 cat:'Starter'},
  {id:'heart_storm_start',rarity:'uncommon', price:55,  icon:'üåü', name:'Big Heart Mode',     desc:'Always active: hearts are 40% larger and easier to catch. Bad items fall 15% slower.',     cat:'Passive'},
  {id:'streak_shield',    rarity:'uncommon', price:65,  icon:'üîó', name:'Streak Guard',       desc:'Losing a life keeps your streak at half',         cat:'Passive'},
  {id:'second_wind',      rarity:'uncommon', price:70,  icon:'üí®', name:'Second Wind',        desc:'Once per game: auto-revive with 1 HP at 0',       cat:'Combat'},
  {id:'coin_hoarder',     rarity:'uncommon', price:72,  icon:'ü§ë', name:'Coin Hoarder',       desc:'End-game bonus coins doubled',                    cat:'Passive'},
  {id:'buff_extender',    rarity:'uncommon', price:68,  icon:'‚è±Ô∏è', name:'Buff Extender',      desc:'All timed buffs last 20% longer',                 cat:'Passive'},
  {id:'snack_break',      rarity:'uncommon', price:55,  icon:'üç°', name:'Snack Break',        desc:'After catching 20 hearts, earn +5 bonus coins',   cat:'Passive'},
  {id:'dudu_blessing',    rarity:'uncommon', price:75,  icon:'üß°', name:"Dudu's Blessing",    desc:'Start each game with streak beginning at 2',      cat:'Starter'},
  {id:'magnet_pulse',     rarity:'uncommon', price:58,  icon:'üß≤', name:'Magnet Pulse',       desc:'Every 30 hearts, auto-fire a 3s mini-magnet',     cat:'Passive'},
  // ‚îÄ‚îÄ RARE (90‚Äì130 coins) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'shield_start',     rarity:'rare',     price:90,  icon:'üõ°Ô∏è', name:'Starter Shield',     desc:'Begin each game with a shield active',            cat:'Starter'},
  {id:'streak_bonus',     rarity:'rare',     price:100, icon:'üî•', name:'Streak Master',      desc:'Streaks 5+ give +2 pts each',                     cat:'Passive'},
  {id:'xp_master',        rarity:'rare',     price:105, icon:'üìö', name:'XP Master',          desc:'+35% XP gain always (stacks with Booster)',       cat:'Passive'},
  {id:'bad_shrink',       rarity:'rare',     price:95,  icon:'üíÄ', name:'Bad Shrink',         desc:'Bad items are 35% smaller ‚Äî easier to dodge',     cat:'Combat'},
  {id:'triple_start',     rarity:'rare',     price:110, icon:'üåü', name:'Triple Ready',       desc:'Begin with 5s of Triple Points active',           cat:'Starter'},
  {id:'boss_bane',        rarity:'rare',     price:120, icon:'‚öîÔ∏è', name:'Boss Bane',          desc:'Boss HP is 20% lower at the start of fights',     cat:'Combat'},
  {id:'xp_overflow',      rarity:'rare',     price:115, icon:'üåä', name:'XP Overflow',        desc:'Excess XP after level-up carries over fully',     cat:'Passive'},
  {id:'golden_basket',    rarity:'rare',     price:125, icon:'‚ú®', name:'Golden Basket',      desc:'Catching 10+ streak gives +5 bonus coins',        cat:'Passive'},
  {id:'nomnom_king',      rarity:'rare',     price:108, icon:'üëë', name:'Nomnom King',        desc:'Bao potato passive gives +1 life AND +3 coins',   cat:'Passive'},
  {id:'coin_insurance',   rarity:'rare',     price:95,  icon:'üè¶', name:'Coin Insurance',     desc:'If you score 0 in a game, refund 10 coins',       cat:'Passive'},
  {id:'maroon_cloak',     rarity:'rare',     price:118, icon:'üü•', name:'Maroon Cloak',       desc:'Take 2 hits before losing a life (once per game)', cat:'Combat'},
  // ‚îÄ‚îÄ EPIC (160‚Äì230 coins) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'magnet_start',     rarity:'epic',     price:170, icon:'üß≤', name:'Born Magnetic',      desc:'Always have a mini magnet active',                 cat:'Passive'},
  {id:'double_coins',     rarity:'epic',     price:200, icon:'üíé', name:'Double Coins',       desc:'2√ó coins earned every game',                      cat:'Passive'},
  {id:'phoenix_start',    rarity:'epic',     price:210, icon:'üî•', name:'Born Phoenix',       desc:'Always start with Phoenix revive ready',           cat:'Starter'},
  {id:'armor',            rarity:'epic',     price:185, icon:'ü™ñ', name:'Armor Plating',      desc:'First hit each game does 0 damage',                cat:'Combat'},
  {id:'double_xp_start',  rarity:'epic',     price:190, icon:'‚ö°', name:'Hyper Study',        desc:'First 60s of every game: double XP gain',         cat:'Starter'},
  {id:'eternal_streak',   rarity:'epic',     price:220, icon:'‚ôæÔ∏è', name:'Eternal Streak',     desc:'Streaks never reset below 3 (ever)',               cat:'Passive'},
  {id:'boss_slayer',      rarity:'epic',     price:205, icon:'üó°Ô∏è', name:'Boss Slayer',        desc:'Defeating a boss gives a guaranteed Epic buff',    cat:'Combat'},
  {id:'coin_magnet',      rarity:'epic',     price:215, icon:'üí∞', name:'Coin Magnet',        desc:'+50% coins always AND +1 coin per heart caught',   cat:'Passive'},
  {id:'amber_heart',      rarity:'epic',     price:195, icon:'ü´Ä', name:"Amber's Heart",      desc:'Start with +1 life AND a shield AND Lucky Break',  cat:'Starter'},
  // ‚îÄ‚îÄ LEGENDARY (300‚Äì450 coins) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'legend_luck',      rarity:'legendary',price:320, icon:'üëë', name:"Queen's Luck",       desc:'Legendary buff odds tripled in all picks',         cat:'Passive'},
  {id:'omni_start',       rarity:'legendary',price:400, icon:'‚ú®', name:'Omni Aura',          desc:'Start every game with Omnipower buff (8s)',        cat:'Starter'},
  {id:'bao_legend',       rarity:'legendary',price:380, icon:'ü•ü', name:'Legendary Bao',      desc:'Start as level 2 with 5 lives and Lucky Break',   cat:'Starter'},
  {id:'weeknd_mode',      rarity:'legendary',price:450, icon:'üåô', name:'Weeknd Mode',        desc:'Night theme: heart scores +1 and coins +50% always', cat:'Passive'},
  {id:'dudu_ultimate',    rarity:'legendary',price:420, icon:'üß°', name:"Dudu's Ultimate",    desc:'All buffs last 40% longer AND XP doubled always',  cat:'Passive'},
  {id:'kovan_memory_shop',rarity:'legendary',price:350, icon:'üíå', name:'Kovan Memory',       desc:'Game start: +3 lives, shield, and 8 bonus hearts', cat:'Starter'},
  // ‚îÄ‚îÄ NEW COMMON ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'soft_landing',     rarity:'common',   price:22,  icon:'üå∏', name:'Soft Landing',       desc:'Missing a heart only costs 0.5 streak (rounded down)', cat:'Combat'},
  {id:'warm_start',       rarity:'common',   price:25,  icon:'‚òï', name:'Warm Start',         desc:'Start each game with streak already at 2',             cat:'Starter'},
  {id:'candy_heart',      rarity:'common',   price:18,  icon:'üç¨', name:'Candy Heart',        desc:'Every 10th heart caught gives +1 bonus coin',          cat:'Passive'},
  {id:'lucky_charm',      rarity:'common',   price:30,  icon:'üçÄ', name:'Lucky Charm',        desc:'5% chance any bad item becomes a heart instead',       cat:'Combat'},
  // ‚îÄ‚îÄ NEW UNCOMMON ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'heart_magnet',     rarity:'uncommon', price:62,  icon:'üß≤', name:'Heart Magnet',       desc:'Hearts drift toward basket from up to 20px away',      cat:'Passive'},
  {id:'extra_time',       rarity:'uncommon', price:58,  icon:'‚è≥', name:'Time Cushion',       desc:'Game lasts 15 extra seconds before speed peaks',       cat:'Passive'},
  {id:'life_saver',       rarity:'uncommon', price:70,  icon:'üíä', name:'Life Saver',         desc:'Once per game, a lethal hit leaves you at 1 HP instead', cat:'Combat'},
  {id:'xp_rush',          rarity:'uncommon', price:55,  icon:'üìà', name:'XP Rush',            desc:'First 20 hearts each game give 2√ó XP',                 cat:'Passive'},
  {id:'coin_shower',      rarity:'uncommon', price:65,  icon:'üåßÔ∏è', name:'Coin Shower',        desc:'After each boss kill, earn +8 bonus coins immediately', cat:'Passive'},
  // ‚îÄ‚îÄ NEW RARE ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'basket_bumper',    rarity:'rare',     price:115, icon:'ü™É', name:'Basket Bumper',      desc:'Basket catches hearts 6px beyond each edge (wider reach)', cat:'Combat'},
  {id:'streak_fire',      rarity:'rare',     price:105, icon:'üî•', name:'Streak Fire',        desc:'At streak 8+, every catch scores +2 extra pts',        cat:'Passive'},
  {id:'diamond_rain',     rarity:'rare',     price:120, icon:'üíé', name:'Diamond Rain',       desc:'Earn +1 diamond for every 5 hearts caught in a game',  cat:'Passive'},
  {id:'heart_echo',       rarity:'rare',     price:98,  icon:'üíû', name:'Heart Echo',         desc:'Every 15th catch spawns a bonus free heart instantly',  cat:'Passive'},
  // ‚îÄ‚îÄ NEW EPIC ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'overdrive',        rarity:'epic',     price:230, icon:'‚ö°', name:'Overdrive',          desc:'After level-up: 10s of 3√ó score and magnet',           cat:'Combat'},
  {id:'golden_heart',     rarity:'epic',     price:210, icon:'üíõ', name:'Golden Heart',       desc:'+2 coins per heart always AND streak bonus at 3 (not 5)', cat:'Passive'},
  {id:'shield_wall',      rarity:'epic',     price:195, icon:'üõ°Ô∏è', name:'Shield Wall',        desc:'Start with 2 shields. Shields recharge 1 per boss kill', cat:'Starter'},
  // ‚îÄ‚îÄ NEW LEGENDARY ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'heart_empress',    rarity:'legendary',price:480, icon:'üë∏', name:'Heart Empress',      desc:'All hearts worth +2pts. Bad items fall 20% slower. Start with 2 shields.', cat:'Passive'},
  {id:'infinite_nomnom',  rarity:'legendary',price:460, icon:'üçú', name:'Infinite Nomnom',   desc:'Bao needs only 3 potatoes (not 5) AND potato gives +1 life AND +5 coins', cat:'Passive'},
];

// ===================== PERSISTENT STORAGE =====================
let P=JSON.parse(localStorage.getItem('bao_v4')||'null')||{
  highScore:0,highLevel:1,totalHearts:0,gamesPlayed:0,bestStreak:0,
  coinsEarned:0,itemsBought:0,buffsPicked:0,bestXP:0,legendaryRolled:0,
  baogames:0,dudugames:0,steamShields:0,angryAura:0,bossesDefeated:0,
  achievedLevels:[1],coins:0,diamonds:0,owned:[],bubuUnlocked:false,bubugames:0,
};
function saveP(){localStorage.setItem('bao_v4',JSON.stringify(P));}
function updateWalletDisplays(){
  if(!P.diamonds) P.diamonds=0;
  document.getElementById('shop-wallet').textContent=P.coins;
  const sdw=document.getElementById('shop-diamond-wallet');
  if(sdw) sdw.textContent=P.diamonds;
  const gdd=document.getElementById('gacha-diamond-display');
  if(gdd) gdd.textContent=P.diamonds;
}

// ===================== CANVAS =====================
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const overlay=document.getElementById('overlay');
let W,H;
function resize(){
  const wrap=document.getElementById('canvas-wrap');
  const cw=wrap.clientWidth;
  W=canvas.width=cw>0?cw:(window.innerWidth>700?Math.min(660,window.innerWidth-40):window.innerWidth-24);
  H=canvas.height=window.innerWidth<700
    ? Math.round(Math.min(360,window.innerHeight*0.44))
    : Math.round(Math.min(540,window.innerHeight*0.60));
}
resize();
window.addEventListener('resize',resize);

const BASE_W=70,BH=22;
const HEART_EMO=['üíï','üß°','üíõ','üå∏','üíñ','üíó'];
const BAD_EMO=['üíÄ','üî•','üñ§','ü¶†','üòà'];

let basket={x:0};
let items=[],popups=[];
let score=0,lives=3,xp=0,level=1,frame=0; // running declared above
let streak=0,sessionHearts=0,coins=0,sessionXP=0;
let activeBuffs=[];
let shieldsLeft=0,phoenixReady=false;
let potatoCount=0; // Bao passive: potatoes collected

// ===================== BOSS STATE =====================
let bossActive=false,bossHP=0,bossMaxHP=0,bossX=0,bossDir=1,bossFrame=0;
let bossPhase=0; // 0=idle/patrol, 1=charging, 2=rage
let bossNextSpawn=0,bossShot=[];
let bossDefeated=0; // total bosses defeated this run
let passiveCharge=0; // Bao: counts hearts toward next steam shield
let st={};

function shopHas(id){return P.owned.includes(id);}
function maxLives(){return shopHas('start_life')?4:3;}

function computeState(){
  st={bw:1,sm:1,x2:false,x3:false,x4:false,x5:false,magnet:false,xpM:1,freezeBad:false,coinM:1,streakBonus:false,coinX2:false,
      streakSave:false,timeFrozen:false,ghost:false,coinPerHeart:0,rallyBonus:0,starburstBonus:false,heartstorm:false,bigHeartMode:false,
      doubleshotter:false,lifesteal:false,soulbound:false,badShrink:false};
  if(shopHas('start_wide'))  st.bw=Math.max(st.bw,1.3);
  if(shopHas('xp_passive'))  st.xpM=Math.max(st.xpM,1.15);
  if(shopHas('coin_mult'))   st.coinM=Math.max(st.coinM,1.25);
  if(shopHas('streak_bonus'))st.streakBonus=true;
  if(shopHas('magnet_start'))st.magnet=true;
  if(shopHas('double_coins'))st.coinM=Math.max(st.coinM,2);
  if(shopHas('xp_master'))   st.xpM=Math.max(st.xpM,1.35);
  if(shopHas('heart_storm_start')) st.bigHeartMode=true;
  if(shopHas('armor'))       st.armor=true;
  if(shopHas('bad_shrink'))  st.badShrink=true;

  activeBuffs=activeBuffs.filter(b=>b.endsAt===Infinity||b.endsAt>frame);
  for(const b of activeBuffs){
    if(b.id==='wide_s')    st.bw=Math.max(st.bw,1.3);
    if(b.id==='wide_m')    st.bw=Math.max(st.bw,1.5);
    if(b.id==='wide_l')    st.bw=Math.max(st.bw,1.8);
    if(b.id==='slow_s')    st.sm=Math.min(st.sm,.8);
    if(b.id==='slow_m')    st.sm=Math.min(st.sm,.65);
    if(b.id==='slow_l')    st.sm=Math.min(st.sm,.45);
    if(b.id==='magnet_s'||b.id==='magnet_m') st.magnet=true;
    if(b.id==='double')    st.x2=true;
    if(b.id==='triple')    st.x3=true;
    if(b.id==='frenzy')    st.x4=true;
    if(b.id==='xp_s')      st.xpM=Math.max(st.xpM,1.2);
    if(b.id==='xp_m')      st.xpM=Math.max(st.xpM,1.6);
    if(b.id==='xp_l')      st.xpM=Math.max(st.xpM,2.0);
    if(b.id==='freeze')    st.freezeBad=true;
    if(b.id==='coins_xl')  st.coinX2=true;
    if(b.id==='streak_up') st.streakSave=true;
    if(b.id==='timewarp')  st.timeFrozen=true;
    if(b.id==='ghost')     st.ghost=true;
    if(b.id==='coinrain')  st.coinPerHeart=3;
    if(b.id==='rally')     st.rallyBonus=1;
    if(b.id==='rallyplus') st.rallyBonus=Math.max(st.rallyBonus,3);
    if(b.id==='coinboost_boss') st.coinPerHeart=Math.max(st.coinPerHeart,3);
    if(b.id==='starburst') {st.starburstBonus=true;}
    if(b.id==='heartstorm') st.heartstorm=true;
    if(b.id==='omni')       {st.x3=true;st.magnet=true;st.freezeBad=true;}
    if(b.id==='godmode')    {st.x2=true;st.magnet=true;st.sm=Math.min(st.sm,.7);}
    // NEW BUFFS
    if(b.id==='heartboost') st.rallyBonus=Math.max(st.rallyBonus,2);
    if(b.id==='miniwall')   st.badShrink=true;
    if(b.id==='xp_streak'&&streak>=3) st.xpM=Math.max(st.xpM,2.0);
    if(b.id==='bounty')     st.coinPerHeart=Math.max(st.coinPerHeart,2);
    if(b.id==='doubleshot') st.doubleshotter=true;
    if(b.id==='overclock')  {st.x2=true;st.sm=Math.max(st.sm,1.5);}
    if(b.id==='overcharge') st.x5=true;
    if(b.id==='lifesteal')  st.lifesteal=true;
    if(b.id==='vortex')     {st.x3=true;st.magnet=true;st.freezeBad=true;}
    if(b.id==='soulbound')  st.soulbound=true;
    if(b.id==='apotheosis') {st.x5=true;st.magnet=true;st.freezeBad=true;}
    // new buffs
    if(b.id==='tailwind')   {st.bw=Math.max(st.bw,1.25);st.rallyBonus=Math.max(st.rallyBonus,1);}
    if(b.id==='warmup')     {st.xpM=Math.max(st.xpM,1.1);st.coinM=Math.max(st.coinM,1.1);}
    if(b.id==='shieldplus') {if(shieldsLeft<2) shieldsLeft=2;} // handled once below
    if(b.id==='breezy')     {st.sm=Math.min(st.sm,.75);st.bw=Math.max(st.bw,1.2);}
    if(b.id==='caffeinate') st.xpM=Math.max(st.xpM,1.15);
    if(b.id==='goldrain')   st.coinPerHeart=Math.max(st.coinPerHeart,5);
    if(b.id==='timegod')    {st.timeFrozen=true;st.x3=true;}
    if(b.id==='supernova')  {st.x4=true;st.freezeBad=true;}
    if(b.id==='heartquake') {st.x5=true;st.magnet=true;st.freezeBad=true;}
    if(b.id==='eclipse')    {st.x5=true;st.magnet=true;st.freezeBad=true;}
  }
  // Apply equipped pet passive bonuses
  petApplyState(st);
  // New shop items passive effects
  if(shopHas('cozy_basket'))    st.bw=Math.max(st.bw,1.15);
  if(shopHas('coin_magnet'))   {st.coinM=Math.max(st.coinM,1.5);st.coinPerHeart=Math.max(st.coinPerHeart||0,1);}
  if(shopHas('weeknd_mode'))   {st.rallyBonus=Math.max(st.rallyBonus||0,1);st.coinM=Math.max(st.coinM,1.5);}
  if(shopHas('dudu_ultimate')) {st.xpM=Math.max(st.xpM||1,2);} // buff extend handled in buff loop
  if(shopHas('eternal_streak')) window._petStreakGuard=true;
  if(shopHas('streak_shield'))  window._petStreakGuard=true;
  // New shop items
  if(shopHas('heart_magnet'))   st.magnet=true;
  if(shopHas('lucky_charm'))    st._luckyCharm=true;
  if(shopHas('basket_bumper'))  st._bumper=true;
  if(shopHas('streak_fire'))    st._streakFire=true;
  if(shopHas('golden_heart'))   {st.coinPerHeart=Math.max(st.coinPerHeart||0,2);st.streakBonus=true;}
  if(shopHas('shield_wall'))    st._shieldWall=true;
  if(shopHas('heart_empress'))  {st.rallyBonus=Math.max(st.rallyBonus||0,2);st.badShrink=true;st.sm=Math.min(st.sm,0.8);}
  if(shopHas('infinite_nomnom')&&currentChar==='bao') st._infiniteNomnom=true;
  if(shopHas('overdrive'))      st._overdrive=true;
}

// ===================== HUD =====================
function lvData(lv){return LEVELS[Math.min(lv,LEVELS.length)-1];}
function xpNeeded(lv){return lvData(lv)?.xpNeeded??9999;}

function updateHUD(){
  const ch=CHARS[currentChar];
  document.getElementById('scoreDisplay').textContent=score;
  document.getElementById('coinsDisplay').textContent=coins;
  const d=lvData(level);
  const badge=document.getElementById('hud-level-badge');
  badge.textContent=`Lv.${level} ${d.title}`;
  badge.style.background=d.color;
  document.getElementById('hud-passive-chip').textContent=`${ch.emoji} ${ch.name} passive: ${ch.passive} ‚Äî ${ch.passiveDesc}`;

  const pct=Math.min(100,xp/xpNeeded(level)*100);
  document.getElementById('xp-bar').style.width=pct+'%';
  document.getElementById('hp-bar').style.width=(lives/Math.max(1,maxLives())*100)+'%';

  // Passive bar
  if(currentChar==='bao'){
    document.getElementById('passive-bar-label').textContent=`ü•î ${potatoCount}/5`;
    document.getElementById('passive-bar').style.background=CHARS.bao.passiveBarColor;
    document.getElementById('passive-bar').style.width=(potatoCount/CHARS.bao.passiveTrigger*100)+'%';
  } else if(currentChar==='bubu'){
    document.getElementById('passive-bar-label').textContent=`üõçÔ∏è ${passiveCharge}/5`;
    document.getElementById('passive-bar').style.background=CHARS.bubu.passiveBarColor;
    document.getElementById('passive-bar').style.width=(passiveCharge/CHARS.bubu.passiveTrigger*100)+'%';
  } else {
    document.getElementById('passive-bar-label').textContent='AURA';
    document.getElementById('passive-bar').style.background=CHARS.dudu.passiveBarColor;
    document.getElementById('passive-bar').style.width=duduAuraReady?100:Math.min(100,(streak/5)*100)+'%';
  }
  document.getElementById('xp-label').textContent=`${xp} / ${xpNeeded(level)} XP`;

  const row=document.getElementById('buffs-row');
  row.innerHTML='';
  for(const b of activeBuffs){
    const chip=document.createElement('div');
    chip.className=`buff-chip rarity-${b.rarity}`;
    const left=b.endsAt===Infinity?'‚àû':Math.max(0,Math.ceil((b.endsAt-frame)/60))+'s';
    chip.innerHTML=`${b.emoji} ${b.short} <span class="bt">${left}</span>`;
    row.appendChild(chip);
  }
  const msgs=['Catch hearts, avoid ‚úñÔ∏è!','Keep going! üíï','Streak on fire! üî•','Heart wizard! üå∏','LEGENDARY! üåü'];
  document.getElementById('game-msg').textContent=msgs[Math.min(Math.floor(score/12),msgs.length-1)];
}

function updateStatsPanel(){
  document.getElementById('st-hs').textContent=P.highScore;
  const hero=document.getElementById('st-hs-hero');if(hero)hero.textContent=P.highScore||0;
  document.getElementById('st-lv').textContent=P.highLevel;
  document.getElementById('st-hc').textContent=P.totalHearts;
  document.getElementById('st-gp').textContent=P.gamesPlayed;
  document.getElementById('st-st').textContent=P.bestStreak;
  document.getElementById('st-ce').textContent=P.coinsEarned;
  const stDm=document.getElementById('st-dm');if(stDm)stDm.textContent=P.diamonds||0;
  document.getElementById('st-ip').textContent=P.itemsBought;
  document.getElementById('st-bp').textContent=P.buffsPicked;
  document.getElementById('st-xp').textContent=P.bestXP;
  document.getElementById('st-leg').textContent=P.legendaryRolled;
  document.getElementById('st-bg').textContent=P.baogames;
  document.getElementById('st-dg').textContent=P.dudugames;
  document.getElementById('st-ss').textContent=P.steamShields;
  document.getElementById('st-aa').textContent=P.angryAura;
  document.getElementById('st-bd').textContent=(P.bossesDefeated||0);
  const setBar=(id,val,max)=>{
    document.getElementById(id).style.width=Math.min(100,val/max*100)+'%';
    document.getElementById(id+'-val').textContent=`${val} / ${max}`;
  };
  setBar('prog-hc',P.totalHearts,100);
  setBar('prog-gp',P.gamesPlayed,20);
  setBar('prog-ce',P.coinsEarned,500);
  setBar('prog-st',P.bestStreak,20);
  renderUnlocks();
  updateWalletDisplays();
}

function renderUnlocks(){
  const list=document.getElementById('unlocks-list');
  list.innerHTML='';
  LEVELS.forEach(l=>{
    const ach=P.achievedLevels.includes(l.level);
    const div=document.createElement('div');
    div.className='unlock-item'+(ach?' achieved':'');
    div.innerHTML=`<span class="unlock-icon" style="color:${l.color}">${ach?'üîì':'üîí'}</span>
      <div><div class="unlock-name">Level ${l.level} ‚Äî ${l.title}</div>
      <div class="unlock-desc">${ach?l.desc:`Reach level ${l.level} to unlock`}</div></div>`;
    list.appendChild(div);
  });
}

// ‚îÄ‚îÄ Shop state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let shopCurrentCat = 'all';
let shopCurrentRar = 'all';
let shopCurrentPage = 1;
const SHOP_PAGE_SIZE = 8;

function setShopCat(cat){
  shopCurrentCat = cat;
  shopCurrentPage = 1;
  document.querySelectorAll('.shop-cat-btn').forEach(b=>b.classList.toggle('active',b.dataset.cat===cat));
  renderShop();
}
function setShopRar(rar){
  shopCurrentRar = rar;
  shopCurrentPage = 1;
  document.querySelectorAll('.shop-rar-btn').forEach(b=>b.classList.toggle('active',b.dataset.rar===rar));
  renderShop();
}
function setShopPage(p){
  shopCurrentPage = p;
  renderShop();
}

function renderShop(){
  updateWalletDisplays();
  // Filter
  let items = SHOP_ITEMS.filter(it=>{
    if(shopCurrentCat !== 'all' && it.cat !== shopCurrentCat) return false;
    if(shopCurrentRar !== 'all' && it.rarity !== shopCurrentRar) return false;
    return true;
  });
  const totalPages = Math.max(1, Math.ceil(items.length / SHOP_PAGE_SIZE));
  if(shopCurrentPage > totalPages) shopCurrentPage = 1;
  const pageItems = items.slice((shopCurrentPage-1)*SHOP_PAGE_SIZE, shopCurrentPage*SHOP_PAGE_SIZE);

  const grid = document.getElementById('shop-grid');
  grid.innerHTML = '';
  if(pageItems.length === 0){
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:1.5rem;font-style:italic;opacity:.5;font-size:.85rem;">Nothing here yet!</div>';
  }
  for(const item of pageItems){
    const owned = P.owned.includes(item.id);
    const afford = P.coins >= item.price;
    const div = document.createElement('div');
    div.className = `shop-item si-${item.rarity}${owned?' owned':!afford?' cant-afford':''}`;
    div.innerHTML = `<div class="shop-item-icon">${item.icon}</div>
      <div class="shop-item-name">${item.name}</div>
      <div class="shop-item-desc">${item.desc}</div>
      ${owned ? '<div class="shop-item-owned">‚úì Owned</div>' : `<div class="shop-item-price">üí∞ ${item.price}</div>`}`;
    if(!owned && afford) div.addEventListener('click', ()=>buyItem(item));
    grid.appendChild(div);
  }

  // Pagination dots/buttons
  const pages = document.getElementById('shop-pages');
  pages.innerHTML = '';
  if(totalPages > 1){
    // Prev button
    const prev = document.createElement('button');
    prev.textContent = '‚Äπ';
    prev.className = 'shop-page-btn';
    prev.disabled = shopCurrentPage === 1;
    prev.onclick = ()=>setShopPage(shopCurrentPage-1);
    pages.appendChild(prev);
    // Page dots
    for(let i=1;i<=totalPages;i++){
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = 'shop-page-btn' + (i===shopCurrentPage?' active':'');
      btn.onclick = (()=>{const p=i;return()=>setShopPage(p);})();
      pages.appendChild(btn);
    }
    // Next button
    const next = document.createElement('button');
    next.textContent = '‚Ä∫';
    next.className = 'shop-page-btn';
    next.disabled = shopCurrentPage === totalPages;
    next.onclick = ()=>setShopPage(shopCurrentPage+1);
    pages.appendChild(next);
    // Page info
    const info = document.createElement('div');
    info.style.cssText='font-size:.65rem;color:var(--deep);opacity:.55;width:100%;text-align:center;margin-top:3px;';
    info.textContent = `${(shopCurrentPage-1)*SHOP_PAGE_SIZE+1}‚Äì${Math.min(shopCurrentPage*SHOP_PAGE_SIZE,items.length)} of ${items.length} items`;
    pages.appendChild(info);
  }
}

function buyItem(item){
  if(P.coins<item.price||P.owned.includes(item.id)) return;
  P.coins-=item.price; P.owned.push(item.id); P.itemsBought++; saveP();
  playBuySound();
  // Apply immediate effects for new items
  applyNewShopItem(item.id);
  renderShop(); updateStatsPanel(); showToast(`${item.icon} ${item.name} purchased!`);
}

function applyNewShopItem(id){
  // Items that give immediate game-start bonuses don't need runtime application
  // Items with runtime effects are handled in computeState / game loop
}

function showToast(msg){
  let t=document.getElementById('toast');
  if(!t){t=document.createElement('div');t.id='toast';
    Object.assign(t.style,{position:'fixed',bottom:'80px',left:'50%',transform:'translateX(-50%)',
    background:'#3D2B1F',color:'#FDF6EC',padding:'.5rem 1.2rem',borderRadius:'20px',
    fontFamily:'Playfair Display,serif',fontSize:'.85rem',zIndex:'999',
    transition:'opacity .4s',boxShadow:'0 4px 16px rgba(0,0,0,.3)'});
    document.body.appendChild(t);}
  t.textContent=msg;t.style.opacity='1';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity='0',2200);
}

// ===================== SPAWN =====================
function gameSecs(){return Math.min(frame/60,180);}

function spawnItem(){
  const isBad=Math.random()<(0.09+level*0.01);
  const t=gameSecs();
  // Smoother speed curve: starts a bit livelier, ramps more gradually
  // Old: base = 0.8 + (t/180)*1.7 + level*0.06  ‚Äî level bump was too sharp
  // New: level contributes less (0.035 per level), time ramp is gentler early using sqrt
  const timeRamp=(t/180)*1.4;          // max +1.4 over full game (was 1.7)
  const lvRamp=level*0.035;            // +0.035 per level (was 0.06)
  const base=0.85+timeRamp+lvRamp;
  let spd=Math.min(2.8,base*(0.88+Math.random()*0.24))*st.sm;  // cap lowered 3.0‚Üí2.8
  const itemSize = st.bigHeartMode ? 31 : 22;
  if(shopHas('slow_start')&&frame<30*60) spd*=0.6;
  const badSpd = st.bigHeartMode ? spd * 0.85 : spd;
  items.push(petDeerlingFilter({
    x:22+Math.random()*(W-44),y:-24,
    vy:isBad&&st.freezeBad?0.3:isBad?badSpd:spd,
    emoji:isBad?BAD_EMO[Math.floor(Math.random()*BAD_EMO.length)]:HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)],
    bad:isBad,size:itemSize,frozen:isBad&&st.freezeBad,
  }));
}

// ===================== GAME LOOP =====================
function gameLoop(){
  if(!running) return;
  frame++;
  computeState();
  petTickFrame();

  // Vacuum: snap all hearts to basket immediately
  if(st._vacuum){
    st._vacuum=false;
    items.filter(it=>!it.bad&&!it.isPotato).forEach(it=>{it.x=basket.x;it.y=H-BH-20;});
  }
  // Scatter: spawn 6 bonus hearts instantly
  if(st._scatter){
    st._scatter=false;
    const _sv=Math.min(2.7,(0.8+(gameSecs()/180)*1.5)*st.sm);
    for(let _i=0;_i<6;_i++){
      items.push({x:28+Math.random()*(W-56),y:-28-(Math.random()*80),
        vy:_sv*(0.85+Math.random()*0.3),
        emoji:HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)],
        bad:false,size:22,frozen:false,warn:0,spawnFrame:frame});
    }
  }
  // Nullfield: remove all bad items from screen
  if(st._nullfield){
    st._nullfield=false;
    items=items.filter(it=>!it.bad);
    bossShot=[];
    showPopup('üö´ Bad items cleared!',W/2,H/2,'#aaa');
  }

  const _t=gameSecs();
  // Spawn rate: starts at 160 frames (~2.7s gap), ramps to ~38 at the end
  // Old: 150 - (t/180)*110 - level*1.5  ‚Äî got dense too quickly
  // New: higher start, gentler time ramp, level contributes less
  const rate=Math.max(38,Math.round(165-(_t/180)*105-level*1.2));
  if(frame%rate===0&&!st.timeFrozen){
    spawnItem();
    if(_t>90&&level>=3&&Math.random()<Math.min(0.55,(_t-90)/160)){
      // Stagger: give the extra item a head start offset so it doesn't land at same time
      const _staggerY = -(28 + Math.random()*60);
      const _staggerVy = Math.min(2.8,(0.85+(_t/180)*1.4+level*0.035)*(0.78+Math.random()*0.24)*st.sm);
      const _isBad2 = Math.random()<(0.09+level*0.01);
      items.push(petDeerlingFilter({x:22+Math.random()*(W-44),y:_staggerY,vy:_staggerVy,
        emoji:_isBad2?BAD_EMO[Math.floor(Math.random()*BAD_EMO.length)]:HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)],
        bad:_isBad2,size:st.bigHeartMode?31:22,frozen:_isBad2&&st.freezeBad}));
    }
    if(_t>150&&level>=6&&Math.random()<Math.min(0.4,(_t-150)/120)){
      const _staggerY2 = -(55 + Math.random()*80);
      const _staggerVy2 = Math.min(2.8,(0.85+(_t/180)*1.4+level*0.035)*(0.72+Math.random()*0.24)*st.sm);
      const _isBad3 = Math.random()<(0.09+level*0.01);
      items.push(petDeerlingFilter({x:22+Math.random()*(W-44),y:_staggerY2,vy:_staggerVy2,
        emoji:_isBad3?BAD_EMO[Math.floor(Math.random()*BAD_EMO.length)]:HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)],
        bad:_isBad3,size:st.bigHeartMode?31:22,frozen:_isBad3&&st.freezeBad}));
    }
    if(st.heartstorm&&Math.random()<.65){
      const _hs=Math.min(2.6,(0.8+(_t/180)*1.4)*st.sm);
      const _hsStagger = -(20 + Math.random()*50);
      items.push({x:22+Math.random()*(W-44),y:_hsStagger,vy:_hs,emoji:HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)],bad:false,size:22,frozen:false});
    }
  }
  if(currentChar==='bao'&&frame%220===0&&Math.random()<(0.28+(_t/180)*0.38)){
    const _ps=Math.min(2.4,(0.75+(_t/180)*1.1)*st.sm);
    items.push({x:22+Math.random()*(W-44),y:-24,vy:_ps,emoji:'ü•î',bad:false,isPotato:true,size:20,frozen:false});
  }
  if(currentChar==='bubu'&&frame%220===0&&Math.random()<(0.28+(_t/180)*0.38)){
    const _bs=Math.min(2.4,(0.75+(_t/180)*1.1)*st.sm);
    items.push({x:22+Math.random()*(W-44),y:-24,vy:_bs,emoji:'üõçÔ∏è',bad:false,isShopbag:true,size:20,frozen:false});
  }
  ctx.clearRect(0,0,W,H);
  // Draw background so canvas isn't transparent
  drawGameBackground();
  if(level>=5) drawStars();
  updateBoss();

  const ch=CHARS[currentChar];
  const bw=BASE_W*st.bw;
  const bx=basket.x-bw/2,by=H-BH-10;

  // ‚îÄ‚îÄ BASKET PARTICLE SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!window._bParticles) window._bParticles=[];
  const bp=window._bParticles;
  // Spawn particles per character
  if(running && frame%3===0){
    if(currentChar==='bao'){
      // Warm steamy wisps
      bp.push({x:bx+8+Math.random()*(bw-16),y:by,vx:(Math.random()-.5)*0.6,vy:-0.8-Math.random()*0.5,
        life:1,maxLife:40+Math.random()*20,r:3+Math.random()*3,
        color:`hsl(${25+Math.random()*20},90%,${75+Math.random()*15}%)`,type:'wisp'});
    } else if(currentChar==='dudu'){
      // Warm amber honey sparks
      if(Math.random()<0.6) bp.push({x:bx+Math.random()*bw,y:by+Math.random()*BH,
        vx:(Math.random()-.5)*2,vy:-0.8-Math.random()*1.2,
        life:1,maxLife:20+Math.random()*14,r:2+Math.random()*2.5,
        color:`hsl(${28+Math.random()*24},85%,${52+Math.random()*20}%)`,type:'spark'});
    } else if(currentChar==='bubu'){
      // Black and white panda paw prints / petals
      if(Math.random()<0.45) bp.push({x:bx+Math.random()*bw,y:by,
        vx:(Math.random()-.5)*1.0,vy:-0.5-Math.random()*0.7,
        life:1,maxLife:38+Math.random()*22,r:3+Math.random()*2.5,
        color:Math.random()<0.5?`rgba(30,30,30,0.8)`:`rgba(240,240,240,0.85)`,type:'petal',
        rot:Math.random()*Math.PI*2,rotV:(Math.random()-.5)*0.1});
    }
  }
  // Update & draw particles
  for(let i=bp.length-1;i>=0;i--){
    const p=bp[i];
    p.x+=p.vx; p.y+=p.vy; p.life-=1/p.maxLife;
    if(p.life<=0){bp.splice(i,1);continue;}
    const alpha=p.life*(p.life<0.3?p.life/0.3:1);
    ctx.save(); ctx.globalAlpha=alpha;
    if(p.type==='wisp'){
      const g2=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*2);
      g2.addColorStop(0,p.color); g2.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=g2; ctx.beginPath(); ctx.arc(p.x,p.y,p.r*2,0,Math.PI*2); ctx.fill();
    } else if(p.type==='spark'){
      ctx.strokeStyle=p.color; ctx.lineWidth=1.5; ctx.shadowBlur=6; ctx.shadowColor=p.color;
      ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p.x-p.vx*4,p.y-p.vy*4); ctx.stroke();
    } else if(p.type==='petal'){
      p.rot+=p.rotV;
      ctx.translate(p.x,p.y); ctx.rotate(p.rot);
      ctx.fillStyle=p.color; ctx.shadowBlur=4; ctx.shadowColor=p.color;
      ctx.beginPath(); ctx.ellipse(0,0,p.r,p.r*0.6,0,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }

  // ‚îÄ‚îÄ CHARACTER BASKET DRAWING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const t=frame; // time for animation

  if(currentChar==='bao'){
    // ‚îÄ‚îÄ BAO: fluffy steamed bun basket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const pulse=Math.sin(t*0.06)*1.5; // gentle float/breathe
    const rainbowMode=level>=7;

    // Outer glow
    ctx.save();
    ctx.shadowBlur=rainbowMode?28:20;
    ctx.shadowColor=rainbowMode?`hsl(${t*2%360},80%,65%)`:'#F4A56A';
    if(activeBuffs.length>0||level>=6){
      ctx.shadowBlur=26; ctx.shadowColor=lvData(level).color;
    }

    // Bun body (rounded rect with slight dome top)
    if(rainbowMode){
      const rg=ctx.createLinearGradient(bx,0,bx+bw,0);
      rg.addColorStop(0,'#FF9ECD'); rg.addColorStop(.5,'#FFD700'); rg.addColorStop(1,'#6FCCAA');
      ctx.fillStyle=rg;
    } else {
      const bg=ctx.createLinearGradient(bx,by+pulse,bx+bw,by+BH+pulse);
      bg.addColorStop(0,'#FDE8D0'); bg.addColorStop(0.4,'#F4A56A'); bg.addColorStop(1,'#E8875A');
      ctx.fillStyle=bg;
    }
    ctx.beginPath(); ctx.roundRect(bx,by+pulse,bw,BH,10); ctx.fill();

    // Shiny top highlight (bun shine)
    ctx.fillStyle='rgba(255,255,255,0.35)';
    ctx.beginPath(); ctx.ellipse(basket.x-bw*0.1,by+pulse+4,bw*0.28,4,0,0,Math.PI*2); ctx.fill();

    // Steamer fold lines (the pleats of a bao)
    ctx.strokeStyle='rgba(220,150,100,0.5)'; ctx.lineWidth=1;
    for(let i=1;i<4;i++){
      const lx=bx+bw*i/4;
      ctx.beginPath(); ctx.moveTo(lx,by+pulse+3); ctx.lineTo(lx,by+pulse+BH-4); ctx.stroke();
    }

    // Bao face ‚Äî tiny happy eyes + blush
    const fcx=basket.x, fcy=by+pulse+BH*0.48;
    ctx.fillStyle='#5A2D0C';
    // eyes
    ctx.beginPath(); ctx.arc(fcx-8,fcy-1,2,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(fcx+8,fcy-1,2,0,Math.PI*2); ctx.fill();
    // smile
    ctx.strokeStyle='#5A2D0C'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.arc(fcx,fcy+2,5,0.1,Math.PI-0.1); ctx.stroke();
    // blush circles
    ctx.fillStyle='rgba(255,150,100,0.35)';
    ctx.beginPath(); ctx.ellipse(fcx-11,fcy+2,4,2.5,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(fcx+11,fcy+2,4,2.5,0,0,Math.PI*2); ctx.fill();

    // Steam wisps above bun
    ctx.strokeStyle='rgba(255,220,180,0.5)'; ctx.lineWidth=2; ctx.lineCap='round';
    for(let s=0;s<3;s++){
      const sx=bx+bw*(0.25+s*0.25), steamWave=Math.sin(t*0.08+s*1.2)*3;
      ctx.beginPath();
      ctx.moveTo(sx,by+pulse-4);
      ctx.quadraticCurveTo(sx+steamWave,by+pulse-10,sx,by+pulse-16);
      ctx.stroke();
    }
    ctx.restore();

  } else if(currentChar==='dudu'){
    // ‚îÄ‚îÄ DUDU: warm brown bear basket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const auraReady=duduAuraReady;
    const breathe=Math.sin(t*0.05)*1.0; // gentle bear breathing
    const honeyDrip=((t*0.8)%60)/60; // honey drip cycle 0‚Üí1

    ctx.save();

    // Outer honey-amber glow when aura ready, soft warm glow otherwise
    if(auraReady){
      ctx.shadowBlur=28; ctx.shadowColor='#FFB300';
      // Honey amber pulsing border
      ctx.strokeStyle=`hsla(38,${85+Math.sin(t*0.12)*10}%,${50+Math.sin(t*0.15)*8}%,${0.55+Math.sin(t*0.15)*0.25})`;
      ctx.lineWidth=3;
      ctx.beginPath(); ctx.roundRect(bx-3,by+breathe-3,bw+6,BH+6,13); ctx.stroke();
    } else {
      ctx.shadowBlur=14; ctx.shadowColor='#8B5E3C';
    }

    // Bear body ‚Äî warm brown gradient
    const dg=ctx.createLinearGradient(bx,by+breathe,bx+bw,by+BH+breathe);
    if(auraReady){
      // honey-amber glow when streak ready
      dg.addColorStop(0,'#E8A020'); dg.addColorStop(0.5,'#C47A10'); dg.addColorStop(1,'#8B5A08');
    } else {
      dg.addColorStop(0,'#C68642'); dg.addColorStop(0.4,'#8B5E3C'); dg.addColorStop(1,'#5C3D1E');
    }
    ctx.fillStyle=dg;
    ctx.beginPath(); ctx.roundRect(bx,by+breathe,bw,BH,10); ctx.fill();

    // Belly patch ‚Äî lighter circle in the centre
    ctx.fillStyle='rgba(222,180,130,0.45)';
    ctx.beginPath(); ctx.ellipse(basket.x,by+breathe+BH*0.55,bw*0.28,BH*0.35,0,0,Math.PI*2); ctx.fill();

    // Top highlight
    ctx.fillStyle='rgba(255,235,200,0.22)';
    ctx.beginPath(); ctx.roundRect(bx+4,by+breathe+2,bw-8,BH*0.4,8); ctx.fill();

    // Round bear ears on top
    ctx.shadowBlur=0;
    ctx.fillStyle=auraReady?'#C47A10':'#6B3F1F';
    ctx.beginPath(); ctx.arc(basket.x-bw*0.32,by+breathe-5,8,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(basket.x+bw*0.32,by+breathe-5,8,0,Math.PI*2); ctx.fill();
    // Inner ear
    ctx.fillStyle=auraReady?'#E8A020':'#A0603A';
    ctx.beginPath(); ctx.arc(basket.x-bw*0.32,by+breathe-5,4.5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(basket.x+bw*0.32,by+breathe-5,4.5,0,Math.PI*2); ctx.fill();

    // Bear face
    const dcx=basket.x, dcy=by+breathe+BH*0.42;
    // Muzzle (lighter oval)
    ctx.fillStyle='rgba(210,170,120,0.7)';
    ctx.beginPath(); ctx.ellipse(dcx,dcy+3,8,5,0,0,Math.PI*2); ctx.fill();
    // Eyes ‚Äî small dark beads
    ctx.fillStyle='#1A0A00';
    ctx.beginPath(); ctx.arc(dcx-7,dcy-2,2.2,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(dcx+7,dcy-2,2.2,0,Math.PI*2); ctx.fill();
    // Eye shine
    ctx.fillStyle='rgba(255,255,255,0.75)';
    ctx.beginPath(); ctx.arc(dcx-6,dcy-3,0.9,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(dcx+8,dcy-3,0.9,0,Math.PI*2); ctx.fill();
    // Nose
    ctx.fillStyle='#2A1000';
    ctx.beginPath(); ctx.ellipse(dcx,dcy+1,2.5,2,0,0,Math.PI*2); ctx.fill();

    // Streak counter / aura state
    if(auraReady){
      ctx.fillStyle='#FFD700'; ctx.font='bold 8px serif'; ctx.textAlign='center';
      ctx.shadowBlur=6; ctx.shadowColor='#FFB300';
      ctx.fillText('üçØ',basket.x,by+breathe+BH-3);
    } else if(streak>=2){
      ctx.fillStyle='rgba(255,235,180,0.9)'; ctx.font='bold 8px serif';
      ctx.shadowBlur=0;
      ctx.fillText(`üêæ√ó${streak}`,basket.x,by+breathe+BH-2);
    }

    // Honey drip from bottom when aura ready
    if(auraReady){
      const dy=by+breathe+BH;
      ctx.fillStyle='rgba(255,180,0,0.7)';
      ctx.beginPath();
      ctx.moveTo(basket.x-4,dy);
      ctx.lineTo(basket.x+4,dy);
      ctx.lineTo(basket.x+2,dy+honeyDrip*10);
      ctx.quadraticCurveTo(basket.x,dy+honeyDrip*14,basket.x-2,dy+honeyDrip*10);
      ctx.closePath(); ctx.fill();
    }
    ctx.restore();

  } else if(currentChar==='bubu'){
    // ‚îÄ‚îÄ BUBU: black-and-white panda basket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const bounce=Math.sin(t*0.07)*1.2;
    const shimmer=Math.sin(t*0.09);

    ctx.save();
    ctx.shadowBlur=18; ctx.shadowColor='#555';

    // Body ‚Äî white with black trim (panda colouring)
    const bbg=ctx.createLinearGradient(bx,by+bounce,bx+bw,by+BH+bounce);
    bbg.addColorStop(0,'#F8F8F8'); bbg.addColorStop(0.5,'#E8E8E8'); bbg.addColorStop(1,'#D0D0D0');
    ctx.fillStyle=bbg;
    ctx.beginPath(); ctx.roundRect(bx,by+bounce,bw,BH,10); ctx.fill();

    // Black border stripe (panda markings around the basket)
    ctx.strokeStyle='#222'; ctx.lineWidth=2; ctx.shadowBlur=0;
    ctx.beginPath(); ctx.roundRect(bx,by+bounce,bw,BH,10); ctx.stroke();

    // Subtle shimmer highlight
    ctx.fillStyle=`rgba(255,255,255,${0.15+shimmer*0.08})`;
    ctx.beginPath(); ctx.roundRect(bx+3,by+bounce+2,bw-6,BH*0.38,8); ctx.fill();

    // Panda ears ‚Äî black circles poking up
    ctx.fillStyle='#1A1A1A'; ctx.shadowBlur=6; ctx.shadowColor='#000';
    ctx.beginPath(); ctx.arc(basket.x-bw*0.32,by+bounce-6,9,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(basket.x+bw*0.32,by+bounce-6,9,0,Math.PI*2); ctx.fill();

    // Panda face
    const pcx=basket.x, pcy=by+bounce+BH*0.42;

    // Large oval black eye patches ‚Äî classic panda look
    ctx.fillStyle='#1A1A1A'; ctx.shadowBlur=0;
    ctx.beginPath(); ctx.ellipse(pcx-8.5,pcy-1,5.5,4.5,Math.PI*0.1,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(pcx+8.5,pcy-1,5.5,4.5,-Math.PI*0.1,0,Math.PI*2); ctx.fill();

    // White eye inside the patch
    ctx.fillStyle='white';
    ctx.beginPath(); ctx.arc(pcx-8,pcy-1,2.8,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(pcx+8,pcy-1,2.8,0,Math.PI*2); ctx.fill();

    // Dark pupils
    ctx.fillStyle='#111';
    ctx.beginPath(); ctx.arc(pcx-8,pcy-1,1.5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(pcx+8,pcy-1,1.5,0,Math.PI*2); ctx.fill();

    // Eye shine
    ctx.fillStyle='rgba(255,255,255,0.85)';
    ctx.beginPath(); ctx.arc(pcx-7,pcy-2,0.8,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(pcx+9,pcy-2,0.8,0,Math.PI*2); ctx.fill();

    // Muzzle ‚Äî off-white oval
    ctx.fillStyle='rgba(240,240,230,0.9)';
    ctx.beginPath(); ctx.ellipse(pcx,pcy+4,7,4.5,0,0,Math.PI*2); ctx.fill();

    // Nose
    ctx.fillStyle='#333';
    ctx.beginPath(); ctx.ellipse(pcx,pcy+2,2,1.5,0,0,Math.PI*2); ctx.fill();

    // Tiny smile
    ctx.strokeStyle='#333'; ctx.lineWidth=1.2;
    ctx.beginPath(); ctx.arc(pcx,pcy+5,3,0.2,Math.PI-0.2); ctx.stroke();

    // Bamboo stalks on either side
    for(let b2=0;b2<2;b2++){
      const bsX=b2===0?bx-7:bx+bw+2;
      ctx.fillStyle='#5A8A3A'; ctx.shadowBlur=0;
      ctx.fillRect(bsX,by+bounce-8,4,BH+10);
      // bamboo nodes
      ctx.fillStyle='#3A6A1A';
      for(let n=0;n<3;n++){
        ctx.fillRect(bsX-1,by+bounce-6+n*(BH/2.5),6,2);
      }
      // bamboo leaves
      ctx.fillStyle='#5A8A3A';
      ctx.beginPath();
      ctx.ellipse(bsX+2,by+bounce-10,8,4,b2===0?-0.4:0.4,0,Math.PI*2);
      ctx.fill();
    }

    // Passive charge ‚Äî floating bag icons
    if(passiveCharge>0){
      ctx.font='9px serif'; ctx.textAlign='center'; ctx.shadowBlur=0;
      ctx.fillText('üõçÔ∏è'.repeat(Math.min(passiveCharge,5)), basket.x, by+bounce-14);
    }

    ctx.restore();
  }

  // ‚îÄ‚îÄ LEVEL 7 RAINBOW OVERRIDE (additional shimmer) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(level>=7){
    ctx.save(); ctx.globalAlpha=0.18;
    const rg7=ctx.createLinearGradient(bx,0,bx+bw,0);
    rg7.addColorStop(0,'#FF9ECD'); rg7.addColorStop(.5,'#FFD700'); rg7.addColorStop(1,'#6FCCAA');
    ctx.fillStyle=rg7;
    ctx.beginPath(); ctx.roundRect(bx,by,bw,BH,10); ctx.fill();
    ctx.restore();
  }

  // ‚îÄ‚îÄ SHIELD INDICATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(shieldsLeft>0){
    ctx.save(); ctx.font='11px serif'; ctx.fillStyle='#90caf9'; ctx.textAlign='center';
    ctx.shadowBlur=8; ctx.shadowColor='#90caf9';
    ctx.fillText('üõ°Ô∏è'.repeat(Math.min(shieldsLeft,3)),basket.x,by-8); ctx.restore();
  }

  drawBoss();
  drawBossParticles();
  // items
  for(let i=items.length-1;i>=0;i--){
    const it=items[i];
    if(!it.frozen&&!st.timeFrozen) it.y+=it.vy;
    if(st.magnet&&!it.bad) it.x+=(basket.x-it.x)*0.03;
    ctx.save();
    if(it.bad){
      const badSize=st.badShrink?Math.round(it.size*0.65):it.size;
      // Red danger glow for bad items
      ctx.shadowBlur=14;ctx.shadowColor='rgba(232,80,80,0.9)';
      ctx.globalAlpha=.15;ctx.font=badSize+'px serif';ctx.textAlign='center';
      ctx.fillText(it.emoji,it.x+2,it.y+3);
      ctx.globalAlpha=1;ctx.fillText(it.emoji,it.x,it.y);
    } else if(it.isPotato){
      // Golden glow for potatoes
      ctx.shadowBlur=10;ctx.shadowColor='rgba(244,165,106,0.8)';
      ctx.globalAlpha=.1;ctx.font=it.size+'px serif';ctx.textAlign='center';
      ctx.fillText(it.emoji,it.x+2,it.y+3);
      ctx.globalAlpha=1;ctx.fillText(it.emoji,it.x,it.y);
    } else {
      // Normal items ‚Äî subtle shadow
      ctx.globalAlpha=.1;ctx.font=it.size+'px serif';ctx.textAlign='center';
      ctx.fillText(it.emoji,it.x+2,it.y+3);
      ctx.globalAlpha=1;ctx.fillText(it.emoji,it.x,it.y);


    }
    ctx.restore();

    // catch
    const bumperExtra = st._bumper ? 6 : 0;
    if(it.y>=by-4&&it.y<=by+BH+14&&it.x>=bx-8-bumperExtra&&it.x<=bx+bw+8+bumperExtra){
      // Lucky charm: 5% chance to convert bad item to heart
      if(it.bad && st._luckyCharm && Math.random()<0.05){
        it.bad=false; it.emoji=HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)];
        showPopup('üçÄ Charmed!',it.x,it.y,'#4CAF50');
      }
      if(it.bad){
        // Ghost mode: bad items pass through
        if(st.ghost){showPopup('üëª Phased!',it.x,it.y,'#CE93D8');items.splice(i,1);continue;}
        // Lucky break: one-time block
        const luckyBuff=activeBuffs.find(b=>b.id==='lucky_s');
        if(luckyBuff){activeBuffs=activeBuffs.filter(b=>b.id!=='lucky_s');showPopup('üçÄ Lucky!',it.x,it.y,'#4CAF50');items.splice(i,1);continue;}
        if(shieldsLeft>0){
          shieldsLeft--;
          if(shieldsLeft===0) activeBuffs=activeBuffs.filter(b=>b.id!=='shield'&&b.id!=='shield2');
          showPopup('üõ°Ô∏è Blocked!',it.x,it.y,'#90caf9');
        } else {
          // streak_save: don't reset streak on first miss
          const hadStreak=streak>0;
          if(st.streakSave&&hadStreak){streak=Math.max(1,streak-1);showPopup('üî• Saved!',it.x,it.y,'#FF9800');}
          else if(window._petStreakGuard&&streak>0){streak=Math.max(3,Math.floor(streak/2));showPopup('üêò Guarded!',it.x,it.y,'#90caf9');triggerPetAnim('shake','#90caf9','üõ°Ô∏è');}
          else streak=0;
          // Armor: first hit is free
          if(st.armor&&!armorUsed){armorUsed=true;showPopup('ü™ñ Armored!',it.x,it.y,'#90caf9');items.splice(i,1);continue;}
          lives--;duduAuraReady=false;passiveCharge=0;potatoCount=0;
          showPopup('üí¢ Ouch!',it.x,it.y,'#E8736A');
          if(lives<=0){
            // Life Saver: once per game prevent death at 0
            if(window._lifeSaverReady){window._lifeSaverReady=false;lives=1;showPopup('üíä Life Saved!',W/2,H/2,'#90caf9');updateHUD();}
            else if(phoenixReady){phoenixReady=false;lives=3;showPopup('üî• PHOENIX!',W/2,H/2,'#FF9800');activeBuffs=activeBuffs.filter(b=>b.id!=='phoenix');}
            else{endGame();return;}
          }
        }
      } else if(it.isPotato){
        // Bao passive: potato collected!
        potatoCount++;
        showPopup('ü•î +1 potato!',it.x,it.y,'#F4A56A');
        const nommTrigger = st._infiniteNomnom ? 3 : CHARS.bao.passiveTrigger-(shopHas('potato_boost')?1:0);
        if(potatoCount>=nommTrigger){
          potatoCount=0;
          lives=Math.min(lives+1,6);
          P.steamShields++;
          if(st._infiniteNomnom){coins+=5;P.coins+=5;P.coinsEarned+=5;showPopup('üçú Infinite Nomnom! +1 Life +5üí∞',basket.x,by-20,'#F4A56A');}
          else showPopup('ü•î Nomnom! +1 Life! üíï',basket.x,by-20,'#F4A56A');
        }
        updateHUD();items.splice(i,1);continue;
      } else if(it.isShopbag){
        // Bubu passive: shopping bag collected!
        passiveCharge++;
        showPopup('üõçÔ∏è +1 bag!',it.x,it.y,'#FF6BA8');
        if(passiveCharge>=CHARS.bubu.passiveTrigger){
          passiveCharge=0;
          const bubuBonus=5;
          coins+=bubuBonus;P.coins+=bubuBonus;P.coinsEarned+=bubuBonus;
          showPopup(`üõçÔ∏è Shopaholic! +${bubuBonus} Coins! üíï`,basket.x,by-20,'#FF6BA8');
        }
        updateHUD();items.splice(i,1);continue;
      } else {
        // Base pts ‚Äî frenzy > triple > double
        let pts=st.x5?5:st.x4?4:st.x3?3:st.x2?2:1;
        pts+=st.rallyBonus; // Rally +1
        if(st.starburstBonus) pts+=2; // starburst boost
        const bonusStreak=(st.streakBonus&&streak>=5)?2:0;

        // DUDU passive: Angry Aura
        let auraBonus=0;
        if(currentChar==='dudu'&&duduAuraReady){
          auraBonus=pts; // effectively 2√ó
          duduAuraReady=false;
          P.angryAura++;
          showPopup('üí• AURA!',it.x,it.y-12,'#CE93D8');
        }

        const total=pts+bonusStreak+auraBonus;
        // Boss hit detection ‚Äî every caught heart damages the boss
        if(bossActive){
          bossHP--;
          showPopup('‚öîÔ∏è Hit! -1',bossX,55,'#FFD700');
          if(bossHP<=0){defeatBoss();score+=total;streak++;sessionHearts++;P.totalHearts++;updateHUD();items.splice(i,1);continue;}
        }
        score+=total;streak++;sessionHearts++;P.totalHearts++;
        petOnHeartCaught(it.x,it.y);
        if(streak>P.bestStreak) P.bestStreak=streak;
        // Streak Fire: at streak 8+, +2 extra pts
        if(st._streakFire&&streak>=8){score+=2;showPopup('üî•+2!',it.x,it.y-8,'#FF9800');}
        // Candy Heart: every 10th catch +1 coin
        if(!window._candyCount)window._candyCount=0;
        window._candyCount++;
        if(shopHas('candy_heart')&&window._candyCount%10===0){coins+=1;P.coins+=1;P.coinsEarned+=1;showPopup('üç¨+1üí∞',basket.x,by-18,'#FFD700');}
        // Heart Echo: every 15th catch spawns a bonus heart
        if(shopHas('heart_echo')&&window._candyCount%15===0){
          items.push({x:basket.x+(Math.random()-.5)*60,y:-24,vy:1.0,emoji:HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)],bad:false,size:st.bigHeartMode?31:22,frozen:false});
          showPopup('üíû Echo!',basket.x,by-28,'#FF9ECD');
        }
        // Diamond Rain: every 5 catches = +1 diamond
        if(shopHas('diamond_rain')&&window._candyCount%5===0){P.diamonds=(P.diamonds||0)+1;showPopup('üíé+1',it.x,it.y-14,'#a78bfa');}
        // Lifesteal: 0.25 life per heart (tracked with debt system)
        if(st.lifesteal){if(!window._lifeDebt)window._lifeDebt=0;window._lifeDebt+=0.25;if(window._lifeDebt>=1){window._lifeDebt-=1;lives=Math.min(lives+1,maxLives()+2);showPopup('üßõ +1 Life!',basket.x,by-22,'#CE93D8');updateHUD();}}
        // Soulbound: 1 full life per heart caught
        if(st.soulbound){lives=Math.min(lives+1,maxLives()+2);showPopup('üíú +1!',it.x,it.y-10,'#CE93D8');updateHUD();}
        // Doubleshot: every other heart scores 2√ó
        if(st.doubleshotter){if(!window._dsToggle)window._dsToggle=false;window._dsToggle=!window._dsToggle;if(window._dsToggle){score+=total;showPopup('üéØ 2√ó!',it.x,it.y-8,'#F4A56A');}}

        // Dudu: arm aura at streak 5+
        if(currentChar==='dudu'&&streak>=5&&!duduAuraReady){
          duduAuraReady=true;showPopup('‚ö° Aura Ready!',it.x,it.y-14,'#CE93D8');
        }

        if(!bossActive){
          const xpGain=Math.round((pts+(streak>=5?1:0))*st.xpM);
          xp+=xpGain;sessionXP+=xpGain;
          const cBase=Math.random()<(0.35+(st._petCoinBonus?0.05:0))?1:0;
          const cExtra=st.coinPerHeart||0;
          const cGain=Math.round((cBase+cExtra)*(st.coinX2?2:1)*st.coinM);
          if(cGain>0){coins+=cGain;P.coins+=cGain;P.coinsEarned+=cGain;}
          showPopup(auraBonus>0?`üí•+${total}!`:pts>1?`+${total}üíû`:'üíû',it.x,it.y,lvData(level).color);
          checkLevelUp();
        }
      }
      updateHUD();items.splice(i,1);continue;
    }
    if(it.y>H+30){
      // Only plain hearts (not potatoes or bags) cost a life when missed
      if(!it.bad&&!it.isPotato&&!it.isShopbag){
        // Lucky Break: also saves 1 missed good heart!
        const luckyMiss=activeBuffs.find(b=>b.id==='lucky_s');
        if(luckyMiss){activeBuffs=activeBuffs.filter(b=>b.id!=='lucky_s');showPopup('üçÄ Lucky Save!',it.x,H-40,'#4CAF50');}
        else{lives--;streak=0;if(currentChar==='dudu')duduAuraReady=false;if(lives<=0){endGame();return;}updateHUD();}
      }
      if(it.bad) petOnBadDodged(it);
      items.splice(i,1);
    }
  }
  // Boss shot collision with basket
  if(bossActive){
    const bw2=BASE_W*(st.bw||1);
    const bx2=basket.x-bw2/2,by2=H-BH-10;
    for(let i=bossShot.length-1;i>=0;i--){
      const s=bossShot[i];
      if(s.y>=by2-4&&s.y<=by2+BH+14&&s.x>=bx2-8&&s.x<=bx2+bw2+8){
        if(shieldsLeft>0){
          shieldsLeft--;
          if(shieldsLeft===0) activeBuffs=activeBuffs.filter(b=>b.id!=='shield'&&b.id!=='shield2');
          showPopup('üõ°Ô∏è Boss Shot Blocked!',s.x,s.y,'#90caf9');
        } else {
          lives--;streak=0;duduAuraReady=false;passiveCharge=0;potatoCount=0;
          showPopup('üíÄ Boss Hit!',s.x,s.y,'#FF4444');
          if(lives<=0){
            if(phoenixReady){phoenixReady=false;lives=3;showPopup('üî• PHOENIX!',W/2,H/2,'#FF9800');activeBuffs=activeBuffs.filter(b=>b.id!=='phoenix');}
            else{endGame();return;}
          }
          updateHUD();
        }
        bossShot.splice(i,1);
      }
    }
  }
  drawPopups();
  requestAnimationFrame(gameLoop);
}

function drawGameBackground(){
  ctx.save();
  const lvl=level||1;
  const char=currentChar||'bao';

  // The outer #game-wrap is #3D2B1F (deep warm brown).
  // Canvas edge must match this so there's no jarring border.
  // We paint a base fill matching the wrapper, then a radial vignette
  // that deepens toward the character's signature mid-tone in the centre.

  // Outer edge colour ‚Äî must match #game-wrap background exactly
  const outerBrown='#3D2B1F';

  // Character inner colours (centre of the radial gradient)
  const charInner={
    bao: lvl>=7?`hsl(${(frame*0.4)%360},40%,14%)`
               :lvl>=5?'#2a1828'
               :lvl>=3?'#2d1820'
               :'#2e1e18',   // warm rose-brown, deeper than outer
    dudu:lvl>=7?`hsl(${(frame*0.4)%360},40%,14%)`
               :lvl>=5?'#281828'
               :lvl>=3?'#321c10'
               :'#301c0e',   // deeper amber-brown
    bubu:lvl>=7?`hsl(${(frame*0.4)%360},40%,14%)`
               :lvl>=5?'#261428'
               :lvl>=3?'#2e1630'
               :'#2a1628',   // deep rose-lilac
  };

  const inner=charInner[char]||charInner.bao;

  // 1. Fill entire canvas with the outer brown (edges will naturally match)
  ctx.fillStyle=outerBrown;
  ctx.fillRect(0,0,W,H);

  // 2. Radial gradient from inner colour (centre) ‚Üí transparent (edges)
  //    This darkens/tints the centre while leaving edges = outerBrown
  const cx2=W/2, cy2=H/2;
  const radius=Math.max(W,H)*0.72;
  const radial=ctx.createRadialGradient(cx2,cy2,0,cx2,cy2,radius);
  radial.addColorStop(0,inner);
  radial.addColorStop(0.55,inner);
  radial.addColorStop(1,'rgba(61,43,31,0)'); // fades to transparent ‚Üí shows outerBrown base
  ctx.fillStyle=radial;
  ctx.fillRect(0,0,W,H);

  ctx.restore();
}

let starCache=null;
function drawStars(){
  if(!starCache) starCache=Array.from({length:28},()=>({x:Math.random()*100,y:Math.random()*100,r:Math.random()*1.3+.3}));
  ctx.save();ctx.fillStyle='rgba(255,255,255,0.3)';
  for(const s of starCache){ctx.beginPath();ctx.arc(s.x/100*W,s.y/100*H,s.r,0,Math.PI*2);ctx.fill();}
  ctx.restore();
}

function showPopup(text,x,y,color='#F4A56A'){popups.push({text,x,y,color,age:0});}
function drawPopups(){
  for(let i=popups.length-1;i>=0;i--){
    const p=popups[i];p.age++;p.y-=1.3;
    ctx.save();ctx.globalAlpha=Math.max(0,1-p.age/38);
    ctx.font='bold 13px serif';ctx.fillStyle=p.color;ctx.textAlign='center';
    ctx.fillText(p.text,p.x,p.y);ctx.restore();
    if(p.age>38) popups.splice(i,1);
  }
}

// ===================== LEVEL UP =====================
function checkLevelUp(){
  if(level>=LEVELS.length) return;
  if(xp>=xpNeeded(level)){
    xp-=xpNeeded(level);level++;
    if(!P.achievedLevels.includes(level)) P.achievedLevels.push(level);
    if(level>P.highLevel) P.highLevel=level;
    saveP();
    // Spawn boss at levels 3, 6, 9
    if([3,6,9].includes(level)&&!bossActive){
      running=false;
      showBossWarning(()=>{running=true;spawnBoss(level);gameLoop();});
    } else {
      // Overdrive: 10s of triple + magnet after level-up
      if(shopHas('overdrive')){
        activeBuffs.push({id:'triple',rarity:'epic',emoji:'‚ö°',short:'OVERDRIVE',endsAt:frame+10*60});
        activeBuffs.push({id:'magnet_s',rarity:'epic',emoji:'üß≤',short:'Magnet',endsAt:frame+10*60});
        showPopup('‚ö° OVERDRIVE!',W/2,H/3,'#FFD700');
      }
      running=false;showLevelUpScreen();
    }
  }
}

// ===================== BOSS DEFINITIONS =====================
// All bosses ‚Äî randomly pick 3 per encounter
const ALL_BOSSES = [

  // ‚îÄ‚îÄ TIER ONE (hp 15‚Äì25) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {
    id:'udon_worm_titan', tier:1,
    name:'The Udon Worm Titan', subtitle:'Chaos of Slippery Textures',
    emoji:'üçú', shotEmoji:'ü™±', color:'#8B6914', bgColor:'rgba(139,105,20,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'Born from Amber\'s deepest dread ‚Äî worm-like noodles that wriggle and slither endlessly. Fires double squirming projectiles!',
    hp:20, rageMult:1.2, specialty:'Fires two worm shots at once!',
  },
  {
    id:'onion_overlord', tier:1,
    name:'The Onion Overlord of Tears', subtitle:'Lord of Eye-Watering Intrusion',
    emoji:'üßÖ', shotEmoji:'üò≠', color:'#9C7B2F', bgColor:'rgba(156,123,47,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'The pungent sovereign of garnishes Amber never ordered. Its crying shots flood the arena with lamentation!',
    hp:18, rageMult:1.3, specialty:'Rains tear-shots in rage!',
  },
  {
    id:'maroon_queen', tier:1,
    name:'The Maroon Queen of Nostalgia', subtitle:'Guardian of Comfort and Memory',
    emoji:'üëë', shotEmoji:'üíú', color:'#800020', bgColor:'rgba(128,0,32,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Draped in Amber\'s favourite maroon, she tests your resolve with bittersweet pulses. Defeat her to earn the power of memory!',
    hp:18, rageMult:1.1, specialty:'Fires nostalgic heart pulses!',
  },
  {
    id:'broccoli_sprite', tier:1,
    name:'The Soft Broccoli Sprite', subtitle:'Gentle Titan of the Steamer',
    emoji:'ü•¶', shotEmoji:'üåø', color:'#2d6a2d', bgColor:'rgba(45,106,45,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Perfectly steamed and utterly soft ‚Äî just the way Amber loves it. This tiny titan bounces cheerfully and fires leafy blessings!',
    hp:15, rageMult:1.0, specialty:'Bounces erratically across the arena!',
  },
  {
    id:'grapefruit_witch', tier:1,
    name:'The Grapefruit Citrus Witch', subtitle:'Sovereign of the Bitter Zest',
    emoji:'üçä', shotEmoji:'‚ö°', color:'#CC5500', bgColor:'rgba(204,85,0,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'A citrusy sorceress with a bitter-sweet personality ‚Äî much like the fruit Amber adores. Her zappy shots are sharp and fast!',
    hp:16, rageMult:1.15, specialty:'Fires fast zap-shots in bursts!',
  },
  {
    id:'raw_onion_specter', tier:1,
    name:'The Raw Onion Specter', subtitle:'Ghost of Uninvited Garnishes',
    emoji:'üëª', shotEmoji:'üßÖ', color:'#6B5A2A', bgColor:'rgba(107,90,42,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'The translucent spirit of every raw onion ever placed on a dish without consent. It haunts the arena with pungent ghost-shots!',
    hp:17, rageMult:1.25, specialty:'Fires ghost-onion ambush shots!',
  },
  {
    id:'bean_sprout_imp', tier:1,
    name:'The Bean Sprout Imp', subtitle:'Tiny Terror of Worm-Like Strings',
    emoji:'üå±', shotEmoji:'üåø', color:'#5a8a3a', bgColor:'rgba(90,138,58,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'Small but relentless, the Bean Sprout Imp zips across the field firing stringy projectiles that look disturbingly worm-like!',
    hp:15, rageMult:1.2, specialty:'Moves twice as fast as normal bosses!',
  },
  {
    id:'potato_sentinel', tier:1,
    name:'The Baked Potato Sentinel', subtitle:'Protector of Fluffy Comfort',
    emoji:'ü•î', shotEmoji:'üí®', color:'#8B6347', bgColor:'rgba(139,99,71,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Guardian of Amber\'s beloved baked potato ‚Äî perfectly fluffy inside, golden outside. Its steam-puff shots are deceptively warm!',
    hp:20, rageMult:1.05, specialty:'Fires steam puffs in all directions!',
  },
  {
    id:'mashed_egg_duchess', tier:1,
    name:'The Mashed Egg Duchess', subtitle:'Empress of Mayonnaise and Comfort',
    emoji:'ü•ö', shotEmoji:'ü´ß', color:'#D4A800', bgColor:'rgba(212,168,0,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'The noble duchess of mashed egg with mayo ‚Äî Amber\'s go-to comfort snack. She fires creamy bubble-shots with regal elegance!',
    hp:16, rageMult:1.1, specialty:'Fires bubble volleys in rage!',
  },
  {
    id:'maggie_noodle_fiend', tier:1,
    name:'The Spicy Maggie Fiend', subtitle:'Lord of Late-Night Cravings',
    emoji:'üçù', shotEmoji:'üå∂Ô∏è', color:'#CC2200', bgColor:'rgba(204,34,0,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'The spicy spirit of Amber\'s beloved instant noodles ‚Äî always craved, always satisfying. It launches chilli shots that sting!',
    hp:19, rageMult:1.2, specialty:'Fires triple chilli shots in rage!',
  },
  {
    id:'penne_phantom', tier:1,
    name:'The Penne Pasta Phantom', subtitle:'Specter of the Tube-Shaped Truth',
    emoji:'üçù', shotEmoji:'‚ú®', color:'#C8A040', bgColor:'rgba(200,160,64,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Unlike the feared Udon Worm, penne pasta holds no terror ‚Äî it is Amber\'s friend! This phantom showers the field in pasta bliss!',
    hp:17, rageMult:1.1, specialty:'Fires pasta spirals that curve!',
  },
  {
    id:'kovan_memory', tier:1,
    name:'The Kovan Memory Wraith', subtitle:'Spirit of the First Date',
    emoji:'üíå', shotEmoji:'üíï', color:'#A0307A', bgColor:'rgba(160,48,122,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Conjured from the memory of Ding Te Le and that navy blue top ‚Äî a wraith woven from the warmth of a perfect first evening!',
    hp:15, rageMult:1.0, specialty:'Fires heart-shaped memory blasts!',
  },
  {
    id:'navyblue_knight', tier:1,
    name:'The Navy Blue Knight', subtitle:'Champion of the First Encounter',
    emoji:'ü´ê', shotEmoji:'üíô', color:'#003080', bgColor:'rgba(0,48,128,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Clad in the colour of Amber\'s first-date top, the Navy Blue Knight is a fierce but honourable guardian of cherished memories!',
    hp:22, rageMult:1.1, specialty:'Charges in straight-line dashes!',
  },
  {
    id:'brown_pant_phantom', tier:1,
    name:'The Brown Pant Phantom', subtitle:'Silent Warden of First Memories',
    emoji:'ü§é', shotEmoji:'üçÇ', color:'#7B4F2A', bgColor:'rgba(123,79,42,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'An apparition shaped like autumn warmth, inspired by the brown trousers of a certain nostalgic first date. Warm, steady, and deceptive!',
    hp:18, rageMult:1.05, specialty:'Fires leaf-shot spirals!',
  },

  // ‚îÄ‚îÄ TIER TWO (hp 28‚Äì40) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {
    id:'bean_sprout_hydra', tier:2,
    name:'The Bean Sprout Hydra', subtitle:'The Stringy Many-Headed Terror',
    emoji:'üåø', shotEmoji:'ü™±', color:'#4a7c3f', bgColor:'rgba(74,124,63,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'Every head regrows when severed! This stringy nightmare embodies every unwanted garnish Amber has ever encountered!',
    hp:35, rageMult:1.4, specialty:'Splits into five shots in rage mode!',
  },
  {
    id:'steamboat_guardian', tier:2,
    name:'The Steamboat Guardian of Comfort', subtitle:'Protector of the Sacred Hot Pot',
    emoji:'ü´ï', shotEmoji:'üçó', color:'#D4570A', bgColor:'rgba(212,87,10,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'The spirit of every beloved steamboat night ‚Äî chicken, crabsticks, enoki mushrooms and maggie. Prove you deserve the cozy warmth!',
    hp:30, rageMult:1.1, specialty:'Slowly heals during the fight!',
  },
  {
    id:'sheng_jian_empress', tier:2,
    name:'The Sheng Jian Flame Empress', subtitle:'The Crispy-Bottom Sovereign',
    emoji:'ü•ü', shotEmoji:'üî•', color:'#C0392B', bgColor:'rgba(192,57,43,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'The fiery spirit of Chinatown\'s finest sheng jian bao ‚Äî perfectly crispy below, perfectly soft above. Her flames are a loving test!',
    hp:32, rageMult:1.2, specialty:'Drops fire rings in rage phase!',
  },
  {
    id:'udon_warlord', tier:2,
    name:'The Udon Warlord of Slime', subtitle:'Commander of Worm-Like Forces',
    emoji:'üçú', shotEmoji:'ü™±', color:'#7A5A10', bgColor:'rgba(122,90,16,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'A stronger evolution of the Udon threat ‚Äî this warlord commands armies of slithering noodle-worms across the battlefield!',
    hp:38, rageMult:1.3, specialty:'Fires waves of worm volleys!',
  },
  {
    id:'onion_colossus', tier:2,
    name:'The Onion Colossus of Sorrow', subtitle:'Ancient Weeping Giant',
    emoji:'üßÖ', shotEmoji:'üíß', color:'#8A6A1A', bgColor:'rgba(138,106,26,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'An ancient colossus made entirely of raw onion layers. It weeps constantly and its tears fill the whole arena!',
    hp:36, rageMult:1.35, specialty:'Spreads teardrop shots widely!',
  },
  {
    id:'crabstick_commander', tier:2,
    name:'The Crabstick Commander', subtitle:'Admiral of the Steamboat Fleet',
    emoji:'ü¶Ä', shotEmoji:'üåä', color:'#CC4400', bgColor:'rgba(204,68,0,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'The proud admiral of steamboat ingredients ‚Äî crabsticks are Amber\'s favourite hot-pot pick! This commander fires ocean waves!',
    hp:28, rageMult:1.15, specialty:'Fires ocean wave blasts!',
  },
  {
    id:'enoki_empress', tier:2,
    name:'The Enoki Mushroom Empress', subtitle:'Mistress of the Delicate Threads',
    emoji:'üçÑ', shotEmoji:'üåæ', color:'#C8B060', bgColor:'rgba(200,176,96,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Slender and delicate like enoki mushrooms ‚Äî a steamboat staple Amber adores. The Empress fires golden thread-shots!',
    hp:30, rageMult:1.2, specialty:'Fires golden thread volleys!',
  },
  {
    id:'lor_mee_specter', tier:2,
    name:'The Lor Mee Specter of Stench', subtitle:'Dark Wraith of the Famous Stall',
    emoji:'ü´ô', shotEmoji:'üåë', color:'#3A2010', bgColor:'rgba(58,32,16,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'A specter conjured from the darkest sauce ‚Äî the legendary Lor Mee. It slathers the arena in thick dark blasts!',
    hp:34, rageMult:1.4, specialty:'Fires dark sauce arc-shots!',
  },
  {
    id:'si_ji_dou_guardian', tier:2,
    name:'The Si Ji Dou Guardian', subtitle:'Protector of Grandma\'s Sacred Recipe',
    emoji:'ü´ò', shotEmoji:'üíö', color:'#3A7A3A', bgColor:'rgba(58,122,58,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'The faithful guardian of grandma\'s si ji dou ‚Äî green beans cooked with love. This protector fires nourishing green bolts!',
    hp:29, rageMult:1.1, specialty:'Fires green bean boomerangs!',
  },
  {
    id:'cozy_maroon_sentinel', tier:2,
    name:'The Cozy Maroon Sentinel', subtitle:'Warden of Warmth and Favourite Hues',
    emoji:'üü•', shotEmoji:'‚ù§Ô∏è', color:'#7A0020', bgColor:'rgba(122,0,32,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Clad entirely in Amber\'s beloved maroon, this sentinel defends the colour of comfort itself. Its heart-shots carry warmth!',
    hp:31, rageMult:1.1, specialty:'Fires heart-burst volleys in rage!',
  },
  {
    id:'penne_sorcerer', tier:2,
    name:'The Penne Pasta Sorcerer', subtitle:'Archmage of Tube-Shaped Comfort',
    emoji:'üçù', shotEmoji:'üåÄ', color:'#B89040', bgColor:'rgba(184,144,64,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'A pasta wizard of immense power ‚Äî unlike the worm-like udon, penne is Amber\'s beloved ally! The sorcerer fires curling vortex spells!',
    hp:33, rageMult:1.2, specialty:'Fires curved pasta vortex-shots!',
  },
  {
    id:'yew_kee_champion', tier:2,
    name:'The Yew Kee Champion of Rice', subtitle:'Keeper of the Sacred Duck Stall',
    emoji:'üçö', shotEmoji:'ü¶Ü', color:'#9A5A20', bgColor:'rgba(154,90,32,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Guardian of Amber\'s hallowed Yew Kee duck rice ‚Äî the stall that holds a special place in her heart. Fights with rice-scatter attacks!',
    hp:35, rageMult:1.2, specialty:'Rains rice pellets in a wide arc!',
  },
  {
    id:'raw_bean_tyrant', tier:2,
    name:'The Raw Bean Sprout Tyrant', subtitle:'Supreme Ruler of Unwanted Crunch',
    emoji:'üåø', shotEmoji:'üí¢', color:'#3A5A1A', bgColor:'rgba(58,90,26,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'The supreme overlord of every bean sprout Amber ever pushed to the side of her bowl. It rains fury upon any who disrespect the crunch!',
    hp:37, rageMult:1.45, specialty:'Fires anger-bursts in all directions!',
  },
  {
    id:'nightfall_wanderer', tier:2,
    name:'The Nightfall R&B Wanderer', subtitle:'Drifter of Late-Night Moods',
    emoji:'üéß', shotEmoji:'üéµ', color:'#3A0060', bgColor:'rgba(58,0,96,0.15)',
    type:'love', typeLabel:'Comfort Boss', typeColor:'#CE93D8',
    lore:'Fueled by The Weeknd\'s late-night energy, this wanderer drifts across the arena firing musical note projectiles into the dark!',
    hp:32, rageMult:1.25, specialty:'Fires musical note streams!',
  },

  // ‚îÄ‚îÄ TIER THREE (hp 45‚Äì65) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {
    id:'midnight_weeknd_sorceress', tier:3,
    name:'The Midnight Weeknd Sorceress', subtitle:'Queen of Late-Night Sorcery',
    emoji:'üåô', shotEmoji:'üéµ', color:'#4A0080', bgColor:'rgba(74,0,128,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'Channelling the haunting energy of The Weeknd\'s midnight vibes. Every music note she fires pulses with dark R&B power!',
    hp:55, rageMult:1.3, specialty:'Notes fire in musical wave-patterns!',
  },
  {
    id:'duck_rice_overlord', tier:3,
    name:'The Duck Rice Overlord of Yew Kee', subtitle:'Supreme Sovereign of the Sacred Stall',
    emoji:'ü¶Ü', shotEmoji:'üçö', color:'#8B4513', bgColor:'rgba(139,69,19,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'The ultimate spirit of Yew Kee Duck Rice ‚Äî Amber\'s hallowed local favourite. Rich, savoury, and absolutely formidable!',
    hp:50, rageMult:1.2, specialty:'Rains rice in a wide scatter!',
  },
  {
    id:'lor_mee_demon', tier:3,
    name:'The Great Lor Mee Demon', subtitle:'Dark Lord of the Thick Sauce',
    emoji:'ü´ô', shotEmoji:'üíÄ', color:'#2C1810', bgColor:'rgba(44,24,16,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'The ultimate chaos incarnate ‚Äî the dark thick sauce of Lor Mee given demonic form. Terrifying, relentless, and pungent!',
    hp:60, rageMult:1.5, specialty:'Fires massive dark sauce blasts!',
  },
  {
    id:'weeknd_colossus', tier:3,
    name:'The Starboy Colossus', subtitle:'Apex of Midnight R&B Power',
    emoji:'‚≠ê', shotEmoji:'üé∂', color:'#200040', bgColor:'rgba(32,0,64,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'The supreme manifestation of The Weeknd\'s entire discography given physical form. Its music-shots echo through the whole arena!',
    hp:58, rageMult:1.35, specialty:'Fires star-pattern music bursts!',
  },
  {
    id:'udon_demon_king', tier:3,
    name:'The Udon Demon King', subtitle:'Ruler of the Worm Dimension',
    emoji:'üòà', shotEmoji:'ü™±', color:'#600010', bgColor:'rgba(96,0,16,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'The final and most terrifying form of the udon threat ‚Äî a demonic king who commands the worm dimension. Its projectiles writhe!',
    hp:62, rageMult:1.5, specialty:'Fires worm-shots that zigzag!',
  },
  {
    id:'onion_god', tier:3,
    name:'The Ancient Onion God of Ruin', subtitle:'Primordial Force of Unwanted Garnish',
    emoji:'üåã', shotEmoji:'üßÖ', color:'#5A4A00', bgColor:'rgba(90,74,0,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'A primordial onion deity that has haunted dinner tables since the dawn of time. Amber never asked for it. It came anyway. It always comes.',
    hp:65, rageMult:1.55, specialty:'Erupts onion-volleys from every direction!',
  },
  {
    id:'maroon_empress_eternal', tier:3,
    name:'The Eternal Maroon Empress', subtitle:'Undying Queen of the Favourite Colour',
    emoji:'üíú', shotEmoji:'‚ù§Ô∏è', color:'#600018', bgColor:'rgba(96,0,24,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'The eternal queen of maroon ‚Äî Amber\'s colour made sovereign. She has guarded the hue since memory began, and she will not yield easily!',
    hp:52, rageMult:1.25, specialty:'Fires triple heart volleys in rage!',
  },
  {
    id:'steamboat_supreme', tier:3,
    name:'The Steamboat Supreme Sovereign', subtitle:'Final Guardian of the Hot Pot Realm',
    emoji:'üî•', shotEmoji:'ü´ï', color:'#B04000', bgColor:'rgba(176,64,0,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'The supreme ruler of all hot pot ingredients ‚Äî every chicken slice, every crabstick, every enoki mushroom bows before her!',
    hp:55, rageMult:1.3, specialty:'Fires rings of all steamboat ingredients!',
  },
  {
    id:'nostalgia_eclipse', tier:3,
    name:'The Nostalgia Eclipse', subtitle:'Shadow of the Perfect First Evening',
    emoji:'üåí', shotEmoji:'üíå', color:'#300050', bgColor:'rgba(48,0,80,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'A cosmic shadow conjured from the memory of Ding Te Le, navy blue tops, and first-date butterflies. Impossibly beautiful. Impossibly strong.',
    hp:50, rageMult:1.2, specialty:'Fires love-letter blasts in crescents!',
  },
  {
    id:'great_sheng_jian', tier:3,
    name:'The Great Sheng Jian Titan', subtitle:'Supreme Lord of the Crispy Bottom',
    emoji:'ü•ü', shotEmoji:'üí•', color:'#A02000', bgColor:'rgba(160,32,0,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'The ultimate embodiment of Chinatown\'s finest sheng jian bao ‚Äî this Titan is impossibly crispy below and impossibly powerful above!',
    hp:57, rageMult:1.4, specialty:'Fires explosion-bursts from below!',
  },
  {
    id:'bean_sprout_apocalypse', tier:3,
    name:'The Bean Sprout Apocalypse', subtitle:'End of All Garnish-Free Dining',
    emoji:'‚ò†Ô∏è', shotEmoji:'üåø', color:'#1A4A0A', bgColor:'rgba(26,74,10,0.15)',
    type:'hate', typeLabel:'Chaos Boss', typeColor:'#E8736A',
    lore:'The final reckoning for all who dared to hope for a bowl without bean sprouts. The apocalypse fires relentless sprout-barrages!',
    hp:63, rageMult:1.5, specialty:'Fires rapid-fire sprout barrages!',
  },
  {
    id:'si_ji_dou_deity', tier:3,
    name:'The Si Ji Dou Deity', subtitle:'Divine Guardian of Grandma\'s Kitchen',
    emoji:'üåü', shotEmoji:'ü´ò', color:'#2A6A2A', bgColor:'rgba(42,106,42,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'A deity born from every pot of si ji dou grandma ever made ‚Äî the most sacred comfort food. Its power is as boundless as love itself!',
    hp:48, rageMult:1.2, specialty:'Fires sacred green bean mandalas!',
  },
  {
    id:'after_hours_phantom', tier:3,
    name:'The After Hours Phantom', subtitle:'Phantom of the Darkest R&B Hour',
    emoji:'üéôÔ∏è', shotEmoji:'üåå', color:'#180030', bgColor:'rgba(24,0,48,0.15)',
    type:'love', typeLabel:'Legendary Boss', typeColor:'#FFD700',
    lore:'The phantom born at the darkest hour of the night ‚Äî fueled by After Hours, Blinding Lights, and every late-night vibe Amber loves!',
    hp:60, rageMult:1.4, specialty:'Fires cosmic music-wave blasts!',
  },
];

// Pick 3 random bosses from the appropriate tier for the current level
function getBossChoices(lv) {
  const tier = lv===3?1:lv===6?2:3;
  const pool = ALL_BOSSES.filter(b=>b.tier===tier);
  const shuffled = pool.slice().sort(()=>Math.random()-0.5);
  // Reduce HP by 30% for more achievable fights; reduce rageMult for easier rage
  return shuffled.slice(0,3).map(b=>({
    ...b,
    hp: Math.max(5, Math.round(b.hp * 0.7)),
    rageMult: Math.max(1.0, b.rageMult * 0.85),
  }));
}

let selectedBoss = null;

function showBossWarning(cb){
  const bosses = getBossChoices(level);
  overlay.classList.remove('hidden');

  // Build boss selection cards
  const cardsHTML = bosses.map((b, i) => `
    <div class="boss-select-card" data-idx="${i}" style="
      flex:1; min-width:0; border-radius:14px; padding:.7rem .5rem; cursor:pointer;
      border:2.5px solid ${b.typeColor}; background:${b.bgColor};
      text-align:center; transition:transform .15s, box-shadow .2s;
      display:flex; flex-direction:column; align-items:center; gap:3px;
    ">
      <div style="font-size:.52rem;border-radius:8px;padding:1px 6px;background:${b.typeColor};color:white;font-family:'Lora',serif;font-weight:700;letter-spacing:.05em;margin-bottom:2px;">${b.typeLabel}</div>
      <div style="font-size:2rem;line-height:1.1;">${b.emoji}</div>
      <div style="font-family:'Playfair Display',serif;font-size:.72rem;color:${b.typeColor};font-weight:700;line-height:1.2;">${b.name}</div>
      <div style="font-size:.58rem;opacity:.7;font-style:italic;line-height:1.3;">${b.subtitle}</div>
      <div style="font-size:.58rem;color:#FFD700;margin-top:2px;">‚ù§Ô∏è ${b.hp} HP</div>
      <div style="font-size:.56rem;color:rgba(255,255,255,.55);font-style:italic;margin-top:1px;">‚ú® ${b.specialty}</div>
    </div>
  `).join('');

  overlay.innerHTML=`
    <h2 style="color:#FF4444;font-size:1.3rem;animation:pulse 0.6s ease-in-out infinite">‚ö†Ô∏è BOSS INCOMING!</h2>
    <p style="color:rgba(253,246,236,.7);font-size:.75rem;margin:.3rem 0 .6rem;">Choose your opponent for Level ${level}!</p>
    <div style="display:flex;gap:7px;width:100%;margin-bottom:.6rem;">${cardsHTML}</div>
    <div id="boss-lore-box" style="background:rgba(0,0,0,.3);border-radius:10px;padding:.5rem .7rem;font-size:.7rem;color:rgba(253,246,236,.7);font-style:italic;min-height:2.5em;text-align:left;margin-bottom:.5rem;line-height:1.5;">‚Üê Tap a boss to learn their story</div>
    <p style="font-size:.72rem;color:rgba(253,246,236,.55);margin-bottom:.4rem">Catch üíï hearts to deal damage ¬∑ Dodge their projectiles!</p>
    <p style="font-size:.65rem;opacity:.5;margin-bottom:.4rem">Boss drops a guaranteed RARE+ buff on defeat</p>
    <button class="game-btn" id="boss-ready-btn" style="background:#555;margin-top:.2rem;opacity:.5;cursor:not-allowed;" disabled>Select a Boss First!</button>`;

  // Card hover/select logic
  let chosenIdx = -1;
  document.querySelectorAll('.boss-select-card').forEach(card => {
    card.addEventListener('click', () => {
      chosenIdx = parseInt(card.dataset.idx);
      selectedBoss = bosses[chosenIdx];
      document.querySelectorAll('.boss-select-card').forEach(c => {
        const b2 = bosses[parseInt(c.dataset.idx)];
        c.style.transform = c === card ? 'scale(1.04)' : 'scale(1)';
        c.style.boxShadow = c === card ? `0 0 18px ${b2.typeColor}` : 'none';
        c.style.opacity = c === card ? '1' : '0.6';
      });
      document.getElementById('boss-lore-box').textContent = selectedBoss.lore;
      const btn = document.getElementById('boss-ready-btn');
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
      btn.style.background = selectedBoss.typeColor;
      btn.textContent = `Fight ${selectedBoss.emoji} ${selectedBoss.name.split(' ')[0]}! ‚öîÔ∏è`;
    });
  });

  document.getElementById('boss-ready-btn').addEventListener('click',()=>{
    if(!selectedBoss) return;
    overlay.classList.add('hidden');items=[];bossShot=[];popups=[];cb();
  });
}

function spawnBoss(lv){
  bossActive=true;
  // Use selectedBoss HP if available, else fallback
  let _bossHPBase = selectedBoss ? selectedBoss.hp : (lv===3?20:lv===6?35:55);
  if(window._bossBane) _bossHPBase = Math.max(5, Math.round(_bossHPBase * 0.8));
  bossMaxHP = _bossHPBase;
  bossHP=bossMaxHP;
  bossX=W/2;bossDir=1;bossFrame=0;bossPhase=0;
  bossShot=[];bossNextSpawn=frame+90;bossParticles=[];
  const bname = selectedBoss ? selectedBoss.name : 'The Boss';
  showToast(`‚öîÔ∏è BOSS FIGHT: ${bname}! Catch hearts to deal damage!`);
}


// ‚îÄ‚îÄ Boss visual effects particles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let bossParticles = [];

function spawnBossParticle(x, y, emoji, color, vx, vy) {
  bossParticles.push({x, y, emoji, color, vx, vy, life: 35, maxLife: 35, size: 14});
}

function updateBossParticles() {
  for (let i = bossParticles.length - 1; i >= 0; i--) {
    const p = bossParticles[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.08; p.life--;
    if (p.life <= 0) bossParticles.splice(i, 1);
  }
}

function drawBossParticles() {
  for (const p of bossParticles) {
    const alpha = p.life / p.maxLife;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.font = p.size + 'px serif';
    ctx.textAlign = 'center';
    ctx.fillText(p.emoji, p.x, p.y);
    ctx.restore();
  }
}

// ‚îÄ‚îÄ Boss shot factory ‚Äî thematic per boss ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeBossShot(x, vy, vx, boss, overrideEmoji) {
  const e = overrideEmoji || (boss ? boss.shotEmoji : 'üíÄ');
  return {x, y: 60, vy, vx: vx || 0, emoji: e, bad: true, size: 16, isBossShot: true, drift: false, driftPhase: 0};
}

function fireBossPattern() {
  const boss = selectedBoss;
  const rage = bossPhase === 2;
  const isChaos = boss && boss.type === 'hate';
  // Chaos shots: notably faster; Comfort shots: slower and more telegraphed
  const baseVy = isChaos
    ? (rage ? 2.2 : 1.55)
    : (rage ? 1.3 : 0.9);
  const id = boss ? boss.id : 'generic';

  // Clamp shots to arena width with padding
  function cx(x) { return Math.max(22, Math.min(W - 22, x)); }

  // ‚îÄ‚îÄ Thematic pattern functions (no nested function declarations in switch) ‚îÄ
  const patterns = {

    // Single slow drop ‚Äî Love boss default
    gentle: () => {
      bossShot.push(makeBossShot(cx(bossX), baseVy, 0, boss));
    },

    // Two flanking soft shots
    flank: () => {
      bossShot.push(makeBossShot(cx(bossX - 35), baseVy, 0, boss));
      bossShot.push(makeBossShot(cx(bossX + 35), baseVy, 0, boss));
    },

    // Sinusoidal wriggling worm shot
    worm: (n) => {
      for (let k = 0; k < n; k++) {
        const s = makeBossShot(cx(bossX + (k - Math.floor(n/2)) * 22), baseVy, 0, boss);
        s.drift = true; s.driftPhase = k * 1.1; s.driftAmp = 1.2;
        bossShot.push(s);
      }
    },

    // Teardrop rain from random x ‚Äî onion crying
    tearRain: (n) => {
      for (let k = 0; k < n; k++) {
        const rx = cx(30 + Math.random() * (W - 60));
        bossShot.push(makeBossShot(rx, baseVy * 1.1, 0, boss));
      }
    },

    // Sniper: aims at basket, telegraphed (slower than before)
    sniper: () => {
      const tx = basket.x;
      const dx = tx - bossX;
      const dist = Math.sqrt(dx * dx + 180 * 180);
      const spd = baseVy * 1.3;
      bossShot.push(makeBossShot(cx(bossX), spd * (180 / dist), spd * (dx / dist) * 0.7, boss));
    },

    // Steam puffs in staggered cascade
    cascade: (n) => {
      for (let k = 0; k < n; k++) {
        const x = cx(bossX + (-Math.floor(n/2) + k) * 30);
        const s = makeBossShot(x, baseVy, 0, boss);
        s.y = 60 + k * 8;
        bossShot.push(s);
      }
    },

    // Boomerangs: drift outward, telegraphed slowly
    boomerang: () => {
      bossShot.push(makeBossShot(cx(bossX - 15), baseVy * 0.9, 1.4, boss));
      bossShot.push(makeBossShot(cx(bossX + 15), baseVy * 0.9, -1.4, boss));
    },

    // Wide arc fan
    fan: (n) => {
      const count = n || 4;
      for (let k = 0; k < count; k++) {
        const x = cx(28 + (W - 56) * k / (count - 1));
        bossShot.push(makeBossShot(x, baseVy + k * 0.1, 0, boss));
      }
    },

    // Musical note wave (Weeknd) ‚Äî slow oscillating
    musicWave: (n) => {
      for (let k = 0; k < n; k++) {
        const s = makeBossShot(cx(bossX + (k - Math.floor(n/2)) * 28), baseVy, 0, boss);
        s.drift = true; s.driftPhase = k * 0.9; s.driftAmp = 0.9;
        bossShot.push(s);
      }
    },

    // Rice scatter: many tiny fast shots spread wide
    riceScatter: (n) => {
      for (let k = 0; k < n; k++) {
        const x = cx(24 + (W - 48) * k / (n - 1));
        const s = makeBossShot(x, baseVy * 1.2, 0, boss);
        s.size = 12;
        bossShot.push(s);
      }
    },

    // Pulse: tight cluster that expands sideways gently
    pulse: () => {
      for (let k = -2; k <= 2; k++) {
        const s = makeBossShot(cx(bossX + k * 10), baseVy, k * 0.5, boss);
        bossShot.push(s);
      }
    },

    // Thick dark arc (Lor Mee) ‚Äî slow heavy shots
    darkArc: () => {
      bossShot.push(makeBossShot(cx(bossX - 40), baseVy * 0.85, 0.8, boss));
      bossShot.push(makeBossShot(cx(bossX), baseVy, 0, boss));
      bossShot.push(makeBossShot(cx(bossX + 40), baseVy * 0.85, -0.8, boss));
    },

    // Spiral: shots fan evenly across arena width
    spiral: () => {
      const positions = [0.15, 0.38, 0.62, 0.85];
      positions.forEach(pct => {
        bossShot.push(makeBossShot(cx(W * pct), baseVy + Math.random() * 0.2, 0, boss));
      });
    },
  };

  // ‚îÄ‚îÄ PER-BOSS DISPATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Each boss fires thematically appropriate, visually distinct pattern.
  // Rage mode adds ONE extra element, not double the shots.

  if (id === 'udon_worm_titan' || id === 'udon_warlord' || id === 'udon_demon_king') {
    // Wriggling sine wave ‚Äî like worms
    patterns.worm(rage ? 3 : 2);
    if (rage) spawnBossParticle(bossX, 65, 'ü™±', '#8B6914', (Math.random()-0.5)*2, -1);

  } else if (id === 'onion_overlord' || id === 'raw_onion_specter' || id === 'onion_colossus' || id === 'onion_god') {
    // Teardrops raining down ‚Äî like crying
    patterns.tearRain(rage ? 4 : 2);
    if (rage) spawnBossParticle(bossX, 65, 'üò≠', '#9C7B2F', 0, -1.5);

  } else if (id === 'maroon_queen' || id === 'maroon_empress_eternal' || id === 'cozy_maroon_sentinel') {
    // Elegant aimed sniper + particle flourish
    patterns.sniper();
    spawnBossParticle(bossX, 65, '‚ôüÔ∏è', '#800020', (Math.random()-0.5)*1.5, -1.2);
    if (rage) patterns.flank();

  } else if (id === 'broccoli_sprite') {
    // Cheerful bouncing cascade
    patterns.cascade(rage ? 3 : 2);
    spawnBossParticle(bossX, 65, 'üåø', '#2d6a2d', (Math.random()-0.5)*2, -1);

  } else if (id === 'grapefruit_witch') {
    // Zappy fan
    patterns.fan(rage ? 4 : 3);
    spawnBossParticle(bossX, 65, '‚ö°', '#CC5500', (Math.random()-0.5)*3, -2);

  } else if (id === 'bean_sprout_imp' || id === 'bean_sprout_hydra' || id === 'raw_bean_tyrant' || id === 'bean_sprout_apocalypse') {
    // Boomerang strings ‚Äî like string-like sprouts
    patterns.boomerang();
    if (rage) patterns.flank();
    spawnBossParticle(bossX, 65, 'üåø', '#4a7c3f', (Math.random()-0.5)*2, -1);

  } else if (id === 'potato_sentinel') {
    // Steam puffs cascade
    patterns.cascade(rage ? 4 : 2);
    spawnBossParticle(bossX, 65, 'üí®', '#8B6347', 0, -1.5);

  } else if (id === 'mashed_egg_duchess') {
    // Creamy pulse cluster
    patterns.pulse();
    spawnBossParticle(bossX, 65, 'ü´ß', '#D4A800', (Math.random()-0.5)*2, -1);

  } else if (id === 'maggie_noodle_fiend') {
    // Triple chilli spice shots
    bossShot.push(makeBossShot(cx(bossX - 25), baseVy, 0, boss));
    bossShot.push(makeBossShot(cx(bossX), baseVy * 1.1, 0, boss));
    if (rage) bossShot.push(makeBossShot(cx(bossX + 25), baseVy, 0, boss));
    spawnBossParticle(bossX, 65, 'üå∂Ô∏è', '#CC2200', (Math.random()-0.5)*2, -1.5);

  } else if (id === 'penne_phantom' || id === 'penne_sorcerer') {
    // Gentle curving wave (penne curves, unlike worm udon)
    patterns.musicWave(rage ? 3 : 2);
    spawnBossParticle(bossX, 65, '‚ú®', '#C8A040', (Math.random()-0.5)*2, -1);

  } else if (id === 'kovan_memory' || id === 'nostalgia_eclipse') {
    // Love letter cross pattern ‚Äî nostalgic and elegant
    patterns.sniper();
    if (rage) {
      bossShot.push(makeBossShot(cx(bossX - 50), baseVy * 0.5, 1.0, boss));
      bossShot.push(makeBossShot(cx(bossX + 50), baseVy * 0.5, -1.0, boss));
    }
    spawnBossParticle(bossX, 65, 'üíå', '#A0307A', 0, -1.5);

  } else if (id === 'navyblue_knight') {
    // Charge sniper
    patterns.sniper();
    spawnBossParticle(bossX, 65, '‚öîÔ∏è', '#003080', 0, -2);

  } else if (id === 'brown_pant_phantom') {
    // Leaf cascade spiral
    patterns.cascade(rage ? 3 : 2);
    spawnBossParticle(bossX, 65, 'üçÇ', '#7B4F2A', (Math.random()-0.5)*1.5, -1);

  } else if (id === 'steamboat_guardian' || id === 'steamboat_supreme') {
    // Warm staggered steam bubbles
    patterns.cascade(rage ? 3 : 2);
    if (Math.random() < 0.12 && bossHP < bossMaxHP) {
      bossHP = Math.min(bossMaxHP, bossHP + 1);
      showPopup('ü´ï +1 Heal!', bossX, 55, '#4CAF50');
    }
    spawnBossParticle(bossX, 65, '‚ô®Ô∏è', '#D4570A', 0, -1.5);

  } else if (id === 'sheng_jian_empress' || id === 'great_sheng_jian') {
    // Crispy bottom fire ring ‚Äî pulse with fire particles
    patterns.pulse();
    spawnBossParticle(bossX - 20, 65, 'üî•', '#C0392B', -1, -1.5);
    spawnBossParticle(bossX + 20, 65, 'üî•', '#C0392B', 1, -1.5);
    if (rage) patterns.flank();

  } else if (id === 'crabstick_commander') {
    // Ocean wave fan
    patterns.fan(rage ? 4 : 3);
    spawnBossParticle(bossX, 65, 'üåä', '#CC4400', 0, -1.5);

  } else if (id === 'enoki_empress') {
    // Delicate spiral
    patterns.spiral();
    spawnBossParticle(bossX, 65, 'üåæ', '#C8B060', (Math.random()-0.5)*1.5, -1);

  } else if (id === 'lor_mee_specter' || id === 'lor_mee_demon') {
    // Thick dark arc ‚Äî heavy and slow
    patterns.darkArc();
    spawnBossParticle(bossX, 65, 'üåë', '#3A2010', 0, -1);
    if (rage) patterns.gentle();

  } else if (id === 'si_ji_dou_guardian' || id === 'si_ji_dou_deity') {
    // Boomerang green beans + particle
    patterns.boomerang();
    spawnBossParticle(bossX, 65, 'ü´ò', '#3A7A3A', 0, -1.5);
    if (rage) patterns.cascade(2);

  } else if (id === 'yew_kee_champion' || id === 'duck_rice_overlord') {
    // Rice scatter wide
    patterns.riceScatter(rage ? 5 : 3);
    spawnBossParticle(bossX, 65, 'üçö', '#9A5A20', (Math.random()-0.5)*2, -1);

  } else if (id === 'nightfall_wanderer' || id === 'midnight_weeknd_sorceress' || id === 'weeknd_colossus' || id === 'after_hours_phantom') {
    // Musical note wave ‚Äî slow and hypnotic
    patterns.musicWave(rage ? 3 : 2);
    spawnBossParticle(bossX, 65, 'üéµ', '#4A0080', (Math.random()-0.5)*2, -1.5);
    if (rage) patterns.sniper();

  } else if (id === 'maroon_cloak') {
    patterns.sniper();
    if (rage) patterns.flank();

  } else {
    // Generic fallback
    rage ? patterns.flank() : patterns.gentle();
  }
}

function updateBoss() {
  if (!bossActive) return;
  bossFrame++;
  const boss = selectedBoss;
  const rageMult = boss ? boss.rageMult : 1.2;
  const isChaos = boss && boss.type === 'hate';

  // ‚îÄ‚îÄ MOVEMENT: Chaos bosses move faster & jitter; Comfort drift gently ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const baseSpd = isChaos ? 1.9 : 1.1;
  const spd = bossPhase === 2 ? (baseSpd * rageMult) : baseSpd;
  bossX += bossDir * spd;

  // Chaos bosses randomly reverse direction; Comfort bosses only bounce off walls
  if (bossX > W - 30 || bossX < 30) bossDir *= -1;
  if (isChaos && bossPhase === 2 && Math.random() < 0.018) bossDir *= -1; // random jerk

  // ‚îÄ‚îÄ RAGE THRESHOLD: same for both ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (bossHP <= Math.floor(bossMaxHP / 3) && bossPhase < 2) {
    bossPhase = 2;
    showPopup(isChaos ? 'üí¢ FRENZY!' : 'üíú SURGE!', W/2, H/2, isChaos ? '#FF4444' : '#CE93D8');
  }

  // ‚îÄ‚îÄ FIRE RATE: Chaos fires more frequently ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (frame >= bossNextSpawn) {
    fireBossPattern();
    const normalInterval = isChaos ? 78 : 115;
    const rageInterval  = isChaos ? 52 : 82;
    bossNextSpawn = frame + (bossPhase === 2 ? rageInterval : normalInterval);
  }

  // ‚îÄ‚îÄ CANVAS AURA: tint the background behind the boss ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const framesUntilFire = bossNextSpawn - frame;
  if (bossActive) {
    const auraAlpha = bossPhase === 2 ? 0.13 : 0.07;
    const auraColor = isChaos
      ? `rgba(220,60,30,${auraAlpha + (framesUntilFire<=18?0.07:0)})`
      : `rgba(180,120,255,${auraAlpha + (framesUntilFire<=18?0.05:0)})`;
    ctx.save();
    ctx.fillStyle = auraColor;
    ctx.fillRect(0, 0, W, H);
    ctx.restore();
  }

  updateBossParticles();

  // Move boss shots
  for (let i = bossShot.length - 1; i >= 0; i--) {
    const s = bossShot[i];
    s.y += s.vy;
    if (s.vx) s.x += s.vx;
    if (s.drift) {
      s.driftPhase = (s.driftPhase || 0) + 0.07;
      s.x += Math.sin(s.driftPhase) * (s.driftAmp || 1.0);
    }
    // Keep in bounds
    if (s.x < 0) s.x = 0;
    if (s.x > W) s.x = W;
    if (s.y > H + 30) bossShot.splice(i, 1);
  }
}


function drawBoss(){
  if(!bossActive) return;
  const boss = selectedBoss;
  const emoji = boss ? boss.emoji : (level===3?'üçñ':level===6?'üå∂Ô∏è':'üíÄ');
  const bossColor = boss ? boss.color : '#FF4444';
  const isChaos = boss && boss.type === 'hate';
  const scale = bossPhase===2 ? 2.6 : 2.1;

  // Pre-fire warning telegraph
  const framesUntilFire = bossNextSpawn - frame;
  const telegraphing = framesUntilFire <= 20 && framesUntilFire > 0;

  ctx.save();

  if(telegraphing){
    const pulse = Math.sin((20-framesUntilFire)*0.5)*0.5+0.5;
    // Chaos: harsh red-yellow flash; Comfort: warm purple-pink glow
    const warnColor = isChaos ? `rgba(255,${80+pulse*80},0,0.9)` : `rgba(220,160,255,0.9)`;
    ctx.shadowBlur = 40 + pulse*20;
    ctx.shadowColor = isChaos ? '#FF4400' : '#CE93D8';
    // Chaos gets a shaking effect
    if(isChaos) ctx.translate(Math.sin(bossFrame*0.8)*(pulse*2.5), 0);
  } else if(bossPhase===2){
    ctx.shadowBlur = isChaos ? 42 : 30;
    ctx.shadowColor = isChaos ? '#FF2200' : '#CE93D8';
    if(isChaos) ctx.translate(Math.sin(bossFrame*0.5)*1.5, 0); // subtle rage shake
  } else {
    ctx.shadowBlur = isChaos ? 16 : 10;
    ctx.shadowColor = isChaos ? '#FF6633' : bossColor;
  }

  // Boss emoji
  ctx.font=`${scale*20}px serif`; ctx.textAlign='center';
  ctx.fillText(emoji, bossX, 52);
  ctx.restore();

  // Boss name tag + type badge
  if(boss){
    ctx.save();
    // Type badge background
    const badgeColor = isChaos ? 'rgba(220,60,30,0.75)' : 'rgba(120,60,200,0.6)';
    const badgeW = 62, badgeH = 11;
    const badgeX = bossX - badgeW/2;
    ctx.fillStyle = badgeColor;
    ctx.beginPath(); ctx.roundRect(badgeX, 2, badgeW, badgeH, 5); ctx.fill();
    ctx.fillStyle = isChaos ? '#FFD0C0' : '#E8D0FF';
    ctx.font = 'bold 7px serif'; ctx.textAlign = 'center';
    ctx.fillText(isChaos ? 'üí¢ CHAOS BOSS' : 'üíú COMFORT BOSS', bossX, 11);

    // Boss name
    ctx.fillStyle = bossPhase===2 ? (isChaos ? '#FF9999' : '#E0B0FF') : 'rgba(255,255,255,0.82)';
    ctx.font = 'bold 8px serif';
    const nameShort = boss.name.length>22 ? boss.name.slice(0,20)+'‚Ä¶' : boss.name;
    ctx.fillText(nameShort, bossX, 24);

    if(bossPhase===2){
      ctx.fillStyle = isChaos ? '#FF4444' : '#CE93D8';
      ctx.font = 'bold 7px serif';
      ctx.fillText(isChaos ? 'üí¢ FRENZY!' : 'üíú SURGE!', bossX, 33);
    }
    ctx.restore();
  }

  // HP bar ‚Äî red for chaos, purple for comfort
  const barW=W*0.7, barX=(W-barW)/2, barY=62;
  ctx.fillStyle='rgba(0,0,0,0.4)'; ctx.fillRect(barX,barY,barW,8);
  const pct=bossHP/bossMaxHP;
  const hpColor = isChaos
    ? (pct>0.5?'#FF6633':pct>0.25?'#FF3300':'#CC0000')
    : (pct>0.5?'#9C27B0':pct>0.25?'#7B1FA2':'#CE93D8');
  ctx.fillStyle=hpColor; ctx.fillRect(barX,barY,barW*pct,8);
  ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.strokeRect(barX,barY,barW,8);
  ctx.font='bold 9px serif'; ctx.fillStyle='white'; ctx.textAlign='center';
  ctx.fillText(`${boss?boss.emoji:'üíÄ'} HP: ${bossHP}/${bossMaxHP}`, W/2, 60);

  // Draw shots ‚Äî chaos shots have red tint shadow, comfort have purple
  for(const s of bossShot){
    ctx.save();
    ctx.shadowBlur = isChaos ? 14 : 8;
    ctx.shadowColor = isChaos ? 'rgba(255,80,30,0.85)' : 'rgba(180,100,255,0.7)';
    ctx.font=s.size+'px serif'; ctx.textAlign='center';
    ctx.fillText(s.emoji, s.x, s.y);
    ctx.restore();
  }
}

function checkBossHit(heartX,heartY){
  if(!bossActive) return false;
  if(Math.abs(heartX-bossX)<35&&heartY<70){
    bossHP--;
    showPopup('‚öîÔ∏è Hit! -1',bossX,55,'#FFD700');
    if(bossHP<=0) defeatBoss();
    return true;
  }
  return false;
}

// ‚îÄ‚îÄ BOSS-SPECIFIC REWARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Each boss has a thematic unique buff tied to what they represent
const BOSS_REWARDS = {
  // ‚îÄ‚îÄ Chaos bosses ‚Üí offensive / score power ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  udon_worm_titan:    {id:'double',    dur:18, name:'üçú Worm Vanquisher',   desc:'2√ó score for 18s ‚Äî you tamed the worm!'},
  onion_overlord:     {id:'rally',     dur:14, name:'üò§ Tear Proof',         desc:'Rally bonus +2pts/heart for 14s ‚Äî no more crying!'},
  raw_onion_specter:  {id:'magnet_s',  dur:15, name:'üëª Ghost Repel',        desc:'Magnet for 15s ‚Äî ghosts can\'t haunt you now!'},
  bean_sprout_imp:    {id:'breezy',    dur:12, name:'üå± Sprout Stomp',       desc:'All items 25% slower + wider basket for 12s!'},
  bean_sprout_hydra:  {id:'shield2',   dur:0,  name:'üåø Hydra Shield',       desc:'Fortress shield ‚Äî block 3 bad items! The Hydra fears you.'},
  raw_bean_tyrant:    {id:'double',    dur:14, name:'üåø Bean Buster',         desc:'2√ó score for 14s ‚Äî that tyrant is silenced!'},
  bean_sprout_apocalypse:{id:'eclipse',dur:0,  name:'‚ò†Ô∏è Apocalypse Ender',  desc:'All bad items vanish + 5√ó pts + magnet!'},
  lor_mee_specter:    {id:'coinboost', dur:14, name:'ü´ô Sauce Purged',        desc:'+3 coins per heart for 14s ‚Äî the sauce is yours now!'},
  lor_mee_demon:      {id:'apotheosis',dur:0,  name:'ü´ô Demon Sauce',         desc:'5√ó pts + clear all bad items + magnet for 10s!'},
  udon_warlord:       {id:'heartquake',dur:0,  name:'üçú Noodle Storm',        desc:'5√ó pts + scatter 6 hearts + freeze bad for 12s!'},
  udon_demon_king:    {id:'omni',      dur:20, name:'üòà King Slayer',         desc:'3√ó pts + magnet + freeze bad for 20s ‚Äî legendary kill!'},
  onion_colossus:     {id:'liferegen', dur:0,  name:'üßÖ Tear Healer',         desc:'+1 life recovered ‚Äî you suffered, now you heal!'},
  onion_god:          {id:'ultralife', dur:0,  name:'üåã God Toppled',         desc:'+3 lives! The ancient onion deity is felled!'},

  // ‚îÄ‚îÄ Comfort bosses ‚Üí protective / healing / utility ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  maroon_queen:       {id:'shieldplus',dur:0,  name:'üëë Queen\'s Blessing',   desc:'Iron Shield ‚Äî block 2 bad items. She grants you grace.'},
  broccoli_sprite:    {id:'liferegen', dur:0,  name:'ü•¶ Gentle Healing',      desc:'+1 life ‚Äî the soft sprite gifts you health.'},
  grapefruit_witch:   {id:'magnet_m',  dur:14, name:'üçä Citrus Charm',        desc:'Strong magnet for 14s ‚Äî her zesty power is yours!'},
  potato_sentinel:    {id:'liferegen', dur:0,  name:'ü•î Fluffy Comfort',      desc:'+1 life ‚Äî the potato sentinel heals your wounds.'},
  mashed_egg_duchess: {id:'rallyplus', dur:12, name:'ü•ö Creamy Rally',        desc:'+3pts per heart for 12s ‚Äî the duchess is generous!'},
  maggie_noodle_fiend:{id:'double',    dur:14, name:'üçù Spicy Power',          desc:'2√ó score for 14s ‚Äî the fiend\'s spice fuels you!'},
  penne_phantom:      {id:'magnet_s',  dur:12, name:'üçù Pasta Pull',           desc:'Magnet for 12s ‚Äî penne never lets anything slip!'},
  kovan_memory:       {id:'soulbound', dur:8,  name:'üíå Memory Pulse',         desc:'Soulbound: hearts heal 1 life each for 8s!'},
  navyblue_knight:    {id:'shield2',   dur:0,  name:'ü´ê Knight\'s Honour',     desc:'Fortress Shield ‚Äî the knight guards you now.'},
  brown_pant_phantom: {id:'rally',     dur:14, name:'ü§é Autumn Grace',         desc:'Rally +1pt/heart for 14s ‚Äî warm and steady!'},
  steamboat_guardian: {id:'liferegen', dur:0,  name:'ü´ï Hotpot Heal',          desc:'+1 life ‚Äî the steamboat guardian restores your warmth!'},
  sheng_jian_empress: {id:'double',    dur:12, name:'ü•ü Crispy Victory',       desc:'2√ó score for 12s ‚Äî the empress\'s fire empowers you!'},
  crabstick_commander:{id:'magnet_m',  dur:12, name:'ü¶Ä Ocean Pull',           desc:'Strong magnet for 12s ‚Äî the ocean draws hearts to you!'},
  enoki_empress:      {id:'shieldplus',dur:0,  name:'üçÑ Thread Shield',        desc:'Iron Shield (2 blocks) ‚Äî the empress weaves your protection!'},
  si_ji_dou_guardian: {id:'liferegen', dur:0,  name:'ü´ò Grandma\'s Love',      desc:'+1 life ‚Äî grandma\'s green beans heal you deeply.'},
  cozy_maroon_sentinel:{id:'shield',   dur:0,  name:'üî¥ Maroon Ward',          desc:'Love Shield ‚Äî the sentinel guards your next step!'},
  nightfall_wanderer: {id:'xp_l',      dur:15, name:'üéß Midnight Surge',       desc:'+100% XP for 15s ‚Äî the R&B wanderer enlightens you!'},
  maroon_empress_eternal:{id:'godmode',dur:15, name:'üíú Eternal Grace',        desc:'Queen Mode for 15s ‚Äî the empress crowns you!'},
  steamboat_supreme:  {id:'ultralife', dur:0,  name:'üî• Supreme Warmth',       desc:'+3 lives ‚Äî the supreme sovereign heals you fully!'},
  nostalgia_eclipse:  {id:'soulbound', dur:10, name:'üåí Eclipse Blessing',     desc:'Soulbound for 10s ‚Äî every heart heals 1 life!'},
  duck_rice_overlord: {id:'coins_xl',  dur:0,  name:'ü¶Ü Yew Kee Jackpot',     desc:'+60 coins + 2√ó coins for 10s ‚Äî Yew Kee blesses you!'},
  great_sheng_jian:   {id:'heartquake',dur:0,  name:'ü•ü Great Crispy Blast',   desc:'5√ó pts + scatter 6 hearts + freeze bad for 12s!'},
  maroon_empress_eternal2:{id:'eclipse',dur:0, name:'üíú Eternal Eclipse',      desc:'All bad items gone + 5√ó pts + magnet!'},
  si_ji_dou_deity:    {id:'omni',      dur:20, name:'üåü Divine Bounty',        desc:'3√ó pts + magnet + freeze bad for 20s ‚Äî sacred blessing!'},
  midnight_weeknd_sorceress:{id:'xp_l',dur:20, name:'üåô Midnight Mastery',    desc:'+100% XP for 20s ‚Äî the sorceress reveals all secrets!'},
  weeknd_colossus:    {id:'apotheosis',dur:0,  name:'‚≠ê Starboy Ascension',    desc:'5√ó pts + clear all bad + magnet ‚Äî the Colossus kneels!'},
  after_hours_phantom:{id:'godmode',  dur:20,  name:'üéôÔ∏è After Hours Mode',     desc:'Queen Mode for 20s ‚Äî the phantom grants you its power!'},
  duck_rice_overlord2:{id:'coins_xl',  dur:0,  name:'ü¶Ü Duck Rice Wealth',     desc:'+60 coins + 2√ó coins for 10s!'},
};

// A "rallyplus" is +3pts/heart ‚Äî slightly better than standard rally
// We handle it via a custom inline buff object
function getBossSpecificReward(boss) {
  if (!boss) return null;
  const spec = BOSS_REWARDS[boss.id];
  if (!spec) {
    // Fallback: chaos ‚Üí double points, comfort ‚Üí life regen
    return boss.type === 'hate'
      ? ALL_BUFFS.find(b=>b.id==='double')
      : ALL_BUFFS.find(b=>b.id==='liferegen');
  }
  // Special case rallyplus
  if (spec.id === 'rallyplus') {
    return {id:'rallyplus',rarity:'rare',emoji:'üí™',short:'Rally+',name:spec.name,desc:spec.desc,dur:spec.dur||12,w:0};
  }
  if (spec.id === 'coinboost') {
    return {id:'coinboost',rarity:'rare',emoji:'üí∞',short:'Coins',name:spec.name,desc:spec.desc,dur:spec.dur||12,w:0};
  }
  const baseBuff = ALL_BUFFS.find(b=>b.id===spec.id);
  if (!baseBuff) return ALL_BUFFS.find(b=>b.id==='double');
  return {
    ...baseBuff,
    name: spec.name,
    desc: spec.desc,
    dur: spec.dur !== undefined ? spec.dur : baseBuff.dur,
  };
}

function defeatBoss(){
  bossActive=false;bossShot=[];bossDefeated++;
  // Fire event for easter egg system
  if(selectedBoss) document.dispatchEvent(new CustomEvent('bossDefeatedEvt',{detail:{bossId:selectedBoss.id}}));
  P.achievedLevels.push('boss'+level);
  // Coin Shower: +8 coins on boss kill
  if(shopHas('coin_shower')){coins+=8;P.coins+=8;P.coinsEarned+=8;showPopup('üåßÔ∏è +8 Coins!',W/2,H/3,'#FFD700');}
  // Shield Wall recharge: +1 shield on boss kill
  if(shopHas('shield_wall')&&shieldsLeft<2){shieldsLeft=Math.min(2,shieldsLeft+1);showPopup('üõ°Ô∏è Shield recharged!',W/2,H/3+24,'#90caf9');}
  saveP();
  running=false;

  const boss = selectedBoss;
  // Boss-specific thematic reward, or rare+ fallback
  let reward = getBossSpecificReward(boss);
  if (!reward) {
    const rareBuff=ALL_BUFFS.filter(b=>['rare','epic','legendary'].includes(b.rarity));
    reward=rareBuff[Math.floor(Math.random()*rareBuff.length)];
  }
  // Boss slayer perk: upgrade to epic if shop has it
  if(shopHas('boss_slayer') && ['common','uncommon'].includes(reward.rarity)){
    const epicBuffs=ALL_BUFFS.filter(b=>b.rarity==='epic');
    const epicReward=epicBuffs[Math.floor(Math.random()*epicBuffs.length)];
    reward={...epicReward, name:'üó°Ô∏è '+epicReward.name, desc:'[Boss Slayer] '+epicReward.desc};
  }

  const bossDisplayName = boss ? `${boss.emoji} ${boss.name}` : (level===3?'üçñ The Greasy Pork Chunk':level===6?'üå∂Ô∏è Lord Chili Burn':'üíÄ THE DEMON DUMPLING');
  const bossTypeLabel = boss ? boss.typeLabel : 'Boss';
  const isChaos = boss && boss.type === 'hate';
  const victoryColor = isChaos ? '#FF9977' : '#CE93D8';

  overlay.classList.remove('hidden');
  overlay.innerHTML=`
    <h2 style="color:var(--gold)">üèÜ BOSS DEFEATED!</h2>
    <div style="font-size:2rem;margin:.4rem 0">${isChaos?'üí¢‚öîÔ∏èüî•':'üíú‚ú®üå∏'}</div>
    <p>You defeated the <span style="color:${victoryColor};font-size:.75rem;font-weight:bold">${bossTypeLabel}</span><br>
    <strong style="color:var(--peach);font-size:1rem">${bossDisplayName}</strong>!</p>
    ${boss?`<p style="font-size:.72rem;opacity:.65;font-style:italic;margin-bottom:.3rem">"${boss.lore.slice(0,80)}‚Ä¶"</p>`:''}
    <p style="font-size:.78rem;margin-bottom:.2rem">üéÅ <strong>Boss Reward:</strong></p>
    <div style="border:2px solid ${isChaos?'#FF6633':'#CE93D8'};border-radius:12px;padding:.5rem .8rem;margin:.3rem 0;background:${isChaos?'rgba(255,80,30,0.08)':'rgba(180,100,255,0.08)'}">
      <div style="font-size:.7rem;color:${victoryColor};margin-bottom:.15rem">‚ú¶ Thematic Reward ‚Äî ${bossTypeLabel}</div>
      <strong style="font-family:'Playfair Display',serif">${reward.name}</strong><br>
      <span style="font-size:.75rem;opacity:.85">${reward.desc}</span>
    </div>
    <button class="game-btn" id="boss-claim-btn" style="background:${isChaos?'linear-gradient(135deg,#C0392B,#E74C3C)':'linear-gradient(135deg,#7B1FA2,#9C27B0)'}">Claim Reward! ${isChaos?'‚öîÔ∏è':'üíú'}</button>`;
  document.getElementById('boss-claim-btn').addEventListener('click',()=>{
    if(reward.instant&&reward.fn){const g={coins,P,lives};reward.fn(g);coins=g.coins;lives=g.lives;}
    if(reward.id==='shield') shieldsLeft=1;
    if(reward.id==='shield2') shieldsLeft=3;
    if(reward.id==='shieldplus') shieldsLeft=Math.max(shieldsLeft,2);
    if(reward.id==='phoenix') phoenixReady=true;
    if(reward.id==='liferegen'){lives=Math.min(lives+1,maxLives()+2);updateHUD();}
    if(reward.id==='ultralife'){lives=Math.min(lives+3,maxLives()+4);updateHUD();}
    if(reward.id==='coins_xl'){coins+=60;P.coins+=60;P.coinsEarned+=60;
      activeBuffs.push({id:'coinboost_boss',rarity:'rare',emoji:'üí∞',short:'Coins√ó2',endsAt:frame+10*60});}
    if(reward.id==='rallyplus')
      activeBuffs.push({id:'rallyplus',rarity:'rare',emoji:'üí™',short:'Rally+',endsAt:frame+(reward.dur||12)*60});
    if(reward.id==='coinboost')
      activeBuffs.push({id:'coinboost_boss',rarity:'rare',emoji:'üí∞',short:'+Coins',endsAt:frame+(reward.dur||12)*60});
    if(reward.dur>0&&!reward.instant&&reward.id!=='rallyplus'&&reward.id!=='coinboost'&&reward.id!=='coins_xl')
      activeBuffs.push({id:reward.id,rarity:reward.rarity||'rare',emoji:reward.emoji,short:reward.short,endsAt:reward.dur===Infinity?Infinity:frame+reward.dur*60});
    overlay.classList.add('hidden');running=true;updateHUD();
    // Then show level-up buff pick
    showLevelUpScreen();
  });
}

function showLevelUpScreen(){
  const legendLuck=shopHas('legend_luck');
  const buffs=pick3Buffs(level,legendLuck);
  buffs.forEach(b=>{if(b.rarity==='legendary')P.legendaryRolled++;});saveP();
  const d=lvData(level);
  overlay.classList.remove('hidden');
  overlay.innerHTML=`
    <h2>‚ú® Level Up!</h2>
    <p style="color:${d.color};font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;font-style:normal;margin-bottom:.15rem">
      Lv.${level} ‚Äî ${d.title}</p>
    <p style="font-size:.72rem;margin-bottom:.5rem">${d.desc}</p>
    <p>Pick your buff, Bao! üéÄ<br><span style="font-size:.7rem;opacity:.6;font-style:normal">Game resumes 1.2s after you pick</span></p>
    <div id="buff-picker">
      ${buffs.map(b=>`<button class="buff-option bo-${b.rarity}" data-id="${b.id}">
        <strong><span class="rarity-tag rt-${b.rarity}">${RARITY_LABELS[b.rarity]}</span>${b.name}</strong>
        ${b.desc}</button>`).join('')}
    </div>`;
  document.querySelectorAll('.buff-option').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id;
      const cat=ALL_BUFFS.find(b=>b.id===id);if(!cat) return;
      P.buffsPicked++;saveP();
      if(cat.instant&&cat.fn){const g={coins,P,lives};cat.fn(g);coins=g.coins;lives=g.lives;}
      if(cat.id==='shield') shieldsLeft=1;
      if(cat.id==='shield2') shieldsLeft=3;
      if(cat.id==='shieldplus') shieldsLeft=Math.max(shieldsLeft,2);
      if(cat.id==='phoenix') phoenixReady=true;
      if(cat.id==='vacuum') st._vacuum=true; // handled in game loop
      if(cat.id==='starburst'){streak=Math.min(streak+2,99);score+=2;}
      if(cat.dur>0&&!cat.instant) activeBuffs.push({id:cat.id,rarity:cat.rarity,emoji:cat.emoji,short:cat.short,endsAt:cat.dur===Infinity?Infinity:frame+cat.dur*60});
      overlay.classList.add('hidden');
      // Brief pause so player is ready before items can hit
      running=false;
      setTimeout(()=>{
        // Move all items that are near the basket upward slightly to give time
        const safeY=H*0.55;
        items=items.filter(it=>it.y<safeY);
        running=true;updateHUD();gameLoop();
      },1200);
    });
  });
}

// ===================== END GAME =====================
let lastGameShare={};
function endGame(){
  running=false;
  P.gamesPlayed++;
  if(currentChar==='bao') P.baogames++; else if(currentChar==='dudu') P.dudugames++; else if(currentChar==='bubu') P.bubugames++;
  P.bossesDefeated=(P.bossesDefeated||0)+bossDefeated;
  const prevHighScore = P.highScore;
  const isNewHighScore = score > prevHighScore && prevHighScore > 0;
  if(score>P.highScore) P.highScore=score;
  if(sessionXP>P.bestXP) P.bestXP=sessionXP;
  const bonusCoins=Math.floor(score/5);
  coins+=bonusCoins;P.coins+=bonusCoins;P.coinsEarned+=bonusCoins;
  // Award diamonds for high scores (1 üíé per 20 points, hard to get!)
  if(!P.diamonds) P.diamonds=0;
  const bonusDiamonds=Math.floor(score/20);
  if(bonusDiamonds>0) P.diamonds+=bonusDiamonds;
  saveP();updateStatsPanel();renderShop();
  // Sound effects
  if(isNewHighScore && P.highScore > 0){
    setTimeout(()=>playHighScoreSound(), 200);
  } else {
    setTimeout(()=>playGameOverSound(), 100);
  }
  const d=lvData(level);
  const medal=score>=60?'üèÖ':score>=35?'ü•à':score>=18?'ü•â':'üíï';
  // Store for share card
  lastGameShare={score,level,levelTitle:d.title,levelColor:d.color,medal,streak,sessionHearts,bossDefeated,char:currentChar,highScore:P.highScore};
  overlay.classList.remove('hidden');
  overlay.innerHTML=`
    <h2>${isNewHighScore && P.highScore>0?'üåü NEW RECORD!':score>=40?'üåü Incredible!':score>=20?'üíï Well done!':'üß° Good try!'}</h2>
    ${isNewHighScore && P.highScore>0?`<div style="font-family:'Playfair Display',serif;font-size:.95rem;color:#FFD700;font-style:italic;margin-bottom:.3rem;animation:pulse 1s ease-in-out infinite;">‚ú® Personal Best: ${P.highScore} ‚ú®</div>`:''}
    <p>Reached <strong style="color:${d.color}">Lv.${level} ${d.title}</strong><br>
    ${medal} Score: <strong>${score}</strong> ¬∑ Best: ${P.highScore}<br>
    Hearts: ${sessionHearts} ¬∑ Streak: ${streak}${bossDefeated>0?`<br><span style="color:#FFD700">‚öîÔ∏è Bosses defeated: ${bossDefeated}</span>`:''}${(window._perfectCount||0)>0?`<br><span style="color:#FFD700">‚ú® Perfect catches: ${window._perfectCount}</span>`:''}
    <br><span style="color:var(--gold)">+${bonusCoins} üí∞ bonus coins!</span>${bonusDiamonds>0?`<br><span style="color:#a78bfa">+${bonusDiamonds} üíé diamond${bonusDiamonds>1?'s':''}! (score ‚â• ${bonusDiamonds*20})</span>`:''}</p>
    <p style="font-size:.72rem;opacity:.7;margin-bottom:.7rem">${score>=40?'Legendary as always, Bao üíõ':score>=20?'Keep collecting nomnoms! üçú':'Practice makes perfect, sweet Bao üå∏'}</p>
    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:.4rem">
      <button class="game-btn" id="restart-btn" style="margin:0">Play Again üíï</button>
      <button class="game-btn" id="share-btn" style="margin:0;background:var(--rose);color:white">Share Score üì∏</button>
    </div>`;
  document.getElementById('restart-btn').addEventListener('click',startGame);
  document.getElementById('share-btn').addEventListener('click',openShareModal);
  promptLeaderboard();
}

// ===================== RESET / START =====================
let armorUsed=false;
function resetGame(){
  items=[];popups=[];activeBuffs=[];
  window._bParticles=[];
  window._perfectCount=0;
  score=0;lives=maxLives();xp=0;level=1;frame=0;
  streak=0;sessionHearts=0;coins=0;sessionXP=0;
  shieldsLeft=0;phoenixReady=false;starCache=null;
  passiveCharge=0;duduAuraReady=false;potatoCount=0;window._lifeDebt=0;window._dsToggle=false;
  bossActive=false;bossShot=[];bossDefeated=0;bossPhase=0;
  selectedBoss=null;
  armorUsed=false;
  window._petHeartCount=0;window._petBadDodged=0;window._petMagnetTimer=0;
  window._petX2Timer=0;window._petDuduX2Timer=0;window._petDodgeDebt=0;window._petStreakGuard=false;
  window._petAnim={pulseFrames:0,pulseColor:'#FFD700',burstParticles:[],shakeFrames:0};
  basket.x=W/2;
  if(shopHas('shield_start'))  shieldsLeft=1;
  if(shopHas('phoenix_start')) phoenixReady=true;
  if(shopHas('lucky_start'))   activeBuffs.push({id:'lucky_s',rarity:'common',emoji:'üçÄ',short:'Lucky',endsAt:Infinity});
  if(shopHas('omni_start'))    activeBuffs.push({id:'omni',rarity:'legendary',emoji:'‚ú®',short:'OMNI',endsAt:frame+8*60});
  // New shop item start bonuses
  if(shopHas('soft_landing'))  window._softLandingUsed=false;
  if(shopHas('head_start'))    xp+=5;
  if(shopHas('pocket_change')) {coins+=3;P.coins+=3;}
  if(shopHas('second_wind'))   window._secondWindReady=true;
  if(shopHas('first_aid'))     window._firstAidReady=true;
  if(shopHas('triple_start'))  activeBuffs.push({id:'triple',rarity:'epic',emoji:'üåü',short:'3√ó',endsAt:frame+5*60});
  if(shopHas('double_xp_start')) activeBuffs.push({id:'xp_m',rarity:'rare',emoji:'‚ö°',short:'XP++',endsAt:frame+60*60});
  if(shopHas('dudu_blessing')) streak=2;
  if(shopHas('amber_heart'))   {lives=Math.min(lives+1,8);shieldsLeft=1;activeBuffs.push({id:'lucky_s',rarity:'common',emoji:'üçÄ',short:'Lucky',endsAt:Infinity});}
  if(shopHas('bao_legend'))    {level=2;xp=0;lives=Math.min(lives+2,8);activeBuffs.push({id:'lucky_s',rarity:'common',emoji:'üçÄ',short:'Lucky',endsAt:Infinity});}
  if(shopHas('kovan_memory_shop')){lives=Math.min(lives+3,8);shieldsLeft=1;window._kovanScatter=true;}
  if(shopHas('boss_bane'))     window._bossBane=true;
  if(shopHas('warm_start'))    streak=2;
  if(shopHas('shield_wall'))   shieldsLeft=Math.max(shieldsLeft,2);
  if(shopHas('life_saver'))    window._lifeSaverReady=true;
  if(shopHas('overdrive'))     window._overdriveReady=true;
  window._candyCount=0;
  updateHUD();
}
function startGame(){
  resize(); // ensure canvas dimensions are correct before starting
  resetGame();
  overlay.classList.add('hidden');
  running=true;
  if(window._kovanScatter){
    window._kovanScatter=false;
    setTimeout(()=>{
      for(let _i=0;_i<8;_i++) items.push({x:28+Math.random()*(W-56),y:-28-(Math.random()*120),vy:1.2,emoji:HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)],bad:false,size:22,frozen:false});
    },600);
  }
  gameLoop();
}
document.getElementById('start-btn').addEventListener('click',startGame);

// ===================== CONTROLS =====================
function moveBasket(clientX){
  const rect=canvas.getBoundingClientRect();
  const bw=BASE_W*(st.bw||1);
  let x=(clientX-rect.left)*(W/rect.width);
  basket.x=Math.max(bw/2,Math.min(W-bw/2,x));
}
canvas.addEventListener('mousemove',e=>{if(running)moveBasket(e.clientX);});
canvas.addEventListener('touchmove',e=>{e.preventDefault();if(running)moveBasket(e.touches[0].clientX);},{passive:false});
canvas.addEventListener('touchstart',e=>{if(running)moveBasket(e.touches[0].clientX);},{passive:true});

// ===================== TABS =====================
function hcSubTab(sub){
  document.getElementById('hc-subtab-play-content').style.display = sub==='play' ? '' : 'none';
  document.getElementById('hc-subtab-shop-content').style.display = sub==='shop' ? '' : 'none';
  document.getElementById('hc-subtab-play').classList.toggle('active', sub==='play');
  document.getElementById('hc-subtab-shop').classList.toggle('active', sub==='shop');
  if(sub==='shop') renderShop();
}

function showTab(tab){
  const tabs=['game','blackjack','c4','stats'];
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',tabs[i]===tab));
  ['tab-game','tab-blackjack','tab-c4','tab-stats'].forEach(id=>{
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById('tab-'+tab).classList.remove('hidden');
  if(tab==='game'){
    // Canvas-wrap was hidden (display:none), so clientWidth was 0. Re-measure now it's visible.
    requestAnimationFrame(()=>{ resize(); });
    const shopVisible = document.getElementById('hc-subtab-shop-content') && document.getElementById('hc-subtab-shop-content').style.display !== 'none';
    if(shopVisible) renderShop();
  }
  if(tab==='stats') updateStatsPanel();
  if(tab==='blackjack'){ if(typeof pdUpdateCoinDisplay==='function') pdUpdateCoinDisplay(); }
}





// ===================== POTATO DEALER (Blackjack RPG) =====================
// ===================== POTATO DEALER (Blackjack RPG) =====================

// ‚îÄ‚îÄ Sound Engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const pdAudio = (function(){
  let ctx = null;
  function getCtx(){ if(!ctx) try{ctx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){} return ctx; }
  function play(type){
    const c=getCtx(); if(!c) return;
    const o=c.createOscillator(), g=c.createGain();
    o.connect(g); g.connect(c.destination);
    const t=c.currentTime;
    if(type==='deal'){
      o.type='triangle'; o.frequency.setValueAtTime(520,t); o.frequency.exponentialRampToValueAtTime(280,t+.12);
      g.gain.setValueAtTime(.18,t); g.gain.exponentialRampToValueAtTime(.001,t+.13);
      o.start(t); o.stop(t+.14);
    } else if(type==='win'){
      ['triangle','sine'].forEach((tp,i)=>{
        const o2=c.createOscillator(),g2=c.createGain();
        o2.connect(g2);g2.connect(c.destination);
        o2.type=tp;
        [440,554,660,880].forEach((f,j)=>{ o2.frequency.setValueAtTime(f,t+j*.09+i*.03); });
        g2.gain.setValueAtTime(.12,t); g2.gain.exponentialRampToValueAtTime(.001,t+.5);
        o2.start(t); o2.stop(t+.52);
      });
    } else if(type==='lose'){
      o.type='sawtooth'; o.frequency.setValueAtTime(300,t); o.frequency.exponentialRampToValueAtTime(120,t+.3);
      g.gain.setValueAtTime(.15,t); g.gain.exponentialRampToValueAtTime(.001,t+.32);
      o.start(t); o.stop(t+.34);
    } else if(type==='ability'){
      o.type='sine'; o.frequency.setValueAtTime(660,t); o.frequency.setValueAtTime(880,t+.05); o.frequency.setValueAtTime(1100,t+.1);
      g.gain.setValueAtTime(.14,t); g.gain.exponentialRampToValueAtTime(.001,t+.18);
      o.start(t); o.stop(t+.2);
    } else if(type==='ability_shield'){
      // Heavy thud + low rumble ‚Äî defensive wall
      o.type='square'; o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(140,t+.1);
      g.gain.setValueAtTime(.22,t); g.gain.exponentialRampToValueAtTime(.001,t+.25);
      o.start(t); o.stop(t+.28);
      const o2=c.createOscillator(),g2=c.createGain(); o2.connect(g2);g2.connect(c.destination);
      o2.type='triangle'; o2.frequency.setValueAtTime(440,t+.05); o2.frequency.exponentialRampToValueAtTime(660,t+.18);
      g2.gain.setValueAtTime(.1,t+.05); g2.gain.exponentialRampToValueAtTime(.001,t+.22); o2.start(t+.05);o2.stop(t+.24);
    } else if(type==='ability_double'){
      // Crisp double-ping ‚Äî burst of luck
      [660,1320].forEach((f,i)=>{ const o2=c.createOscillator(),g2=c.createGain(); o2.connect(g2);g2.connect(c.destination); o2.type='triangle'; o2.frequency.value=f; g2.gain.setValueAtTime(.16,t+i*.07); g2.gain.exponentialRampToValueAtTime(.001,t+i*.07+.15); o2.start(t+i*.07);o2.stop(t+i*.07+.17); });
    } else if(type==='ability_rage'){
      // Growling snarl ‚Äî anger surge
      o.type='sawtooth'; o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(280,t+.15);
      g.gain.setValueAtTime(.2,t); g.gain.exponentialRampToValueAtTime(.001,t+.22);
      o.start(t); o.stop(t+.24);
    } else if(type==='ability_streak'){
      // Rising flame ‚Äî power stacking
      [330,440,550,660,770].forEach((f,i)=>{ const o2=c.createOscillator(),g2=c.createGain(); o2.connect(g2);g2.connect(c.destination); o2.type='sawtooth'; o2.frequency.value=f; g2.gain.setValueAtTime(.1,t+i*.04); g2.gain.exponentialRampToValueAtTime(.001,t+i*.04+.1); o2.start(t+i*.04);o2.stop(t+i*.04+.12); });
    } else if(type==='ability_peek'){
      // Soft whisper swish ‚Äî sneaky reveal
      o.type='sine'; o.frequency.setValueAtTime(1200,t); o.frequency.exponentialRampToValueAtTime(600,t+.2);
      g.gain.setValueAtTime(.1,t); g.gain.exponentialRampToValueAtTime(.001,t+.22);
      o.start(t); o.stop(t+.24);
    } else if(type==='ability_lucky'){
      // Sparkling twinkle ‚Äî luck magic
      [880,1108,1320,1760].forEach((f,i)=>{ const o2=c.createOscillator(),g2=c.createGain(); o2.connect(g2);g2.connect(c.destination); o2.type='triangle'; o2.frequency.value=f; g2.gain.setValueAtTime(.12,t+i*.06); g2.gain.exponentialRampToValueAtTime(.001,t+i*.06+.12); o2.start(t+i*.06);o2.stop(t+i*.06+.14); });
    } else if(type==='ult'){
      [1,1.26,1.5,2].forEach((r,i)=>{ const o2=c.createOscillator(),g2=c.createGain(); o2.connect(g2);g2.connect(c.destination); o2.type='sine'; o2.frequency.setValueAtTime(440*r,t+i*.08); g2.gain.setValueAtTime(.16,t+i*.08); g2.gain.exponentialRampToValueAtTime(.001,t+i*.08+.25); o2.start(t+i*.08);o2.stop(t+i*.08+.27); });
    } else if(type==='boss_hurt'){
      o.type='square'; o.frequency.setValueAtTime(180,t); o.frequency.exponentialRampToValueAtTime(80,t+.2);
      g.gain.setValueAtTime(.2,t); g.gain.exponentialRampToValueAtTime(.001,t+.22);
      o.start(t); o.stop(t+.24);
    } else if(type==='reward'){
      [523,659,784,1047].forEach((f,i)=>{ const o2=c.createOscillator(),g2=c.createGain(); o2.connect(g2);g2.connect(c.destination); o2.type='triangle'; o2.frequency.value=f; g2.gain.setValueAtTime(.13,t+i*.1); g2.gain.exponentialRampToValueAtTime(.001,t+i*.1+.2); o2.start(t+i*.1);o2.stop(t+i*.1+.22); });
    } else if(type==='flip'){
      o.type='triangle'; o.frequency.setValueAtTime(800,t); o.frequency.exponentialRampToValueAtTime(400,t+.08);
      g.gain.setValueAtTime(.1,t); g.gain.exponentialRampToValueAtTime(.001,t+.09);
      o.start(t); o.stop(t+.1);
    }
  }
  return { play };
})();

// ‚îÄ‚îÄ Character Definitions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PD_CHARS = {
  bao: {
    name:'Bao', color:'var(--peach)', hp:120,
    abilities:[
      {id:'shield', name:'Potato Shield', icon:'ü•î', desc:'Block next dealer attack (0 dmg)', cooldown:3},
      {id:'double',  name:'Double Luck',    icon:'üí•', desc:'Win = 2√ó damage dealt',           cooldown:2},
    ],
    ult:{id:'nomnom', name:'Nomnom Feast', icon:'üçü', desc:'Heal 50 HP. If your hand is under 15, swap your worst card for a safer one. Peek the dealer\'s hidden card.', cost:3}
  },
  dudu: {
    name:'Dudu', color:'#f4a261', hp:100,
    abilities:[
      {id:'rage',   name:'Rage Draw',   icon:'üò°', desc:'Force dealer to draw extra card', cooldown:2},
      {id:'streak', name:'Angry Aura',  icon:'üî•', desc:'Each win adds +6 bonus damage (stacks)', cooldown:0},
    ],
    ult:{id:'bearrage', name:'Bear Rage', icon:'üêæ', desc:'Deal 35 direct + 2√ó streak bonus', cost:3}
  },
  bubu: {
    name:'Bubu', color:'#a78bfa', hp:110,
    abilities:[
      {id:'peek',  name:'Peek Card',   icon:'üëÅÔ∏è', desc:"See dealer's hidden card",       cooldown:2},
      {id:'lucky', name:'Lucky Star',  icon:'‚≠ê', desc:'Replace worst card in your hand', cooldown:3},
    ],
    ult:{id:'fortune', name:'Fortune Paw', icon:'üåü', desc:'Guarantee next win + heal 30 HP', cost:3}
  }
};

// ‚îÄ‚îÄ Bosses (themed around Amber's world) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PD_BOSSES = [
  {
    name:'Udon Worm', sprite:'ü™±', hp:80, atk:12, tier:1,
    desc:'A slimy worm-like noodle that Amber refuses to eat.',
    taunt:"Slurp slurp~ I'm unavoidable!",
    special: null
  },
  {
    name:'Onion King', sprite:'üßÖ', hp:110, atk:18, tier:2,
    desc:"The king of everything Amber picks out of her food.",
    taunt:"You can't escape my layers!",
    special:'tears' // makes player "cry" (skip one card reveal)
  },
  {
    name:'Bean Sprout Boss', sprite:'üå±', hp:140, atk:22, tier:3,
    desc:"Stringy, slimy, and absolutely not wanted.",
    taunt:"I grow stronger the more you hate me!",
    special:'double_draw' // dealer draws 2 cards sometimes
  },
  {
    name:'Weekend Enemy', sprite:'üò§', hp:170, atk:27, tier:4,
    desc:"The force that makes weekends feel too short. Based on The Weeknd ironically.",
    taunt:"Blinding Lights won't save you now!",
    special:'freeze' // occasionally freezes an ability cooldown
  },
  {
    name:'Dark Sour Sam', sprite:'üòà', hp:210, atk:32, tier:5,
    desc:"The ultimate boss. Everything Amber dislikes given form.",
    taunt:"No maroon walls can protect you here!",
    special:'mirror' // 50% chance to mirror damage back
  }
];

// ‚îÄ‚îÄ Reward Pool ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Tier 1 (after boss 1), Tier 2 (bosses 2-3), Tier 3 (bosses 4-5)
const PD_REWARD_POOL = {
  1: [
    {id:'extra_hp_sm',   name:'Potato Snack',      icon:'ü•î', desc:'Restore 20 HP right now.', type:'instant', val:20},
    {id:'shield_charge', name:'Extra Spud Shield',  icon:'üõ°Ô∏è', desc:'Next Potato Shield has 2 charges.', type:'passive'},
    {id:'start_bonus',   name:'Head Start',         icon:'üé¥', desc:'Start each hand with 1 safe bonus card (only added if it won\'t bust you ‚Äî skipped if your hand is already 17+).', type:'passive'},
    {id:'win_heal',      name:'Victory Snack',       icon:'üå∏', desc:'Heal 5 HP every time you win a hand.', type:'passive'},
    {id:'reduced_cd_1',  name:'Quick Hands',         icon:'‚ö°', desc:'Ability 1 cooldown reduced by 1.', type:'passive'},
    {id:'lucky_draw',    name:'Lucky Potato',        icon:'‚ú®', desc:'Once per hand, re-draw 1 card automatically if over 18.', type:'passive'},
  ],
  2: [
    {id:'extra_hp_md',   name:'Baked Potato',       icon:'üç†', desc:'Restore 35 HP right now.', type:'instant', val:35},
    {id:'double_cd',     name:'Power Surge',         icon:'üí™', desc:'Ability 2 cooldown reduced by 1.', type:'passive'},
    {id:'streak_amp',    name:'Maroon Fire',         icon:'‚ù§Ô∏è', desc:'Streak bonus damage +4 per win.', type:'passive'},
    {id:'boss_weak',     name:'Boss Buster',         icon:'üéØ', desc:'All boss attacks deal 4 less damage.', type:'passive'},
    {id:'ult_charge',    name:'Power Potato',        icon:'‚ö°', desc:'Ult charges faster (cost -1 win).', type:'passive'},
    {id:'blackjack_amp', name:'Natural 21',          icon:'üÉè', desc:'Blackjack (21 on deal) deals +20 bonus damage.', type:'passive'},
    {id:'push_heal',     name:'Tie Break',           icon:'ü§ù', desc:'Push (tie) hands now heal 8 HP.', type:'passive'},
  ],
  3: [
    {id:'extra_hp_lg',   name:'Grandma\'s Si Ji Dou',icon:'ü´õ', desc:'Restore 45 HP now + permanently heal 6 HP every win.', type:'hybrid', val:45, passiveId:'siji_sustain'},
    {id:'mirror_shield', name:'Spud Mirror',         icon:'ü™û', desc:'When shielded, reflect 12 dmg back at boss.', type:'passive'},
    {id:'mega_streak',   name:'Sheng Jian Bao',     icon:'ü•ü', desc:'Streak bonus is permanent across boss fights.', type:'passive'},
    {id:'dealer_penalty',name:'Yew Kee Power',      icon:'ü¶Ü', desc:'Dealer busts = deal 15 extra damage.', type:'passive'},
    {id:'full_restore',  name:'Lor Mee Surge',       icon:'üçú', desc:'Restore 30 HP now + permanently deal +10 bonus dmg on wins.', type:'hybrid', val:30, passiveId:'lormee_power'},
    {id:'ult_refund',    name:'Fortune Cat',         icon:'üê±', desc:'Using ult restores 1 ult charge on win.', type:'passive'},
  ]
};

// ‚îÄ‚îÄ Game State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pdState = {};

// ‚îÄ‚îÄ Init & Portrait Population ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function pdInitPortraits(){
  const ids=['bao','dudu','bubu'];
  ids.forEach(id=>{
    const el=document.getElementById('pd-portrait-'+id);
    if(el) el.innerHTML=getCharPortraitHTML(id,36);
  });
})();

// ‚îÄ‚îÄ Card Engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PD_SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£'];
const PD_RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
// Potato-themed rank display
const PD_POTATO_RANKS={'A':'ü•î','2':'2','3':'3','4':'4','5':'5','6':'6','7':'7','8':'8','9':'9','10':'10','J':'J','Q':'Q','K':'K'};

function pdDeck(){
  const d=[];
  for(const s of PD_SUITS) for(const r of PD_RANKS) d.push({suit:s,rank:r,hidden:false});
  for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]];}
  return d;
}

function pdCardVal(rank){
  if(['J','Q','K'].includes(rank)) return 10;
  if(rank==='A') return 11;
  return parseInt(rank);
}

function pdHandTotal(cards){
  let t=0,a=0;
  for(const c of cards){ t+=pdCardVal(c.rank); if(c.rank==='A')a++; }
  while(t>21&&a>0){t-=10;a--;}
  return t;
}

function pdCardHTML(card, delay=0){
  if(card.hidden){
    return `<div class="pd-card hidden-card dealing" style="animation-delay:${delay}ms;" title="Hidden">
      <div style="font-size:1.4rem;">ü•î</div>
    </div>`;
  }
  const isRed=card.suit==='‚ô•'||card.suit==='‚ô¶';
  const cls=isRed?'red':'black';
  const rankDisplay=card.rank==='A'?'ü•î':card.rank;
  return `<div class="pd-card ${cls} dealing" style="animation-delay:${delay}ms;" title="${card.rank}${card.suit}">
    <div class="rank">${rankDisplay}</div>
    <div class="suit">${card.suit}</div>
  </div>`;
}

function pdRenderCards(){
  const s=pdState;
  const dc=document.getElementById('pd-dealer-cards');
  const pc=document.getElementById('pd-player-cards');
  if(!dc||!pc) return;
  dc.innerHTML=s.dealerCards.map((c,i)=>pdCardHTML(c,i*80)).join('');
  pc.innerHTML=s.playerCards.map((c,i)=>pdCardHTML(c,i*80+200)).join('');
  const pt=pdHandTotal(s.playerCards);
  document.getElementById('pd-player-total').textContent=pt;
  const visD=s.dealerCards.filter(c=>!c.hidden);
  document.getElementById('pd-dealer-total').textContent=visD.length?pdHandTotal(visD)+'':'?';
}

// ‚îÄ‚îÄ Select Character ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdSelectChar(charId){
  if(pdState.running) return;
  // Check bet
  if((P.coins||0) < pdCurrentBet){
    document.getElementById('pd-bet-error').textContent = `Not enough coins! You have ${P.coins||0} ü™ô`;
    return;
  }
  if(pdCurrentBet < 5){
    document.getElementById('pd-bet-error').textContent = 'Minimum bet is 5 coins!';
    return;
  }
  // Deduct bet
  P.coins -= pdCurrentBet;
  saveP();
  pdUpdateCoinDisplay();
  P.pdPetReviveUsed = false; // reset revive for new game
  
  const char=PD_CHARS[charId];
  pdState={
    char:charId, charDef:char, running:true,
    hp:char.hp, maxHp:char.hp,
    bossIdx:0,
    bossHp:PD_BOSSES[0].hp, bossMaxHp:PD_BOSSES[0].hp,
    deck:pdDeck(),
    playerCards:[], dealerCards:[],
    ab1Cd:0, ab2Cd:0, ultWins:0, ultCost:char.ult.cost,
    shield:false, doubleDmg:false, rageDraw:false, fortuneNext:false, freeCards:0,
    streakBonus:0, streakCount:0,
    phase:'deal', round:1,
    acquiredBuffs:[],
    betAmount: pdCurrentBet,
    bonusCoins: 0,
    // Buff flags
    bufWinHeal:0, bufBossWeak:0, bufBlackjackAmp:0, bufPushHeal:0, bufLorMeeDmg:0,
    bufMirrorShield:false, bufMegaStreak:false, bufDealerPenalty:0,
    bufUltRefund:false, bufLuckyDraw:false, bufStartBonus:false,
    selectedReward:null,
  };
  document.getElementById('pd-bet-panel').style.display='none';
  document.querySelectorAll('.pd-char-btn').forEach(b=>b.style.opacity='.45');
  document.getElementById('pd-btn-'+charId).style.opacity='1';
  document.getElementById('pd-hero-name').textContent=char.name;
  document.getElementById('pd-hero-portrait').innerHTML=getCharPortraitHTML(charId,30);
  pdUpdateBoss();
  pdUpdateAbilityBtns();
  document.getElementById('pd-game-area').style.display='block';
  document.getElementById('pd-reward-screen').style.display='none';
  document.getElementById('pd-end-screen').style.display='none';
  pdDeal();
}

// ‚îÄ‚îÄ Boss UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdUpdateBoss(){
  const boss=PD_BOSSES[pdState.bossIdx];
  document.getElementById('pd-boss-name').textContent=boss.name;
  document.getElementById('pd-boss-sprite').textContent=boss.sprite;
  pdUpdateHpBars();
  pdUpdateWaveInfo();
}

function pdUpdateHpBars(){
  const s=pdState;
  const hPct=Math.max(0,s.hp/s.maxHp*100);
  const bPct=Math.max(0,s.bossHp/s.bossMaxHp*100);
  document.getElementById('pd-hero-hp-bar').style.width=hPct+'%';
  document.getElementById('pd-hero-hp-text').textContent=Math.max(0,s.hp)+'/'+s.maxHp;
  document.getElementById('pd-boss-hp-bar').style.width=bPct+'%';
  document.getElementById('pd-boss-hp-text').textContent=Math.max(0,s.bossHp)+'/'+s.bossMaxHp;
}

function pdUpdateWaveInfo(){
  const s=pdState;
  document.getElementById('pd-wave-info').textContent=`Boss ${s.bossIdx+1}/${PD_BOSSES.length} ¬∑ Round ${s.round}`;
}

function pdBossShakeAnim(){
  const el=document.getElementById('pd-boss-sprite');
  el.classList.remove('boss-shake','boss-hurt');
  void el.offsetWidth;
  el.classList.add('boss-shake','boss-hurt');
  setTimeout(()=>el.classList.remove('boss-shake','boss-hurt'),500);
  pdAudio.play('boss_hurt');
}

function pdPlayerWinAnim(){
  const el=document.getElementById('pd-hero-portrait');
  el.classList.remove('player-win-anim');
  void el.offsetWidth;
  el.classList.add('player-win-anim');
  setTimeout(()=>el.classList.remove('player-win-anim'),600);
}

// ‚îÄ‚îÄ Float Message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdFloatMsg(text, duration=900){
  const el=document.getElementById('pd-float-msg');
  if(!el) return;
  el.textContent=text;
  el.style.display='block';
  el.style.opacity='1';
  setTimeout(()=>{
    el.style.transition='opacity .4s';
    el.style.opacity='0';
    setTimeout(()=>{el.style.display='none';el.style.transition='';},400);
  },duration);
}

function pdMsg(text){ const el=document.getElementById('pd-msg'); if(el) el.textContent=text; }

// ‚îÄ‚îÄ Deal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdDeal(){
  const s=pdState;
  s.phase='play';
  s.shield=false; s.doubleDmg=false; s.rageDraw=false;
  if(s.deck.length<8) s.deck=pdDeck();

  s.playerCards=[pdDraw(),pdDraw()];
  if(s.bufStartBonus){
    const bonusCard=pdDraw();
    const testTotal=pdHandTotal([...s.playerCards,bonusCard]);
    // Only add bonus card if it won't bust ‚Äî discard silently if it would
    if(testTotal<=21) s.playerCards.push(bonusCard);
  }
  for(let i=0;i<s.freeCards;i++) s.playerCards.push(pdDraw());
  s.freeCards=0;
  s.dealerCards=[pdDraw(),{...pdDraw(),hidden:true}];

  // Ability cooldown tick
  if(s.ab1Cd>0) s.ab1Cd--;
  if(s.ab2Cd>0) s.ab2Cd--;

  pdRenderCards();
  pdUpdateAbilityBtns();
  pdShowActionBtns(true);
  document.getElementById('pd-deal-btn').style.display='none';

  // Lucky draw passive: if dealt >18, replace one card
  if(s.bufLuckyDraw&&pdHandTotal(s.playerCards)>18){
    setTimeout(()=>{
      const idx=s.playerCards.findIndex(c=>pdCardVal(c.rank)>5);
      if(idx>=0){ s.playerCards[idx]=pdDraw(); pdRenderCards(); pdMsg('‚≠ê Lucky Draw activated!'); }
    },600);
  }

  const pt=pdHandTotal(s.playerCards);
  if(pt===21){
    pdAudio.play('win');
    pdFloatMsg('ü•î POTATO 21! ü•î');
    pdMsg('Potato 21! Natural win!');
    setTimeout(()=>pdStand(),400);
    return;
  }
  pdAudio.play('deal');
  pdMsg('Hit or Stand?');
}

function pdDraw(){
  if(pdState.deck.length<4) pdState.deck=pdDeck();
  return pdState.deck.pop();
}

// ‚îÄ‚îÄ Hit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdHit(){
  const s=pdState;
  if(s.phase!=='play') return;
  const newCard=pdDraw();
  s.playerCards.push(newCard);
  pdAudio.play('deal');
  pdRenderCards();
  const total=pdHandTotal(s.playerCards);
  if(total>21){
    // Pet lucky draw: chance to auto-replace the bad card
    if(pdPetLuckyDraw() && s.playerCards.length>2){
      s.playerCards.pop(); // remove the bad card
      const betterCard = pdDraw();
      s.playerCards.push(betterCard);
      pdRenderCards();
      const newTotal = pdHandTotal(s.playerCards);
      pdPetFloatText('üçÄ Lucky Re-draw!', '#4ade80');
      pdAudio.play('reward');
      if(newTotal>21){ pdMsg('Still bust! üí•'); pdResolve('bust'); }
      else if(newTotal===21){ pdMsg('21! Pet saved you! üêæü•î'); setTimeout(()=>pdStand(),300); }
      else pdMsg(`üêæ Lucky re-draw! Total: ${newTotal}`);
    } else {
      pdMsg('Bust! üí• Over 21!'); pdAudio.play('lose'); pdResolve('bust');
    }
  }
  else if(total===21){ pdMsg('21! Perfect! ü•î'); setTimeout(()=>pdStand(),300); }
  else pdMsg(`Total: ${total} ‚Äî Hit or Stand?`);
}

// ‚îÄ‚îÄ Stand / Dealer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdStand(){
  const s=pdState;
  if(s.phase!=='play') return;
  s.phase='dealer';
  pdAudio.play('flip');

  // Reveal hidden card
  s.dealerCards.forEach(c=>c.hidden=false);
  pdRenderCards();

  const boss=PD_BOSSES[s.bossIdx];
  const target=boss.name==='Udon Worm'?18:boss.name==='Bean Sprout Boss'?18:17;

  setTimeout(()=>{
    // Dealer draws
    let extras=s.rageDraw?1:0;
    if(boss.special==='double_draw'&&Math.random()<.35) extras++;
    let draws=0;
    const dealerDraw=()=>{
      if(pdHandTotal(s.dealerCards)<target||draws<extras){
        s.dealerCards.push(pdDraw());
        draws++;
        pdAudio.play('deal');
        pdRenderCards();
        setTimeout(dealerDraw,350);
      } else {
        const pt=pdHandTotal(s.playerCards);
        const dt=pdHandTotal(s.dealerCards);
        if(pt>21) pdResolve('bust');
        else if(dt>21) pdResolve('win',true);
        else if(pt>dt) pdResolve('win');
        else if(pt===dt) pdResolve('push');
        else pdResolve('lose');
      }
    };
    dealerDraw();
  },400);
}

// ‚îÄ‚îÄ Resolve ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdResolve(result, dealerBust=false){
  const s=pdState;
  s.phase='end';
  pdShowActionBtns(false);
  document.getElementById('pd-deal-btn').style.display='';
  const boss=PD_BOSSES[s.bossIdx];

  let dmgDealt=0, dmgTaken=0, msg='';

  if(result==='win'){
    s.ultWins++;
    s.streakCount++;
    const nat21=pdHandTotal(s.playerCards)===21&&s.playerCards.length===2;
    dmgDealt=20+s.streakBonus+(s.bufBlackjackAmp&&nat21?20:0)+(dealerBust&&s.bufDealerPenalty?s.bufDealerPenalty:0)+(s.bufLorMeeDmg||0);
    if(s.doubleDmg) dmgDealt*=2;
    // Pet damage bonus
    const petBonus = pdPetOnWin(s);
    dmgDealt += petBonus.dmgBonus;
    // Mirror shield boss: chance to reflect
    if(boss.special==='mirror'&&Math.random()<.5) {
      const reflected=Math.floor(dmgDealt*.15);
      s.hp-=reflected;
      msg+=` (boss reflected ${reflected}!)`;
    }
    s.bossHp-=dmgDealt;
    if(s.bufWinHeal) s.hp=Math.min(s.maxHp,s.hp+s.bufWinHeal);
    // Pet heal bonus
    if(petBonus.healBonus) s.hp=Math.min(s.maxHp,s.hp+petBonus.healBonus);
    // Pet coin bonus
    if(petBonus.coinBonus){ s.bonusCoins=(s.bonusCoins||0)+petBonus.coinBonus; }
    if(s.fortuneNext){ s.hp=Math.min(s.maxHp,s.hp+30); s.fortuneNext=false; }
    if(s.charDef===PD_CHARS.dudu){ s.streakBonus+=6+(s.bufMegaStreak?0:0); }
    pdPlayerWinAnim();
    pdBossShakeAnim();
    pdAudio.play('win');
    const petTxt = petBonus.dmgBonus>0?` +${petBonus.dmgBonus}üêæ`:'';
    pdFloatMsg('‚öîÔ∏è +'+dmgDealt+' dmg!'+petTxt);
    msg=`Win! ‚öîÔ∏è ${dmgDealt} damage to boss!`+msg;
    if(petBonus.healBonus>0) msg += ` üêæ+${petBonus.healBonus}HP`;
    if(dealerBust) msg='Dealer bust! '+msg;
    if(s.bufUltRefund&&s.ultWins>=s.ultCost) s.ultWins=Math.max(0,s.ultWins-1);
  } else if(result==='lose'||result==='bust'){
    s.streakBonus=pdState.bufMegaStreak?s.streakBonus:0;
    s.streakCount=0;
    dmgTaken=Math.max(0,boss.atk-(s.bufBossWeak||0));
    if(boss.special==='freeze'&&Math.random()<.3){s.ab1Cd+=2;s.ab2Cd+=2;msg+=' ‚ùÑÔ∏è Abilities frozen!';}
    // Pet block chance
    const petBlock = Math.random() < pdPetBlockChance();
    if(!s.shield && !petBlock) s.hp-=dmgTaken;
    else if(s.shield){
      if(s.bufMirrorShield) s.bossHp-=12;
      msg+=' ü•î Shield blocked it!';
    } else if(petBlock){
      pdPetAnimTrigger(PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet)||{emoji:'üõ°Ô∏è'}, 'shield');
      msg+=' üêæ Pet blocked it!';
    }
    s.shield=false;
    pdAudio.play('lose');
    pdFloatMsg(result==='bust'?'üí• Bust!':'üíî Ouch!');
    msg=(result==='bust'?'Bust! ':'')+`Took ${(s.shield||petBlock)?0:dmgTaken} dmg.`+msg;
  } else { // push
    if(s.bufPushHeal) s.hp=Math.min(s.maxHp,s.hp+s.bufPushHeal);
    pdMsg('Push! ü§ù A tie ‚Äî no damage.');
    pdUpdateHpBars(); pdUpdateAbilityBtns();
    s.round++;
    pdUpdateWaveInfo();
    return;
  }

  pdUpdateHpBars();
  pdUpdateAbilityBtns();
  pdMsg(msg);
  s.round++;
  pdUpdateWaveInfo();
  pdUpdateActiveBuffDisplay();

  // Check hero death
  if(s.hp<=0){
    // Try pet revive
    if(pdPetCanRevive()){
      pdPetRevive(s);
      pdMsg('üî• Pet revived you! ' + (PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet)?.emoji||'') + ' saved your life!');
      pdUpdateHpBars();
    } else {
      setTimeout(()=>pdEndGame(false),1000); return;
    }
  }
  // Check boss defeat
  if(s.bossHp<=0){
    setTimeout(()=>pdShowRewards(),700);
    return;
  }
}

// ‚îÄ‚îÄ Abilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdUseAbility(which){
  const s=pdState;
  if(s.phase!=='play') return;
  const def=s.charDef;

  if(which===1){
    if(s.ab1Cd>0){ pdMsg(`‚è≥ On cooldown: ${s.ab1Cd} hand(s)`); return; }
    const ab=def.abilities[0];
    s.ab1Cd=Math.max(1,ab.cooldown-(s.bufReducedCd1||0));
    if(ab.id==='shield'){ s.shield=true; pdMsg('ü•î Potato Shield! Next hit blocked!'); }
    else if(ab.id==='rage'){ s.rageDraw=true; pdMsg('üò° Rage Draw! Dealer draws one more!'); }
    else if(ab.id==='peek'){
      const h=s.dealerCards.find(c=>c.hidden);
      if(h) pdMsg(`üëÅÔ∏è Dealer's hidden card: ${h.rank}${h.suit}!`);
      else pdMsg('üëÅÔ∏è No hidden cards right now!');
    }
    pdAudio.play('ability_'+ab.id);
  } else if(which===2){
    if(s.ab2Cd>0){ pdMsg(`‚è≥ On cooldown: ${s.ab2Cd} hand(s)`); return; }
    const ab=def.abilities[1];
    s.ab2Cd=Math.max(1,ab.cooldown-(s.bufReducedCd2||0));
    if(ab.id==='double'){ s.doubleDmg=true; pdMsg('üí• Double Luck! Win = 2√ó damage!'); }
    else if(ab.id==='streak'){ pdMsg(`üî• Angry Aura active! Current streak bonus: +${s.streakBonus} dmg.`); s.ab2Cd=0;}
    else if(ab.id==='lucky'){
      const total=pdHandTotal(s.playerCards);
      if(total>15&&s.playerCards.length>2){
        // Replace the highest-value card that's making us risky
        let worstIdx=0; let worstScore=-Infinity;
        s.playerCards.forEach((c,i)=>{ const v=pdCardVal(c.rank); if(v>worstScore){worstScore=v;worstIdx=i;} });
        s.playerCards[worstIdx]=pdDraw();
        pdRenderCards();
        pdMsg('‚≠ê Lucky Star! Replaced worst card!');
      } else pdMsg('‚≠ê Hand looks fine already!');
    }
    pdAudio.play('ability_'+ab.id);
  } else if(which==='ult'){
    if(s.ultWins<s.ultCost){ pdMsg(`‚ú® Need ${s.ultCost-s.ultWins} more win(s) for Ultimate!`); return; }
    s.ultWins=0;
    const ult=def.ult;
    if(ult.id==='nomnom'){
      // 1. Big heal
      s.hp=Math.min(s.maxHp,s.hp+50);
      pdUpdateHpBars();
      let msg='üçü NOMNOM FEAST! +50 HP!';

      // 2. Reveal dealer's hidden card
      const hiddenCard=s.dealerCards.find(c=>c.hidden);
      if(hiddenCard){
        hiddenCard.hidden=false;
        msg+=` Dealer has ${hiddenCard.rank}${hiddenCard.suit}!`;
        setTimeout(()=>{ hiddenCard.hidden=true; pdRenderCards(); },2800);
        pdRenderCards();
      }

      // 3. If hand is under 15, swap worst high card for a safer one (‚â§6)
      const currentTotal=pdHandTotal(s.playerCards);
      if(currentTotal<15 && s.playerCards.length>0){
        // Find the highest-value card (most likely to cause problems)
        let worstIdx=0, worstVal=-1;
        s.playerCards.forEach((c,i)=>{ const v=pdCardVal(c.rank); if(v>worstVal){worstVal=v;worstIdx=i;} });
        // Try to draw a card worth 6 or less
        let safeCard=null, attempts=0;
        while(attempts<8){
          const drawn=pdDraw();
          if(pdCardVal(drawn.rank)<=6){ safeCard=drawn; break; }
          // put back and try again (simplified ‚Äî just draw until safe or give up)
          s.deck.unshift(drawn); attempts++;
        }
        if(safeCard){
          s.playerCards[worstIdx]=safeCard;
          pdRenderCards();
          msg+=` Swapped ${['A','2','3','4','5','6','7','8','9','10','J','Q','K'][worstIdx]||'a card'} for a safer one!`;
        }
      } else if(currentTotal>=15){
        msg+=' Hand already strong, no swap needed!';
      }

      pdMsg(msg);
    } else if(ult.id==='bearrage'){
      const dmg=35+s.streakBonus*2;
      s.bossHp-=dmg;
      pdMsg(`üêæ BEAR RAGE! ${dmg} direct damage!`);
      pdBossShakeAnim();
      pdUpdateHpBars();
      if(s.bossHp<=0){ setTimeout(()=>pdShowRewards(),500); return; }
    } else if(ult.id==='fortune'){
      s.fortuneNext=true;
      s.playerCards=[pdDraw(),pdDraw()];
      pdRenderCards();
      pdMsg('üåü FORTUNE PAW! Next win guaranteed + 30 HP heal!');
    }
    pdAudio.play('ult');
    pdUpdateAbilityBtns();
  }
  pdUpdateAbilityBtns();
}

// ‚îÄ‚îÄ Ability Button UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdUpdateAbilityBtns(){
  const s=pdState;
  if(!s.charDef) return;
  const def=s.charDef;
  const abs=def.abilities;
  document.getElementById('pd-ab1-icon').textContent=abs[0].icon;
  document.getElementById('pd-ab1-name').textContent=abs[0].name;
  document.getElementById('pd-ab1-cd').textContent=s.ab1Cd>0?s.ab1Cd+' hand(s)':'Ready ‚úì';
  document.getElementById('pd-ab1-btn').style.opacity=s.ab1Cd>0?'.45':'1';
  document.getElementById('pd-ab1-btn').title=abs[0].desc+(abs[0].cooldown?` (CD: ${abs[0].cooldown} hands)`:'');
  const ab1Desc=document.getElementById('pd-ab1-desc');
  if(ab1Desc){ab1Desc.textContent=abs[0].desc;ab1Desc.style.display='';}
  document.getElementById('pd-ab2-icon').textContent=abs[1].icon;
  document.getElementById('pd-ab2-name').textContent=abs[1].name;
  document.getElementById('pd-ab2-cd').textContent=s.ab2Cd>0?s.ab2Cd+' hand(s)':'Ready ‚úì';
  document.getElementById('pd-ab2-btn').style.opacity=s.ab2Cd>0?'.45':'1';
  document.getElementById('pd-ab2-btn').title=abs[1].desc+(abs[1].cooldown?` (CD: ${abs[1].cooldown} hands)`:' (Passive)');
  const ab2Desc=document.getElementById('pd-ab2-desc');
  if(ab2Desc){ab2Desc.textContent=abs[1].desc;ab2Desc.style.display='';}
  document.getElementById('pd-ult-icon').textContent=def.ult.icon;
  document.getElementById('pd-ult-name').textContent=def.ult.name;
  document.getElementById('pd-ult-btn').title=def.ult.desc+` (Cost: ${s.ultCost} wins)`;
  const ultDesc=document.getElementById('pd-ult-desc');
  if(ultDesc){ultDesc.textContent=def.ult.desc;ultDesc.style.display='';}
  const ready=s.ultWins>=s.ultCost;
  document.getElementById('pd-ult-cd').textContent=ready?'READY! ‚ú®':`${s.ultWins}/${s.ultCost}`;
  document.getElementById('pd-ult-btn').style.background=ready?'linear-gradient(135deg,var(--gold),#e8c068)':'linear-gradient(135deg,rgba(212,168,83,.12),rgba(212,168,83,.04))';
  document.getElementById('pd-ult-btn').style.opacity=ready?'1':'.55';
}

function pdUpdateActiveBuffDisplay(){
  const s=pdState;
  const buffs=[];
  if(s.shield) buffs.push('ü•î');
  if(s.doubleDmg) buffs.push('üí•√ó2');
  if(s.streakBonus>0) buffs.push(`üî•+${s.streakBonus}`);
  if(s.fortuneNext) buffs.push('‚≠êWin');
  if(s.freeCards>0) buffs.push(`üé¥√ó${s.freeCards}`);
  if(s.bufWinHeal>0) buffs.push(`ü´õ+${s.bufWinHeal}hp`);
  if(s.bufLorMeeDmg>0) buffs.push(`üçú+${s.bufLorMeeDmg}dmg`);
  document.getElementById('pd-active-buffs').textContent=buffs.join(' ')||'‚Äî';
}

function pdShowActionBtns(show){
  document.getElementById('pd-hit-btn').style.display=show?'':'none';
  document.getElementById('pd-stand-btn').style.display=show?'':'none';
}

// ‚îÄ‚îÄ Rewards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdShowRewards(){
  const s=pdState;
  const boss=PD_BOSSES[s.bossIdx];
  const tier=boss.tier<=1?1:boss.tier<=3?2:3;
  const pool=PD_REWARD_POOL[tier].filter(r=>!s.acquiredBuffs.includes(r.id));
  // Pick 3 random distinct rewards
  const shuffled=[...pool].sort(()=>Math.random()-.5).slice(0,Math.min(3,pool.length));

  document.getElementById('pd-game-area').style.display='none';
  document.getElementById('pd-reward-screen').style.display='block';
  document.getElementById('pd-reward-emoji').textContent=boss.sprite;
  document.getElementById('pd-reward-title').textContent=boss.name+' Defeated! üéâ';
  document.getElementById('pd-reward-subtitle').textContent=tier===3?'üåü Epic Reward ‚Äî Choose one':'Choose your reward';
  pdAudio.play('reward');

  // Show current HP bar + acquired buffs to help player decide
  const hpPct=Math.round((s.hp/s.maxHp)*100);
  const hpColor=s.hp>s.maxHp*.6?'#4ade80':s.hp>s.maxHp*.3?'#facc15':'#f87171';
  let rewardStatusEl=document.getElementById('pd-reward-status');
  if(!rewardStatusEl){
    rewardStatusEl=document.createElement('div');
    rewardStatusEl.id='pd-reward-status';
    const subtitleEl=document.getElementById('pd-reward-subtitle');
    subtitleEl.parentNode.insertBefore(rewardStatusEl,subtitleEl.nextSibling);
  }
  const acquiredNames=s.acquiredBuffs.map(id=>{
    for(const t of Object.values(PD_REWARD_POOL)){
      const r=t.find(x=>x.id===id);
      if(r) return r.icon+' '+r.name;
    }
    return id;
  });
  rewardStatusEl.innerHTML=`
    <div style="margin:.6rem 0 .35rem;display:flex;align-items:center;gap:.5rem;">
      <span style="font-size:.72rem;font-family:'Lora',serif;opacity:.7;">‚ù§Ô∏è HP</span>
      <div style="flex:1;background:rgba(61,43,31,.12);border-radius:99px;height:9px;overflow:hidden;">
        <div style="width:${hpPct}%;background:${hpColor};height:100%;border-radius:99px;transition:width .4s;"></div>
      </div>
      <span style="font-size:.7rem;font-family:'Playfair Display',serif;font-weight:bold;color:${hpColor};">${s.hp}/${s.maxHp}</span>
    </div>
    ${acquiredNames.length?`<div style="font-size:.63rem;font-family:'Lora',serif;opacity:.6;margin-bottom:.3rem;">üì¶ Buffs: ${acquiredNames.join(' ¬∑ ')}</div>`:''}
  `;

  const choicesEl=document.getElementById('pd-reward-choices');
  choicesEl.innerHTML='';
  s.pendingRewards=shuffled;
  s.selectedReward=null;
  document.getElementById('pd-continue-btn').style.display='none';

  shuffled.forEach((r,i)=>{
    const el=document.createElement('div');
    el.className='pd-reward-card';
    el.style.animationDelay=(i*100)+'ms';
    el.innerHTML=`
      <div style="display:flex;align-items:center;gap:.8rem;text-align:left;">
        <div style="font-size:1.8rem;flex-shrink:0;">${r.icon}</div>
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:.88rem;color:var(--deep);font-weight:bold;">${r.name}</div>
          <div style="font-size:.7rem;color:var(--deep);opacity:.7;margin-top:.1rem;font-style:italic;">${r.desc}</div>
          <div style="font-size:.62rem;color:var(--gold);margin-top:.15rem;">${r.type==='instant'?'‚ö° Instant':r.type==='hybrid'?'‚ö° Instant + üì¶ Permanent':'üì¶ Permanent buff'} ¬∑ Tier ${tier}</div>
        </div>
      </div>`;
    el.onclick=()=>{
      document.querySelectorAll('.pd-reward-card').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      s.selectedReward=r;
      document.getElementById('pd-continue-btn').style.display='block';
      pdAudio.play('ability');
    };
    choicesEl.appendChild(el);
  });

  // If no rewards left
  if(shuffled.length===0){
    choicesEl.innerHTML='<div style="text-align:center;font-family:\'Lora\',serif;font-style:italic;color:var(--deep);opacity:.7;">You\'ve collected all rewards! Incredible!</div>';
    document.getElementById('pd-continue-btn').style.display='block';
  }
}

function pdContinueAfterReward(){
  const s=pdState;
  if(s.pendingRewards&&s.pendingRewards.length>0&&!s.selectedReward) return;

  // Apply selected reward
  if(s.selectedReward){
    const r=s.selectedReward;
    s.acquiredBuffs.push(r.id);
    if(r.type==='instant'){
      s.hp=Math.min(s.maxHp,s.hp+(r.val||0));
    } else if(r.type==='hybrid'){
      // Hybrid: instant heal + permanent passive
      s.hp=Math.min(s.maxHp,s.hp+(r.val||0));
      if(r.passiveId==='siji_sustain') s.bufWinHeal+=6;   // Grandma's love: +6 HP every win
      if(r.passiveId==='lormee_power') s.bufLorMeeDmg=(s.bufLorMeeDmg||0)+10;  // Thick sauce: +10 dmg on wins
    } else {
      // Apply passive buffs
      if(r.id==='win_heal') s.bufWinHeal+=5;
      if(r.id==='boss_weak') s.bufBossWeak+=4;
      if(r.id==='blackjack_amp') s.bufBlackjackAmp=true;
      if(r.id==='push_heal') s.bufPushHeal+=8;
      if(r.id==='mirror_shield') s.bufMirrorShield=true;
      if(r.id==='mega_streak') s.bufMegaStreak=true;
      if(r.id==='dealer_penalty') s.bufDealerPenalty+=15;
      if(r.id==='ult_refund') s.bufUltRefund=true;
      if(r.id==='lucky_draw') s.bufLuckyDraw=true;
      if(r.id==='start_bonus') s.bufStartBonus=true;
      if(r.id==='reduced_cd_1') s.bufReducedCd1=(s.bufReducedCd1||0)+1;
      if(r.id==='double_cd') s.bufReducedCd2=(s.bufReducedCd2||0)+1;
      if(r.id==='streak_amp') s.streakBonus+=4;
      if(r.id==='ult_charge') s.ultCost=Math.max(1,s.ultCost-1);
      if(r.id==='shield_charge') s.shieldCharges=(s.shieldCharges||0)+1;
    }
    s.selectedReward=null;
  }

  // Advance to next boss
  s.bossIdx++;
  if(s.bossIdx>=PD_BOSSES.length){ pdEndGame(true); return; }

  const newBoss=PD_BOSSES[s.bossIdx];
  s.bossHp=newBoss.hp;
  s.bossMaxHp=newBoss.hp;
  if(!s.bufMegaStreak){ s.streakBonus=0; s.streakCount=0; }
  s.ultWins=0;
  s.round=1;

  document.getElementById('pd-reward-screen').style.display='none';
  document.getElementById('pd-game-area').style.display='block';
  pdUpdateBoss();
  pdUpdateAbilityBtns();
  pdUpdateHpBars();
  pdDeal();
}

// ‚îÄ‚îÄ End Game ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdEndGame(won){
  const s=pdState;
  s.running=false;
  document.getElementById('pd-game-area').style.display='none';
  document.getElementById('pd-reward-screen').style.display='none';
  document.getElementById('pd-end-screen').style.display='block';
  document.getElementById('pd-end-emoji').textContent=won?'üèÜ':'üíî';
  document.getElementById('pd-end-title').textContent=won?'All Bosses Defeated! üåü':'You fell in battle...';
  document.getElementById('pd-end-msg').textContent=won
    ?'Bao would be proud! You conquered every dislike boss! üíï'
    :'The bosses were too strong this time. Try again! ü•î';
  const bufList=s.acquiredBuffs;
  document.getElementById('pd-acquired-buffs').textContent=bufList.length
    ?'Buffs earned: '+bufList.map(id=>{const r=Object.values(PD_REWARD_POOL).flat().find(x=>x.id===id);return r?r.icon+r.name:'';}).filter(Boolean).join(', '):'';
  // Bet-based coin rewards
  const betAmt = s.betAmount || 5;
  const petCoins = s.bonusCoins || 0;
  let coinsEarned = 0;
  if(won){
    // Win: earn back bet + same amount + pet bonus (capped at 2√ó bet to prevent runaway)
    coinsEarned = Math.min(betAmt * 2, betAmt + petCoins + 5);
  } else {
    // Lose: small consolation (20% of bet back)
    coinsEarned = Math.max(1, Math.floor(betAmt * 0.2));
  }
  P.coins=(P.coins||0)+coinsEarned;
  P.coinsEarned=(P.coinsEarned||0)+coinsEarned;
  saveP();
  pdUpdateCoinDisplay();
  updateWalletDisplays();
  document.getElementById('pd-coins-earned-msg').textContent=won
    ?`üí∞ +${coinsEarned} coins earned! (bet: ${betAmt}) Visit the Shop tab for the Casino!`
    :`üí∞ +${coinsEarned} consolation coins (bet ${betAmt} lost)`;
  // Hide the old inline slot ‚Äî it's now in the Shop sub-tab
  document.getElementById('pd-slot-wrap').style.display='none';
  pdAudio.play(won?'ult':'lose');
}

// ‚îÄ‚îÄ Potato Dealer Slot Machine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PD_SLOT_SYMBOLS = ['ü•î','üå∏','üçü','üí•','‚≠ê','üåü'];
const PD_SLOT_WEIGHTS = [35,25,20,12,6,2]; // üåü = super rare ~2%
const PD_SLOT_PETS = [
  {syms:['üåü','üåü','üåü'], name:'üåü LEGENDARY PET: Tater Sprite', msg:'Unlock: TaterSprite pet! ‚ú®', rarity:'legendary', fn:()=>{
    if(!P.gachaInventory.includes('pet_potato_sprite')){ P.gachaInventory.push('pet_potato_sprite'); }
    if(!P.bubuUnlocked){ P.bubuUnlocked=true; refreshBubuCard(); showAchievement('üêº BUBU UNLOCKED via Slot Machine! üé∞'); }
  }},
  {syms:['‚≠ê','‚≠ê','‚≠ê'], name:'üåü Epic reward: Stardust pet!',    msg:'Unlock: Stardust pet!',   rarity:'epic', fn:()=>{ if(!P.gachaInventory.includes('pet_stardust')){ P.gachaInventory.push('pet_stardust'); } }},
  {syms:['üí•','üí•','üí•'], name:'üéÜ Jackpot! +50 coins!',          msg:'+50 coins! üí∞',             rarity:'rare', fn:()=>{ P.coins+=50; P.coinsEarned+=50; }},
  {syms:['üçü','üçü','üçü'], name:'üçü Triple Fries! +20 coins!',    msg:'+20 coins! üçü',             rarity:'uncommon', fn:()=>{ P.coins+=20; P.coinsEarned+=20; }},
  {syms:['üå∏','üå∏','üå∏'], name:'üå∏ Lucky! +10 coins!',           msg:'+10 coins! üå∏',             rarity:'common', fn:()=>{ P.coins+=10; P.coinsEarned+=10; }},
  {syms:['ü•î','ü•î','ü•î'], name:'ü•î Potato! +5 coins back!',      msg:'Refunded 5 ü™ô!',            rarity:'common', fn:()=>{ P.coins+=5; P.coinsEarned+=5; }},
];

function _pdSlotRoll(){
  const tot=PD_SLOT_WEIGHTS.reduce((a,b)=>a+b,0);
  let r=Math.random()*tot,acc=0;
  for(let i=0;i<PD_SLOT_SYMBOLS.length;i++){ acc+=PD_SLOT_WEIGHTS[i]; if(r<acc) return PD_SLOT_SYMBOLS[i]; }
  return PD_SLOT_SYMBOLS[0];
}

let _pdSlotBusy=false;
function pdSlotPull(){
  if(_pdSlotBusy) return;
  const cost=5;
  if((P.coins||0)<cost){ document.getElementById('pd-slot-result').textContent='Need 5 ü™ô coins to pull!'; return; }
  P.coins-=cost; saveP(); updateWalletDisplays();
  _pdSlotBusy=true;
  document.getElementById('pd-slot-btn').disabled=true;
  document.getElementById('pd-slot-result').textContent='üé∞ Spinning...';

  // Animate reels with staggered delay
  const reels=['pd-slot-r1','pd-slot-r2','pd-slot-r3'];
  const results=[_pdSlotRoll(),_pdSlotRoll(),_pdSlotRoll()];

  // Play slot spin sound
  pdAudio.play('deal');

  reels.forEach((id,i)=>{
    let ticks=8+i*4;
    let tickInterval=null;
    let count=0;
    tickInterval=setInterval(()=>{
      const el=document.getElementById(id);
      el.textContent=PD_SLOT_SYMBOLS[Math.floor(Math.random()*PD_SLOT_SYMBOLS.length)];
      el.classList.remove('spinning');
      void el.offsetWidth;
      el.classList.add('spinning');
      count++;
      if(count>=ticks){
        clearInterval(tickInterval);
        el.textContent=results[i];
        el.classList.remove('spinning');
        void el.offsetWidth;
        el.classList.add('spinning');
        if(i===2){
          setTimeout(()=>_pdSlotReveal(results),200);
        }
      }
    },80+i*20);
  });
}

function _pdSlotReveal(results){
  const [a,b,c]=results;
  let matched=null;
  if(a===b&&b===c){
    matched=PD_SLOT_PETS.find(p=>p.syms[0]===a);
  }
  const resEl=document.getElementById('pd-slot-result');
  if(matched){
    matched.fn(); saveP(); updateWalletDisplays();
    resEl.textContent='üéâ '+matched.msg;
    resEl.style.color=matched.rarity==='legendary'?'#ffd700':matched.rarity==='epic'?'#a78bfa':matched.rarity==='rare'?'#38bdf8':'#4ade80';
    pdAudio.play('win');
    showAchievement('üé∞ '+matched.name);
  } else {
    // Small consolation for near-miss: 2 same symbols = +1 coin back
    if(a===b||b===c||a===c){ P.coins+=1; P.coinsEarned+=1; saveP(); updateWalletDisplays(); resEl.textContent='So close! +1 ü™ô consolation'; }
    else { resEl.textContent='No match. Try again! ü•î'; }
    resEl.style.color='rgba(255,255,255,.7)';
    pdAudio.play('lose');
  }
  document.getElementById('pd-slot-btn').disabled=false;
  _pdSlotBusy=false;
}

function pdRestartGame(){
  pdState={};
  document.querySelectorAll('.pd-char-btn').forEach(b=>b.style.opacity='1');
  document.getElementById('pd-game-area').style.display='none';
  document.getElementById('pd-reward-screen').style.display='none';
  document.getElementById('pd-end-screen').style.display='none';
  document.getElementById('pd-char-select').style.marginBottom='';
  document.getElementById('pd-bet-panel').style.display='block';
  pdUpdateCoinDisplay();
}

// ===================== POTATO DEALER SUB-TABS =====================
function pdSubTab(tab){
  ['play','shop','pets'].forEach(t=>{
    const el=document.getElementById('pd-subtab-'+t+'-content');
    const btn=document.getElementById('pd-subtab-'+t);
    if(el) el.style.display=t===tab?'block':'none';
    if(btn) btn.classList.toggle('active',t===tab);
  });
  if(tab==='pets') pdRenderPetGrid();
  if(tab==='shop') pdUpdateCoinDisplay();
  pdUpdateCoinDisplay();
}

// ===================== COIN DISPLAY =====================
function pdUpdateCoinDisplay(){
  const cd=document.getElementById('pd-coins-display');
  const dd=document.getElementById('pd-diamonds-display');
  const pb=document.getElementById('pd-pet-badge');
  if(cd) cd.textContent=P.coins||0;
  if(dd) dd.textContent=P.diamonds||0;
  if(pb){
    if(P.pdEquippedPet){
      const pet=PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet);
      pb.textContent=pet?`${pet.emoji} ${pet.name}`:'No pet';
    } else pb.textContent='No pet';
  }
}

// ===================== BETTING SYSTEM =====================
let pdCurrentBet = 5;

function pdGetMaxBet(){
  // Max bet scales with total coins earned to prevent runaway wealth
  // Start: max 50, scales up slowly. Never more than 25% of current coins or 100 absolute max
  const baseMax = 50;
  const scaled = Math.min(100, baseMax + Math.floor((P.coinsEarned||0) / 200) * 10);
  const pctCap = Math.max(5, Math.floor((P.coins||0) * 0.25)); // can't bet more than 25% of holdings
  return Math.min(scaled, Math.max(5, pctCap));
}

function pdAdjustBet(delta){
  const maxBet = pdGetMaxBet();
  pdCurrentBet = Math.max(5, Math.min(maxBet, pdCurrentBet + delta));
  document.getElementById('pd-bet-amount').textContent = pdCurrentBet;
  document.getElementById('pd-bet-limit-info').textContent = `Max bet: ${maxBet} coins (25% of wallet cap)`;
  document.getElementById('pd-bet-error').textContent = '';
}

function pdSetBet(amt){
  const maxBet = pdGetMaxBet();
  pdCurrentBet = Math.max(5, Math.min(maxBet, amt));
  document.getElementById('pd-bet-amount').textContent = pdCurrentBet;
  document.getElementById('pd-bet-limit-info').textContent = `Max bet: ${maxBet} coins (25% of wallet cap)`;
  document.getElementById('pd-bet-error').textContent = '';
}

// ===================== PET DEFINITIONS FOR BLACKJACK =====================
const PD_PET_DEFS = [
  // COMMON ‚Äî subtle bonuses
  {id:'pd_pet_cat',     rarity:'common',   emoji:'üê±', name:'Whiskers',    bjSkill:'heal',   bjVal:3,  desc:'Heals 3 HP on win',        sound:'pet_heal'},
  {id:'pd_pet_chick',   rarity:'common',   emoji:'üê•', name:'Peepster',    bjSkill:'coins',  bjVal:1,  desc:'+1 bonus coin on win',     sound:'pet_coin'},
  {id:'pd_pet_frog',    rarity:'common',   emoji:'üê∏', name:'Hopkins',     bjSkill:'heal',   bjVal:2,  desc:'Heals 2 HP on win',        sound:'pet_heal'},
  {id:'pd_pet_bunny',   rarity:'common',   emoji:'üê∞', name:'Cottontail',  bjSkill:'coins',  bjVal:1,  desc:'+1 bonus coin on win',     sound:'pet_coin'},
  {id:'pd_pet_hamster', rarity:'common',   emoji:'üêπ', name:'Cheekums',    bjSkill:'heal',   bjVal:2,  desc:'Heals 2 HP on win',        sound:'pet_heal'},
  {id:'pd_pet_turtle',  rarity:'common',   emoji:'üê¢', name:'Shellbert',   bjSkill:'shield', bjVal:8,  desc:'8% block chance',          sound:'pet_shield'},
  {id:'pd_pet_duck',    rarity:'common',   emoji:'ü¶Ü', name:'Quackers',    bjSkill:'coins',  bjVal:1,  desc:'+1 bonus coin on win',     sound:'pet_coin'},
  {id:'pd_pet_ladybug', rarity:'common',   emoji:'üêû', name:'Dotty',       bjSkill:'lucky',  bjVal:3,  desc:'3% chance free re-draw',   sound:'pet_lucky'},
  // UNCOMMON ‚Äî decent bonuses
  {id:'pd_pet_fox',     rarity:'uncommon', emoji:'ü¶ä', name:'Foxy',        bjSkill:'damage', bjVal:3,  desc:'+3 bonus damage on win',   sound:'pet_atk'},
  {id:'pd_pet_penguin', rarity:'uncommon', emoji:'üêß', name:'Waddles',     bjSkill:'shield', bjVal:15, desc:'15% block chance',         sound:'pet_shield'},
  {id:'pd_pet_bee',     rarity:'uncommon', emoji:'üêù', name:'Buzzy',       bjSkill:'coins',  bjVal:2,  desc:'+2 bonus coins on win',    sound:'pet_coin'},
  {id:'pd_pet_owl',     rarity:'uncommon', emoji:'ü¶â', name:'Hootsworth',  bjSkill:'damage', bjVal:4,  desc:'+4 bonus damage on win',   sound:'pet_atk'},
  {id:'pd_pet_crab',    rarity:'uncommon', emoji:'ü¶Ä', name:'Snappy',      bjSkill:'heal',   bjVal:5,  desc:'Heals 5 HP on win',        sound:'pet_heal'},
  {id:'pd_pet_otter',   rarity:'uncommon', emoji:'ü¶¶', name:'Bubbles',     bjSkill:'lucky',  bjVal:6,  desc:'6% chance free re-draw',   sound:'pet_lucky'},
  // RARE ‚Äî strong bonuses
  {id:'pd_pet_dragon',  rarity:'rare',     emoji:'üê≤', name:'Longlong',    bjSkill:'damage', bjVal:6,  desc:'+6 bonus damage on win',   sound:'pet_atk'},
  {id:'pd_pet_panda',   rarity:'rare',     emoji:'üêº', name:'Mochi',       bjSkill:'heal',   bjVal:8,  desc:'Heals 8 HP on win',        sound:'pet_heal'},
  {id:'pd_pet_unicorn', rarity:'rare',     emoji:'ü¶Ñ', name:'Sparkle',     bjSkill:'shield', bjVal:22, desc:'22% block chance',         sound:'pet_shield'},
  {id:'pd_pet_wolf',    rarity:'rare',     emoji:'üê∫', name:'Howler',      bjSkill:'damage', bjVal:7,  desc:'+7 bonus damage + 3% lifesteal', sound:'pet_atk'},
  {id:'pd_pet_deer',    rarity:'rare',     emoji:'ü¶å', name:'Deerling',    bjSkill:'lucky',  bjVal:10, desc:'10% free re-draw chance',  sound:'pet_lucky'},
  {id:'pd_pet_tiger',   rarity:'rare',     emoji:'üêØ', name:'Tigeroo',     bjSkill:'coins',  bjVal:4,  desc:'+4 bonus coins on win',    sound:'pet_coin'},
  // EPIC ‚Äî powerful abilities
  {id:'pd_pet_phoenix', rarity:'epic',     emoji:'üî•', name:'Blaze',       bjSkill:'revive', bjVal:30, desc:'Revive once with 30 HP!',  sound:'pet_ult'},
  {id:'pd_pet_dino',    rarity:'epic',     emoji:'ü¶ï', name:'Nomnom Jr.',  bjSkill:'damage', bjVal:10, desc:'+10 bonus damage on win',  sound:'pet_atk'},
  {id:'pd_pet_lion',    rarity:'epic',     emoji:'ü¶Å', name:'Simba',       bjSkill:'shield', bjVal:30, desc:'30% block + reflect 5 dmg',sound:'pet_shield'},
  {id:'pd_pet_dolphin', rarity:'epic',     emoji:'üê¨', name:'Flipper',     bjSkill:'heal',   bjVal:12, desc:'Heals 12 HP on win',       sound:'pet_heal'},
  {id:'pd_pet_narwhal', rarity:'epic',     emoji:'ü¶ë', name:'Narwhal',     bjSkill:'lucky',  bjVal:15, desc:'15% free re-draw + heal 5',sound:'pet_lucky'},
  // LEGENDARY ‚Äî game-changing (super rare)
  {id:'pd_pet_minibao', rarity:'legendary',emoji:'ü•ü', name:'Mini Bao',    bjSkill:'ultimate',bjVal:0, desc:'All abilities: heal 8, +8 dmg, 25% block, +3 coins', sound:'pet_ult'},
  {id:'pd_pet_lildudu', rarity:'legendary',emoji:'üêª', name:'Lil Dudu',    bjSkill:'ultimate',bjVal:0, desc:'Rage mode: 2√ó damage for 3 hands after boss hit',     sound:'pet_ult'},
  {id:'pd_pet_royaldragon',rarity:'legendary',emoji:'üî±',name:'Royal Dragon',bjSkill:'ultimate',bjVal:0,desc:'Dragon fire: 15 dmg on win + 20% block + heal 5',    sound:'pet_ult'},
  // NEW COMMON PETS
  {id:'pd_pet_snail',   rarity:'common',   emoji:'üêå', name:'Sludge',      bjSkill:'shield', bjVal:6,  desc:'6% block chance',          sound:'pet_shield'},
  {id:'pd_pet_mouse',   rarity:'common',   emoji:'üê≠', name:'Nibbles',     bjSkill:'coins',  bjVal:1,  desc:'+1 coin on win',           sound:'pet_coin'},
  {id:'pd_pet_parrot',  rarity:'common',   emoji:'ü¶ú', name:'Polly',       bjSkill:'heal',   bjVal:2,  desc:'Heals 2 HP on win',        sound:'pet_heal'},
  {id:'pd_pet_hedgehog',rarity:'common',   emoji:'ü¶î', name:'Spikes',      bjSkill:'shield', bjVal:7,  desc:'7% block + 1 reflect dmg', sound:'pet_shield'},
  {id:'pd_pet_fish',    rarity:'common',   emoji:'üê†', name:'Bubbles',     bjSkill:'lucky',  bjVal:4,  desc:'4% free re-draw chance',   sound:'pet_lucky'},
  // NEW UNCOMMON PETS
  {id:'pd_pet_koala',   rarity:'uncommon', emoji:'üê®', name:'Eucalyptus',  bjSkill:'heal',   bjVal:6,  desc:'Heals 6 HP on win',        sound:'pet_heal'},
  {id:'pd_pet_flamingo',rarity:'uncommon', emoji:'ü¶©', name:'Rosie',       bjSkill:'coins',  bjVal:3,  desc:'+3 coins on win',          sound:'pet_coin'},
  {id:'pd_pet_sloth',   rarity:'uncommon', emoji:'ü¶•', name:'Lazy',        bjSkill:'shield', bjVal:18, desc:'18% block chance',         sound:'pet_shield'},
  {id:'pd_pet_raccoon', rarity:'uncommon', emoji:'ü¶ù', name:'Bandit',      bjSkill:'lucky',  bjVal:8,  desc:'8% free re-draw chance',   sound:'pet_lucky'},
  // NEW RARE PETS
  {id:'pd_pet_elephant',rarity:'rare',     emoji:'üêò', name:'Peanut',      bjSkill:'heal',   bjVal:10, desc:'Heals 10 HP on win + 5% block', sound:'pet_heal'},
  {id:'pd_pet_croc',    rarity:'rare',     emoji:'üêä', name:'Chomper',     bjSkill:'damage', bjVal:8,  desc:'+8 bonus damage on win',   sound:'pet_atk'},
  {id:'pd_pet_octopus', rarity:'rare',     emoji:'üêô', name:'Inky',        bjSkill:'lucky',  bjVal:12, desc:'12% re-draw + heal 3 HP',  sound:'pet_lucky'},
  {id:'pd_pet_shark',   rarity:'rare',     emoji:'ü¶à', name:'Finn',        bjSkill:'damage', bjVal:9,  desc:'+9 dmg + 10% lifesteal',   sound:'pet_atk'},
  // NEW EPIC PETS
  {id:'pd_pet_whale',   rarity:'epic',     emoji:'üêã', name:'Moby',        bjSkill:'heal',   bjVal:15, desc:'Heals 15 HP on win',       sound:'pet_heal'},
  {id:'pd_pet_gorilla', rarity:'epic',     emoji:'ü¶ç', name:'Kong',        bjSkill:'damage', bjVal:12, desc:'+12 dmg + stun 1 turn',    sound:'pet_atk'},
  {id:'pd_pet_snake',   rarity:'epic',     emoji:'üêç', name:'Venom',       bjSkill:'lucky',  bjVal:18, desc:'18% re-draw + +6 dmg',     sound:'pet_lucky'},
  // NEW LEGENDARY PET
  {id:'pd_pet_bubu',    rarity:'legendary',emoji:'üêº', name:'Bubu Paw',    bjSkill:'ultimate',bjVal:0, desc:'Fortune paw: guarantee 1 win per boss + heal 20 HP', sound:'pet_ult'},
];

// Casino-grade probabilities for pet egg machine
const PD_PET_EGG_WEIGHTS = {common:55, uncommon:28, rare:12, epic:4, legendary:0.8};
if(!P.pdPets) P.pdPets = [];
if(!P.pdEquippedPet) P.pdEquippedPet = null;
if(!P.pdEggPity) P.pdEggPity = 0;
if(!P.pdPetReviveUsed) P.pdPetReviveUsed = false;

// ‚îÄ‚îÄ Pet Egg Machine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdEggPull(){
  const cost = 25;
  if((P.coins||0) < cost){
    document.getElementById('pd-egg-result').textContent = 'Need 25 coins! üí∞';
    document.getElementById('pd-egg-result').style.color = '#f87171';
    return;
  }
  P.coins -= cost;
  P.pdEggPity = (P.pdEggPity||0) + 1;
  
  // Roll rarity with casino odds
  let rarity;
  if(P.pdEggPity >= 50){
    // Pity: guaranteed rare+
    const w = {rare:65, epic:25, legendary:10};
    const tot = 100; let r = Math.random()*tot, acc = 0;
    for(const rv of ['rare','epic','legendary']){ acc += w[rv]; if(r < acc){ rarity = rv; break; } }
    P.pdEggPity = 0;
  } else {
    const tot = Object.values(PD_PET_EGG_WEIGHTS).reduce((a,b)=>a+b,0);
    let r = Math.random()*tot, acc = 0;
    for(const rv of ['common','uncommon','rare','epic','legendary']){
      acc += PD_PET_EGG_WEIGHTS[rv];
      if(r < acc){ rarity = rv; break; }
    }
    if(rarity !== 'common' && rarity !== 'uncommon') P.pdEggPity = 0;
  }
  
  const pool = PD_PET_DEFS.filter(p => p.rarity === rarity);
  const fresh = pool.filter(p => !(P.pdPets||[]).includes(p.id));
  const chosen = (fresh.length ? fresh : pool)[Math.floor(Math.random()*(fresh.length||pool.length))];
  
  if(!P.pdPets.includes(chosen.id)) P.pdPets.push(chosen.id);
  if(rarity === 'legendary') P.legendaryRolled = (P.legendaryRolled||0) + 1;
  
  saveP();
  pdUpdateCoinDisplay();
  
  // Egg hatch animation
  const eggEl = document.getElementById('pd-egg-display');
  eggEl.textContent = 'ü•ö';
  eggEl.style.animation = 'none';
  void eggEl.offsetWidth;
  eggEl.style.animation = 'pdBossShake .3s ease 3';
  
  setTimeout(()=>{
    eggEl.textContent = chosen.emoji;
    eggEl.style.animation = 'pdRewardReveal .5s ease';
    const rarColors = {common:'#aaa',uncommon:'#4CAF50',rare:'#2196F3',epic:'#9C27B0',legendary:'#FFD700'};
    const resEl = document.getElementById('pd-egg-result');
    resEl.innerHTML = `<span style="color:${rarColors[rarity]};font-weight:bold;">${rarity.toUpperCase()}</span> ‚Äî ${chosen.emoji} ${chosen.name}!<br><span style="font-size:.6rem;opacity:.7;">${chosen.desc}</span>`;
    resEl.style.color = rarColors[rarity];
    
    // Sound
    if(rarity === 'legendary') playHighScoreSound();
    else if(rarity === 'epic') pdAudio.play('ult');
    else if(rarity === 'rare') pdAudio.play('reward');
    else pdAudio.play('win');
  }, 900);
}

// ‚îÄ‚îÄ Shop Slot Machine (always accessible) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PD_SHOP_SLOT_SYMBOLS = ['ü•î','üå∏','üçü','üí•','‚≠ê','üåü'];
const PD_SHOP_SLOT_WEIGHTS_NORMAL = [35,25,20,12,6,2];
const PD_SHOP_SLOT_WEIGHTS_SUPER = [30,22,18,14,10,6]; // better legendary odds

let _pdShopSlotBusy = false;
function pdShopSlotPull(cost){
  if(_pdShopSlotBusy) return;
  if((P.coins||0) < cost){
    document.getElementById('pd-shop-slot-result').textContent = `Need ${cost} coins! üí∞`;
    return;
  }
  P.coins -= cost;
  saveP();
  pdUpdateCoinDisplay();
  _pdShopSlotBusy = true;
  
  const isSuper = cost >= 15;
  const weights = isSuper ? PD_SHOP_SLOT_WEIGHTS_SUPER : PD_SHOP_SLOT_WEIGHTS_NORMAL;
  
  function rollSym(){
    const tot = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*tot, acc = 0;
    for(let i=0;i<PD_SHOP_SLOT_SYMBOLS.length;i++){
      acc += weights[i];
      if(r < acc) return PD_SHOP_SLOT_SYMBOLS[i];
    }
    return PD_SHOP_SLOT_SYMBOLS[0];
  }
  
  const results = [rollSym(), rollSym(), rollSym()];
  const reels = ['pd-shop-slot-r1','pd-shop-slot-r2','pd-shop-slot-r3'];
  
  document.getElementById('pd-shop-slot-result').textContent = 'üé∞ Spinning...';
  pdAudio.play('deal');
  
  reels.forEach((id,i)=>{
    let ticks = 8+i*4, count = 0;
    const iv = setInterval(()=>{
      const el = document.getElementById(id);
      el.textContent = PD_SHOP_SLOT_SYMBOLS[Math.floor(Math.random()*PD_SHOP_SLOT_SYMBOLS.length)];
      el.classList.remove('spinning'); void el.offsetWidth; el.classList.add('spinning');
      count++;
      if(count >= ticks){
        clearInterval(iv);
        el.textContent = results[i];
        el.classList.remove('spinning'); void el.offsetWidth; el.classList.add('spinning');
        if(i === 2) setTimeout(()=>pdShopSlotReveal(results, isSuper), 200);
      }
    }, 80+i*20);
  });
}

function pdShopSlotReveal(results, isSuper){
  const [a,b,c] = results;
  const resEl = document.getElementById('pd-shop-slot-result');
  
  if(a===b && b===c){
    // Triple match!
    const rewards = {
      'üåü': {msg:'üåü LEGENDARY PET UNLOCKED!', coins:0, rarity:'legendary', pet:true,
        fn:()=>{
          // Unlock a random legendary pet
          const legends = PD_PET_DEFS.filter(p=>p.rarity==='legendary'&&!P.pdPets.includes(p.id));
          if(legends.length){
            const pet = legends[Math.floor(Math.random()*legends.length)];
            P.pdPets.push(pet.id);
            resEl.innerHTML = `üåü LEGENDARY: ${pet.emoji} ${pet.name}!`;
            showAchievement(`üåü LEGENDARY PET: ${pet.emoji} ${pet.name}!`);
          } else {
            P.coins += 200; P.coinsEarned += 200;
            resEl.textContent = 'üåü All legendaries owned! +200 coins!';
          }
          playHighScoreSound();
        }},
      '‚≠ê': {msg:'‚≠ê EPIC PET UNLOCKED!', coins:0, rarity:'epic', pet:true,
        fn:()=>{
          const epics = PD_PET_DEFS.filter(p=>p.rarity==='epic'&&!P.pdPets.includes(p.id));
          if(epics.length){
            const pet = epics[Math.floor(Math.random()*epics.length)];
            P.pdPets.push(pet.id);
            resEl.innerHTML = `‚≠ê Epic: ${pet.emoji} ${pet.name}!`;
            showAchievement(`‚≠ê Epic Pet: ${pet.emoji} ${pet.name}!`);
          } else {
            P.coins += 80; P.coinsEarned += 80;
            resEl.textContent = '‚≠ê All epics owned! +80 coins!';
          }
          pdAudio.play('ult');
        }},
      'üí•': {msg:'+50 coins! üí•', coins:50, fn:()=>{P.coins+=50;P.coinsEarned+=50;pdAudio.play('reward');}},
      'üçü': {msg:'+20 coins! üçü', coins:20, fn:()=>{P.coins+=20;P.coinsEarned+=20;pdAudio.play('win');}},
      'üå∏': {msg:'+10 coins! üå∏', coins:10, fn:()=>{P.coins+=10;P.coinsEarned+=10;pdAudio.play('win');}},
      'ü•î': {msg:'Refund 5 coins! ü•î',coins:5, fn:()=>{P.coins+=5;P.coinsEarned+=5;pdAudio.play('deal');}},
    };
    const reward = rewards[a];
    if(reward){
      reward.fn();
      resEl.textContent = 'üéâ ' + reward.msg;
      const rc = {legendary:'#ffd700',epic:'#a78bfa',rare:'#38bdf8',uncommon:'#4ade80',common:'#ddd'};
      resEl.style.color = reward.rarity ? rc[reward.rarity] : '#4ade80';
    }
  } else if(a===b || b===c || a===c){
    P.coins += 1; P.coinsEarned += 1;
    resEl.textContent = 'Almost! +1 consolation coin ü™ô';
    resEl.style.color = 'rgba(255,255,255,.65)';
    pdAudio.play('lose');
  } else {
    resEl.textContent = 'No match. Try again! üé∞';
    resEl.style.color = 'rgba(255,255,255,.5)';
    pdAudio.play('lose');
  }
  
  saveP();
  pdUpdateCoinDisplay();
  _pdShopSlotBusy = false;
}

// ‚îÄ‚îÄ Pet Grid Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdRenderPetGrid(){
  const grid = document.getElementById('pd-pet-grid');
  if(!grid) return;
  
  const owned = (P.pdPets||[]).map(id => PD_PET_DEFS.find(p=>p.id===id)).filter(Boolean);
  
  if(owned.length === 0){
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;font-style:italic;opacity:.5;font-size:.8rem;padding:1rem;">No pets yet! Try the Casino üé∞</div>';
  } else {
    const rarOrder = {legendary:0,epic:1,rare:2,uncommon:3,common:4};
    owned.sort((a,b) => rarOrder[a.rarity] - rarOrder[b.rarity]);
    
    grid.innerHTML = '';
    for(const pet of owned){
      const isEquipped = P.pdEquippedPet === pet.id;
      const rarColors = {common:'var(--common)',uncommon:'var(--uncommon)',rare:'var(--rare)',epic:'var(--epic)',legendary:'var(--legendary)'};
      const div = document.createElement('div');
      div.className = 'pd-pet-card' + (isEquipped ? ' equipped' : '');
      div.style.borderColor = rarColors[pet.rarity];
      div.style.background = isEquipped ? `rgba(212,168,83,.08)` : `rgba(0,0,0,.02)`;
      div.innerHTML = `
        <div class="pet-emoji">${pet.emoji}</div>
        <div class="pet-name" style="color:${rarColors[pet.rarity]}">${pet.name}</div>
        <div class="pet-skill">${pet.desc}</div>
        <div style="font-size:.55rem;margin-top:.2rem;color:${rarColors[pet.rarity]};text-transform:uppercase;letter-spacing:.05em;">${pet.rarity}</div>
        ${isEquipped ? '<div style="font-size:.6rem;color:var(--gold);margin-top:.15rem;">‚úÖ Equipped</div>' : '<div style="font-size:.6rem;color:var(--deep);opacity:.5;margin-top:.15rem;">Tap to equip</div>'}
      `;
      div.onclick = () => {
        P.pdEquippedPet = pet.id;
        saveP();
        pdRenderPetGrid();
        pdUpdateCoinDisplay();
        pdUpdateEquippedDisplay();
        pdAudio.play('ability');
        showToast(`${pet.emoji} ${pet.name} equipped!`);
      };
      grid.appendChild(div);
    }
  }
  pdUpdateEquippedDisplay();
}

function pdUpdateEquippedDisplay(){
  const infoEl = document.getElementById('pd-equipped-pet-info');
  const abilEl = document.getElementById('pd-equipped-pet-ability');
  if(!P.pdEquippedPet){
    if(infoEl) infoEl.textContent = 'None equipped ‚Äî tap a pet below!';
    if(abilEl) abilEl.textContent = '';
    return;
  }
  const pet = PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet);
  if(!pet) return;
  const rarColors = {common:'#9E9E9E',uncommon:'#4CAF50',rare:'#2196F3',epic:'#9C27B0',legendary:'#FFD700'};
  if(infoEl) infoEl.innerHTML = `<span style="font-size:1.5rem;">${pet.emoji}</span> <span style="color:${rarColors[pet.rarity]};font-weight:bold;">${pet.name}</span>`;
  if(abilEl) abilEl.textContent = `üé≤ ${pet.desc}`;
}

// ‚îÄ‚îÄ Pet Ability Triggers in Blackjack ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdPetOnWin(s){
  if(!P.pdEquippedPet) return {healBonus:0, dmgBonus:0, coinBonus:0};
  const pet = PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet);
  if(!pet) return {healBonus:0, dmgBonus:0, coinBonus:0};
  
  let result = {healBonus:0, dmgBonus:0, coinBonus:0};
  const sk = pet.bjSkill;
  
  if(sk === 'heal') result.healBonus = pet.bjVal;
  else if(sk === 'damage') result.dmgBonus = pet.bjVal;
  else if(sk === 'coins') result.coinBonus = pet.bjVal;
  else if(sk === 'ultimate'){
    // Legendary: all bonuses
    if(pet.id === 'pd_pet_minibao') { result.healBonus=8; result.dmgBonus=8; result.coinBonus=3; }
    else if(pet.id === 'pd_pet_lildudu') { result.dmgBonus=12; }
    else if(pet.id === 'pd_pet_royaldragon') { result.dmgBonus=15; result.healBonus=5; }
  }
  
  // Trigger animation
  if(result.healBonus>0 || result.dmgBonus>0 || result.coinBonus>0){
    pdPetAnimTrigger(pet, sk==='damage'||sk==='ultimate'?'attack':sk==='shield'?'shield':'heal');
  }
  return result;
}

function pdPetBlockChance(){
  if(!P.pdEquippedPet) return 0;
  const pet = PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet);
  if(!pet) return 0;
  if(pet.bjSkill === 'shield') return pet.bjVal / 100;
  if(pet.bjSkill === 'ultimate'){
    if(pet.id === 'pd_pet_minibao') return 0.25;
    if(pet.id === 'pd_pet_lion') return 0.30;
    if(pet.id === 'pd_pet_royaldragon') return 0.20;
  }
  return 0;
}

function pdPetLuckyDraw(){
  if(!P.pdEquippedPet) return false;
  const pet = PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet);
  if(!pet || pet.bjSkill !== 'lucky') return false;
  return Math.random() < (pet.bjVal / 100);
}

function pdPetCanRevive(){
  if(!P.pdEquippedPet || P.pdPetReviveUsed) return false;
  const pet = PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet);
  return pet && pet.bjSkill === 'revive';
}

function pdPetRevive(s){
  if(!pdPetCanRevive()) return false;
  const pet = PD_PET_DEFS.find(p=>p.id===P.pdEquippedPet);
  P.pdPetReviveUsed = true;
  s.hp = pet.bjVal;
  pdPetAnimTrigger(pet, 'heal');
  pdAudio.play('ult');
  return true;
}

// ‚îÄ‚îÄ Pet Animation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pdPetAnimTrigger(pet, type){
  const sprite = document.getElementById('pd-boss-sprite');
  const heroPort = document.getElementById('pd-hero-portrait');
  if(!sprite || !heroPort) return;
  
  // Play sound
  pdPetPlaySound(type);
  
  if(type === 'attack'){
    sprite.classList.add('boss-shake');
    setTimeout(()=>sprite.classList.remove('boss-shake'), 400);
    // Floating damage text
    pdPetFloatText(`${pet.emoji} +DMG!`, '#FF6633');
  } else if(type === 'heal'){
    pdPetFloatText(`${pet.emoji} +HP!`, '#4ade80');
  } else if(type === 'shield'){
    pdPetFloatText(`${pet.emoji} BLOCKED!`, '#38bdf8');
  }
}

function pdPetFloatText(text, color){
  const area = document.getElementById('pd-game-area');
  if(!area) return;
  const el = document.createElement('div');
  el.className = 'pd-pet-heal';
  el.textContent = text;
  el.style.color = color;
  el.style.left = '50%';
  el.style.top = '40%';
  el.style.transform = 'translateX(-50%)';
  el.style.zIndex = '10';
  el.style.fontFamily = "'Playfair Display',serif";
  el.style.fontWeight = 'bold';
  el.style.textShadow = '0 2px 6px rgba(0,0,0,.3)';
  area.style.position = 'relative';
  area.appendChild(el);
  setTimeout(()=>el.remove(), 750);
}

function pdPetPlaySound(type){
  const c = typeof pdAudio!=='undefined' ? pdAudio : null;
  if(!c) return;
  if(type === 'heal') c.play('reward');
  else if(type === 'attack') c.play('boss_hurt');
  else if(type === 'shield') c.play('ability_shield');
  else c.play('ability');
}

// ===================== LANDING =====================
document.getElementById('envBtn').addEventListener('click',()=>{
  document.getElementById('landing').classList.add('gone');
  document.getElementById('main').classList.add('visible');
  showTab('game');
  spawnHeartsBg();updateStatsPanel();renderShop();
});
function spawnHeartsBg(){
  const bg=document.getElementById('heartsBg');
  const emojis=['üß°','üíõ','üå∏','üíï','‚ú®'];
  for(let i=0;i<18;i++){
    const h=document.createElement('div');h.className='heart-float';
    h.textContent=emojis[Math.floor(Math.random()*emojis.length)];
    h.style.left=Math.random()*100+'%';
    h.style.animationDuration=(6+Math.random()*10)+'s';
    h.style.animationDelay=(Math.random()*8)+'s';
    h.style.fontSize=(0.9+Math.random()*1.2)+'rem';
    bg.appendChild(h);
  }
}

// ===================== HIGH SCORE (device-local) =====================
// High score is saved in localStorage via the P object ‚Äî no leaderboard needed.
function promptLeaderboard(){
  // Called after game ends ‚Äî nothing extra to do, high score already saved in P.
}


// ============================================================
// CONNECT BAO ‚Äî Connect 4 RPG ENGINE
// ============================================================
const C4_ROWS=6, C4_COLS=7;

// ‚îÄ‚îÄ Connect Bao: Boss Pool ‚Äî Amber-themed! ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Bosses are grouped into tiers (1-4). Each level picks 3 random bosses from
// the appropriate tier for the player to choose from.
// Special tags: none | regen | shield | burn | counter | copy | rage | drain | thorns

const C4_BOSS_TIERS=[
  // ‚îÄ‚îÄ TIER 1: Cozy beginners (Lv 1-3) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {tier:1, bosses:[
    {name:'Baby Dough',         emoji:'ü´ì', maxHP:18, atk:4,  aiDepth:1, rand:0.70, special:'none',    reward:3,  flavor:'A soft lump of dough ‚Äî still figuring things out.'},
    {name:'Flour Ghost',        emoji:'üëª', maxHP:20, atk:4,  aiDepth:1, rand:0.65, special:'none',    reward:3,  flavor:'Drifts around aimlessly. Very harmless.'},
    {name:'Soft Broccoli',      emoji:'ü•¶', maxHP:22, atk:5,  aiDepth:1, rand:0.60, special:'none',    reward:4,  flavor:"Amber's beloved soft broccoli. Gentle and nutritious."},
    {name:'Baked Potato',       emoji:'ü•î', maxHP:20, atk:4,  aiDepth:1, rand:0.65, special:'none',    reward:3,  flavor:"Warm, comforting, and a little slow. Amber approves."},
    {name:'Penne Pasta',        emoji:'üçù', maxHP:22, atk:5,  aiDepth:1, rand:0.60, special:'none',    reward:4,  flavor:'Soft pasta energy. Slides around unpredictably.'},
    {name:'Grapefruit Baby',    emoji:'üçä', maxHP:18, atk:4,  aiDepth:1, rand:0.70, special:'none',    reward:3,  flavor:'Sweet-sour little thing. Mostly just bounces around.'},
    {name:'Mashed Egg',         emoji:'ü•ö', maxHP:20, atk:4,  aiDepth:1, rand:0.65, special:'none',    reward:3,  flavor:"Mashed with mayo ‚Äî Amber's comfort. Surprisingly slippery."},
    {name:'Enoki Scout',        emoji:'üçÑ', maxHP:22, atk:5,  aiDepth:1, rand:0.62, special:'none',    reward:4,  flavor:'Tiny steamboat mushroom scouting ahead of the group.'},
  ]},
  // ‚îÄ‚îÄ TIER 2: Love-based comfort guardians (Lv 4-6) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {tier:2, bosses:[
    {name:'Soy Boss',           emoji:'üçú', maxHP:30, atk:7,  aiDepth:2, rand:0.30, special:'regen',   reward:6,  flavor:'Regenerates 4 HP every 4 turns. Soy-powered stamina.'},
    {name:'Steam Bun',          emoji:'‚ô®Ô∏è', maxHP:34, atk:7,  aiDepth:3, rand:0.25, special:'shield',  reward:7,  flavor:'Blocks hits with a burst of steam. Cozy but firm.'},
    {name:'Sheng Jian Guardian',emoji:'ü•ü', maxHP:32, atk:7,  aiDepth:2, rand:0.28, special:'shield',  reward:7,  flavor:"Defender of Amber's fave Chinatown stall. Crispy base, steam shield."},
    {name:'Duck Rice Overlord', emoji:'ü¶Ü', maxHP:36, atk:7,  aiDepth:3, rand:0.28, special:'regen',   reward:8,  flavor:"Yew Kee's legendary duck. Roasted to perfection, heals constantly."},
    {name:'Lor Mee Baron',      emoji:'üç≤', maxHP:34, atk:7,  aiDepth:2, rand:0.30, special:'regen',   reward:7,  flavor:'86 Lor Mee ‚Äî thick gravy restores strength every few turns.'},
    {name:'Crabstick Knight',   emoji:'ü¶Ä', maxHP:30, atk:6,  aiDepth:2, rand:0.32, special:'none',    reward:6,  flavor:"Amber's steamboat staple. Fast sideways moves."},
    {name:'Maggie Spirit',      emoji:'üå∂Ô∏è', maxHP:32, atk:7,  aiDepth:2, rand:0.30, special:'none',    reward:6,  flavor:"Spicy Maggie noodles, Amber's midnight comfort. Feisty."},
    {name:'Si Ji Dou Elder',    emoji:'ü´ò', maxHP:34, atk:7,  aiDepth:3, rand:0.28, special:'shield',  reward:7,  flavor:"Grandma's four-season beans. Old wisdom = good blocking."},
    {name:'Maroon Queen',       emoji:'‚ù§Ô∏è', maxHP:36, atk:7,  aiDepth:3, rand:0.25, special:'regen',   reward:8,  flavor:"Amber's signature maroon energy. Regal and self-sustaining."},
    {name:'Chicken Warrior',    emoji:'üçó', maxHP:30, atk:6,  aiDepth:2, rand:0.32, special:'none',    reward:6,  flavor:"Steamboat's MVP. Reliable, straightforward fighter."},
  ]},
  // ‚îÄ‚îÄ TIER 3: Amber hates + mid-difficulty (Lv 7-9) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {tier:3, bosses:[
    {name:'Chili Pepper',       emoji:'üå∂Ô∏è', maxHP:34, atk:7,  aiDepth:3, rand:0.25, special:'burn',    reward:10, flavor:'Burns for 2 HP/turn. Spicy but a bit scatterbrained.'},
    {name:'Udon Worm Titan',    emoji:'üçú', maxHP:40, atk:8,  aiDepth:4, rand:0.18, special:'drain',   reward:11, flavor:"Looks like worms. Amber's worst nightmare. Drains 2 HP/turn on contact."},
    {name:'Onion Overlord',     emoji:'üßÖ', maxHP:38, atk:8,  aiDepth:4, rand:0.20, special:'burn',    reward:10, flavor:"Tears. So many tears. Burns your eyes every other turn."},
    {name:'Bean Sprout Hydra',  emoji:'üå±', maxHP:36, atk:7,  aiDepth:3, rand:0.22, special:'regen',   reward:10, flavor:"Regrows relentlessly. Amber finds this deeply unsettling."},
    {name:'Worm Noodle Fiend',  emoji:'üêõ', maxHP:42, atk:8,  aiDepth:4, rand:0.18, special:'counter', reward:12, flavor:'Stringy, slippery, worm-textured horror. Hits harder on your streaks.'},
    {name:'Raw Onion Wraith',   emoji:'üò§', maxHP:38, atk:8,  aiDepth:3, rand:0.22, special:'burn',    reward:10, flavor:"Pungent aura causes burn damage. Amber refuses to even look."},
    {name:'Slimy Sprout',       emoji:'üíß', maxHP:36, atk:7,  aiDepth:3, rand:0.25, special:'drain',   reward:10, flavor:"Wet, stringy, intrusive. Drains your energy just by being here."},
    {name:'Iron Wok',           emoji:'ü´ï', maxHP:46, atk:9,  aiDepth:5, rand:0.08, special:'regen',   reward:14, flavor:'Regenerates AND defends. A real chef gone rogue.'},
    {name:'The Weeknd Dusk',    emoji:'üéµ', maxHP:40, atk:8,  aiDepth:4, rand:0.18, special:'counter', reward:11, flavor:"Late-night R&B energy turned hostile. Hits harder when you're on a roll."},
    {name:'Rice Demon',         emoji:'üçö', maxHP:36, atk:8,  aiDepth:3, rand:0.20, special:'none',    reward:8,  flavor:'Getting serious now. Prefers the center.'},
  ]},
  // ‚îÄ‚îÄ TIER 4: Elite / Final bosses (Lv 10-12) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {tier:4, bosses:[
    {name:'DARK BAO',           emoji:'üíÄ', maxHP:55, atk:11, aiDepth:6, rand:0.02, special:'copy',    reward:25, flavor:'The final darkness. Nearly perfect play.'},
    {name:'Lord Chili Burn',    emoji:'üî•', maxHP:50, atk:10, aiDepth:5, rand:0.05, special:'burn',    reward:16, flavor:'Inferno mode. Burns 2 HP/turn. You will feel the heat.'},
    {name:'Shadow Bao',         emoji:'üåë', maxHP:52, atk:10, aiDepth:6, rand:0.04, special:'shield',  reward:18, flavor:'Dark mirror of Bao. Blocks and counters.'},
    {name:'Midnight Weeknd',    emoji:'üåÉ', maxHP:50, atk:10, aiDepth:5, rand:0.05, special:'counter', reward:17, flavor:"The Weeknd's final form. Blinding drop damage on your streaks."},
    {name:'Udon Titan Prime',   emoji:'üåÄ', maxHP:54, atk:11, aiDepth:6, rand:0.04, special:'drain',   reward:20, flavor:"Amber's ultimate nemesis. Drain + nearly perfect play."},
    {name:'Onion Demon King',   emoji:'üëÅÔ∏è', maxHP:52, atk:10, aiDepth:6, rand:0.04, special:'burn',    reward:18, flavor:'Tears of pure malice. Max burn damage, near-perfect AI.'},
    {name:'Hydra Queen',        emoji:'üêç', maxHP:50, atk:10, aiDepth:5, rand:0.05, special:'regen',   reward:17, flavor:'Regen + shield. Amber shudders. You must end this.'},
    {name:'Kovan Specter',      emoji:'üèÆ', maxHP:48, atk:10, aiDepth:5, rand:0.06, special:'shield',  reward:16, flavor:'Haunts the memory of Ding Te Le. Shields + nostalgia attacks.'},
    {name:'Amber\'s Nemesis',   emoji:'üí¢', maxHP:55, atk:11, aiDepth:6, rand:0.03, special:'copy',    reward:22, flavor:'A distillation of every food Amber hates. The ultimate horror.'},
  ]},
];

// Flat C4_LEVELS for backward compatibility (used by c4Render level counter etc.)
// We dynamically assign levels based on current progress
const C4_LEVELS_COUNT=12;

// Map game level (0-based) to tier
function c4GetTier(lvIdx){
  if(lvIdx<=2) return 0; // tier index 0 = tier 1
  if(lvIdx<=5) return 1;
  if(lvIdx<=8) return 2;
  return 3;
}

// Pick 3 random unique bosses from the appropriate tier
function c4PickBossChoices(lvIdx){
  const pool=[...C4_BOSS_TIERS[c4GetTier(lvIdx)].bosses];
  // Shuffle
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
  return pool.slice(0,Math.min(3,pool.length));
}

const C4_CHARS={
  bao:{
    name:'Bao', emoji:'', maxHP:40, atk:7,
    skills:[
      {id:'drop',   name:'‚öîÔ∏è Drop',      desc:'Drop disc + dmg',   maxCd:0},
      {id:'shield', name:'üõ°Ô∏è Steam Bun', desc:'Block next hit',    maxCd:3},
      {id:'heal',   name:'ü•î Nomnom',    desc:'Heal 12 HP (cd:3)', maxCd:3},
    ],
    passiveDesc:'Regen 5 HP every 3 turns',
  },
  dudu:{
    name:'Dudu', emoji:'', maxHP:36, atk:10,
    skills:[
      {id:'drop',   name:'‚öîÔ∏è Rage Drop',  desc:'Drop disc + dmg',      maxCd:0},
      {id:'aura',   name:'üí• Angry Aura', desc:'Next drop √ó2 damage',   maxCd:3},
      {id:'burst',  name:'üåÄ Disc Bomb',  desc:'Remove 1 enemy disc',   maxCd:4},
    ],
    passiveDesc:'5-disc streak = √ó1.6 dmg',
  },
  bubu:{
    name:'Bubu', emoji:'üêº', maxHP:32, atk:8,
    skills:[
      {id:'drop',   name:'‚öîÔ∏è Shop Drop', desc:'Drop disc + dmg',         maxCd:0},
      {id:'lucky',  name:'üõçÔ∏è Lucky Bag', desc:'Deal dmg + gain 3 coins', maxCd:2},
      {id:'splurge',name:'üí∏ Splurge',   desc:'Spend 5 coins: deal 20 dmg', maxCd:0},
    ],
    passiveDesc:'Win rounds ‚Üí earn bonus coins ü™ô',
  },
};

// Game state
let c4={
  active:false, char:'bao',
  board:[],
  pHP:40, pMaxHP:40, eHP:18, eMaxHP:18,
  pShield:false, eShield:false,
  pAuraActive:false, pStreak:0,
  skillCDs:[0,0,0],
  turn:0, level:0,   // level = 0-based index (0-11)
  burnActive:false, burnCounter:0,
  enemy:null, playerTurn:true, thinking:false,
  pendingSkill:-1,
  lastWon:false,     // track win state for nextRound
};
let c4Char='bao';

function c4MakeBoard(){
  const b=[];
  for(let r=0;r<C4_ROWS;r++){b.push(Array(C4_COLS).fill(null));}
  return b;
}

function c4SelectChar(ch){
  if(!P.bubuUnlocked&&ch==='bubu'){
    showToast('üîí Mystery character locked! Try the Capsule Machine to discover them!');
    const dd=document.getElementById('c4-char-dropdown');
    if(dd) dd.value=c4Char;
    return;
  }
  c4Char=ch;
  const dd=document.getElementById('c4-char-dropdown');
  if(dd) dd.value=ch;
  updateC4CharPreview(ch);
}

function updateC4CharPreview(ch){
  const cfg=C4_CHARS[ch];
  if(!cfg) return;
  const av=document.getElementById('c4-char-preview-avatar');
  const nm=document.getElementById('c4-char-preview-name');
  const ps=document.getElementById('c4-char-preview-passive');
  if(av) av.innerHTML=getCharPortraitHTML(ch,38);
  if(nm) nm.textContent=cfg.name;
  if(ps) ps.textContent=cfg.passiveDesc;
}

function c4StartGame(lvIdx, bossObj){
  const ch=C4_CHARS[c4Char];
  // If no boss passed, pick first from choices for that level
  const lv=bossObj||c4PickBossChoices(lvIdx||0)[0];
  c4={
    active:true, char:c4Char,
    board:c4MakeBoard(),
    pHP:ch.maxHP, pMaxHP:ch.maxHP,
    eHP:lv.maxHP, eMaxHP:lv.maxHP,
    pShield:false, eShield:false,
    pAuraActive:false, pStreak:0,
    skillCDs:[0,0,0],
    turn:0, level:lvIdx||0,
    burnActive:false, burnCounter:0,
    enemy:lv, playerTurn:true, thinking:false,
    pendingSkill:-1, lastWon:false,
  };
  document.getElementById('c4-start-btn').style.display='none';
  document.getElementById('c4-boss-pick').style.display='none';
  // Update player portrait
  const portEl=document.getElementById('c4-p-portrait');
  if(portEl) portEl.innerHTML=getCharPortraitHTML(c4Char,34);
  document.getElementById('c4-overlay').classList.remove('show');
  c4BuildBoard();
  c4UpdateSkillLabels();
  c4Render();
  c4Msg('Level '+(c4.level+1)+': '+lv.name+'!', lv.flavor);
  c4UpdateIntent();
  c4UpdateLevelBar();
}

function c4UpdateLevelBar(){
  const pct=((c4.level)/(C4_LEVELS_COUNT-1))*100;
  document.getElementById('c4-level-bar').style.width=pct+'%';
  document.getElementById('c4-level-label').textContent='‚öîÔ∏è Level '+(c4.level+1)+' / '+C4_LEVELS_COUNT;
  if(c4.enemy) document.getElementById('c4-level-label-r').textContent='vs '+c4.enemy.emoji+' '+c4.enemy.name;
}

// Build DOM board + col buttons
function c4BuildBoard(){
  const board=document.getElementById('c4-board');
  const colBtns=document.getElementById('c4-col-btns');
  board.innerHTML='';colBtns.innerHTML='';
  for(let col=0;col<C4_COLS;col++){
    const btn=document.createElement('div');
    btn.className='c4-col-btn';btn.textContent='‚ñº';btn.dataset.col=col;
    btn.onclick=()=>c4ColClick(col);
    colBtns.appendChild(btn);
  }
  for(let row=0;row<C4_ROWS;row++){
    for(let col=0;col<C4_COLS;col++){
      const cell=document.createElement('div');
      cell.className='c4-cell';cell.dataset.row=row;cell.dataset.col=col;
      board.appendChild(cell);
    }
  }
}

function c4ColClick(col){
  if(!c4.active||!c4.playerTurn||c4.thinking) return;
  c4DoPlayerDrop(col);
}

function c4UseSkill(sk){
  if(!c4.active||!c4.playerTurn||c4.thinking) return;
  if(c4.skillCDs[sk]>0) return;
  const ch=C4_CHARS[c4.char];
  const skillId=ch.skills[sk].id;
  if(skillId==='shield'){
    c4.pShield=true;
    c4.skillCDs[sk]=ch.skills[sk].maxCd;
    c4Msg('Steam Shield up! Next hit blocked.','');
    c4Render();c4EnemyTurn();
  } else if(skillId==='aura'){
    c4.pAuraActive=true;
    c4.skillCDs[sk]=ch.skills[sk].maxCd;
    c4Msg('Angry Aura armed! Next drop deals x2 damage!','');
    c4Render();c4EnemyTurn();
  } else if(skillId==='heal'){
    c4.pHP=Math.min(c4.pMaxHP, c4.pHP+10);
    c4.skillCDs[sk]=ch.skills[sk].maxCd;
    c4Msg('Nomnom! Healed 10 HP','');
    c4Render();c4EnemyTurn();
  } else if(skillId==='burst'){
    // Remove a random enemy disc
    const enemyCells=[];
    for(let r=0;r<C4_ROWS;r++) for(let col=0;col<C4_COLS;col++) if(c4.board[r][col]==='e') enemyCells.push([r,col]);
    if(!enemyCells.length){c4Msg('No enemy discs to remove!','');return;}
    const [rr,rc]=enemyCells[Math.floor(Math.random()*enemyCells.length)];
    c4.board[rr][rc]=null;
    c4.skillCDs[sk]=ch.skills[sk].maxCd;
    c4Msg('Disc Bomb! Destroyed an enemy disc!','');
    c4Render();c4EnemyTurn();
  } else if(skillId==='lucky'){
    // Bubu: Lucky Bag ‚Äî deal damage and earn coins
    const lDmg=Math.round(ch.atk*1.2);
    if(!c4.eShield){ c4.eHP=Math.max(0,c4.eHP-lDmg); } else { c4.eShield=false; }
    P.coins+=3; P.coinsEarned+=3; saveP();
    document.getElementById('coinsDisplay').textContent=P.coins;
    updateWalletDisplays();
    c4.skillCDs[sk]=ch.skills[sk].maxCd;
    c4Msg('üõçÔ∏è Lucky Bag! -'+lDmg+' dmg and +3 coins!','');
    if(c4.eHP<=0){c4Win();return;}
    c4Render();c4EnemyTurn();
  } else if(skillId==='splurge'){
    // Bubu: Spend 5 coins to deal big damage
    if(P.coins<5){c4Msg('Need 5 coins to Splurge!','Need more coins üí∏');return;}
    P.coins-=5; saveP();
    document.getElementById('coinsDisplay').textContent=P.coins;
    updateWalletDisplays();
    const sDmg=20;
    if(!c4.eShield){ c4.eHP=Math.max(0,c4.eHP-sDmg); } else { c4.eShield=false; }
    c4Msg('üí∏ Splurge! Spent 5 coins ‚Üí -'+sDmg+' massive damage!','');
    if(c4.eHP<=0){c4Win();return;}
    c4Render();c4EnemyTurn();
  } else {
    // Drop skill ‚Äî set pending, wait for column click
    c4.pendingSkill=sk;
    c4Msg('Choose a column to drop your disc!','');
  }
}

function c4DoPlayerDrop(col){
  const row=c4FindRow(col);
  if(row===-1){c4Msg('Column full! Choose another.','');return;}

  const ch=C4_CHARS[c4.char];
  c4.board[row][col]='p';
  c4.turn++;c4.pStreak++;
  c4.pendingSkill=-1;

  // Cooldown ticks
  for(let i=0;i<c4.skillCDs.length;i++) if(c4.skillCDs[i]>0) c4.skillCDs[i]--;

  // Bao passive: regen every 4 turns
  if(c4.char==='bao'&&c4.turn%4===0&&c4.turn>0){
    c4.pHP=Math.min(c4.pMaxHP,c4.pHP+6);
    c4Msg('Nomnom regen! +6 HP','');
  }

  // Damage calc
  let dmg=ch.atk;
  if(c4.pAuraActive){dmg*=2;c4.pAuraActive=false;}
  if(c4.char==='dudu'&&c4.pStreak>=5) dmg=Math.round(dmg*1.8);

  // Apply damage
  if(!c4.eShield){
    c4.eHP=Math.max(0,c4.eHP-dmg);
    c4Msg('Disc dropped! -'+dmg+' damage to '+c4.enemy.name,'');
    c4.eShield=false;
  } else {
    c4.eShield=false;
    c4Msg(c4.enemy.name+' shield blocked your disc!','');
  }

  // Animate drop
  c4AnimateDrop(row,col,'player');
  c4Render();

  // Check 4-in-a-row for player
  const pLine=c4CheckWin('p');
  if(pLine){
    const bonusDmg=18;
    c4.eHP=Math.max(0,c4.eHP-bonusDmg);
    c4HighlightWin(pLine);
    c4Msg('CONNECT 4! Bonus -'+bonusDmg+' damage!','');
    c4Render();
    if(c4.eHP<=0){setTimeout(()=>c4Win(),700);return;}
    setTimeout(()=>{c4.board=c4MakeBoard();c4BuildBoard();c4Render();setTimeout(c4EnemyTurn,400);},1400);
    return;
  }

  if(c4.eHP<=0){c4Win();return;}
  if(c4BoardFull()){c4.board=c4MakeBoard();c4BuildBoard();c4Msg('Board full - reset!','');c4Render();setTimeout(c4EnemyTurn,500);return;}
  c4EnemyTurn();
}

function c4FindRow(col){
  for(let r=C4_ROWS-1;r>=0;r--) if(c4.board[r][col]===null) return r;
  return -1;
}

function c4BoardFull(){
  return c4.board[0].every(c=>c!==null);
}

function c4AnimateDrop(row,col,who){
  const cell=document.querySelector('[data-row="'+row+'"][data-col="'+col+'"]');
  if(cell) cell.classList.add('drop-anim');
  setTimeout(()=>{if(cell)cell.classList.remove('drop-anim');},280);
}

// ===== ENEMY AI =====
function c4EnemyTurn(){
  if(!c4.active||!c4.playerTurn) return;
  c4.playerTurn=false;c4.thinking=true;c4Render();
  const lv=c4.enemy;

  // Regen tick (every 4 turns)
  if(lv.special==='regen'&&c4.turn>0&&c4.turn%4===0){
    c4.eHP=Math.min(c4.eMaxHP,c4.eHP+4);
    c4Msg(lv.emoji+' '+lv.name+' regens 4 HP!','');
  }

  // Burn tick on player (only after 2+ turns so player has time to react)
  if(lv.special==='burn'&&c4.burnActive&&c4.turn>=2){
    c4.pHP=Math.max(0,c4.pHP-2);
    c4.burnCounter=Math.max(0,c4.burnCounter-1);
    if(c4.burnCounter<=0) c4.burnActive=false;
    c4Msg('üî• Burn! -2 HP','');
  }

  // Drain tick ‚Äî enemy heals from player
  if(lv.special==='drain'&&c4.burnActive&&c4.turn>=2){
    const drainAmt=2;
    c4.pHP=Math.max(0,c4.pHP-drainAmt);
    c4.eHP=Math.min(c4.eMaxHP,c4.eHP+drainAmt);
    c4.burnCounter=Math.max(0,c4.burnCounter-1);
    if(c4.burnCounter<=0) c4.burnActive=false;
    c4Msg('ü©∏ Drain! -2 HP ‚Üí enemy heals','');
  }

  setTimeout(()=>{
    // Pick column using level's own aiDepth + rand
    let col;
    if(Math.random()<lv.rand){
      const open=[];for(let c=0;c<C4_COLS;c++) if(c4FindRow(c)>-1) open.push(c);
      col=open.length?open[Math.floor(Math.random()*open.length)]:undefined;
    } else {
      col=c4BestMove(c4.board,lv.aiDepth);
    }

    if(col===undefined){c4.playerTurn=true;c4.thinking=false;c4Render();return;}
    const row=c4FindRow(col);
    if(row===-1){c4.playerTurn=true;c4.thinking=false;c4Render();return;}
    c4.board[row][col]='e';
    c4.turn++;

    // Damage: use lv.atk directly ‚Äî this is the EXACT damage per turn, already balanced
    let eDmg=lv.atk;
    // Shield special: 25% chance enemy shields self, deals half dmg this turn
    if(lv.special==='shield'&&Math.random()<0.25){c4.eShield=true;eDmg=Math.max(1,Math.round(eDmg*0.5));}
    // Burn: apply burn status (3 turns), but only if not already burning
    if(lv.special==='burn'&&!c4.burnActive){c4.burnActive=true;c4.burnCounter=3;}
    // Drain: same mechanic but heals enemy
    if(lv.special==='drain'&&!c4.burnActive){c4.burnActive=true;c4.burnCounter=3;}
    // Counter: +30% dmg when player is on a streak (toned down from 40%)
    if(lv.special==='counter'&&c4.pStreak>=4) eDmg=Math.round(eDmg*1.3);

    if(!c4.pShield){
      c4.pHP=Math.max(0,c4.pHP-eDmg);
      c4Msg(lv.emoji+' '+lv.name+' drops! -'+eDmg+' HP','');
    } else {
      c4.pShield=false;
      c4Msg('üõ°Ô∏è Steam Shield blocked '+lv.name+'!','');
    }

    c4AnimateDrop(row,col,'enemy');
    const eLine=c4CheckWin('e');
    c4Render();

    if(eLine){
      // Connect 4 bonus: REDUCED so it is not instant kill
      const bonusDmg=Math.min(10, Math.round(c4.pMaxHP*0.25));
      c4.pHP=Math.max(0,c4.pHP-bonusDmg);
      c4HighlightWin(eLine);
      c4Msg('Enemy Connect 4! -'+bonusDmg+' bonus dmg!','');
      c4Render();
      if(c4.pHP<=0){setTimeout(()=>c4Lose(),700);c4.thinking=false;return;}
      setTimeout(()=>{c4.board=c4MakeBoard();c4BuildBoard();c4Render();c4.playerTurn=true;c4.thinking=false;c4UpdateIntent();},1400);
      return;
    }

    if(c4.pHP<=0){c4.thinking=false;c4Lose();return;}
    if(c4BoardFull()){c4.board=c4MakeBoard();c4BuildBoard();c4Msg('Board full - reset!','');}
    c4.playerTurn=true;c4.thinking=false;
    c4UpdateIntent();c4Render();
  },650);
}

// ===== MINIMAX + ALPHA-BETA FOR CONNECT 4 =====
function c4BestMove(board,depth){
  let bestScore=-Infinity,bestCol=3;
  const colOrder=[3,2,4,1,5,0,6];
  for(const col of colOrder){
    const row=c4FindRowOnBoard(board,col);
    if(row===-1) continue;
    const nb=c4CloneBoard(board);nb[row][col]='e';
    const score=c4Minimax(nb,Math.max(1,depth-1),false,-Infinity,Infinity);
    if(score>bestScore){bestScore=score;bestCol=col;}
  }
  return bestCol;
}

function c4Minimax(board,depth,isMax,alpha,beta){
  const eWin=c4CheckWinOnBoard(board,'e');
  const pWin=c4CheckWinOnBoard(board,'p');
  if(eWin) return 1000+depth;
  if(pWin) return -1000-depth;
  if(depth===0) return c4Score(board);
  const colOrder=[3,2,4,1,5,0,6];
  const open=colOrder.filter(c=>c4FindRowOnBoard(board,c)>-1);
  if(!open.length) return 0;
  if(isMax){
    let best=-Infinity;
    for(const col of open){
      const row=c4FindRowOnBoard(board,col);
      const nb=c4CloneBoard(board);nb[row][col]='e';
      best=Math.max(best,c4Minimax(nb,depth-1,false,alpha,beta));
      alpha=Math.max(alpha,best);if(beta<=alpha) break;
    }
    return best;
  } else {
    let best=Infinity;
    for(const col of open){
      const row=c4FindRowOnBoard(board,col);
      const nb=c4CloneBoard(board);nb[row][col]='p';
      best=Math.min(best,c4Minimax(nb,depth-1,true,alpha,beta));
      beta=Math.min(beta,best);if(beta<=alpha) break;
    }
    return best;
  }
}

function c4Score(board){
  let score=0;
  // Horizontal
  for(let r=0;r<C4_ROWS;r++)
    for(let c=0;c<C4_COLS-3;c++) score+=c4EvalWindow([board[r][c],board[r][c+1],board[r][c+2],board[r][c+3]]);
  // Vertical
  for(let c=0;c<C4_COLS;c++)
    for(let r=0;r<C4_ROWS-3;r++) score+=c4EvalWindow([board[r][c],board[r+1][c],board[r+2][c],board[r+3][c]]);
  // Diagonal \
  for(let r=0;r<C4_ROWS-3;r++)
    for(let c=0;c<C4_COLS-3;c++) score+=c4EvalWindow([board[r][c],board[r+1][c+1],board[r+2][c+2],board[r+3][c+3]]);
  // Diagonal /
  for(let r=3;r<C4_ROWS;r++)
    for(let c=0;c<C4_COLS-3;c++) score+=c4EvalWindow([board[r][c],board[r-1][c+1],board[r-2][c+2],board[r-3][c+3]]);
  // Center preference
  for(let r=0;r<C4_ROWS;r++) if(board[r][3]==='e') score+=3;
  return score;
}

function c4EvalWindow(w){
  const e=w.filter(c=>c==='e').length, p=w.filter(c=>c==='p').length, n=w.filter(c=>c===null).length;
  if(e===4) return 100;
  if(e===3&&n===1) return 8;
  if(e===2&&n===2) return 2;
  if(p===3&&n===1) return -7;
  if(p===4) return -100;
  return 0;
}

function c4CheckWin(who){return c4CheckWinOnBoard(c4.board,who);}
function c4CheckWinOnBoard(board,who){
  // Horizontal
  for(let r=0;r<C4_ROWS;r++)
    for(let c=0;c<C4_COLS-3;c++)
      if(board[r][c]===who&&board[r][c+1]===who&&board[r][c+2]===who&&board[r][c+3]===who)
        return[[r,c],[r,c+1],[r,c+2],[r,c+3]];
  // Vertical
  for(let c=0;c<C4_COLS;c++)
    for(let r=0;r<C4_ROWS-3;r++)
      if(board[r][c]===who&&board[r+1][c]===who&&board[r+2][c]===who&&board[r+3][c]===who)
        return[[r,c],[r+1,c],[r+2,c],[r+3,c]];
  // Diagonal \
  for(let r=0;r<C4_ROWS-3;r++)
    for(let c=0;c<C4_COLS-3;c++)
      if(board[r][c]===who&&board[r+1][c+1]===who&&board[r+2][c+2]===who&&board[r+3][c+3]===who)
        return[[r,c],[r+1,c+1],[r+2,c+2],[r+3,c+3]];
  // Diagonal /
  for(let r=3;r<C4_ROWS;r++)
    for(let c=0;c<C4_COLS-3;c++)
      if(board[r][c]===who&&board[r-1][c+1]===who&&board[r-2][c+2]===who&&board[r-3][c+3]===who)
        return[[r,c],[r-1,c+1],[r-2,c+2],[r-3,c+3]];
  return null;
}

function c4FindRowOnBoard(board,col){
  for(let r=C4_ROWS-1;r>=0;r--) if(board[r][col]===null) return r;
  return -1;
}

function c4CloneBoard(board){return board.map(r=>[...r]);}

function c4HighlightWin(line){
  line.forEach(([r,c])=>{
    const cell=document.querySelector('[data-row="'+r+'"][data-col="'+c+'"]');
    if(cell) cell.classList.add('win-cell');
  });
}

// ‚îÄ‚îÄ Boss selection UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showBossPick(lvIdx){
  const choices=c4PickBossChoices(lvIdx);
  const container=document.getElementById('c4-boss-pick');
  if(!container) return;
  const tierNames=['Cozy Tier','Comfort Tier','Chaos Tier','Elite Tier'];
  const tierColors=['#E8736A','#D4A853','#9C27B0','#C0392B'];
  const tier=c4GetTier(lvIdx);
  container.innerHTML=`
    <div style="font-family:'Playfair Display',serif;font-size:.95rem;color:var(--gold);margin-bottom:.5rem;text-align:center;">
      ‚öîÔ∏è Level ${lvIdx+1} ‚Äî Choose your opponent!
      <div style="font-size:.6rem;color:${tierColors[tier]};margin-top:.15rem;letter-spacing:.1em;">${tierNames[tier].toUpperCase()}</div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;">
      ${choices.map((b,i)=>`
        <div onclick="c4StartGame(${lvIdx}, window._c4BossChoices[${i}])"
          style="flex:1;min-width:88px;max-width:130px;background:linear-gradient(160deg,#2a1200,#1a0800);border:1.5px solid ${tierColors[tier]};border-radius:12px;padding:.6rem .5rem;text-align:center;cursor:pointer;transition:transform .12s,filter .12s;"
          onmouseover="this.style.transform='scale(1.04)'" onmouseout="this.style.transform='scale(1)'">
          <div style="font-size:1.8rem;margin-bottom:.2rem;">${b.emoji}</div>
          <div style="font-family:'Playfair Display',serif;font-size:.72rem;color:var(--gold);margin-bottom:.2rem;line-height:1.2;">${b.name}</div>
          <div style="font-size:.58rem;color:rgba(244,195,130,.5);margin-bottom:.3rem;line-height:1.3;">${b.flavor}</div>
          <div style="display:flex;gap:3px;justify-content:center;flex-wrap:wrap;">
            <span style="font-size:.55rem;background:rgba(255,100,100,.15);border:1px solid rgba(255,100,100,.3);border-radius:5px;padding:.1rem .3rem;color:#ff9999;">‚ù§Ô∏è ${b.maxHP}</span>
            <span style="font-size:.55rem;background:rgba(255,165,0,.12);border:1px solid rgba(255,165,0,.3);border-radius:5px;padding:.1rem .3rem;color:#ffcc88;">‚öîÔ∏è ${b.atk}</span>
            ${b.special!=='none'?`<span style="font-size:.55rem;background:rgba(180,79,255,.15);border:1px solid rgba(180,79,255,.3);border-radius:5px;padding:.1rem .3rem;color:#ce93ff;">${c4SpecialIcon(b.special)}</span>`:''}
          </div>
        </div>
      `).join('')}
    </div>`;
  window._c4BossChoices=choices;
  container.style.display='block';
  // Hide the start button since boss pick shows instead
  document.getElementById('c4-start-btn').style.display='none';
}

function c4SpecialIcon(sp){
  return {none:'',regen:'‚ôªÔ∏è Regen',shield:'üõ°Ô∏è Shield',burn:'üî• Burn',counter:'‚ö° Counter',copy:'ü™û Copy',drain:'ü©∏ Drain',thorns:'üåµ Thorns',rage:'üí¢ Rage'}[sp]||sp;
}

// ===== WIN/LOSE =====
function c4Win(){
  c4.active=false; c4.lastWon=true;
  const lv=c4.enemy;
  const isLast=c4.level>=C4_LEVELS_COUNT-1;
  let reward=lv.reward;
  let bubuBonus=0;
  if(c4.char==='bubu'){ bubuBonus=3; reward+=bubuBonus; }
  coins+=reward;P.coins+=reward;P.coinsEarned+=reward;
  // Award a diamond for defeating a boss! üíé
  if(!P.diamonds) P.diamonds=0;
  P.diamonds+=1;
  // Track consecutive win streak for Bubu unlock
  if(!P.c4WinStreak) P.c4WinStreak=0;
  P.c4WinStreak++;
  // Unlock Bubu at 5 consecutive Connect Bao wins!
  if(!P.bubuUnlocked && P.c4WinStreak>=5){
    P.bubuUnlocked=true;
    refreshBubuCard();
    showAchievement('üêº BUBU UNLOCKED! 5-win streak in Connect Bao! üî•');
  }
  saveP();
  document.getElementById('coinsDisplay').textContent=P.coins;
  updateWalletDisplays();
  const dEl=document.getElementById('gacha-diamond-display');
  if(dEl) dEl.textContent=P.diamonds;
  const nextLv=Math.min(c4.level+1, C4_LEVELS_COUNT-1);
  // Peek at what comes next (random from next tier)
  const nextPeek=isLast?null:c4PickBossChoices(nextLv);
  document.getElementById('c4-ov-title').textContent=isLast?'YOU WIN! üéâ':'Victory! üèÜ';
  document.getElementById('c4-ov-body').innerHTML=
    'Defeated <strong>'+lv.emoji+' '+lv.name+'</strong>!<br>'+
    '<span style="color:var(--gold)">+'+reward+' coins!'+(bubuBonus>0?' <span style="color:#FF6BA8">(+'+bubuBonus+' Bubu bonus!)</span>':'')+' </span>'+
    ' <span style="color:#a78bfa">+1 üíé diamond!</span>'+(isLast?'<br><span style="color:var(--peach)">You cleared all 12 levels! üíï</span>':
    '<br><span style="opacity:.6;font-size:.7rem">Next: pick from '+nextPeek.map(b=>b.emoji+' '+b.name).join(' ¬∑ ')+'</span>');
  document.getElementById('c4-ov-streak').textContent='Level '+(c4.level+1)+' / '+C4_LEVELS_COUNT+' cleared! ‚≠ê';
  document.getElementById('c4-next-btn').textContent=isLast?'Play Again üíï':'Next Level ‚ñ∂Ô∏è';
  document.getElementById('c4-overlay').classList.add('show');
  c4Render();
  c4UpdateLevelBar();
}

function c4Lose(){
  c4.active=false; c4.lastWon=false;
  if(!P.c4WinStreak) P.c4WinStreak=0;
  P.c4WinStreak=0; // reset streak on loss
  saveP();
  const lv=c4.enemy;
  document.getElementById('c4-ov-title').textContent='Defeated... üíÄ';
  document.getElementById('c4-ov-body').innerHTML=
    '<strong>'+lv.emoji+' '+lv.name+'</strong> won!<br>'+
    '<span style="opacity:.65">'+lv.flavor+'</span>';
  document.getElementById('c4-ov-streak').textContent='Retry Level '+(c4.level+1)+'! üí™';
  document.getElementById('c4-next-btn').textContent='Retry ‚Ü©Ô∏è';
  document.getElementById('c4-overlay').classList.add('show');
  c4Render();
}

function c4NextRound(){
  document.getElementById('c4-overlay').classList.remove('show');
  const isWin=c4.lastWon;
  const isLast=c4.level>=C4_LEVELS_COUNT-1&&isWin;
  const nextLv=isWin?Math.min(c4.level+1,C4_LEVELS_COUNT-1):c4.level;
  if(isLast){
    // Restart from level 0 with boss pick
    showBossPick(0);
  } else {
    showBossPick(nextLv);
  }
}

// ===== RENDER =====
function c4Render(){
  const ch=C4_CHARS[c4.char];
  // HP bars
  document.getElementById('c4-p-bar').style.width=Math.max(0,(c4.pHP/c4.pMaxHP)*100)+'%';
  document.getElementById('c4-e-bar').style.width=c4.enemy?Math.max(0,(c4.eHP/c4.eMaxHP)*100)+'%':'100%';
  document.getElementById('c4-p-hp').textContent=c4.pHP+'/'+c4.pMaxHP+' HP';
  document.getElementById('c4-p-name').textContent=ch.name;
  const portEl=document.getElementById('c4-p-portrait');
  if(portEl) portEl.innerHTML=getCharPortraitHTML(c4.char,34);
  if(c4.enemy){
    document.getElementById('c4-e-name').textContent=c4.enemy.emoji+' '+c4.enemy.name;
    document.getElementById('c4-e-hp').textContent=c4.eHP+'/'+c4.eMaxHP+' HP';
  }
  document.getElementById('c4-round-text').textContent='Level '+(c4.level+1)+' / '+C4_LEVELS_COUNT;
  // Show streak + Bubu unlock progress if not yet unlocked
  const streak=P.c4WinStreak||0;
  if(!P.bubuUnlocked){
    document.getElementById('c4-streak-hud').textContent=`Win streak: ${streak}/5 üî• (unlock üêº Bubu!)`;
  } else {
    document.getElementById('c4-streak-hud').textContent=(c4.enemy?c4.enemy.emoji+' '+c4.enemy.name:'Win streak: '+streak+' üî•');
  }

  // Board cells
  document.querySelectorAll('.c4-cell').forEach(cell=>{
    const r=+cell.dataset.row, c=+cell.dataset.col;
    cell.className='c4-cell';
    const v=c4.board[r][c];
    if(v==='p') cell.classList.add('player');
    else if(v==='e') cell.classList.add('enemy');
    else if(!c4.playerTurn&&c4.thinking) cell.classList.add('thinking');
  });

  // Column buttons
  document.querySelectorAll('.c4-col-btn').forEach(btn=>{
    const col=+btn.dataset.col;
    btn.classList.toggle('disabled', !c4.active||!c4.playerTurn||c4.thinking||c4FindRow(col)===-1);
  });

  // Skill buttons
  ch.skills.forEach((sk,i)=>{
    const btn=document.getElementById('c4-sk'+i);
    const cd=document.getElementById('c4-sk'+i+'-cd');
    if(btn){
      btn.disabled=!c4.active||!c4.playerTurn||c4.thinking||c4.skillCDs[i]>0;
      cd.textContent=c4.skillCDs[i]>0?'cd:'+c4.skillCDs[i]:'';
    }
  });

  // Buffs
  const bArr=[];
  if(c4.pShield) bArr.push('üõ°Ô∏è Shield');
  if(c4.pAuraActive) bArr.push('üí• Aura');
  if(c4.burnActive&&c4.enemy?.special==='drain') bArr.push('ü©∏ Draining');
  else if(c4.burnActive) bArr.push('üî• Burned');
  if(c4.eShield) bArr.push('‚ô®Ô∏è Enemy Shield');
  document.getElementById('c4-buffs').innerHTML=bArr.map(b=>'<div class="c4-buff-chip">'+b+'</div>').join('');
}

function c4Msg(main,sub){
  document.getElementById('c4-status-main').textContent=main;
  document.getElementById('c4-status-sub').textContent=sub;
}

function c4UpdateSkillLabels(){
  const ch=C4_CHARS[c4.char];
  ch.skills.forEach((sk,i)=>{
    const nameEl=document.getElementById('c4-sk'+i+'-name');
    const descEl=document.getElementById('c4-sk'+i+'-desc');
    if(nameEl) nameEl.textContent=sk.name;
    if(descEl) descEl.textContent=sk.desc;
  });
}

function c4UpdateIntent(){
  if(!c4.enemy||!c4.active){document.getElementById('c4-intent').textContent='';return;}
  const intents={none:'planning its next move...',regen:'regenerating strength...',shield:'preparing a defense...',counter:'watching your streak...',burn:'heating the board...',copy:'reading your mind...',drain:'draining your life...',rage:'getting stronger...',thorns:'sharpening its thorns...'};
  const burnStr=c4.burnActive?' (burning '+c4.burnCounter+' turns)':'';
  document.getElementById('c4-intent').textContent=c4.enemy.emoji+' '+c4.enemy.name+' is '+(intents[c4.enemy.special]||'thinking...')+burnStr;
}

// ===================== SCORE SHARE =====================
function openShareModal(){
  const modal=document.getElementById('share-modal');
  if(!modal) return;
  generateShareCard();
  modal.classList.add('show');
}
function closeShareModal(){
  const modal=document.getElementById('share-modal');
  if(modal) modal.classList.remove('show');
}

function generateShareCard(){
  const g=lastGameShare;
  const sc=document.getElementById('share-canvas');
  if(!sc) return;
  const W2=540,H2=300;
  sc.width=W2;sc.height=H2;
  const ctx2=sc.getContext('2d');

  // Background gradient
  const bg=ctx2.createLinearGradient(0,0,W2,H2);
  bg.addColorStop(0,'#3D2B1F');bg.addColorStop(.6,'#5C3D2A');bg.addColorStop(1,'#2A1810');
  ctx2.fillStyle=bg;ctx2.fillRect(0,0,W2,H2);

  // Soft decorative circles
  ctx2.save();ctx2.globalAlpha=.07;
  ctx2.fillStyle='#F4A56A';ctx2.beginPath();ctx2.arc(W2*0.82,H2*0.18,110,0,Math.PI*2);ctx2.fill();
  ctx2.fillStyle='#E8736A';ctx2.beginPath();ctx2.arc(W2*0.12,H2*0.85,90,0,Math.PI*2);ctx2.fill();
  ctx2.restore();

  // Top accent line
  const line=ctx2.createLinearGradient(0,0,W2,0);
  line.addColorStop(0,'#E8736A');line.addColorStop(.5,'#F4A56A');line.addColorStop(1,'#D4A853');
  ctx2.fillStyle=line;ctx2.fillRect(0,0,W2,4);

  // Title
  ctx2.fillStyle='#F4A56A';ctx2.font='italic bold 18px Georgia,serif';ctx2.textAlign='left';
  ctx2.fillText('Happy Bao üß°',32,44);

  // Score ‚Äî big
  ctx2.fillStyle='#FDF6EC';ctx2.font='bold 72px Georgia,serif';ctx2.textAlign='left';
  ctx2.fillText(g.score,32,130);
  ctx2.fillStyle='rgba(253,246,236,.45)';ctx2.font='16px Georgia,serif';
  ctx2.fillText('SCORE',32,152);

  // Stats column
  const sx=32,sy=178,gap=24;
  const stats=[
    {label:'Level',val:`${g.level} ‚Äî ${g.levelTitle}`},
    {label:'Hearts',val:String(g.sessionHearts)},
    {label:'Best Streak',val:String(g.streak)},
    {label:'Personal Best',val:String(g.highScore)},
  ];
  if(g.bossDefeated>0) stats.push({label:'Bosses',val:'‚öîÔ∏è '+g.bossDefeated});
  stats.forEach((s,i)=>{
    ctx2.fillStyle='rgba(253,246,236,.5)';ctx2.font='12px Georgia,serif';ctx2.textAlign='left';
    ctx2.fillText(s.label.toUpperCase(),sx,sy+i*gap);
    ctx2.fillStyle='#FDF6EC';ctx2.font='bold 13px Georgia,serif';
    ctx2.fillText(s.val,sx+90,sy+i*gap);
  });

  // Medal big
  ctx2.font='64px serif';ctx2.textAlign='right';
  ctx2.fillText(g.medal,W2-36,120);

  // Character
  const charLabel=g.char==='bao'?'üç° Bao':'üêª Dudu';
  ctx2.fillStyle='rgba(253,246,236,.55)';ctx2.font='italic 14px Georgia,serif';ctx2.textAlign='right';
  ctx2.fillText(charLabel,W2-36,148);

  // Bottom tag
  ctx2.fillStyle='rgba(253,246,236,.25)';ctx2.font='11px Georgia,serif';ctx2.textAlign='right';
  ctx2.fillText('üíï play Happy Bao',W2-32,H2-18);

  // Update preview
  const preview=document.getElementById('share-preview');
  if(preview) preview.src=sc.toDataURL('image/png');
}

function copyShareText(){
  const g=lastGameShare;
  const lines=[
    `${g.medal} Happy Bao ‚Äî Score: ${g.score}`,
    `üìä Level ${g.level} ¬∑ ${g.levelTitle}`,
    `üíï ${g.sessionHearts} hearts ¬∑ ${g.streak} streak`,
    g.bossDefeated>0?`‚öîÔ∏è ${g.bossDefeated} boss${g.bossDefeated>1?'es':''} defeated`:'',
    `üèÜ Personal best: ${g.highScore}`,
    '',
    'üíå Play Happy Bao üß°'
  ].filter(Boolean).join('\n');
  navigator.clipboard.writeText(lines).then(()=>{
    const btn=document.querySelector('.copy-btn');
    if(btn){const orig=btn.textContent;btn.textContent='Copied! ‚úì';setTimeout(()=>btn.textContent=orig,2000);}
  }).catch(()=>alert('Copy failed ‚Äî try the download instead!'));
}

function downloadShareCard(){
  const sc=document.getElementById('share-canvas');
  if(!sc) return;
  const a=document.createElement('a');
  a.href=sc.toDataURL('image/png');
  a.download='happy-bao-score.png';
  a.click();
}

// ===================== GACHA SYSTEM =====================
const GACHA_POOL = [
  // ‚îÄ‚îÄ COMMON PETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'pet_cat',    type:'pet', rarity:'common',    name:'üê± Whiskers',   emoji:'üê±', desc:'Purrs softly. Tiny chance to catch nearby hearts.',          petSkill:'heartsnag'},
  {id:'pet_chick',  type:'pet', rarity:'common',    name:'üê• Peepster',   emoji:'üê•', desc:'Tiny fluffy buddy. Cheers you on for a small luck boost.',    petSkill:'luck'},
  {id:'pet_frog',   type:'pet', rarity:'common',    name:'üê∏ Hopkins',    emoji:'üê∏', desc:'Ribbit! Occasionally slows a falling bad item.',             petSkill:'frogluck'},
  {id:'pet_bunny',  type:'pet', rarity:'common',    name:'üê∞ Cottontail', emoji:'üê∞', desc:'Hoppy pal. Boosts coin chance by +5%.',                      petSkill:'coinchance'},
  {id:'pet_hamster',type:'pet', rarity:'common',    name:'üêπ Cheekums',   emoji:'üêπ', desc:'Stores luck in cheeks. Small streak protection.',            petSkill:'luck'},
  {id:'pet_turtle', type:'pet', rarity:'common',    name:'üê¢ Shellbert',  emoji:'üê¢', desc:'Slow and steady. Slightly extends buff timers.',             petSkill:'luck'},
  {id:'pet_duck',   type:'pet', rarity:'common',    name:'ü¶Ü Quackers',   emoji:'ü¶Ü', desc:'Quack! Gently nudges hearts toward basket.',                 petSkill:'heartsnag'},
  {id:'pet_ladybug',type:'pet', rarity:'common',    name:'üêû Dotty',      emoji:'üêû', desc:'Lucky bug. +1% coin drop chance per heart.',                 petSkill:'coinchance'},
  // ‚îÄ‚îÄ UNCOMMON PETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'pet_star',   type:'pet', rarity:'uncommon',  name:'‚≠ê Starling',   emoji:'‚≠ê', desc:'Glittery friend. Restores 1 life every 40 hearts.',           petSkill:'regen40'},
  {id:'pet_fox',    type:'pet', rarity:'uncommon',  name:'ü¶ä Foxy',       emoji:'ü¶ä', desc:'Clever companion. Spots incoming bad items ‚Äî shrinks them.',  petSkill:'shrink'},
  {id:'pet_penguin',type:'pet', rarity:'uncommon',  name:'üêß Waddles',    emoji:'üêß', desc:'Cool as ice. Bad items fall 8% slower.',                     petSkill:'slowbad'},
  {id:'pet_bee',    type:'pet', rarity:'uncommon',  name:'üêù Buzzy',      emoji:'üêù', desc:'Busy bee. +1 coin every 10 hearts caught.',                  petSkill:'beecoin'},
  {id:'pet_owl',    type:'pet', rarity:'uncommon',  name:'ü¶â Hootsworth', emoji:'ü¶â', desc:'Wise owl. XP gains increased by +10%.',                      petSkill:'xpowl'},
  {id:'pet_crab',   type:'pet', rarity:'uncommon',  name:'ü¶Ä Snappy',     emoji:'ü¶Ä', desc:'Sidestep master. Bad items 12% smaller.',                    petSkill:'shrink'},
  {id:'pet_otter',  type:'pet', rarity:'uncommon',  name:'ü¶¶ Bubbles',    emoji:'ü¶¶', desc:'Playful otter. Every 15 hearts, a free coin appears.',        petSkill:'beecoin'},
  // ‚îÄ‚îÄ RARE PETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'pet_dragon', type:'pet', rarity:'rare',      name:'üê≤ Longlong',   emoji:'üê≤', desc:'Lucky dragon. Spawns 1 bonus heart every 15 seconds.',       petSkill:'heartspawn'},
  {id:'pet_panda',  type:'pet', rarity:'rare',      name:'üêº Mochi',      emoji:'üêº', desc:'Squishy panda. Gives a mini magnet for 3s every 20 hearts.', petSkill:'minimagnet'},
  {id:'pet_uni',    type:'pet', rarity:'rare',      name:'ü¶Ñ Sparkle',    emoji:'ü¶Ñ', desc:'Pure magic. Doubles score once every 30 seconds.',           petSkill:'scoredouble'},
  {id:'pet_wolf',   type:'pet', rarity:'rare',      name:'üê∫ Howler',     emoji:'üê∫', desc:'Fierce. Boosts streak by +1 every 25 consecutive hearts.',   petSkill:'streakboost'},
  {id:'pet_deer',   type:'pet', rarity:'rare',      name:'ü¶å Deerling',   emoji:'ü¶å', desc:'Graceful. +5% chance to turn a bad item into a heart.',      petSkill:'baddtonluck'},
  {id:'pet_catt',   type:'pet', rarity:'rare',      name:'üêØ Tigeroo',    emoji:'üêØ', desc:'Fierce cub. Doubles coin gain for 5s every 25 hearts.',      petSkill:'scoredouble'},
  {id:'pet_mushroom',type:'pet',rarity:'rare',      name:'üçÑ Shroomie',   emoji:'üçÑ', desc:'Magical. Every 20 catches clears all baddies instantly.',    petSkill:'clearbad'},
  // ‚îÄ‚îÄ EPIC PETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'pet_dino',   type:'pet', rarity:'epic',      name:'ü¶ï Nomnom Jr.', emoji:'ü¶ï', desc:'Baby brachiosaurus. Every 20 hearts, all bad items vanish!', petSkill:'clearbad'},
  {id:'pet_phoenix',type:'pet', rarity:'epic',      name:'ü¶Ö Blaze',      emoji:'ü¶Ö', desc:'Fiery guardian. Every 15 hearts, deflects the nearest falling bad item.',  petSkill:'deflect'},
  {id:'pet_lion',   type:'pet', rarity:'epic',      name:'ü¶Å Simba',      emoji:'ü¶Å', desc:'Roar! Every bad item you dodge restores 0.5 life.',          petSkill:'dodgerheal'},
  {id:'pet_dolphin',type:'pet', rarity:'epic',      name:'üê¨ Flipper',    emoji:'üê¨', desc:'Playful! Grants a Lucky Break shield every 30 hearts.',      petSkill:'luckyregen'},
  {id:'pet_narwhal',type:'pet', rarity:'epic',      name:'ü¶ë Narwhal',    emoji:'ü¶ë', desc:'Mystic horn. Every 15 hearts, a free XP surge (5s).',        petSkill:'xpburst'},
  {id:'pet_elepha', type:'pet', rarity:'epic',      name:'üêò Dumpling',   emoji:'üêò', desc:'Never forgets. Streak resets to 3 (not 0) when hit.',        petSkill:'streakguard'},
  // ‚îÄ‚îÄ UNCOMMON / RARE BONUSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'bon_coins20',type:'bonus',rarity:'uncommon', name:'üí∞ Coin Bag',   emoji:'üí∞', desc:'+20 coins now',  instant:true, fn:(p)=>{p.coins+=20;p.coinsEarned+=20;}},
  {id:'bon_coins30',type:'bonus',rarity:'uncommon', name:'üí∞ Coin Pouch', emoji:'üí∞', desc:'+30 coins now',  instant:true, fn:(p)=>{p.coins+=30;p.coinsEarned+=30;}},
  {id:'bon_coins50',type:'bonus',rarity:'rare',     name:'üíé Gem Chest',  emoji:'üíé', desc:'+50 coins now',  instant:true, fn:(p)=>{p.coins+=50;p.coinsEarned+=50;}},
  {id:'bon_coins80',type:'bonus',rarity:'epic',     name:'üí∞ JACKPOT',    emoji:'üí∞', desc:'+80 coins now',  instant:true, fn:(p)=>{p.coins+=80;p.coinsEarned+=80;}},
  // ‚îÄ‚îÄ LEGENDARY PETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {id:'pet_baobao', type:'pet', rarity:'legendary', name:'ü•ü Mini Bao',   emoji:'ü•ü', desc:'A tiny Bao ‚ú® Grants a full Lucky Break + magnet every 25 hearts!', petSkill:'minibao'},
  {id:'pet_dudu2',  type:'pet', rarity:'legendary', name:'üêª Lil Dudu',   emoji:'üêª', desc:'Fluffiest boy. Doubles score for 5s every 35 hearts caught.', petSkill:'dudubuff'},
  {id:'pet_dragon2',type:'pet', rarity:'legendary', name:'üî± Royal Dragon',emoji:'üî±',desc:'Majestic. Bad items shrink AND fall slower. Always on.',        petSkill:'royalguard'},
  {id:'char_bubu',  type:'char',rarity:'legendary', name:'üêº BUBU',        emoji:'üêº', desc:'Unlock Bubu as a playable character! üéâ (Shopaholic passive)'},
  // NEW COMMON PETS
  {id:'pet_snail',  type:'pet', rarity:'common',    name:'üêå Sludge',     emoji:'üêå', desc:'Slow and chill. Slightly widens basket edges.',              petSkill:'luck'},
  {id:'pet_mouse',  type:'pet', rarity:'common',    name:'üê≠ Nibbles',    emoji:'üê≠', desc:'Tiny but brave. +5% coin drop rate.',                        petSkill:'coinchance'},
  {id:'pet_parrot', type:'pet', rarity:'common',    name:'ü¶ú Polly',      emoji:'ü¶ú', desc:'Squawk! Announces incoming bad items with a flash.',          petSkill:'frogluck'},
  {id:'pet_hedgehog',type:'pet',rarity:'common',    name:'ü¶î Spikes',     emoji:'ü¶î', desc:'Prickly pal. Very small chance to deflect a bad item.',       petSkill:'frogluck'},
  {id:'pet_fish',   type:'pet', rarity:'common',    name:'üê† Bubbles',    emoji:'üê†', desc:'Bubbly friend. Boosts coin chance by +4%.',                   petSkill:'coinchance'},
  // NEW UNCOMMON PETS
  {id:'pet_koala',  type:'pet', rarity:'uncommon',  name:'üê® Eucalyptus', emoji:'üê®', desc:'Drowsy but helpful. Restores 1 life every 35 hearts.',        petSkill:'regen40'},
  {id:'pet_flamingo',type:'pet',rarity:'uncommon',  name:'ü¶© Rosie',      emoji:'ü¶©', desc:'Elegant dancer. XP gains +12%.',                             petSkill:'xpowl'},
  {id:'pet_sloth',  type:'pet', rarity:'uncommon',  name:'ü¶• Lazy',       emoji:'ü¶•', desc:'Takes it easy. Bad items fall 10% slower.',                  petSkill:'slowbad'},
  {id:'pet_raccoon',type:'pet', rarity:'uncommon',  name:'ü¶ù Bandit',     emoji:'ü¶ù', desc:'Sneaky! Grabs +1 bonus coin every 12 hearts.',               petSkill:'beecoin'},
  {id:'pet_butterfly',type:'pet',rarity:'uncommon', name:'ü¶ã Flutter',    emoji:'ü¶ã', desc:'Gentle flutter nudges stray hearts toward basket.',           petSkill:'heartsnag'},
  // NEW RARE PETS
  {id:'pet_elephant',type:'pet',rarity:'rare',      name:'üêò Peanut',     emoji:'üêò', desc:'Never forgets AND streak resets to 4 instead of 0.',         petSkill:'streakguard'},
  {id:'pet_octopus',type:'pet', rarity:'rare',      name:'üêô Inky',       emoji:'üêô', desc:'Eight arms! 8% chance to catch a second nearby heart.',       petSkill:'heartsnag'},
  {id:'pet_shark',  type:'pet', rarity:'rare',      name:'ü¶à Finn',       emoji:'ü¶à', desc:'Fins up! Doubles coin gain for 5s every 20 hearts.',          petSkill:'scoredouble'},
  {id:'pet_gorilla',type:'pet', rarity:'rare',      name:'ü¶ç Kong',       emoji:'ü¶ç', desc:'Mighty! Every 25 hearts, clears all bad items instantly.',    petSkill:'clearbad'},
  // NEW EPIC PETS
  {id:'pet_whale',  type:'pet', rarity:'epic',      name:'üêã Moby',       emoji:'üêã', desc:'Ocean giant. Every 20 hearts spawns 2 bonus hearts.',         petSkill:'heartspawn'},
  {id:'pet_snake',  type:'pet', rarity:'epic',      name:'üêç Venom',      emoji:'üêç', desc:'Bad items that fall past the basket give +1 coin instead of hurting.', petSkill:'dodgerheal'},
  {id:'pet_tiger',  type:'pet', rarity:'epic',      name:'üêØ Stripes',    emoji:'üêØ', desc:'Fierce! Streak multiplier kicks in at 3 instead of 5.',       petSkill:'xpburst'},
];
const GACHA_WEIGHTS = {common:55,uncommon:28,rare:12,epic:4,legendary:1};
const GACHA_RARITIES = ['common','uncommon','rare','epic','legendary'];
const RARITY_CSS = {common:'gr-common',uncommon:'gr-uncommon',rare:'gr-rare',epic:'gr-epic',legendary:'gr-legendary'};
const RARITY_LABEL = {common:'Common',uncommon:'Uncommon',rare:'‚ú¶ Rare',epic:'‚òÖ Epic',legendary:'‚ú¶‚ú¶ LEGENDARY'};

// Migrate old P if needed
if(!P.gachaPulls) P.gachaPulls=0;
if(!P.gachaPity) P.gachaPity=0;
if(!P.gachaInventory) P.gachaInventory=[];
if(!P.equippedPet) P.equippedPet=null;
if(!P.dailyStreak) P.dailyStreak=0;
if(!P.lastLogin) P.lastLogin=null;
if(!P.lastDailyClaim) P.lastDailyClaim=null;

function gachaRoll(){
  P.gachaPulls++;P.gachaPity++;
  let rarity;
  if(P.gachaPity>=10){
    // Guaranteed rare+
    const w={rare:70,epic:20,legendary:10};
    const rarities=['rare','epic','legendary'];
    const tot=100;const r=Math.random()*tot;let acc=0;
    for(const rv of rarities){acc+=w[rv];if(r<acc){rarity=rv;break;}}
    P.gachaPity=0;
  } else {
    const tot=Object.values(GACHA_WEIGHTS).reduce((a,b)=>a+b,0);
    const r=Math.random()*tot;let acc=0;
    for(const rv of GACHA_RARITIES){acc+=GACHA_WEIGHTS[rv];if(r<acc){rarity=rv;break;}}
    if(rarity!=='common'&&rarity!=='uncommon') P.gachaPity=0;
  }
  const pool=GACHA_POOL.filter(i=>i.rarity===rarity);
  // prefer items not owned yet as pets
  const fresh=pool.filter(i=>i.type!=='pet'||!P.gachaInventory.includes(i.id));
  const chosen=(fresh.length?fresh:pool)[Math.floor(Math.random()*(fresh.length||pool.length))];
  // Apply instant bonus
  if(chosen.instant&&chosen.fn){chosen.fn(P);}
  // Add pet to inventory (pets only, no dupes)
  if(chosen.type==='pet'&&!P.gachaInventory.includes(chosen.id)) P.gachaInventory.push(chosen.id);
  // Unlock char
  if(chosen.type==='char'&&chosen.id==='char_bubu'&&!P.bubuUnlocked){
    P.bubuUnlocked=true;
    refreshBubuCard();
    showAchievement(`üêº BUBU UNLOCKED! She's ready to play! üõçÔ∏è`);
  }
  if(rarity==='legendary') P.legendaryRolled++;
  saveP();
  return chosen;
}

function openGacha(){showTab('game');setTimeout(()=>{hcSubTab('shop');document.getElementById('tab-game-shop')?.scrollIntoView({behavior:'smooth'});},100);}
function closeGacha(){}

function refreshBubuCard(){
  // Update both catch-hearts and Connect Bao dropdowns
  const opt1=document.getElementById('bubu-option');
  const opt2=document.getElementById('c4-bubu-option');
  if(P.bubuUnlocked){
    if(opt1){ opt1.disabled=false; opt1.textContent='üêº Bubu ‚Äî Shopaholic (catch 5 üõçÔ∏è bags ‚Üí +5 coins!)'; }
    if(opt2){ opt2.disabled=false; opt2.textContent='üêº Bubu ‚Äî Lucky Shopper (earn bonus coins from disc drops!)'; }
  } else {
    if(opt1){ opt1.disabled=true; opt1.textContent='üîí ??? ‚Äî Mystery Character (unlock via Capsule Machine)'; }
    if(opt2){ opt2.disabled=true; opt2.textContent='üîí ??? ‚Äî Mystery Character (unlock via Capsule Machine)'; }
  }
}

function updateGachaUI(){
  if(!P.diamonds) P.diamonds=0;
  document.getElementById('gacha-pity-txt').textContent=`Pity: ${P.gachaPity} / 10 pulls until rare+`;
  const hasSingle=P.diamonds>=3;
  const hasTen=P.diamonds>=25;
  document.getElementById('gpb1').disabled=!hasSingle;
  document.getElementById('gpb10').disabled=!hasTen;
  const dEl=document.getElementById('gacha-diamond-display');
  if(dEl) dEl.textContent=P.diamonds;
  renderGachaInv();
  // update wallet in shop too
  updateWalletDisplays();
}

// ‚îÄ‚îÄ GACHA SOUND ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _audioCtx = (()=>{
  try { return new (window.AudioContext||window.webkitAudioContext)(); } catch(e){ return null; }
})();

function _playTone(freq, type='sine', startTime=0, duration=0.15, vol=0.18, endFreq=null){
  if(!_audioCtx) return;
  const osc = _audioCtx.createOscillator();
  const gain = _audioCtx.createGain();
  osc.connect(gain); gain.connect(_audioCtx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, _audioCtx.currentTime + startTime);
  if(endFreq) osc.frequency.exponentialRampToValueAtTime(endFreq, _audioCtx.currentTime + startTime + duration);
  gain.gain.setValueAtTime(vol, _audioCtx.currentTime + startTime);
  gain.gain.exponentialRampToValueAtTime(0.001, _audioCtx.currentTime + startTime + duration);
  osc.start(_audioCtx.currentTime + startTime);
  osc.stop(_audioCtx.currentTime + startTime + duration + 0.01);
}

function _playNoise(startTime=0, duration=0.08, vol=0.12){
  if(!_audioCtx) return;
  const buf = _audioCtx.createBuffer(1, _audioCtx.sampleRate * duration, _audioCtx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1);
  const src = _audioCtx.createBufferSource();
  const gain = _audioCtx.createGain();
  const filter = _audioCtx.createBiquadFilter();
  filter.type = 'bandpass';
  filter.frequency.value = 800;
  src.buffer = buf;
  src.connect(filter); filter.connect(gain); gain.connect(_audioCtx.destination);
  gain.gain.setValueAtTime(vol, _audioCtx.currentTime + startTime);
  gain.gain.exponentialRampToValueAtTime(0.001, _audioCtx.currentTime + startTime + duration);
  src.start(_audioCtx.currentTime + startTime);
}

function playGameOverSound(){
  if(!_audioCtx) return;
  if(_audioCtx.state==='suspended') _audioCtx.resume();
  // Descending sad wah-wah
  [[392,0],[330,0.18],[277,0.36],[220,0.55]].forEach(([f,d])=>
    _playTone(f,'sawtooth',d,0.22,0.14));
  _playTone(220,'sine',0.55,0.6,0.08,110);
  _playNoise(0.55,0.12,0.18);
}

function playHighScoreSound(){
  if(!_audioCtx) return;
  if(_audioCtx.state==='suspended') _audioCtx.resume();
  [[523,0],[659,0.1],[784,0.2],[1047,0.32],[1319,0.46],[1047,0.62],[1319,0.76],[1568,0.9]].forEach(([f,d])=>
    _playTone(f,'triangle',d,0.16,0.2));
  _playTone(523,'sine',0,1.1,0.06,1568);
  for(let i=0;i<5;i++) setTimeout(()=>_playNoise(0,0.05,0.12), 400+i*130);
}

function playBuySound(){
  if(!_audioCtx) return;
  if(_audioCtx.state==='suspended') _audioCtx.resume();
  _playTone(880,'triangle',0,0.1,0.18);
  _playTone(1108,'triangle',0.08,0.12,0.16);
  _playTone(1318,'triangle',0.18,0.18,0.14);
  _playTone(1760,'sine',0.3,0.22,0.1);
}

function playGachaStartSound(){
  if(!_audioCtx) return;
  // Lever click
  _playNoise(0, 0.06, 0.25);
  _playTone(200, 'square', 0, 0.08, 0.12, 120);
  // Reel spinning ticks
  for(let i=0;i<12;i++){
    const t = 0.08 + i * 0.07;
    _playTone(300 + Math.random()*200, 'square', t, 0.04, 0.06);
  }
}

function playGachaResultSound(rarity){
  if(!_audioCtx) return;
  const t = 0;
  if(rarity === 'legendary'){
    // Triumphant fanfare
    [[523,0],[659,0.13],[784,0.26],[1047,0.4],[1319,0.55],[1047,0.72],[1319,0.88]].forEach(([f,d])=>
      _playTone(f,'triangle',d,0.18,0.22));
    _playTone(523,'sine',0,0.9,0.08,1319);
    for(let i=0;i<6;i++) setTimeout(()=>_playNoise(0,0.05,0.15), 300+i*120);
  } else if(rarity === 'epic'){
    // Rising sparkle
    [[392,0],[523,0.14],[659,0.28],[784,0.42],[1047,0.58]].forEach(([f,d])=>
      _playTone(f,'triangle',d,0.16,0.2));
    _playTone(392,'sine',0,0.65,0.07,1047);
  } else if(rarity === 'rare'){
    // Nice chime
    [[523,0],[659,0.15],[784,0.3]].forEach(([f,d])=>
      _playTone(f,'triangle',d,0.18,0.18));
  } else if(rarity === 'uncommon'){
    _playTone(440,'triangle',0,0.14,0.15);
    _playTone(554,'triangle',0.15,0.14,0.15);
  } else {
    // Common: soft blip
    _playTone(330,'sine',0,0.12,0.12,280);
  }
}

function gachaPull(count){
  if(!P.diamonds) P.diamonds=0;
  const cost=count===1?3:25;
  if(P.diamonds<cost){showToast(`Need ${cost} üíé diamonds! Earn by defeating bosses & high scores.`);return;}
  P.diamonds-=cost;
  const dEl=document.getElementById('gacha-diamond-display');
  if(dEl) dEl.textContent=P.diamonds;
  saveP();
  const results=[];
  for(let i=0;i<count;i++) results.push(gachaRoll());
  saveP();
  // Sound!
  if(_audioCtx && _audioCtx.state==='suspended') _audioCtx.resume();
  playGachaStartSound();
  // Trigger full animation overlay
  const machineEl=document.getElementById('gacha-ball');
  machineEl.classList.remove('spinning');
  void machineEl.offsetWidth;
  machineEl.classList.add('spinning');
  setTimeout(()=>machineEl.classList.remove('spinning'),1100);
  playGachaAnimation(results, count);
}

// ‚îÄ‚îÄ REEL SYMBOLS (for animation display) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const REEL_SYMS=['üíï','üíñ','‚≠ê','‚ú®','üí∞','üå∏','üéÄ','üéä','üíé','üåü','üî•','üí´'];
function randReelSym(){return REEL_SYMS[Math.floor(Math.random()*REEL_SYMS.length)];}

function playGachaAnimation(results, count){
  const overlay=document.getElementById('gacha-anim-overlay');
  const label=document.getElementById('gacha-anim-label');
  const resultEl=document.getElementById('gacha-anim-result');
  const sparks=document.getElementById('gacha-anim-sparks');
  const rays=document.getElementById('gacha-rays');
  const r1=document.getElementById('ov-reel1');
  const r2=document.getElementById('ov-reel2');
  const r3=document.getElementById('ov-reel3');
  const knob=document.getElementById('ov-lever-knob');

  // Reset
  resultEl.style.display='none';
  resultEl.innerHTML='';
  sparks.innerHTML='';
  rays.classList.remove('show');
  overlay.classList.remove('pulsing');
  label.textContent='üé∞ Pulling...';
  overlay.classList.add('show');

  // Lever pull animation via attribute
  const leverAnim=knob.animate([{cy:56},{cy:100},{cy:100},{cy:56}],{duration:600,easing:'ease-in-out'});

  // Spin reels
  let spinInterval=setInterval(()=>{
    r1.textContent=randReelSym();
    r2.textContent=randReelSym();
    r3.textContent=randReelSym();
  },90);

  // Pick top result for display
  const topResult=results.reduce((best,r)=>{
    const order=['common','uncommon','rare','epic','legendary'];
    return order.indexOf(r.rarity)>order.indexOf(best.rarity)?r:best;
  },results[0]);
  const rarity=topResult.rarity;
  const rarityColors={common:'#ccc',uncommon:'#8de38d',rare:'#88bbff',epic:'#ce93ff',legendary:'#FFD700'};
  const rarityBg={common:'rgba(255,255,255,0.09)',uncommon:'rgba(100,220,100,0.14)',rare:'rgba(80,160,255,0.16)',epic:'rgba(200,100,255,0.2)',legendary:'rgba(255,215,0,0.2)'};
  const rarityBorder={common:'rgba(200,200,200,0.3)',uncommon:'#5cb85c',rare:'#5599ff',epic:'#b44fff',legendary:'#D4A853'};
  const spinDuration=rarity==='legendary'?2200:rarity==='epic'?1700:rarity==='rare'?1300:900;

  setTimeout(()=>{
    clearInterval(spinInterval);
    // Reveal reels one by one
    const finalSyms=[topResult.emoji, count>1?results[Math.min(1,results.length-1)].emoji:randReelSym(), count>2?results[Math.min(2,results.length-1)].emoji:randReelSym()];
    label.textContent='üé≤ Revealing...';

    setTimeout(()=>{ r1.textContent=finalSyms[0]; r1.style.animation='reelReveal 0.4s cubic-bezier(.34,1.56,.64,1) forwards'; setTimeout(()=>r1.style.animation='',500); },0);
    setTimeout(()=>{ r2.textContent=finalSyms[1]; r2.style.animation='reelReveal 0.4s cubic-bezier(.34,1.56,.64,1) forwards'; setTimeout(()=>r2.style.animation='',500); },200);
    setTimeout(()=>{ r3.textContent=finalSyms[2]; r3.style.animation='reelReveal 0.4s cubic-bezier(.34,1.56,.64,1) forwards'; setTimeout(()=>r3.style.animation='',500); },400);

    // Show result card
    setTimeout(()=>{
      // Sparks
      const sparkColors=[rarityColors[rarity],'#fff','#FFD700',rarityColors[rarity]];
      const numSparks=rarity==='legendary'?28:rarity==='epic'?18:rarity==='rare'?12:7;
      for(let s=0;s<numSparks;s++){
        const el=document.createElement('div');
        el.className='spark';
        const angle=Math.random()*Math.PI*2;
        const dist=80+Math.random()*160;
        el.style.cssText=`left:50%;top:45%;--sx:${Math.cos(angle)*dist}px;--sy:${Math.sin(angle)*dist}px;background:${sparkColors[s%sparkColors.length]};animation-delay:${Math.random()*0.3}s;animation-duration:${0.6+Math.random()*0.5}s;`;
        sparks.appendChild(el);
      }
      // Rays for legendary
      if(rarity==='legendary'){rays.classList.add('show');overlay.classList.add('pulsing');}
      if(rarity==='epic'||rarity==='legendary'){overlay.classList.add('pulsing');}

      // Build result card
      const cardLabel=rarity==='legendary'?'‚ú¶‚ú¶ LEGENDARY ‚ú¶‚ú¶':rarity==='epic'?'‚òÖ EPIC ‚òÖ':rarity==='rare'?'‚ú¶ Rare':rarity==='uncommon'?'Uncommon':'Common';
      let cardHtml='';
      if(count===1){
        cardHtml=`<div style="font-size:.65rem;letter-spacing:.15em;color:${rarityColors[rarity]};margin-bottom:.3rem;">${cardLabel}</div>
          <div style="font-size:2.2rem;margin:.2rem 0;">${topResult.emoji}</div>
          <div style="font-size:.95rem;color:${rarityColors[rarity]};font-weight:700;">${topResult.name}</div>
          <div style="font-size:.68rem;color:rgba(244,195,130,.65);margin-top:.2rem;">${topResult.desc}</div>`;
      } else {
        const icons=results.map(r=>`<span title="${r.name}" style="font-size:1.5rem;">${r.emoji}</span>`).join('');
        const best=results.filter(r=>r.rarity==='legendary').length>0?`üåü ${results.filter(r=>r.rarity==='legendary').length}√ó Legendary!`:results.filter(r=>r.rarity==='epic').length>0?`‚òÖ ${results.filter(r=>r.rarity==='epic').length}√ó Epic!`:`${cardLabel} best`;
        cardHtml=`<div style="font-size:.65rem;letter-spacing:.12em;color:${rarityColors[rarity]};margin-bottom:.4rem;">${best}</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-bottom:.3rem;">${icons}</div>`;
      }
      resultEl.innerHTML=cardHtml;
      resultEl.style.cssText=`display:block;background:${rarityBg[rarity]};border:2px solid ${rarityBorder[rarity]};color:${rarityColors[rarity]};`;
      resultEl.style.animation='resultCardPop .52s cubic-bezier(.34,1.56,.64,1) forwards';
      label.textContent=rarity==='legendary'?'üåü LEGENDARY!!':rarity==='epic'?'‚òÖ EPIC!':rarity==='rare'?'‚ú¶ Rare!':'‚ú® Got it!';
      playGachaResultSound(rarity);

      // Close after delay ‚Äî tap to dismiss early
      const closeOverlay=()=>{
        overlay.classList.remove('show','pulsing');
        rays.classList.remove('show');
        sparks.innerHTML='';
        overlay.removeEventListener('click',closeOverlay);
        // Now update the gacha modal result
        renderGachaResult(results,count);
        updateGachaUI();
        if(results.some(r=>r.rarity==='legendary')) showAchievement(`‚ú® LEGENDARY PULL! ${results.find(r=>r.rarity==='legendary').name}`);
        else if(results.some(r=>r.rarity==='epic')) showAchievement(`‚òÖ Epic pull! ${results.find(r=>r.rarity==='epic').name}`);
      };
      setTimeout(closeOverlay, rarity==='legendary'?3200:rarity==='epic'?2500:1800);
      setTimeout(()=>overlay.addEventListener('click',closeOverlay),300);
    }, 680);
  }, spinDuration);
}

function renderGachaResult(results,count){
  const el=document.getElementById('gacha-result');
  if(count===1){
    const r=results[0];
    el.innerHTML=`<div class="gr-item ${RARITY_CSS[r.rarity]}">${r.emoji} <span><strong>${r.name}</strong><br><small>${RARITY_LABEL[r.rarity]}${r.type==='bonus'?' ¬∑ '+r.desc:''}</small></span></div>`;
  } else {
    const html=results.map(r=>`<div class="gr-item ${RARITY_CSS[r.rarity]}" title="${r.name}">${r.emoji} <small>${RARITY_LABEL[r.rarity]}</small></div>`).join('');
    el.innerHTML=`<div class="gacha-multi">${html}</div>`;
  }
}

function renderGachaInv(){
  const el=document.getElementById('gacha-inv');
  const pets=GACHA_POOL.filter(i=>i.type==='pet'&&P.gachaInventory.includes(i.id));
  const charUnlocked=P.bubuUnlocked;
  let html='';
  if(charUnlocked) html+=`<div class="ginv-chip" style="border-color:#FF6BA8;background:rgba(233,30,140,.12);color:#FF6BA8;" title="Bubu unlocked as playable character!">üêº Bubu Unlocked!</div>`;
  if(!pets.length&&!charUnlocked){el.innerHTML=`<span style="font-size:.68rem;color:rgba(244,195,130,.35)">No companions yet ‚Äî pull to collect!</span>`;return;}
  html+=pets.map(p=>`<div class="ginv-chip ${P.equippedPet===p.id?'equipped':''}" onclick="equipPet('${p.id}')" title="${p.desc}">${p.emoji} ${p.name.split(' ').slice(1).join(' ')} <span style="font-size:.5rem;opacity:.6">${p.rarity==='common'?'':p.rarity==='uncommon'?'‚ú¶':'‚òÖ'.repeat({'rare':1,'epic':2,'legendary':3}[p.rarity]||0)}</span></div>`).join('');
  el.innerHTML=html;
}

// Initialize Bubu card state on load
(function(){
  refreshBubuCard();
  updateCharPreview('bao'); // Show default char preview
  if(typeof updateC4CharPreview==='function') setTimeout(()=>updateC4CharPreview('bao'),50);
})();

function equipPet(id){
  P.equippedPet=(P.equippedPet===id)?null:id;
  saveP();renderGachaInv();
  const p=GACHA_POOL.find(x=>x.id===id);
  if(P.equippedPet){
    showToast(`${p.emoji} ${p.name} equipped! ${p.desc}`);
  } else {
    showToast(`Pet unequipped`);
  }
}

// ===================== DAILY LOGIN =====================
function checkDailyLogin(){
  const today=new Date().toDateString();
  if(P.lastDailyClaim===today) return; // already claimed today
  P.lastLogin=today;
  const yesterday=new Date(Date.now()-86400000).toDateString();
  if(P.lastDailyClaim===yesterday){P.dailyStreak=Math.min((P.dailyStreak||0)+1,999);}
  else {P.dailyStreak=1;}
  saveP();
  setTimeout(()=>showDailyModal(),600);
}

function dailyReward(streak){
  if(streak>=30) return {coins:80,label:`+80 coins üí∞ (30-day legend!) +5 üíé`};
  if(streak>=14) return {coins:50,label:`+50 coins üí∞ (2-week warrior!) +3 üíé`};
  if(streak>=7)  return {coins:35,label:`+35 coins üí∞ (week streak! üåü) +1 üíé`};
  if(streak>=3)  return {coins:20,label:`+20 coins üí∞ (3-day streak!)`};
  return {coins:10,label:`+10 coins üí∞`};
}

function showDailyModal(){
  const s=P.dailyStreak||1;
  document.getElementById('dm-streak-num').textContent=s;
  const r=dailyReward(s);
  document.getElementById('dm-reward').textContent=r.label;
  // render dots (last 7 days in streak)
  const dots=document.getElementById('daily-dots');
  dots.innerHTML='';
  for(let i=1;i<=7;i++){
    const d=document.createElement('div');
    d.className='daily-dot';
    const labels=['1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£'];
    d.textContent=labels[i-1];
    if(i<s&&s<=7) d.classList.add('done');
    else if(i===Math.min(s,7)) d.classList.add('today');
    else if(s>7) d.classList.add('done'); // all done after 7
    dots.appendChild(d);
  }
  document.getElementById('daily-modal').classList.add('show');
}

function claimDaily(){
  const r=dailyReward(P.dailyStreak||1);
  P.coins+=r.coins;P.coinsEarned+=r.coins;
  // Bonus diamond for 7-day streak milestones
  if(!P.diamonds) P.diamonds=0;
  const streak7=P.dailyStreak||1;
  let diamondBonus=0;
  if(streak7>=30) diamondBonus=5;
  else if(streak7>=14) diamondBonus=3;
  else if(streak7>=7) diamondBonus=1;
  if(diamondBonus>0){ P.diamonds+=diamondBonus; }
  P.lastDailyClaim=new Date().toDateString();
  saveP();
  document.getElementById('daily-modal').classList.remove('show');
  const dEl=document.getElementById('gacha-diamond-display');
  if(dEl) dEl.textContent=P.diamonds;
  showToast(`Daily reward: ${r.label}${diamondBonus>0?` + ${diamondBonus} üíé diamond${diamondBonus>1?'s':''}!`:''}`);
  updateWalletDisplays();
}

// ===================== COMBO FLASH =====================
function showComboFlash(n){
  const el=document.getElementById('combo-flash');
  let text,color;
  if(n>=20){text=`üåü ${n}√ó LEGENDARY!`;color='#FFD700';}
  else if(n>=15){text=`üí• ${n}√ó INSANE!`;color='#FF9800';}
  else if(n>=10){text=`üî• ${n}√ó ON FIRE!`;color='#E8736A';}
  else {text=`‚ö° ${n}√ó COMBO!`;color='#F4A56A';}
  el.textContent=text;el.style.color=color;
  el.classList.remove('pop','fade');
  void el.offsetWidth;
  el.classList.add('pop');
  setTimeout(()=>{el.classList.remove('pop');void el.offsetWidth;el.classList.add('fade');setTimeout(()=>el.classList.remove('fade'),400);},900);
}

// ===================== ACHIEVEMENT TOAST =====================
let _achieveTimer=null;
function showAchievement(text){
  const el=document.getElementById('achieve-toast');
  el.textContent=text;el.classList.add('show');
  clearTimeout(_achieveTimer);
  _achieveTimer=setTimeout(()=>el.classList.remove('show'),3000);
}

// Track which milestone combos we've shown
let _comboMilestones=new Set();
function checkComboFlash(s){
  if([5,10,15,20,25,30].includes(s)&&!_comboMilestones.has(s)){
    _comboMilestones.add(s);
    showComboFlash(s);
  }
  // Achievements
  if(s===10&&!P._ach_s10){P._ach_s10=true;saveP();showAchievement(`üî• 10√ó Streak! You're on fire, Bao!`);}
  if(s===25&&!P._ach_s25){P._ach_s25=true;saveP();showAchievement(`üåü 25√ó Streak! Absolutely legendary!`);}
}

// Reset per game
const _origReset=typeof resetGame==='function'?resetGame:null;

// ===================== DRAW COMPANION PET =====================
// ‚îÄ‚îÄ Pet animation state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._petAnim={pulseFrames:0,pulseColor:'#FFD700',burstParticles:[],shakeFrames:0};

function triggerPetAnim(type,color,burstEmoji){
  const a=window._petAnim;
  a.pulseFrames=44;a.pulseColor=color||'#FFD700';
  if(type==='burst'&&burstEmoji){
    for(let i=0;i<7;i++){
      const angle=(Math.PI*2/7)*i;
      a.burstParticles.push({x:W-28,y:50,vx:Math.cos(angle)*2.4,vy:Math.sin(angle)*2.4,color,emoji:burstEmoji,life:42,maxLife:42});
    }
  }
  if(type==='shake') a.shakeFrames=18;
}

function drawEquippedPet(){
  if(!P.equippedPet||!running) return;
  const p=GACHA_POOL.find(x=>x.id===P.equippedPet);
  if(!p||p.type!=='pet') return;
  const a=window._petAnim;
  const t=frame*0.06;
  const shakeX=a.shakeFrames>0?(Math.random()-0.5)*5:0;
  const shakeY=a.shakeFrames>0?(Math.random()-0.5)*5:0;
  if(a.shakeFrames>0) a.shakeFrames--;
  const px=W-28+Math.sin(t)*4+shakeX;
  const py=50+Math.cos(t*0.7)*4+shakeY;
  const pulsing=a.pulseFrames>0;
  const scaleBoost=pulsing?1+0.4*(a.pulseFrames/44):1;
  const fontSize=Math.round(18*Math.min(W,H)/340*scaleBoost);
  ctx.save();
  if(pulsing){
    ctx.shadowBlur=22*(a.pulseFrames/44);ctx.shadowColor=a.pulseColor;
    ctx.beginPath();ctx.arc(px,py-fontSize*0.35,fontSize*0.8,0,Math.PI*2);
    ctx.globalAlpha=(a.pulseFrames/44)*0.3;ctx.fillStyle=a.pulseColor;ctx.fill();
    ctx.globalAlpha=1;a.pulseFrames--;
  }
  if(p.rarity==='legendary'){ctx.shadowBlur=12+Math.sin(t)*4;ctx.shadowColor='#FFD700';}
  else if(p.rarity==='epic'){ctx.shadowBlur=8+Math.sin(t)*3;ctx.shadowColor='#CE93D8';}
  else ctx.shadowBlur=0;
  ctx.globalAlpha=0.88;ctx.font=`${fontSize}px serif`;ctx.textAlign='center';
  ctx.fillText(p.emoji,px,py);ctx.restore();
  // burst particles
  for(let i=a.burstParticles.length-1;i>=0;i--){
    const bp=a.burstParticles[i];
    bp.x+=bp.vx;bp.y+=bp.vy;bp.vy+=0.12;bp.life--;
    ctx.save();ctx.globalAlpha=bp.life/bp.maxLife;
    ctx.font=`${Math.round(9*(bp.life/bp.maxLife)+5)}px serif`;ctx.textAlign='center';
    ctx.fillText(bp.emoji,bp.x,bp.y);ctx.restore();
    if(bp.life<=0) a.burstParticles.splice(i,1);
  }
  // rarity dot
  const dotColor=p.rarity==='legendary'?'#FFD700':p.rarity==='epic'?'#CE93D8':p.rarity==='rare'?'#90caf9':p.rarity==='uncommon'?'#a5d6a7':'#aaa';
  ctx.save();ctx.globalAlpha=0.7;ctx.beginPath();ctx.arc(px,py+5,2.5,0,Math.PI*2);ctx.fillStyle=dotColor;ctx.fill();ctx.restore();
}

// ===================== PET SKILL SYSTEM =====================
// Counters for pet skills (reset on game start)
window._petHeartCount=0;   // hearts caught this game (for pet triggers)
window._petBadDodged=0;    // bad items that passed through without hitting player
window._petMagnetTimer=0;  // frames left for mini-magnet (Mochi)
window._petX2Timer=0;      // frames left for score double (Sparkle)
window._petDuduX2Timer=0;  // frames left for Lil Dudu score double

// Called each time a good heart is caught ‚Äî for pet triggers
function petOnHeartCaught(heartX, heartY){
  if(!P.equippedPet||!running) return;
  const p=GACHA_POOL.find(x=>x.id===P.equippedPet);
  if(!p||p.type!=='pet'||!p.petSkill) return;
  window._petHeartCount=(window._petHeartCount||0)+1;
  const hc=window._petHeartCount;
  const sk=p.petSkill;

  // UNCOMMON: Starling ‚Äî 1 life every 40 hearts
  if(sk==='regen40'&&hc%40===0){lives=Math.min(lives+1,maxLives()+2);showPopup('‚≠ê Pet Heal!',heartX,heartY-14,'#FFD700');updateHUD();triggerPetAnim('burst','#FFD700','‚≠ê');}
  // UNCOMMON: Buzzy bee ‚Äî +1 coin every 10 hearts
  if(sk==='beecoin'&&hc%10===0){coins+=1;P.coins+=1;P.coinsEarned+=1;showPopup('üêù +1ü™ô',heartX,heartY-10,'#FFD700');triggerPetAnim('pulse','#FFD700','ü™ô');}
  // RARE: Mini Mochi magnet trigger
  if(sk==='minimagnet'&&hc%20===0){window._petMagnetTimer=180;showPopup('üêº Magnet!',heartX,heartY-14,'#90caf9');triggerPetAnim('burst','#90caf9','üß≤');}
  // RARE: Sparkle ‚Äî score double for 3s every 30 hearts
  if(sk==='scoredouble'&&hc%30===0){window._petX2Timer=180;showPopup('ü¶Ñ 2√ó Score!',heartX,heartY-14,'#CE93D8');triggerPetAnim('burst','#CE93D8','‚ú®');}
  // RARE: Howler ‚Äî streak +1 every 25 hearts
  if(sk==='streakboost'&&hc%25===0){streak=Math.min(streak+1,999);showPopup('üê∫ +1 Streak!',heartX,heartY-14,'#aaa');triggerPetAnim('shake','#aaaaaa','üî•');}
  // EPIC: Dino/Mushroom ‚Äî clear all bads every 20 hearts
  if(sk==='clearbad'&&hc%20===0){items=items.filter(it=>!it.bad);bossShot=[];showPopup('ü¶ï Cleared!',W/2,H/2,'#4CAF50');triggerPetAnim('burst','#4CAF50','üí®');}
  // EPIC: Lion ‚Äî dodge heal (handled in bad-miss path below)
  // EPIC: Dolphin ‚Äî Lucky Break regen every 30 hearts
  if(sk==='luckyregen'&&hc%30===0){
    if(!activeBuffs.find(b=>b.id==='lucky_s')) activeBuffs.push({id:'lucky_s',rarity:'common',emoji:'üçÄ',short:'Lucky',endsAt:Infinity});
    showPopup('üê¨ Lucky!',heartX,heartY-14,'#4CAF50');triggerPetAnim('burst','#4CAF50','üçÄ');
  }
  // EPIC: Narwhal ‚Äî XP surge every 15 hearts
  if(sk==='xpburst'&&hc%15===0){
    activeBuffs.push({id:'xp_m',rarity:'rare',emoji:'‚ö°',short:'XP++',endsAt:frame+5*60});
    showPopup('ü¶ë XP Surge!',heartX,heartY-14,'#FFD700');triggerPetAnim('burst','#FFD700','‚ö°');
  }
  // LEGENDARY: Mini Bao ‚Äî Lucky Break + magnet every 25 hearts
  if(sk==='minibao'&&hc%25===0){
    if(!activeBuffs.find(b=>b.id==='lucky_s')) activeBuffs.push({id:'lucky_s',rarity:'common',emoji:'üçÄ',short:'Lucky',endsAt:Infinity});
    if(!activeBuffs.find(b=>b.id==='magnet_s')) activeBuffs.push({id:'magnet_s',rarity:'uncommon',emoji:'üß≤',short:'Magnet',endsAt:frame+5*60});
    showPopup('ü•ü Pet Power!',heartX,heartY-18,'#FFD700');triggerPetAnim('burst','#FFD700','ü•ü');
  }
  // LEGENDARY: Lil Dudu ‚Äî 2√ó score for 5s every 35 hearts
  if(sk==='dudubuff'&&hc%35===0){window._petDuduX2Timer=300;showPopup('üêª DUDU BUFF!',W/2,H/3,'#CE93D8');triggerPetAnim('burst','#CE93D8','üí•');}
  // EPIC: streakguard ‚Äî handled in bad-hit path, set flag
  if(sk==='streakguard') window._petStreakGuard=true;
  // EPIC: Blaze ‚Äî deflect nearest bad item every 15 hearts
  if(sk==='deflect'&&hc%15===0){
    const bads=items.filter(it=>it.bad&&!it.frozen);
    if(bads.length){
      const closest=bads.reduce((a,b)=>b.y>a.y?b:a);
      closest.bad=false;
      closest.emoji=HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)];
      showPopup('ü¶Ö Deflected!',closest.x,closest.y-14,'#F4A56A');triggerPetAnim('burst','#F4A56A','üî•');
    }
  }
}

// Called each frame in the game loop for always-on effects
function petTickFrame(){
  if(!P.equippedPet||!running) return;
  const p=GACHA_POOL.find(x=>x.id===P.equippedPet);
  if(!p||p.type!=='pet'||!p.petSkill) return;
  const sk=p.petSkill;

  // UNCOMMON: Fox ‚Äî shrinks bad items (handled in computeState via petBadShrink)
  // UNCOMMON: Penguin ‚Äî bad items slower (handled via petSlowBad)
  // UNCOMMON: Owl ‚Äî XP bonus (handled in XP calc)
  // RARE: Mini magnet active?
  if(sk==='minimagnet'&&window._petMagnetTimer>0){
    window._petMagnetTimer--;
    items.forEach(it=>{if(!it.bad) it.x+=(basket.x-it.x)*0.025;});
    // Pulse glow while magnet is active (every 20 frames)
    if(window._petMagnetTimer%20===0) triggerPetAnim('pulse','#90caf9','üß≤');
  }
  // LEGENDARY: Royal Dragon ‚Äî ongoing bad-shrink + slow (via petState)
  // COMMON: Heartsnag ‚Äî 0.4% chance per frame to auto-snap nearest heart
  if(sk==='heartsnag'){
    if(Math.random()<0.004){
      const nearest=items.filter(it=>!it.bad&&!it.isPotato&&!it.isShopbag).sort((a,b)=>Math.abs(a.x-basket.x)-Math.abs(b.x-basket.x))[0];
      if(nearest){nearest.x+=(basket.x-nearest.x)*0.15;triggerPetAnim('pulse','#F4A56A','üíï');}
    }
  }
  // Score multiplier timers for Sparkle & Lil Dudu
  if(window._petX2Timer>0) window._petX2Timer--;
  if(window._petDuduX2Timer>0) window._petDuduX2Timer--;
}

// Pet-applied state (called inside computeState)
function petApplyState(st){
  if(!P.equippedPet) return;
  const p=GACHA_POOL.find(x=>x.id===P.equippedPet);
  if(!p||p.type!=='pet'||!p.petSkill) return;
  const sk=p.petSkill;
  // UNCOMMON: Fox ‚Äî bad items 20% smaller
  if(sk==='shrink') st.badShrink=true;
  // UNCOMMON: Penguin ‚Äî 8% slower bad items
  if(sk==='slowbad') st.sm=Math.min(st.sm||1, (st.sm||1)*0.92);
  // UNCOMMON: Owl ‚Äî +10% XP
  if(sk==='xpowl') st.xpM=Math.max(st.xpM||1, (st.xpM||1)*1.1);
  // UNCOMMON: Bunny ‚Äî coin chance +5% (handled as flag)
  if(sk==='coinchance') st._petCoinBonus=true;
  // RARE: bad‚Üígood 5% chance (Deerling) ‚Äî flag for item loop
  if(sk==='baddtonluck') st._petDeerling=true;
  // EPIC: Blaze/Phoenix deflect ‚Äî visual trigger flag (actual logic in petOnHeartCaught)
  if(sk==='deflect') st._petDeflect=true;
  // LEGENDARY: Royal Dragon ‚Äî shrink + slow bad always
  if(sk==='royalguard'){st.badShrink=true;st.sm=Math.min(st.sm||1, (st.sm||1)*0.88);}
  // Score double for Sparkle/Dudu2
  if((sk==='scoredouble'&&window._petX2Timer>0)||(sk==='dudubuff'&&window._petDuduX2Timer>0)) st.x2=true;
}

// Pet on bad-item-dodge (bad item falls below basket without being caught)
function petOnBadDodged(it){
  if(!P.equippedPet||!running) return;
  const p=GACHA_POOL.find(x=>x.id===P.equippedPet);
  if(!p||p.type!=='pet'||!p.petSkill) return;
  if(p.petSkill==='dodgerheal'){
    if(!window._petDodgeDebt) window._petDodgeDebt=0;
    window._petDodgeDebt+=0.5;
    if(window._petDodgeDebt>=1){window._petDodgeDebt-=1;lives=Math.min(lives+1,maxLives()+2);showPopup('ü¶Å Dodge Heal!',it.x,H-40,'#FF9800');updateHUD();triggerPetAnim('burst','#FF9800','‚ù§Ô∏è');}
  }
}

// RARE: Deerling ‚Äî 5% chance to turn a bad item into a heart when spawned
function petDeerlingFilter(it){
  if(!P.equippedPet||!it.bad) return it;
  const p=GACHA_POOL.find(x=>x.id===P.equippedPet);
  if(!p||p.petSkill!=='baddtonluck') return it;
  if(Math.random()<0.05){
    it.bad=false;it.emoji=HEART_EMO[Math.floor(Math.random()*HEART_EMO.length)];
  }
  return it;
}

// Hook into existing gameLoop ‚Äî patch the end of loop to draw pet
const _origGameLoop=gameLoop;

// ===================== PATCH GAME LOOP FOR COMBO & PET =====================
// We monkey-patch streak increment points to trigger combo flash
// The actual gameLoop draws pets by appending after canvas clear:
// We use a post-draw callback approach by overriding requestAnimationFrame locally
const _raf=window.requestAnimationFrame.bind(window);
window.requestAnimationFrame=function(cb){
  return _raf(function(ts){
    cb(ts);
    // After every frame, draw pet on top
    if(typeof running!=='undefined'&&running&&typeof ctx!=='undefined'&&ctx){
      drawEquippedPet();
    }
  });
};

// Patch streak increment to trigger combo flash
// We listen to the streak variable via a setter
(function patchStreak(){
  let _streak=0;
  Object.defineProperty(window,'streak',{
    get(){return _streak;},
    set(v){
      if(v>_streak&&v>0) checkComboFlash(v);
      if(v===0) _comboMilestones.clear();
      _streak=v;
    },
    configurable:true
  });
})();

// First-visit daily check (after landing click)
document.getElementById('envBtn').addEventListener('click',()=>{
  setTimeout(checkDailyLogin,700);
},true);

// Boss defeat achievement
const _origDefeatBoss=typeof defeatBoss==='function'?defeatBoss:null;
if(_origDefeatBoss){
  window.defeatBoss=function(){
    _origDefeatBoss();
    if(bossDefeated===1&&!P._ach_b1){P._ach_b1=true;saveP();showAchievement(`‚öîÔ∏è First Boss Down! You're unstoppable!`);}
    if(bossDefeated===5&&!P._ach_b5){P._ach_b5=true;saveP();showAchievement(`üèÜ 5 Bosses Defeated! Legendary warrior!`);}
  };
}

</script><!-- SHARE MODAL -->
<div id="share-modal" onclick="if(event.target===this)closeShareModal()">
  <div id="share-card-wrap">
    <img id="share-preview" alt="Score card preview" style="width:100%;border-radius:14px;display:block;margin-bottom:.85rem;"/>
    <canvas id="share-canvas" style="display:none"></canvas>
    <div class="share-btns">
      <button class="share-btn copy-btn" onclick="copyShareText()">Copy Text üìã</button>
      <button class="share-btn dl-btn" onclick="downloadShareCard()">Save Image üíæ</button>
      <button class="share-btn close-btn" onclick="closeShareModal()">Close</button>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê EASTER EGG MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="egg-modal">
  <div id="egg-inner">
    <div id="egg-emoji">ü•ö</div>
    <div id="egg-title">Secret Found!</div>
    <div id="egg-msg"></div>
    <button id="egg-close" onclick="closeEgg()">How sweet ‚ô°</button>
  </div>
</div>
<div class="egg-found-badge" id="egg-badge">ü•ö Easter Egg Found!</div>

<script>
// ‚ïê‚ïê EASTER EGG SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EGGS = [
  {
    id:'egg_title_tap',
    emoji:'üíå',
    title:'A Secret Message',
    msg:`Hey Bao ü•ü You found it! This little hidden message was always here, waiting for the most curious person ‚Äî which is you. I lub you more than you know. Happy exploring. üß°`
  },
  {
    id:'egg_dudu_logo',
    emoji:'üêª',
    title:'Dudu Appears!',
    msg:`Psst ‚Äî it's me, Dudu. I've been hiding in here the whole time. I just wanted to say that making this game for you was one of my favourite things ever. I lub you, Bao. üíõ`
  },
  {
    id:'egg_maroon',
    emoji:'üëë',
    title:'Favourite Colour',
    msg:`Maroon. Your favourite colour. The colour of something warm and chosen and just a little bit regal. Much like a certain someone I know. üü• I lub you, my Maroon Queen. üíï`
  },
  {
    id:'egg_kovan',
    emoji:'üíå',
    title:'Ding Te Le, Kovan',
    msg:`Our first date. You wore your navy blue top and brown pants and I was already a little bit gone. Ding Te Le will forever be my favourite restaurant because of that evening. I lub you. üß°`
  },
  {
    id:'egg_weeknd',
    emoji:'üåô',
    title:'After Hours',
    msg:`Late-night R&B energy. The Weeknd playing somewhere in the background. You, being completely yourself. That's my favourite vibe and it's entirely your fault. I lub you so much. üéµ`
  },
  {
    id:'egg_steamboat',
    emoji:'ü´ï',
    title:'Steamboat Night!',
    msg:`Chicken, crabsticks, enoki mushrooms, maggie noodles ‚Äî the perfect steamboat lineup. Imagining sharing a hotpot with you right now. That would be a very good evening. I lub you. üß°`
  },
  {
    id:'egg_sheng_jian',
    emoji:'ü•ü',
    title:'Sheng Jian Bao!',
    msg:`The Chinatown stall. Perfectly crispy bottoms, warm filling, just the right amount of soup. You have impeccable taste in dumplings and in everything else too. I lub you, Bao. üíï`
  },
  {
    id:'egg_birthday',
    emoji:'üéÇ',
    title:'30 November!',
    msg:`30 November ‚Äî the day you arrived in the world, and I am very grateful for that. You deserve a whole celebration every single year. I lub you to the moon, birthday Bao. üß°‚ú®`
  },
  {
    id:'egg_softbroccoli',
    emoji:'ü•¶',
    title:'Soft Broccoli Supremacy',
    msg:`Soft broccoli is correct and I will defend this hill with you forever. Mushy is not bad. Mushy is comforting. You understand the true nature of vegetables. I lub you. ü•¶üíï`
  },
  {
    id:'egg_udon',
    emoji:'üçú',
    title:'Udon? No Thank You.',
    msg:`They look like worms. You are right. This is a completely valid stance and anyone who disagrees has simply not looked hard enough at udon. I lub you and I support you. ü™±üö´`
  },
  {
    id:'egg_lor_mee',
    emoji:'üçú',
    title:'86 Lor Mee!',
    msg:`Stall 86. The legendary thick sauce. You know the good ones. Having a favourite lor mee stall with an actual stall number memorised is elite behaviour and I love that about you. üíï`
  },
  {
    id:'egg_yew_kee',
    emoji:'ü¶Ü',
    title:'Yew Kee Duck Rice!',
    msg:`Yew Kee. The duck rice of your heart. I respect a person who knows their stall and I adore a person who knows theirs this specifically. I lub you, duck rice connoisseur. üçöüß°`
  },
];

let _eggsFound = JSON.parse(localStorage.getItem('bao_eggs')||'[]');

function showEgg(id){
  const egg = EGGS.find(e=>e.id===id);
  if(!egg) return;
  const isNew = !_eggsFound.includes(id);
  if(isNew){ _eggsFound.push(id); localStorage.setItem('bao_eggs',JSON.stringify(_eggsFound)); flashEggBadge(); }
  document.getElementById('egg-emoji').textContent = egg.emoji;
  document.getElementById('egg-title').textContent = egg.title;
  document.getElementById('egg-msg').textContent = egg.msg + (isNew ? '' : ' (Already found ü•ö)');
  document.getElementById('egg-modal').classList.add('show');
}
function closeEgg(){ document.getElementById('egg-modal').classList.remove('show'); }
function flashEggBadge(){
  const b=document.getElementById('egg-badge');
  b.classList.add('show');
  setTimeout(()=>b.classList.remove('show'),2800);
}

// ‚îÄ‚îÄ Trigger: tap the main title 5 times ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _titleTaps=0,_titleTimer=null;
document.querySelector('.main-title').addEventListener('click',()=>{
  _titleTaps++;
  clearTimeout(_titleTimer);
  _titleTimer=setTimeout(()=>_titleTaps=0,1400);
  if(_titleTaps>=5){ _titleTaps=0; showEgg('egg_title_tap'); }
});

// ‚îÄ‚îÄ Trigger: tap the envelope icon 3 times fast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _envTaps=0,_envTimer=null;
document.getElementById('envBtn').addEventListener('click',()=>{
  _envTaps++;
  clearTimeout(_envTimer);
  _envTimer=setTimeout(()=>_envTaps=0,1200);
  if(_envTaps>=3){ _envTaps=0; showEgg('egg_dudu_logo'); }
},true);

// ‚îÄ‚îÄ Trigger: long-press the note card (1.5s) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _noteHold=null;
document.getElementById('note-card').addEventListener('pointerdown',()=>{
  _noteHold=setTimeout(()=>showEgg('egg_kovan'),1500);
});
document.getElementById('note-card').addEventListener('pointerup',()=>clearTimeout(_noteHold));
document.getElementById('note-card').addEventListener('pointerleave',()=>clearTimeout(_noteHold));

// ‚îÄ‚îÄ Trigger: tap "Bao's Shop" heading 4 times ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _shopTaps=0,_shopTimer=null;
const _shopH3=document.querySelector('#tab-game-shop .shop-header h3')||document.querySelector('#tab-game-shop h3');
if(_shopH3) _shopH3.addEventListener('click',()=>{
  _shopTaps++;
  clearTimeout(_shopTimer);
  _shopTimer=setTimeout(()=>_shopTaps=0,1400);
  if(_shopTaps>=4){ _shopTaps=0; showEgg('egg_steamboat'); }
});

// ‚îÄ‚îÄ Trigger: buy Amber's Heart item ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origBuyItem = buyItem;
window.buyItem = function(item){
  _origBuyItem(item);
  if(item.id==='amber_heart') setTimeout(()=>showEgg('egg_maroon'),400);
  if(item.id==='weeknd_mode') setTimeout(()=>showEgg('egg_weeknd'),400);
  if(item.id==='kovan_memory_shop') setTimeout(()=>showEgg('egg_kovan'),400);
  if(item.id==='bao_legend') setTimeout(()=>showEgg('egg_sheng_jian'),400);
};

// ‚îÄ‚îÄ Trigger: score exactly 30 in a game ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origEndGame = endGame;
window.endGame = function(){
  _origEndGame();
  if(score===30) setTimeout(()=>showEgg('egg_birthday'),1200);
};

// ‚îÄ‚îÄ Trigger: defeat the Duck Rice Overlord ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origDefeatBoss2 = typeof window.defeatBoss==='function' ? window.defeatBoss : null;
// We hook via the boss selection click instead ‚Äî patch via selectedBoss check in defeatBoss
// Already patched via the existing _origDefeatBoss wrapper ‚Äî add egg trigger here:
document.addEventListener('bossDefeatedEvt', e=>{
  if(e.detail && e.detail.bossId==='duck_rice_overlord') showEgg('egg_yew_kee');
  if(e.detail && e.detail.bossId==='sheng_jian_empress') showEgg('egg_sheng_jian');
  if(e.detail && e.detail.bossId==='udon_worm_titan') showEgg('egg_udon');
  if(e.detail && e.detail.bossId==='steamboat_guardian') showEgg('egg_steamboat');
  if(e.detail && e.detail.bossId==='lor_mee_specter'||
     e.detail && e.detail.bossId==='lor_mee_demon') showEgg('egg_lor_mee');
});

// ‚îÄ‚îÄ Trigger: triple-tap the stats heading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _statsTaps=0,_statsTimer=null;
document.querySelector('#tab-stats h3')?.addEventListener('click',()=>{
  _statsTaps++;
  clearTimeout(_statsTimer);
  _statsTimer=setTimeout(()=>_statsTaps=0,1400);
  if(_statsTaps>=3){ _statsTaps=0; showEgg('egg_softbroccoli'); }
});

// ‚îÄ‚îÄ Trigger: 10 consecutive hearts with streak (find it in-game) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// We hook into the score display ‚Äî when streak hits 30 first time ever
let _egg30streak = false;
setInterval(()=>{
  if(!_egg30streak && typeof streak!=='undefined' && streak>=30){
    _egg30streak=true; showEgg('egg_weeknd');
  }
},500);

// Close on backdrop click
document.getElementById('egg-modal').addEventListener('click',e=>{
  if(e.target===document.getElementById('egg-modal')) closeEgg();
});
</script>

</body>
</html>
